import { formBindingData, FormExtensionAbility, formInfo, formProvider } from '@kit.FormKit';
import { Want } from '@kit.AbilityKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { UserInfoManager } from '../common/utils/UserInfoManager';
import { CourseApiService } from '../services/api/CourseApiService';
import { AppConfigManager } from '../services/AppConfigManager';
import { CourseInfo } from '../models/CourseModels';
import { FormService } from '../services/FormService';

interface TodayParm {
  year: number;
  week: number;
  termCode: string;
  weekDay: string;
}

interface TodayCourseFormData {
  formId: string;
  todayCourses: CourseInfo[];
  isLoading: boolean;
  errorMessage?: string;
}

const TAG: string = 'EntryFormAbility';

export default class EntryFormAbility extends FormExtensionAbility {
  private courseApiService: CourseApiService = CourseApiService.getInstance();
  private appConfigManager: AppConfigManager = AppConfigManager.getInstance();
  private userInfoManager: UserInfoManager = UserInfoManager.getInstance();
  private formService: FormService = FormService.getInstance();

  onAddForm(want: Want) {
    if (!want || !want.parameters) {
      hilog.error(0x0000, TAG, `FormAbility onAddForm want or want.parameters is undefined`);
      return formBindingData.createFormBindingData('');
    }

    let formName: string = want.parameters[formInfo.FormParam.NAME_KEY] as string;
    let formId: string = want.parameters[formInfo.FormParam.IDENTITY_KEY] as string;

    hilog.info(0x0000, TAG, `FormAbility onAddForm, formId = ${formId}, formName = ${formName}`);

    hilog.info(0x0000, TAG, `ğŸ¯ [FormAbility] åˆ›å»º${formName}`)

    // å¦‚æœæ˜¯ä»Šæ—¥è¯¾è¡¨å¡ç‰‡
    if (formName === 'todayCourse') {
      hilog.info(0x0000, TAG, `ğŸ¯ [FormAbility] åˆ›å»ºtodayCourse`);

      // å¼‚æ­¥æ·»åŠ  formId åˆ°é¦–é€‰é¡¹åˆ—è¡¨ï¼ˆä½†ä¸é˜»å¡è¿”å›ï¼‰
      this.formService.addFormIdToPreferences(this.context, formId).then(() => {
        hilog.info(0x0000, TAG, `FormId ${formId} æ·»åŠ åˆ°é¦–é€‰é¡¹æˆåŠŸ`);
      }).catch((error: Error) => {
        hilog.error(0x0000, TAG, `FormId ${formId} æ·»åŠ åˆ°é¦–é€‰é¡¹å¤±è´¥: ${JSON.stringify(error)}`);
      });

      // å¼‚æ­¥åŠ è½½ä»Šæ—¥è¯¾ç¨‹æ•°æ®
      this.loadTodayCourses(formId);
    }

    return formBindingData.createFormBindingData('');
  }

  onCastToNormalForm(formId: string) {
    hilog.info(0x0000, TAG, `FormAbility onCastToNormalForm, formId = ${formId}`);
  }

  onUpdateForm(formId: string, wantParams?: Record<string, Object> | undefined) {
    hilog.info(0x0000, TAG, `FormAbility onUpdateForm, formId = ${formId}`);
    this.loadTodayCourses(formId);
  }


  onFormEvent(formId: string, message: string) {
    hilog.info(0x0000, TAG, `FormAbility onFormEvent, formId = ${formId}, message: ${JSON.stringify(message)}`);
  }

  onRemoveForm(formId: string) {
    hilog.info(0x0000, TAG, `FormAbility onRemoveForm, formId = ${formId}`);
    // ä»é¦–é€‰é¡¹åˆ—è¡¨ä¸­ç§»é™¤ formIdï¼ˆå¼‚æ­¥æ‰§è¡Œï¼‰
    this.formService.removeFormIdFromPreferences(this.context, formId).then(() => {
      hilog.info(0x0000, TAG, `FormId ${formId} ä»é¦–é€‰é¡¹ç§»é™¤æˆåŠŸ`);
    }).catch((error: Error) => {
      hilog.error(0x0000, TAG, `FormId ${formId} ä»é¦–é€‰é¡¹ç§»é™¤å¤±è´¥: ${JSON.stringify(error)}`);
    });
  }

  onAcquireFormState(want: Want) {
    return formInfo.FormState.READY;
  }

  private async loadTodayCourses(formId: string, overrideClassId?: string): Promise<void> {
    try {
      // å…ˆæ›´æ–°ä¸ºåŠ è½½çŠ¶æ€
      let loadingFormData: TodayCourseFormData = {
        formId: formId,
        todayCourses: [],
        isLoading: true,
        errorMessage: ''
      };
      let loadingFormMsg: formBindingData.FormBindingData = formBindingData.createFormBindingData(loadingFormData);
      formProvider.updateForm(formId, loadingFormMsg);

      await this.appConfigManager.initialize();

      // ä¼˜å…ˆä½¿ç”¨ä¼ é€’çš„ç­çº§IDï¼Œå¦åˆ™ä»é¦–é€‰é¡¹ä¸­è·å–
      const classId = overrideClassId || this.userInfoManager.getClassId(this.context);

      hilog.info(0x0000, TAG,
        `ğŸ‘¤ [FormAbility] ä½¿ç”¨ç­çº§ID: ${classId} (æ¥æº: ${overrideClassId ? 'ä¸»åº”ç”¨ä¼ é€’' : 'é¦–é€‰é¡¹è·å–'})`);

      if (!classId) {
        hilog.warn(0x0000, TAG, 'æœªæ‰¾åˆ°ç”¨æˆ·ç­çº§ä¿¡æ¯');
        // æ˜¾ç¤ºè¯·å…ˆé€‰æ‹©ç­çº§æç¤º
        this.updateFormData(formId, [], false, 'è¯·å…ˆé€‰æ‹©ç­çº§');
        return;
      }

      const todayParams = this.initTodayParams();
      if (!todayParams) {
        hilog.warn(0x0000, TAG, 'æ— æ³•è·å–ä»Šæ—¥è¯¾ç¨‹å‚æ•°');
        this.updateFormData(formId, [], false, 'è·å–è¯¾ç¨‹å‚æ•°å¤±è´¥');
        return;
      }

      hilog.info(0x0000, TAG,
        `ğŸ” [Today Course Form] åŠ è½½è¯¾ç¨‹: year=${todayParams.year}, week=${todayParams.week}, weekDay=${todayParams.weekDay}, term=${todayParams.termCode}`);

      const response = await this.courseApiService.getTodayCourseList(
        classId,
        todayParams.year,
        todayParams.termCode,
        todayParams.week,
        todayParams.weekDay
      );

      if (response.code === 200 && response.data) {
        this.updateFormData(formId, response.data, false, '');
      } else {
        hilog.warn(0x0000, TAG, 'è·å–ä»Šæ—¥è¯¾ç¨‹å¤±è´¥');
        this.updateFormData(formId, [], false, 'è·å–è¯¾ç¨‹æ•°æ®å¤±è´¥');
      }

    } catch (error) {
      hilog.error(0x0000, TAG, 'åŠ è½½ä»Šæ—¥è¯¾ç¨‹å¤±è´¥:', JSON.stringify(error));
      this.updateFormData(formId, [], false, 'åŠ è½½è¯¾ç¨‹æ•°æ®å¤±è´¥');
    }
  }

  private updateFormData(formId: string, courses: CourseInfo[], isLoading: boolean, errorMessage?: string): void {
    let formData: TodayCourseFormData = {
      formId: formId,
      todayCourses: courses,
      isLoading: isLoading,
      errorMessage: errorMessage
    };
    let formMsg: formBindingData.FormBindingData = formBindingData.createFormBindingData(formData);
    formProvider.updateForm(formId, formMsg).then(() => {
      hilog.info(0x0000, TAG, `updateForm success, courses: ${courses.length}`);
    }).catch((error: Error) => {
      hilog.error(0x0000, TAG, 'updateForm failed.%s', JSON.stringify(error));
    });
  }

  private initTodayParams(): TodayParm | null {
    const currentStatus = this.appConfigManager.getCurrentStatus();
    if (!currentStatus || !currentStatus.currentSemester) {
      hilog.warn(0x0000, TAG, 'æœªæ‰¾åˆ°å½“å‰å­¦æœŸä¿¡æ¯');
      return null;
    }

    const today = new Date();
    const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
    const weekDayStr = weekdays[today.getDay()];

    return {
      year: parseInt(currentStatus.currentSemester.academicYear),
      week: currentStatus.currentWeek,
      termCode: currentStatus.currentSemester.semester === 1 ? '3' : '12',
      weekDay: weekDayStr
    };
  }
}