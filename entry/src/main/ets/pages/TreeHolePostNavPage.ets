/**
 * æ ‘æ´å‘å¸ƒé¡µé¢å¯¼èˆªç»„ä»¶
 * å‚è€ƒMainTabNavPageçš„ç»“æ„ï¼Œå°†TreeHolePostPageç›´æ¥é›†æˆ
 */
import { PostTreeHoleRequest } from '../models/TreeHoleModels';
import { TreeHoleApiService } from '../services/api/TreeHoleApiService';

@Builder
export function TreeHolePostNavPageBuilder() {
  TreeHolePostNavPage();
}

@Component
struct TreeHolePostNavPage {
  @Consume('NavStack') pathStack: NavPathStack;
  @State private content: string = '';
  @State private isAnonymous: boolean = true;
  @State private isPublishing: boolean = false;
  @State private wordCount: number = 0;
  
  // é…ç½®å‚æ•°
  private readonly maxLength: number = 500;
  private treeHoleApiService: TreeHoleApiService = TreeHoleApiService.getInstance();

  aboutToAppear(): void {
    console.info('ğŸŒ³ [TreeHolePostNavPage] å‘å¸ƒé¡µé¢åˆå§‹åŒ–');
  }

  @Builder
  buildTitleBar() {
    Row() {
      Button('å–æ¶ˆ')
        .fontSize(16)
        .fontColor('#666666')
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          this.handleCancel();
        })
      
      Text('å‘å¸ƒæ ‘æ´')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)
      
      Button('å‘å¸ƒ')
        .fontSize(16)
        .fontColor(this.canPublish() ? '#31BFCC' : '#CCCCCC')
        .backgroundColor(Color.Transparent)
        .enabled(this.canPublish())
        .onClick(() => {
          this.handlePublish();
        })
    }
    .width('100%')
    .height(50)
    .padding({ left: 16, right: 16 })
    .backgroundColor(Color.White)
    .justifyContent(FlexAlign.SpaceBetween)
    .alignItems(VerticalAlign.Center)
  }

  @Builder
  buildContentInput() {
    Column() {
      TextArea({ 
        placeholder: 'è¯´ç‚¹ä»€ä¹ˆ...',
        text: $$this.content 
      })
        .width('100%')
        .height(220)
        .fontSize(16)
        .backgroundColor(Color.Transparent)
        .border({ width: 0 })
        .maxLength(this.maxLength)
        .onTextSelectionChange((selectionStart: number, selectionEnd: number) => {
          this.updateWordCount();
        })
        .onChange(() => {
          this.updateWordCount();
        })
      
      // å­—æ•°ç»Ÿè®¡
      Row() {
        Blank()
        
        Text(`${this.wordCount}/${this.maxLength}`)
          .fontSize(14)
          .fontColor(this.wordCount > this.maxLength * 0.8 ? '#FF6B6B' : '#999999')
      }
      .width('100%')
      .margin({ top: 10 })
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 10 })
  }

  @Builder
  buildAnonymousOption() {
    Row() {
      // åŒ¿åå¼€å…³
      Row() {
        Image(this.isAnonymous ? $r('app.media.homeActive') : $r('app.media.home'))
          .width(20)
          .height(20)
          .margin({ right: 8 })
        
        Text('åŒ¿åå‘å¸ƒ')
          .fontSize(16)
          .fontColor('#333333')
      }
      .onClick(() => {
        this.isAnonymous = !this.isAnonymous;
      })
      
      Blank()
      
      Text(this.isAnonymous ? 'åŒ¿åæ¨¡å¼' : 'å®åæ¨¡å¼')
        .fontSize(14)
        .fontColor('#666666')
    }
    .width('100%')
    .height(60)
    .padding({ left: 20, right: 20 })
    .backgroundColor(Color.White)
    .margin({ left: 16, right: 16, top: 10 })
    .alignItems(VerticalAlign.Center)
  }

  @Builder
  buildPublishButton() {
    Button(this.isPublishing ? 'å‘å¸ƒä¸­...' : 'å‘å¸ƒæ ‘æ´')
      .width('100%')
      .height(50)
      .fontSize(18)
      .fontWeight(FontWeight.Medium)
      .fontColor(Color.White)
      .backgroundColor(this.canPublish() ? '#31BFCC' : '#CCCCCC')
      .borderRadius(25)
      .margin({ left: 16, right: 16, bottom: 30 })
      .enabled(this.canPublish() && !this.isPublishing)
      .onClick(() => {
        this.handlePublish();
      })
  }

  build() {
    NavDestination() {
      Column() {
        // è‡ªå®šä¹‰æ ‡é¢˜æ 
        this.buildTitleBar()
        
        // ä¸»å†…å®¹åŒºåŸŸ
        Scroll() {
          Column() {
            this.buildContentInput()
            this.buildAnonymousOption()
          }
        }
        .layoutWeight(1)
        
        // åº•éƒ¨å‘å¸ƒæŒ‰é’®
        this.buildPublishButton()
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#FAFAFA')
    }
    .title('å‘å¸ƒæ ‘æ´')
    .hideTitleBar(true)
    .onReady((ctx: NavDestinationContext) => {
      this.pathStack = ctx.pathStack;
      console.info('ğŸŒ³ [TreeHolePostNavPage] é¡µé¢å°±ç»ª');
    })
    .onBackPressed(() => {
      this.handleCancel();
      return true;
    })
  }

  // ===== è¾…åŠ©æ–¹æ³• =====

  /**
   * æ›´æ–°å­—æ•°ç»Ÿè®¡
   */
  private updateWordCount(): void {
    this.wordCount = this.content.length;
  }

  /**
   * æ£€æŸ¥æ˜¯å¦å¯ä»¥å‘å¸ƒ
   */
  private canPublish(): boolean {
    return this.content.trim().length > 0 && 
           this.content.length <= this.maxLength && 
           !this.isPublishing;
  }

  // ===== äº‹ä»¶å¤„ç†æ–¹æ³• =====

  /**
   * å¤„ç†å–æ¶ˆæ“ä½œ
   */
  private handleCancel(): void {
    if (this.content.trim().length > 0) {
      // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
      this.getUIContext().showAlertDialog({
        title: 'ç¡®è®¤é€€å‡º',
        message: 'å†…å®¹å°šæœªå‘å¸ƒï¼Œç¡®å®šè¦é€€å‡ºå—ï¼Ÿ',
        primaryButton: {
          value: 'ç»§ç»­ç¼–è¾‘',
          action: () => {
            // ä¸åšä»»ä½•æ“ä½œï¼Œç»§ç»­ç¼–è¾‘
          }
        },
        secondaryButton: {
          value: 'ç¡®è®¤é€€å‡º',
          action: () => {
            this.pathStack.pop();
          }
        }
      });
    } else {
      this.pathStack.pop();
    }
  }

  /**
   * å¤„ç†å‘å¸ƒæ“ä½œ
   */
  private async handlePublish(): Promise<void> {
    if (!this.canPublish()) {
      return;
    }

    try {
      this.isPublishing = true;
      
      const request: PostTreeHoleRequest = {
        content: this.content.trim(),
        isAnonymous: this.isAnonymous
      };

      console.info('ğŸŒ³ [TreeHolePostNavPage] å¼€å§‹å‘å¸ƒæ ‘æ´');
      const result = await this.treeHoleApiService.postTreeHole(request);

      if (result.code === 200) {
        console.info('ğŸŒ³ [TreeHolePostNavPage] å‘å¸ƒæˆåŠŸ');
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        this.getUIContext().showAlertDialog({
          title: 'å‘å¸ƒæˆåŠŸ',
          message: this.isAnonymous ? 'å†…å®¹å·²æäº¤ï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸' : 'å‘å¸ƒæˆåŠŸï¼',
          primaryButton: {
            value: 'ç¡®å®š',
            action: () => {
              // è¿”å›æ ‘æ´åˆ—è¡¨é¡µé¢
              this.pathStack.pop();
            }
          }
        });
      } else {
        this.showErrorDialog('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    } catch (error) {
      console.error('ğŸŒ³ [TreeHolePostNavPage] å‘å¸ƒå¤±è´¥:', error);
      this.showErrorDialog('å‘å¸ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    } finally {
      this.isPublishing = false;
    }
  }

  /**
   * æ˜¾ç¤ºé”™è¯¯å¯¹è¯æ¡†
   */
  private showErrorDialog(message: string): void {
    this.getUIContext().showAlertDialog({
      title: 'å‘å¸ƒå¤±è´¥',
      message: message,
      primaryButton: {
        value: 'ç¡®å®š',
        action: () => {
          // ä¸åšä»»ä½•æ“ä½œ
        }
      }
    });
  }
}