/**
 * æ ‘æ´å‘å¸ƒé¡µé¢å¯¼èˆªç»„ä»¶
 * å‚è€ƒMainTabNavPageçš„ç»“æ„ï¼Œå°†TreeHolePostPageç›´æ¥é›†æˆ
 */
import { PostTreeHoleRequest } from '../models/TreeHoleModels';
import { TreeHoleApiService } from '../services/api/TreeHoleApiService';
import { UserInfoManager } from '../common/utils/UserInfoManager';
import { SimpleUserInfo } from '../models/UserModels';

// å†…å®¹éªŒè¯ç»“æœæ¥å£
interface ValidationResult {
  isValid: boolean;
  message?: string;
}

@Builder
export function TreeHolePostNavPageBuilder() {
  TreeHolePostNavPage();
}

@Component
struct TreeHolePostNavPage {
  @Consume('NavStack') pathStack: NavPathStack;
  @State private content: string = '';
  @State private isAnonymous: boolean = true;
  @State private isPublishing: boolean = false;
  @State private wordCount: number = 0;
  // é…ç½®å‚æ•°
  private readonly maxLength: number = 500;
  private treeHoleApiService: TreeHoleApiService = TreeHoleApiService.getInstance();
  private userInfoManager: UserInfoManager = UserInfoManager.getInstance();

  aboutToAppear(): void {
    console.info('ğŸŒ³ [TreeHolePostNavPage] å‘å¸ƒé¡µé¢åˆå§‹åŒ–');
  }

  @Builder
  buildTitleBar() {
    Row() {
      Button('å–æ¶ˆ')
        .fontSize(16)
        .fontColor('#666666')
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          this.handleCancel();
        })

      Text('å‘å¸ƒæ ‘æ´')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Button('å‘å¸ƒ')
        .fontSize(16)
        .fontColor(this.canPublish() ? '#31BFCC' : '#CCCCCC')
        .backgroundColor(Color.Transparent)
        .enabled(this.canPublish())
        .onClick(() => {
          this.handlePublish();
        })
    }
    .width('100%')
    .height(50)
    .padding({ left: 16, right: 16 })
    .backgroundColor(Color.White)
    .justifyContent(FlexAlign.SpaceBetween)
    .alignItems(VerticalAlign.Center)
  }

  @Builder
  buildContentInput() {
    Column() {
      TextArea({
        placeholder: 'è¯´ç‚¹ä»€ä¹ˆ...',
        text: $$this.content
      })
        .width('100%')
        .height(220)
        .fontSize(16)
        .backgroundColor(Color.Transparent)
        .border({ width: 0 })
        .maxLength(this.maxLength)
        .placeholderColor('#CCCCCC')
        .textAlign(TextAlign.Start)
        .onTextSelectionChange((selectionStart: number, selectionEnd: number) => {
          this.updateWordCount();
        })
        .onChange((value: string) => {
          this.content = value;
          this.updateWordCount();
        })

      // å­—æ•°ç»Ÿè®¡å’Œæç¤º
      Row() {
        // å·¦ä¾§æç¤ºæ–‡å­—
        if (this.wordCount === 0) {
          Text('åˆ†äº«ä½ çš„æƒ³æ³•...')
            .fontSize(12)
            .fontColor('#999999')
        } else if (this.isAnonymous) {
          Text('åŒ¿åå‘å¸ƒï¼Œéœ€ç®¡ç†å‘˜å®¡æ ¸')
            .fontSize(12)
            .fontColor('#FF9500')
        } else {
          Text('å®åå‘å¸ƒï¼Œç«‹å³å¯è§')
            .fontSize(12)
            .fontColor('#31BFCC')
        }

        Blank()

        Text(`${this.wordCount}/${this.maxLength}`)
          .fontSize(14)
          .fontColor(this.wordCount > this.maxLength * 0.8 ? '#FF6B6B' : '#999999')
      }
      .width('100%')
      .margin({ top: 10 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(25)
    .borderWidth(1)
    .borderColor('#E8E8E8')
    .margin({ bottom: 15 })
    .shadow({
      radius: 6,
      color: '#0D000000',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder
  buildAnonymousOption() {
    Row() {
      // åŒ¿åå¼€å…³ - ä½¿ç”¨åŸç”ŸCheckbox
      Checkbox({ name: 'anonymous', group: 'checkboxGroup' })
        .select(this.isAnonymous)
        .selectedColor('#31BFCC')
        .unselectedColor('#CCCCCC')
        .onChange((value: boolean) => {
          this.isAnonymous = value;
          console.info(`ğŸŒ³ [TreeHolePostNavPage] åˆ‡æ¢åŒ¿åæ¨¡å¼: ${this.isAnonymous}`);
        })
        .margin({ right: 12 })

      Text('åŒ¿åå‘å¸ƒ')
        .fontSize(16)
        .fontColor('#333333')
        .onClick(() => {
          this.isAnonymous = !this.isAnonymous;
          console.info(`ğŸŒ³ [TreeHolePostNavPage] åˆ‡æ¢åŒ¿åæ¨¡å¼: ${this.isAnonymous}`);
        })

      Blank()

      Text(this.isAnonymous ? 'åŒ¿åæ¨¡å¼' : 'å®åæ¨¡å¼')
        .fontSize(14)
        .fontColor(this.isAnonymous ? '#31BFCC' : '#666666')
        .fontWeight(this.isAnonymous ? FontWeight.Medium : FontWeight.Normal)
    }
    .width('100%')
    .height(60)
    .padding({ left: 20, right: 20 })
    .backgroundColor(Color.White)
    .borderRadius(25)
    .borderWidth(1)
    .borderColor('#E8E8E8')
    .margin({ bottom: 15 })
    .alignItems(VerticalAlign.Center)
    .shadow({
      radius: 6,
      color: '#0D000000',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      this.isAnonymous = !this.isAnonymous;
      console.info(`ğŸŒ³ [TreeHolePostNavPage] åˆ‡æ¢åŒ¿åæ¨¡å¼: ${this.isAnonymous}`);
    })
  }

  @Builder
  buildPublishButton() {
    Button(this.isPublishing ? 'å‘å¸ƒä¸­...' : 'å‘å¸ƒæ ‘æ´')
      .width('100%')
      .height(50)
      .fontSize(18)
      .fontWeight(FontWeight.Medium)
      .fontColor(Color.White)
      .backgroundColor(this.canPublish() ? '#31BFCC' : '#CCCCCC')
      .borderRadius(25)
      .margin({
        left: 20,
        right: 20,
        bottom: 30,
        top: 10
      })
      .enabled(this.canPublish() && !this.isPublishing)
      .shadow({
        radius: this.canPublish() ? 8 : 4,
        color: this.canPublish() ? '#1031BFCC' : '#10CCCCCC',
        offsetX: 0,
        offsetY: 3
      })
      .onClick(() => {
        this.handlePublish();
      })
  }

  build() {
    NavDestination() {
      Column() {
        // è‡ªå®šä¹‰æ ‡é¢˜æ 
        this.buildTitleBar()

        // ä¸»å†…å®¹åŒºåŸŸ - ç§»åˆ°é¡¶éƒ¨
        Scroll() {
          Column() {
            this.buildContentInput()
            this.buildAnonymousOption()
          }
          .width('100%')
          .padding({ top: 10, left: 10, right: 10 })
          .justifyContent(FlexAlign.Start)
          .alignItems(HorizontalAlign.Start)
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
        .align(Alignment.TopStart)

        // åº•éƒ¨å‘å¸ƒæŒ‰é’® - å›ºå®šåœ¨åº•éƒ¨
        this.buildPublishButton()
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#FAFAFA')
      .justifyContent(FlexAlign.Start)
    }
    .title('å‘å¸ƒæ ‘æ´')
    .hideTitleBar(true)
    .onReady((ctx: NavDestinationContext) => {
      this.pathStack = ctx.pathStack;
      console.info('ğŸŒ³ [TreeHolePostNavPage] é¡µé¢å°±ç»ª');
    })
    .onBackPressed(() => {
      this.handleCancel();
      return true;
    })
  }

  // ===== è¾…åŠ©æ–¹æ³• =====

  /**
   * æ›´æ–°å­—æ•°ç»Ÿè®¡
   */
  private updateWordCount(): void {
    this.wordCount = this.content.length;
  }

  /**
   * æ£€æŸ¥æ˜¯å¦å¯ä»¥å‘å¸ƒ
   */
  private canPublish(): boolean {
    const trimmedContent = this.content.trim();

    // åŸºç¡€éªŒè¯
    if (trimmedContent.length === 0) {
      return false;
    }

    if (trimmedContent.length > this.maxLength) {
      return false;
    }

    // å‘å¸ƒçŠ¶æ€æ£€æŸ¥
    if (this.isPublishing) {
      return false;
    }

    return true;
  }

  /**
   * è¯¦ç»†çš„å†…å®¹éªŒè¯
   */
  private validateContent(): ValidationResult {
    const trimmedContent = this.content.trim();

    // ç©ºå†…å®¹æ£€æŸ¥
    if (trimmedContent.length === 0) {
      return { isValid: false, message: 'æ ‘æ´å†…å®¹ä¸èƒ½ä¸ºç©º' } as ValidationResult;
    }

    // é•¿åº¦æ£€æŸ¥
    if (trimmedContent.length > this.maxLength) {
      return { isValid: false, message: `å†…å®¹é•¿åº¦ä¸èƒ½è¶…è¿‡${this.maxLength}ä¸ªå­—ç¬¦` } as ValidationResult;
    }

    // æœ€å°é•¿åº¦æ£€æŸ¥
    if (trimmedContent.length < 5) {
      return { isValid: false, message: 'å†…å®¹è‡³å°‘éœ€è¦5ä¸ªå­—ç¬¦' } as ValidationResult;
    }

    // æ•æ„Ÿè¯æ£€æŸ¥ï¼ˆç®€å•ç¤ºä¾‹ï¼‰
    const sensitiveWords = ['æµ‹è¯•æ•æ„Ÿè¯', 'è¿è§„å†…å®¹'];
    for (const word of sensitiveWords) {
      if (trimmedContent.includes(word)) {
        return { isValid: false, message: 'å†…å®¹åŒ…å«ä¸å½“è¯æ±‡ï¼Œè¯·ä¿®æ”¹åé‡è¯•' } as ValidationResult;
      }
    }

    return { isValid: true } as ValidationResult;
  }

  // ===== äº‹ä»¶å¤„ç†æ–¹æ³• =====

  /**
   * å¤„ç†å–æ¶ˆæ“ä½œ
   */
  private handleCancel(): void {
    if (this.content.trim().length > 0) {
      // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
      this.getUIContext().showAlertDialog({
        title: 'ç¡®è®¤é€€å‡º',
        message: 'å†…å®¹å°šæœªå‘å¸ƒï¼Œç¡®å®šè¦é€€å‡ºå—ï¼Ÿ',
        primaryButton: {
          value: 'ç»§ç»­ç¼–è¾‘',
          action: () => {
            // ä¸åšä»»ä½•æ“ä½œï¼Œç»§ç»­ç¼–è¾‘
          }
        },
        secondaryButton: {
          value: 'ç¡®è®¤é€€å‡º',
          action: () => {
            this.pathStack.pop();
          }
        }
      });
    } else {
      this.pathStack.pop();
    }
  }

  /**
   * å¤„ç†å‘å¸ƒæ“ä½œ
   */
  private async handlePublish(): Promise<void> {
    // è¯¦ç»†éªŒè¯
    const validation = this.validateContent();
    if (!validation.isValid) {
      this.showErrorDialog(validation.message || 'å†…å®¹éªŒè¯å¤±è´¥');
      return;
    }

    try {
      this.isPublishing = true;

      // è·å–å­¦ç±ä¿¡æ¯
      const userInfo = this.userInfoManager.getUserInfo(this.getUIContext().getHostContext());
      if (!userInfo.classId) {
        this.showErrorDialog('è¯·å…ˆå®Œæˆå­¦ç±ä¿¡æ¯è®¾ç½®');
        return;
      }

      // è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
      const currentUser: SimpleUserInfo | null =
        this.userInfoManager.getCurrentUserInfo(this.getUIContext().getHostContext());
      if (!currentUser || !currentUser.userId) {
        this.showErrorDialog('è¯·å…ˆç™»å½•åå†å‘å¸ƒ');
        return;
      }

      // æ„é€ APIè¯·æ±‚å‚æ•°ï¼ˆåŒ¹é…åç«¯æ¥å£æ ¼å¼ï¼‰
      const request: PostTreeHoleRequest = {
        content: this.content.trim(),
        anonymous: this.isAnonymous ? 1 : 0, // è½¬æ¢ä¸ºæ•°å­—æ ¼å¼
        parentId: 0, // å‘å¸ƒæ ‘æ´æ—¶ä¸º0
        userId: currentUser.userId, // ä½¿ç”¨çœŸå®çš„ç”¨æˆ·ID
        deleteTime: ""  // ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºä¸è®¾ç½®åˆ é™¤æ—¶é—´
      };

      console.info('ğŸŒ³ [TreeHolePostNavPage] å¼€å§‹å‘å¸ƒæ ‘æ´ï¼Œè¯·æ±‚å‚æ•°:', JSON.stringify(request));
      const result = await this.treeHoleApiService.postTreeHole(request);

      if (result.code === 200) {
        console.info('ğŸŒ³ [TreeHolePostNavPage] å‘å¸ƒæˆåŠŸ');

        // å‘å¸ƒæˆåŠŸåçš„æç¤º
        const message = this.isAnonymous ?
          'å‘å¸ƒæˆåŠŸï¼å†…å®¹å·²æäº¤ï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸åæ˜¾ç¤º' :
          'å‘å¸ƒæˆåŠŸï¼å†…å®¹å·²å‘å¸ƒ';

        // æ˜¾ç¤ºæˆåŠŸæç¤º
        this.getUIContext().showAlertDialog({
          title: 'å‘å¸ƒæˆåŠŸ',
          message: message,
          primaryButton: {
            value: 'ç¡®å®š',
            action: () => {
              // è¿”å›æ ‘æ´åˆ—è¡¨é¡µé¢ï¼Œå¹¶è§¦å‘åˆ·æ–°
              this.pathStack.pop();

              // é€šçŸ¥æ ‘æ´é¡µé¢åˆ·æ–°æ•°æ®
              setTimeout(() => {
                // è¿™é‡Œå¯ä»¥é€šè¿‡AppStorageæˆ–å…¶ä»–æ–¹å¼é€šçŸ¥æ ‘æ´é¡µé¢åˆ·æ–°
                console.info('ğŸŒ³ [TreeHolePostNavPage] é€šçŸ¥æ ‘æ´é¡µé¢åˆ·æ–°');
              }, 100);
            }
          }
        });
      } else {
        // å¤„ç†æœåŠ¡å™¨è¿”å›çš„é”™è¯¯
        const errorMessage = this.parseServerError(result.code, result.msg);
        this.showErrorDialog(errorMessage);
      }
    } catch (error) {
      console.error('ğŸŒ³ [TreeHolePostNavPage] å‘å¸ƒå¤±è´¥:', error);

      // è§£æç½‘ç»œé”™è¯¯
      const errorMessage = this.parseNetworkError(error);
      this.showErrorDialog(errorMessage);
    } finally {
      this.isPublishing = false;
    }
  }

  /**
   * è§£ææœåŠ¡å™¨é”™è¯¯
   */
  private parseServerError(code: number, message?: string): string {
    switch (code) {
      case 401:
        return 'ç”¨æˆ·æœªç™»å½•æˆ–ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•';
      case 403:
        return 'æ²¡æœ‰å‘å¸ƒæƒé™ï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
      case 429:
        return 'å‘å¸ƒè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•';
      case 500:
        return 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
      default:
        return message || `å‘å¸ƒå¤±è´¥(é”™è¯¯ç : ${code})`;
    }
  }

  /**
   * è§£æç½‘ç»œé”™è¯¯
   */
  private parseNetworkError(error: Error | string | object): string {
    if (typeof error === 'string') {
      if (error.includes('timeout')) {
        return 'ç½‘ç»œè¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
      } else if (error.includes('network')) {
        return 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®';
      }
    } else if (error instanceof Error) {
      if (error.message.includes('timeout')) {
        return 'ç½‘ç»œè¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
      } else if (error.message.includes('network')) {
        return 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®';
      }
    }

    return 'å‘å¸ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•';
  }

  /**
   * æ˜¾ç¤ºé”™è¯¯å¯¹è¯æ¡†
   */
  private showErrorDialog(message: string): void {
    this.getUIContext().showAlertDialog({
      title: 'å‘å¸ƒå¤±è´¥',
      message: message,
      primaryButton: {
        value: 'ç¡®å®š',
        action: () => {
          // ä¸åšä»»ä½•æ“ä½œ
        }
      }
    });
  }
}