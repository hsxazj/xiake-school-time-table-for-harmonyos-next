import { promptAction } from '@kit.ArkUI';
import { SelectItem } from '../components/base/SelectItem';
import { CollegeApiService } from '../services/api/CollegeApiService';
import { UserInfoManager, UserSchoolInfo } from '../common/utils/UserInfoManager';
import { ClassInfo, College, Major, UserSelection } from '../models/CollegeModels';
import { FormService } from '../services/FormService';

@Builder
export function ClassSelectNavPageBuilder() {
  ClassSelectNavPage();
}

@Component
struct ClassSelectNavPage {
  @Consume('NavStack') pathStack: NavPathStack;
  @State private isLoading: boolean = false;
  @State private isInitializing: boolean = true; // æ–°å¢åˆå§‹åŒ–çŠ¶æ€
  @State private collegeName: string = 'åŠ è½½ä¸­...'; // åˆå§‹æ˜¾ç¤ºåŠ è½½ä¸­
  @State private majorName: string = 'åŠ è½½ä¸­...'; // åˆå§‹æ˜¾ç¤ºåŠ è½½ä¸­
  @State private className: string = 'åŠ è½½ä¸­...'; // åˆå§‹æ˜¾ç¤ºåŠ è½½ä¸­
  @State private collegeId: string = '';
  @State private majorId: string = '';
  @State private classId: string = '';
  @State private collegeList: College[] = [];
  @State private majorList: Major[] = [];
  @State private classList: ClassInfo[] = [];
  @State private selectedCollegeIndex: number = 0;
  @State private selectedMajorIndex: number = 0;
  @State private selectedClassIndex: number = 0;
  private collegeApiService: CollegeApiService = CollegeApiService.getInstance();
  private userInfoManager: UserInfoManager = UserInfoManager.getInstance();
  private formService: FormService = FormService.getInstance();
  @State private showCollegePicker: boolean = false;
  @State private showMajorPicker: boolean = false;
  @State private showClassPicker: boolean = false;
  @State private tempCollegeIndex: number = 0; // ä¸´æ—¶å­¦é™¢é€‰æ‹©ç´¢å¼•
  @State private tempMajorIndex: number = 0; // ä¸´æ—¶ä¸“ä¸šé€‰æ‹©ç´¢å¼•  
  @State private tempClassIndex: number = 0; // ä¸´æ—¶ç­çº§é€‰æ‹©ç´¢å¼•
  private promptAction = this.getUIContext().getPromptAction();

  aboutToAppear(): void {
    console.info('ClassSelectPage aboutToAppear å¼€å§‹');
    this.loadInitialData();
  }

  @Builder
  CollegePickerBuilder() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('é€‰æ‹©å­¦é™¢')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
      }
      .width('100%')
      .height(56)
      .justifyContent(FlexAlign.Center)
      .padding({ left: 16, right: 16 })
      .borderRadius({ topLeft: 16, topRight: 16 })
      .backgroundColor(Color.White)

      // åˆ†å‰²çº¿
      Divider()
        .color('#F0F0F0')

      // ä½¿ç”¨TextPickerå®ç°æ»šè½®é€‰æ‹©
      TextPicker({
        range: this.collegeList.map(college => college.collegeName),
        selected: this.tempCollegeIndex
      })
        .selectedTextStyle({ color: '#45CAD9' })
        .defaultPickerItemHeight(52)
        .width('100%')
        .layoutWeight(1)// ä½¿ç”¨layoutWeightå æ®å‰©ä½™ç©ºé—´
        .backgroundColor(Color.White)
        .padding(0)// å»é™¤é»˜è®¤å†…è¾¹è·
        .margin(0)// å»é™¤é»˜è®¤å¤–è¾¹è·
        .onChange((value: string | string[], index: number | number[]) => {
          const selectedValue = Array.isArray(value) ? value[0] : value;
          const selectedIndex = Array.isArray(index) ? index[0] : index;
          console.info(`ä¸´æ—¶é€‰æ‹©å­¦é™¢: ${selectedValue}, index: ${selectedIndex}`);
          this.tempCollegeIndex = selectedIndex; // åªæ›´æ–°ä¸´æ—¶çŠ¶æ€
        })

      Button('ç¡®å®š')
        .margin({ top: 16, bottom: 30 })
        .width('80%')
        .backgroundColor('#45CAD9')
        .fontColor(Color.White)
        .onClick(() => {
          // ç¡®å®šæ—¶æ‰çœŸæ­£é€‰æ‹©
          this.selectedCollegeIndex = this.tempCollegeIndex;
          this.handleCollegeSelect(this.tempCollegeIndex);
          this.showCollegePicker = false;
        })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
    .borderRadius({ topLeft: 16, topRight: 16 })
  }

  @Builder
  MajorPickerBuilder() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('é€‰æ‹©ä¸“ä¸š')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
      }
      .width('100%')
      .height(56)
      .justifyContent(FlexAlign.Center)
      .padding({ left: 16, right: 16 })
      .borderRadius({ topLeft: 16, topRight: 16 })
      .backgroundColor(Color.White)

      // åˆ†å‰²çº¿
      Divider()
        .color('#F0F0F0')

      // ä½¿ç”¨TextPickerå®ç°æ»šè½®é€‰æ‹©
      TextPicker({
        range: this.majorList.map(major => major.majorName),
        selected: this.tempMajorIndex
      })
        .selectedTextStyle({ color: '#45CAD9' })
        .defaultPickerItemHeight(52)
        .width('100%')
        .layoutWeight(1)// ä½¿ç”¨layoutWeightå æ®å‰©ä½™ç©ºé—´
        .backgroundColor(Color.White)
        .padding(0)// å»é™¤é»˜è®¤å†…è¾¹è·
        .margin(0)// å»é™¤é»˜è®¤å¤–è¾¹è·
        .onChange((value: string | string[], index: number | number[]) => {
          const selectedValue = Array.isArray(value) ? value[0] : value;
          const selectedIndex = Array.isArray(index) ? index[0] : index;
          console.info(`ä¸´æ—¶é€‰æ‹©ä¸“ä¸š: ${selectedValue}, index: ${selectedIndex}`);
          this.tempMajorIndex = selectedIndex; // åªæ›´æ–°ä¸´æ—¶çŠ¶æ€
        })

      Button('ç¡®å®š')
        .margin({ top: 16, bottom: 30 })
        .width('80%')
        .backgroundColor('#45CAD9')
        .fontColor(Color.White)
        .onClick(() => {
          // ç¡®å®šæ—¶æ‰çœŸæ­£é€‰æ‹©
          this.selectedMajorIndex = this.tempMajorIndex;
          this.handleMajorSelect(this.tempMajorIndex);
          this.showMajorPicker = false;
        })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius({ topLeft: 16, topRight: 16 })
  }

  @Builder
  ClassPickerBuilder() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('é€‰æ‹©ç­çº§')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
      }
      .width('100%')
      .height(56)
      .justifyContent(FlexAlign.Center)
      .padding({ left: 16, right: 16 })
      .borderRadius({ topLeft: 16, topRight: 16 })
      .backgroundColor(Color.White)

      // åˆ†å‰²çº¿
      Divider()
        .color('#F0F0F0')

      // ä½¿ç”¨TextPickerå®ç°æ»šè½®é€‰æ‹©
      TextPicker({
        range: this.classList.map(classInfo => classInfo.className),
        selected: this.tempClassIndex
      })
        .selectedTextStyle({ color: '#45CAD9' })
        .defaultPickerItemHeight(52)
        .width('100%')
        .layoutWeight(1)// ä½¿ç”¨layoutWeightå æ®å‰©ä½™ç©ºé—´
        .backgroundColor(Color.White)
        .padding(0)// å»é™¤é»˜è®¤å†…è¾¹è·
        .margin(0)// å»é™¤é»˜è®¤å¤–è¾¹è·
        .onChange((value: string | string[], index: number | number[]) => {
          const selectedValue = Array.isArray(value) ? value[0] : value;
          const selectedIndex = Array.isArray(index) ? index[0] : index;
          console.info(`ä¸´æ—¶é€‰æ‹©ç­çº§: ${selectedValue}, index: ${selectedIndex}`);
          this.tempClassIndex = selectedIndex; // åªæ›´æ–°ä¸´æ—¶çŠ¶æ€
        })

      Button('ç¡®å®š')
        .margin({ top: 16, bottom: 30 })
        .width('80%')
        .backgroundColor('#45CAD9')
        .fontColor(Color.White)
        .onClick(() => {
          // ç¡®å®šæ—¶æ‰çœŸæ­£é€‰æ‹©
          this.selectedClassIndex = this.tempClassIndex;
          this.handleClassSelect(this.tempClassIndex);
          this.showClassPicker = false;
        })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
    .borderRadius({ topLeft: 16, topRight: 16 })
  }

  build() {
    NavDestination() {
      Column() {
        Text('é€‰æ‹©è¦æŸ¥çœ‹çš„ç­çº§')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#179FA2')
          .margin({
            top: 120
          })
          .textAlign(TextAlign.Start)
          .width('80%')

        Column() {
          SelectItem({
            icon: $r('app.media.college'),
            title: this.collegeName,
            iconBackgroundColor: '#F2FAF4',
            iconShadowColor: 'rgba(36, 194, 198, 0.2)',
            isSelected: this.collegeId !== '',
            onTap: () => {
              console.info(`å­¦é™¢ç‚¹å‡»äº‹ä»¶è§¦å‘ï¼ŒisInitializing=${this.isInitializing}`);
              if (!this.isInitializing) {
                this.handleCollegeClick();
              } else {
                console.info('åˆå§‹åŒ–ä¸­ï¼Œç‚¹å‡»è¢«å¿½ç•¥');
              }
            }
          })
            .bindSheet($$this.showCollegePicker, this.CollegePickerBuilder(), {
              showClose: false,
              height: 400,
              dragBar: true,
              maskColor: 'rgba(0, 0, 0, 0.4)',
              onAppear: () => {
                console.log("å­¦é™¢é€‰æ‹©å™¨æ˜¾ç¤º");
              },
              onDisappear: () => {
                console.log("å­¦é™¢é€‰æ‹©å™¨éšè—");
              }
            })

          SelectItem({
            icon: $r('app.media.major'),
            title: this.majorName,
            iconBackgroundColor: '#E0EFFF',
            iconShadowColor: 'rgba(126, 175, 252, 0.3)',
            isSelected: this.majorId !== '',
            onTap: () => {
              console.info(`ä¸“ä¸šç‚¹å‡»äº‹ä»¶è§¦å‘ï¼ŒisInitializing=${this.isInitializing}`);
              if (!this.isInitializing) {
                this.handleMajorClick();
              } else {
                console.info('åˆå§‹åŒ–ä¸­ï¼Œç‚¹å‡»è¢«å¿½ç•¥');
              }
            }
          })
            .bindSheet($$this.showMajorPicker, this.MajorPickerBuilder(), {
              showClose: false,
              height: 400,
              dragBar: true,
              maskColor: 'rgba(0, 0, 0, 0.4)',
              onAppear: () => {
                console.log("ä¸“ä¸šé€‰æ‹©å™¨æ˜¾ç¤º");
              },
              onDisappear: () => {
                console.log("ä¸“ä¸šé€‰æ‹©å™¨éšè—");
              }
            })

          SelectItem({
            icon: $r('app.media.class_icon'),
            title: this.className,
            iconBackgroundColor: '#FFF3E9',
            iconShadowColor: 'rgba(250, 207, 94, 0.2)',
            isSelected: this.classId !== '',
            onTap: () => {
              console.info(`ç­çº§ç‚¹å‡»äº‹ä»¶è§¦å‘ï¼ŒisInitializing=${this.isInitializing}`);
              if (!this.isInitializing) {
                this.handleClassClick();
              } else {
                console.info('åˆå§‹åŒ–ä¸­ï¼Œç‚¹å‡»è¢«å¿½ç•¥');
              }
            }
          })
            .bindSheet($$this.showClassPicker, this.ClassPickerBuilder(), {
              showClose: false,
              height: 400,
              dragBar: true,
              maskColor: 'rgba(0, 0, 0, 0.4)',
              onAppear: () => {
                console.log("ç­çº§é€‰æ‹©å™¨æ˜¾ç¤º");
              },
              onDisappear: () => {
                console.log("ç­çº§é€‰æ‹©å™¨éšè—");
              }
            })
        }
        .width('90%')
        .margin({ top: 20 })

        Blank()

        Button('ä¿å­˜')
          .width('60%')
          .height(45)
          .fontSize(16)
          .fontColor(Color.White)
          .backgroundColor(this.isInitializing ? '#CCCCCC' : '#45CAD9')// åˆå§‹åŒ–æ—¶ç°è‰²
          .borderRadius(22)
          .margin({ bottom: 60 })
          .shadow({
            radius: 20,
            color: this.isInitializing ? 'rgba(204, 204, 204, 0.3)' : 'rgba(157, 224, 231, 0.6)',
            offsetY: 0
          })
          .onClick(() => {
            if (!this.isInitializing) {
              this.handleNextStep();
            }
          })

        if (this.isLoading || this.isInitializing) {
          Column() {
            LoadingProgress()
              .width(50)
              .height(50)
              .color('#45CAD9')

            Text(this.isInitializing ? 'æ­£åœ¨åŠ è½½ç”¨æˆ·ä¿¡æ¯...' : 'åŠ è½½ä¸­...')
              .fontSize(14)
              .fontColor('#666666')
              .margin({ top: 10 })
          }
          .position({ x: '50%', y: '50%' })
          .translate({ x: '-50%', y: '-50%' })
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor(Color.White)
      .justifyContent(FlexAlign.Start)
    }
    .hideTitleBar(true)
    .onReady((ctx: NavDestinationContext) => {
      this.pathStack = ctx.pathStack;
    })

  }

  private async loadInitialData(): Promise<void> {
    try {
      console.info('å¼€å§‹åˆå§‹åŒ–ï¼ŒisInitializing = true');
      this.isInitializing = true;
      const response = await this.collegeApiService.getAllColleges();
      this.collegeList = response.data;
      console.info(`å­¦é™¢åˆ—è¡¨åŠ è½½å®Œæˆï¼Œå…±${this.collegeList.length}ä¸ªå­¦é™¢`);

      // å­¦é™¢åˆ—è¡¨åŠ è½½å®Œæˆåï¼ŒåŠ è½½ç”¨æˆ·ä¹‹å‰çš„é€‰æ‹©
      await this.loadUserPreviousSelections();
    } catch (error) {
      console.error('Load colleges failed:', error);
      this.promptAction.showToast({
        message: 'åŠ è½½å­¦é™¢ä¿¡æ¯å¤±è´¥',
        duration: 2000
      });
    } finally {
      console.info('åˆå§‹åŒ–å®Œæˆï¼ŒisInitializing = false');
      this.isInitializing = false; // åˆå§‹åŒ–å®Œæˆï¼Œå¼€æ”¾æ“ä½œ
    }
  }

  /**
   * åŠ è½½ç”¨æˆ·ä¹‹å‰çš„é€‰æ‹©ä¿¡æ¯
   */
  private async loadUserPreviousSelections(): Promise<void> {
    try {
      const userInfo = this.userInfoManager.getUserInfo(this.getUIContext().getHostContext());
      console.info('ç”¨æˆ·ä¿¡æ¯:', JSON.stringify(userInfo));

      // å…ˆé‡ç½®ä¸ºé»˜è®¤çŠ¶æ€
      this.collegeName = 'è¯·é€‰æ‹©å­¦é™¢';
      this.majorName = 'è¯·é€‰æ‹©ä¸“ä¸š';
      this.className = 'è¯·é€‰æ‹©ç­çº§';

      if (userInfo.collegeId && userInfo.collegeId !== '0') {
        // ç”¨æˆ·ä¹‹å‰å·²é€‰æ‹©å­¦é™¢
        this.collegeId = userInfo.collegeId; // ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²
        this.collegeName = userInfo.collegeName;

        // æ‰¾åˆ°å­¦é™¢åœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼• - ç›´æ¥æ¯”è¾ƒå­—ç¬¦ä¸²ID
        const collegeIndex = this.collegeList.findIndex(college => college.collegeId === userInfo.collegeId);
        if (collegeIndex >= 0) {
          this.selectedCollegeIndex = collegeIndex;
        }

        console.info(`å·²é€‰æ‹©å­¦é™¢: ${this.collegeName} (ID: ${this.collegeId})`);

        // åŠ è½½ä¸“ä¸šæ•°æ®
        await this.loadMajorsForPreSelection();

        if (userInfo.majorId && userInfo.majorId !== '0' && this.majorList.length > 0) {
          // ç”¨æˆ·ä¹‹å‰å·²é€‰æ‹©ä¸“ä¸šï¼Œä¸”ä¸“ä¸šåˆ—è¡¨ä¸ä¸ºç©º
          this.majorId = userInfo.majorId; // ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²
          this.majorName = userInfo.majorName;

          // æ‰¾åˆ°ä¸“ä¸šåœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼• - ç›´æ¥æ¯”è¾ƒå­—ç¬¦ä¸²ID
          const majorIndex = this.majorList.findIndex(major => major.majorId === userInfo.majorId);
          if (majorIndex >= 0) {
            this.selectedMajorIndex = majorIndex;
          }

          console.info(`å·²é€‰æ‹©ä¸“ä¸š: ${this.majorName} (ID: ${this.majorId})`);

          // åŠ è½½ç­çº§æ•°æ®
          await this.loadClassesForPreSelection();

          if (userInfo.classId && userInfo.classId !== '0' && this.classList.length > 0) {
            // ç”¨æˆ·ä¹‹å‰å·²é€‰æ‹©ç­çº§ï¼Œä¸”ç­çº§åˆ—è¡¨ä¸ä¸ºç©º
            this.classId = userInfo.classId; // ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²
            this.className = userInfo.className;

            // æ‰¾åˆ°ç­çº§åœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼• - ç›´æ¥æ¯”è¾ƒå­—ç¬¦ä¸²ID
            const classIndex = this.classList.findIndex(classInfo => classInfo.classId === userInfo.classId);
            if (classIndex >= 0) {
              this.selectedClassIndex = classIndex;
            }

            console.info(`å·²é€‰æ‹©ç­çº§: ${this.className} (ID: ${this.classId})`);
          }
        } else if (userInfo.majorId && userInfo.majorId !== '0') {
          // ä¸“ä¸šæ•°æ®åŠ è½½å¤±è´¥ï¼Œä½†ä¿æŒç”¨æˆ·çš„é€‰æ‹©æ˜¾ç¤º
          console.warn('ä¸“ä¸šåˆ—è¡¨ä¸ºç©ºï¼Œä½†ä¿ç•™ç”¨æˆ·ä¹‹å‰çš„ä¸“ä¸šé€‰æ‹©æ˜¾ç¤º');
          this.majorId = userInfo.majorId; // ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²
          this.majorName = userInfo.majorName;

          if (userInfo.classId && userInfo.classId !== '0') {
            this.classId = userInfo.classId; // ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²
            this.className = userInfo.className;
          }
        }
      }

      console.info('ç”¨æˆ·ä¹‹å‰çš„é€‰æ‹©å·²åŠ è½½å®Œæˆ');
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·ä¹‹å‰é€‰æ‹©å¤±è´¥:', error);
      // åŠ è½½å¤±è´¥æ—¶ä¹Ÿè¦é‡ç½®ä¸ºé»˜è®¤çŠ¶æ€
      this.collegeName = 'è¯·é€‰æ‹©å­¦é™¢';
      this.majorName = 'è¯·é€‰æ‹©ä¸“ä¸š';
      this.className = 'è¯·é€‰æ‹©ç­çº§';
    }
  }

  /**
   * ä¸ºé¢„é€‰æ‹©åŠ è½½ä¸“ä¸šæ•°æ®ï¼ˆä¸æ˜¾ç¤ºloadingï¼‰
   */
  private async loadMajorsForPreSelection(): Promise<void> {
    if (this.collegeId === '') {
      return;
    }

    try {
      const response = await this.collegeApiService.getAllMajors(this.collegeId);
      if (response.code === 200 && response.data) {
        this.majorList = response.data;
        console.info(`åŠ è½½äº†${this.majorList.length}ä¸ªä¸“ä¸š`);
      } else {
        console.warn(`åŠ è½½ä¸“ä¸šå¤±è´¥: ${response.msg || 'æœªçŸ¥é”™è¯¯'}`);
        this.majorList = []; // ç¡®ä¿æ˜¯ç©ºæ•°ç»„
      }
    } catch (error) {
      console.error('Load majors for preselection failed:', error);
      this.majorList = []; // ç¡®ä¿æ˜¯ç©ºæ•°ç»„
    }
  }

  /**
   * ä¸ºé¢„é€‰æ‹©åŠ è½½ç­çº§æ•°æ®ï¼ˆä¸æ˜¾ç¤ºloadingï¼‰
   */
  private async loadClassesForPreSelection(): Promise<void> {
    if (this.majorId === '') {
      return;
    }

    try {
      const response = await this.collegeApiService.getAllClasses(this.majorId);
      if (response.code === 200 && response.data) {
        this.classList = response.data;
        console.info(`åŠ è½½äº†${this.classList.length}ä¸ªç­çº§`);
      } else {
        console.warn(`åŠ è½½ç­çº§å¤±è´¥: ${response.msg || 'æœªçŸ¥é”™è¯¯'}`);
        this.classList = []; // ç¡®ä¿æ˜¯ç©ºæ•°ç»„
      }
    } catch (error) {
      console.error('Load classes for preselection failed:', error);
      this.classList = []; // ç¡®ä¿æ˜¯ç©ºæ•°ç»„
    }
  }

  private async handleCollegeClick(): Promise<void> {
    console.info('ç‚¹å‡»å­¦é™¢é€‰æ‹©');

    if (this.collegeList.length === 0) {
      console.info('å­¦é™¢åˆ—è¡¨ä¸ºç©ºï¼Œé‡æ–°åŠ è½½');
      await this.loadInitialData();
    }

    if (this.collegeList.length > 0) {
      console.info(`å‡†å¤‡æ˜¾ç¤ºå­¦é™¢é€‰æ‹©å™¨ï¼Œå…±${this.collegeList.length}ä¸ªå­¦é™¢`);
      // åˆå§‹åŒ–ä¸´æ—¶é€‰æ‹©çŠ¶æ€ä¸ºå½“å‰é€‰æ‹©
      this.tempCollegeIndex = this.selectedCollegeIndex;
      this.showCollegePicker = true;
    } else {
      console.error('å­¦é™¢åˆ—è¡¨ä»ç„¶ä¸ºç©ºï¼Œæ— æ³•æ˜¾ç¤ºé€‰æ‹©å™¨');
    }
  }

  private async handleCollegeSelect(index: number): Promise<void> {
    if (index >= 0 && index < this.collegeList.length) {
      const selectedCollege = this.collegeList[index];
      this.collegeId = selectedCollege.collegeId; // ç›´æ¥ä½¿ç”¨ï¼Œå·²ç»æ˜¯å­—ç¬¦ä¸²
      this.collegeName = selectedCollege.collegeName;
      this.selectedCollegeIndex = index;

      this.resetMajorAndClass();
      await this.loadMajors();
    }
  }

  private async handleMajorClick(): Promise<void> {
    console.info('ç‚¹å‡»ä¸“ä¸šé€‰æ‹©');

    if (this.collegeId === '') {
      console.warn('æœªé€‰æ‹©å­¦é™¢ï¼Œæ— æ³•é€‰æ‹©ä¸“ä¸š');
      // TODO
      this.promptAction.showToast({
        message: 'è¯·é€‰æ‹©å­¦é™¢',
        duration: 2000
      });
      return;
    }

    if (this.majorList.length === 0) {
      console.info('ä¸“ä¸šåˆ—è¡¨ä¸ºç©ºï¼Œé‡æ–°åŠ è½½');
      await this.loadMajors();
    }

    if (this.majorList.length > 0) {
      console.info(`å‡†å¤‡æ˜¾ç¤ºä¸“ä¸šé€‰æ‹©å™¨ï¼Œå…±${this.majorList.length}ä¸ªä¸“ä¸š`);
      // åˆå§‹åŒ–ä¸´æ—¶é€‰æ‹©çŠ¶æ€ä¸ºå½“å‰é€‰æ‹©
      this.tempMajorIndex = this.selectedMajorIndex;
      this.showMajorPicker = true;
    } else {
      console.error('ä¸“ä¸šåˆ—è¡¨ä»ç„¶ä¸ºç©ºï¼Œæ— æ³•æ˜¾ç¤ºé€‰æ‹©å™¨');
      this.promptAction.showToast({
        message: 'è¯¥å­¦é™¢æš‚æ— ä¸“ä¸šæ•°æ®',
        duration: 2000
      });
    }
  }

  private async handleMajorSelect(index: number): Promise<void> {
    if (index >= 0 && index < this.majorList.length) {
      const selectedMajor = this.majorList[index];
      this.majorId = selectedMajor.majorId; // ç›´æ¥ä½¿ç”¨ï¼Œå·²ç»æ˜¯å­—ç¬¦ä¸²
      this.majorName = selectedMajor.majorName;
      this.selectedMajorIndex = index;

      this.resetClass();
      await this.loadClasses();
    }
  }

  private async handleClassClick(): Promise<void> {
    console.info('ç‚¹å‡»ç­çº§é€‰æ‹©');

    if (this.collegeId === '') {
      console.warn('æœªé€‰æ‹©å­¦é™¢ï¼Œæ— æ³•é€‰æ‹©ç­çº§');
      this.promptAction.showToast({
        message: 'è¯·é€‰æ‹©å­¦é™¢',
        duration: 2000
      });
      return;
    }

    if (this.majorId === '') {
      console.warn('æœªé€‰æ‹©ä¸“ä¸šï¼Œæ— æ³•é€‰æ‹©ç­çº§');
      this.promptAction.showToast({
        message: 'è¯·é€‰æ‹©ä¸“ä¸š',
        duration: 2000
      });
      return;
    }

    if (this.classList.length === 0) {
      console.info('ç­çº§åˆ—è¡¨ä¸ºç©ºï¼Œé‡æ–°åŠ è½½');
      await this.loadClasses();
    }

    if (this.classList.length > 0) {
      console.info(`å‡†å¤‡æ˜¾ç¤ºç­çº§é€‰æ‹©å™¨ï¼Œå…±${this.classList.length}ä¸ªç­çº§`);
      // åˆå§‹åŒ–ä¸´æ—¶é€‰æ‹©çŠ¶æ€ä¸ºå½“å‰é€‰æ‹©
      this.tempClassIndex = this.selectedClassIndex;
      this.showClassPicker = true;
    } else {
      console.error('ç­çº§åˆ—è¡¨ä»ç„¶ä¸ºç©ºï¼Œæ— æ³•æ˜¾ç¤ºé€‰æ‹©å™¨');
      this.promptAction.showToast({
        message: 'è¯¥ä¸“ä¸šæš‚æ— ç­çº§æ•°æ®',
        duration: 2000
      });
    }
  }

  private handleClassSelect(index: number): void {
    if (index >= 0 && index < this.classList.length) {
      const selectedClass = this.classList[index];
      this.classId = selectedClass.classId; // ç›´æ¥ä½¿ç”¨ï¼Œå·²ç»æ˜¯å­—ç¬¦ä¸²
      this.className = selectedClass.className;
      this.selectedClassIndex = index;
    }
  }

  private async loadMajors(): Promise<void> {
    if (this.collegeId === '') {
      return;
    }

    try {
      this.isLoading = true;
      const response = await this.collegeApiService.getAllMajors(this.collegeId);
      this.majorList = response.data;
    } catch (error) {
      console.error('Load majors failed:', error);
      this.promptAction.showToast({
        message: 'åŠ è½½ä¸“ä¸šä¿¡æ¯å¤±è´¥',
        duration: 2000
      });
    } finally {
      this.isLoading = false;
    }
  }

  private async loadClasses(): Promise<void> {
    if (this.majorId === '') {
      return;
    }

    try {
      this.isLoading = true;
      const response = await this.collegeApiService.getAllClasses(this.majorId);
      this.classList = response.data;
    } catch (error) {
      console.error('Load classes failed:', error);
      this.promptAction.showToast({
        message: 'åŠ è½½ç­çº§ä¿¡æ¯å¤±è´¥',
        duration: 2000
      });
    } finally {
      this.isLoading = false;
    }
  }

  private resetMajorAndClass(): void {
    this.majorName = 'è¯·é€‰æ‹©ä¸“ä¸š';
    this.majorId = '';
    this.selectedMajorIndex = 0;
    this.majorList = [];

    this.resetClass();
  }

  private resetClass(): void {
    this.className = 'è¯·é€‰æ‹©ç­çº§';
    this.classId = '';
    this.selectedClassIndex = 0;
    this.classList = [];
  }

  private async handleNextStep(): Promise<void> {
    if (this.collegeId === '') {
      this.promptAction.showToast({
        message: 'è¯·é€‰æ‹©å­¦é™¢',
        duration: 2000
      });
      return;
    }

    if (this.majorId === '') {
      this.promptAction.showToast({
        message: 'è¯·é€‰æ‹©ä¸“ä¸š',
        duration: 2000
      });
      return;
    }

    if (this.classId === '') {
      this.promptAction.showToast({
        message: 'è¯·é€‰æ‹©ç­çº§',
        duration: 2000
      });
      return;
    }

    const userSelection: UserSelection = {
      collegeId: this.collegeId,
      collegeName: this.collegeName,
      majorId: this.majorId,
      majorName: this.majorName,
      classId: this.classId,
      className: this.className
    };

    // æ£€æŸ¥ç”¨æˆ·ä¹‹å‰æ˜¯å¦å·²æœ‰å®Œæ•´ä¿¡æ¯ï¼ˆç”¨äºåˆ¤æ–­æ˜¯é¦–æ¬¡è®¾ç½®è¿˜æ˜¯ä¿®æ”¹è®¾ç½®ï¼‰
    const hadCompleteInfo = this.userInfoManager.hasCompleteUserInfo(this.getUIContext().getHostContext());

    // è·å–ä¹‹å‰çš„ç­çº§IDç”¨äºæ¯”è¾ƒ
    const previousUserInfo = this.userInfoManager.getUserInfo(this.getUIContext().getHostContext());
    const previousClassId = previousUserInfo.classId;

    // ä¿å­˜ç”¨æˆ·é€‰æ‹©åˆ°PreferencesUtil
    console.info(`ğŸ” [ClassSelect] å¼€å§‹ä¿å­˜ç”¨æˆ·ä¿¡æ¯...`);
    console.info(`ğŸ” [ClassSelect] å­¦é™¢: ${userSelection.collegeId} - ${userSelection.collegeName}`);
    console.info(`ğŸ” [ClassSelect] ä¸“ä¸š: ${userSelection.majorId} - ${userSelection.majorName}`);
    console.info(`ğŸ” [ClassSelect] ç­çº§: ${userSelection.classId} - ${userSelection.className}`);

    try {
      // åˆ›å»ºç¬¦åˆUserSchoolInfoæ¥å£çš„å¯¹è±¡
      const userInfo: UserSchoolInfo = {
        collegeId: userSelection.collegeId,
        collegeName: userSelection.collegeName,
        majorId: userSelection.majorId,
        majorName: userSelection.majorName,
        classId: userSelection.classId,
        className: userSelection.className
      };

      // ä½¿ç”¨åŒæ­¥ä¿å­˜æ–¹æ³•ç¡®ä¿æ•°æ®å®Œå…¨å†™å…¥
      this.userInfoManager.saveCompleteUserInfo(this.getUIContext().getHostContext(), userInfo);

      // ç«‹å³éªŒè¯ä¿å­˜ç»“æœ
      const savedUserInfo = this.userInfoManager.getUserInfo(this.getUIContext().getHostContext());

      console.info(`âœ… [ClassSelect] ä¿å­˜éªŒè¯:`);
      console.info(`âœ… [ClassSelect] å­¦é™¢ID: ${savedUserInfo.collegeId} (æœŸæœ›: ${userSelection.collegeId})`);
      console.info(`âœ… [ClassSelect] ä¸“ä¸šID: ${savedUserInfo.majorId} (æœŸæœ›: ${userSelection.majorId})`);
      console.info(`âœ… [ClassSelect] ç­çº§ID: ${savedUserInfo.classId} (æœŸæœ›: ${userSelection.classId})`);

      const saveSuccess = savedUserInfo.collegeId === userSelection.collegeId &&
        savedUserInfo.majorId === userSelection.majorId &&
        savedUserInfo.classId === userSelection.classId;

      console.info(`${saveSuccess ? 'âœ…' : 'âŒ'} [ClassSelect] åŒæ­¥ä¿å­˜${saveSuccess ? 'æˆåŠŸ' : 'å¤±è´¥'}`);

      // æ£€æŸ¥ç­çº§IDæ˜¯å¦å‘ç”Ÿäº†å˜åŒ–
      const classIdChanged = previousClassId !== userSelection.classId;
      console.info(`ğŸ”„ [ClassSelect] ç­çº§IDå˜åŒ–æ£€æŸ¥: ${previousClassId} -> ${userSelection.classId} (å˜åŒ–: ${classIdChanged})`);

      this.promptAction.showToast({
        message: saveSuccess ? 'ä¿å­˜æˆåŠŸ' : 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });

      if (saveSuccess) {
        // å…ˆç¡®ä¿æ•°æ®å·²ç»åŒæ­¥ä¿å­˜å®Œæˆåå†è§¦å‘å¡ç‰‡æ›´æ–°
        if (classIdChanged) {
          console.info(`ğŸ”„ [ClassSelect] ç­çº§IDå·²å˜åŒ–ï¼Œæ•°æ®å·²åŒæ­¥ä¿å­˜å®Œæˆï¼Œç°åœ¨è§¦å‘æ‰€æœ‰å¡ç‰‡æ›´æ–°...`);
          try {
            // ç›´æ¥ä¼ é€’æ–°çš„ç­çº§IDç»™å¡ç‰‡ï¼Œä½†ä¸ä¼ é€’è¯¾ç¨‹æ•°æ®ï¼ˆè®©å¡ç‰‡è‡ªå·±æ›´æ–°ï¼‰
            this.formService.updateAllActiveWidgets(this.getUIContext().getHostContext(), userSelection.classId);
            console.info(`âœ… [ClassSelect] æ‰€æœ‰å¡ç‰‡æ›´æ–°è§¦å‘å®Œæˆ`);
          } catch (error) {
            console.error(`âŒ [ClassSelect] è§¦å‘å¡ç‰‡æ›´æ–°å¤±è´¥: ${JSON.stringify(error)}`);
          }
        } else {
          console.info(`ğŸ”„ [ClassSelect] ç­çº§IDæœªå˜åŒ–ï¼Œè·³è¿‡å¡ç‰‡æ›´æ–°`);
        }

        setTimeout(() => {
          if (hadCompleteInfo) {
            // ç”¨æˆ·ä¹‹å‰å·²æœ‰å®Œæ•´ä¿¡æ¯ï¼Œè¯´æ˜æ˜¯ä»é¦–é¡µåˆ‡æ¢è¿‡æ¥çš„ï¼Œç›´æ¥è¿”å›ä¸»é¡µé¢
            this.pathStack.replacePathByName('MainTabNavPage', null);
          } else {
            // ç”¨æˆ·ä¹‹å‰æ²¡æœ‰å®Œæ•´ä¿¡æ¯ï¼Œè¯´æ˜æ˜¯é¦–æ¬¡è®¾ç½®ï¼Œè·³è½¬åˆ°æ¬¢è¿é¡µé¢
            this.pathStack.replacePathByName('WelcomeNavPage', null);
          }
        }, 1000);
      }
    } catch (error) {
      console.error(`âŒ [ClassSelect] ä¿å­˜è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error}`);
      this.promptAction.showToast({
        message: 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }
}