/**
 * æ ‘æ´è¯¦æƒ…é¡µé¢å¯¼èˆªç»„ä»¶
 * å‚è€ƒMainTabNavPageçš„ç»“æ„ï¼Œå°†TreeHoleDetailPageç›´æ¥é›†æˆ
 */
import { TreeHoleComment, TreeHoleItem, PostTreeHoleRequest } from '../models/TreeHoleModels';
import { TreeHoleApiService } from '../services/api/TreeHoleApiService';
import { LoginApiService } from '../services/api/LoginApiService';
import { UserInfoManager } from '../common/utils/UserInfoManager';
import { curves } from '@kit.ArkUI';
import { API_CONFIG } from '../common/constants/AppConstants';

@Builder
export function TreeHoleDetailNavPageBuilder() {
  TreeHoleDetailNavPage();
}

@Component
struct TreeHoleDetailNavPage {
  @Consume('NavStack') pathStack: NavPathStack;
  @State private treeHoleItem: TreeHoleItem | null = null;
  @State private commentsList: TreeHoleComment[] = [];
  @State private isLoading: boolean = false;
  @State private commentText: string = '';
  @State private isCommenting: boolean = false;
  @State private isLoggedIn: boolean = false;
  @State private pageOpacity: number = 0; // é¡µé¢åˆå§‹é€æ˜åº¦ä¸º0
  @State private pageTranslateY: number = 30; // é¡µé¢åˆå§‹å‘ä¸‹åç§»30px
  @State private transitionEffect: TransitionEffect = TransitionEffect.IDENTITY;
  // æ¥æ”¶å‚æ•°
  private treeHoleId: number = 0;
  private treeHoleApiService: TreeHoleApiService = TreeHoleApiService.getInstance();
  private loginService: LoginApiService = LoginApiService.getInstance();
  private userInfoManager: UserInfoManager = UserInfoManager.getInstance();

  aboutToAppear(): void {
    console.info('ğŸŒ³ [TreeHoleDetailNavPage] é¡µé¢åˆå§‹åŒ–');
    this.checkLoginStatus();
    this.startFadeInAnimation();
  }

  @Builder
  buildTitleBar() {
    Row() {
      Button('è¿”å›')
        .fontSize(16)
        .fontColor('#666666')
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          // è®¾ç½®è¿”å›è½¬åœºæ•ˆæœ
          this.transitionEffect = TransitionEffect.IDENTITY;
          this.getUIContext().animateTo({ curve: curves.interpolatingSpring(0, 1, 342, 38) }, () => {
            this.pathStack.pop(false);
          });
        })

      Text('æ ‘æ´è¯¦æƒ…')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      // å ä½
      Row() {
      }
      .width(60)
    }
    .width('100%')
    .height(50)
    .padding({ left: 16, right: 16 })
    .backgroundColor(Color.White)
    .justifyContent(FlexAlign.SpaceBetween)
    .alignItems(VerticalAlign.Center)
  }

  @Builder
  buildTreeHoleDetail() {
    if (this.treeHoleItem) {
      Column() {
        // é¡¶éƒ¨æ—¥æœŸå’Œæ—¶é—´ä¿¡æ¯
        Row() {
          // å¤§å·æ—¥æœŸæ˜¾ç¤º
          Column() {
            Text(this.treeHoleItem.createAt.substring(8, 10))
              .fontSize(32)
              .fontWeight(FontWeight.Bold)
              .fontColor('#45CAD9')
              .lineHeight(36)

            Text(this.treeHoleItem.createAt.substring(0, 7))
              .fontSize(12)
              .fontColor('#999999')
              .margin({ top: 2 })

            Text(this.treeHoleItem.createAt.substring(11, 19))
              .fontSize(12)
              .fontColor('#999999')
              .margin({ top: 2 })
          }
          .alignItems(HorizontalAlign.Center)
          .margin({ right: 20 })

          // é”€æ¯å€’è®¡æ—¶ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
          if (this.treeHoleItem.deleteTime) {
            Column() {
              Text('â° é”€æ¯å€’è®¡æ—¶')
                .fontSize(10)
                .fontColor('#FF6B6B')
              Text(this.formatDeleteTime())
                .fontSize(12)
                .fontColor('#FF6B6B')
                .fontWeight(FontWeight.Medium)
            }
            .alignItems(HorizontalAlign.Center)
          }
        }
        .width('100%')
        .justifyContent(FlexAlign.Start)
        .alignItems(VerticalAlign.Top)
        .margin({ bottom: 16 })

        // å¸–å­å†…å®¹
        Text(this.treeHoleItem.content)
          .fontSize(16)
          .fontColor('#333333')
          .lineHeight(24)
          .width('100%')
          .margin({ bottom: 16 })
          .textAlign(TextAlign.Start)
          .geometryTransition(`content_${this.treeHoleItem.id}`, { follow: true })

        // ä½œè€…ä¿¡æ¯
        Row() {
          Image(this.treeHoleItem.avatar ? `${API_CONFIG.BASE_URL}${this.treeHoleItem.avatar}` :
          $r('app.media.defaultAvatar'))
            .width(32)
            .height(32)
            .borderRadius(16)
            .margin({ right: 12 })
            .geometryTransition(`avatar_${this.treeHoleItem.id}`, { follow: true })

          Column() {
            Text(this.treeHoleItem.anonymous === 1 ?
              (this.treeHoleItem.nickName || `åŒ¿åç”¨æˆ·${this.treeHoleItem.userId}`) :
            this.treeHoleItem.realName)
              .fontSize(14)
              .fontColor('#666666')
              .fontWeight(FontWeight.Medium)
              .geometryTransition(`author_${this.treeHoleItem.id}`, { follow: true })

            Text(this.treeHoleItem.anonymous === 1 ? 'åŒ¿åå‘å¸ƒ' : 'å®åå‘å¸ƒ')
              .fontSize(12)
              .fontColor('#999999')
              .margin({ top: 2 })
          }
          .alignItems(HorizontalAlign.Start)
        }
        .width('100%')
        .justifyContent(FlexAlign.Start)
        .margin({ bottom: 16 })

        // åº•éƒ¨ç»Ÿè®¡å’Œæ“ä½œæ 
        Row() {
          // ç»Ÿè®¡ä¿¡æ¯
          Row() {
            Image($r('app.media.comment'))
              .width(16)
              .height(16)
              .margin({ right: 8 })
            Text(`${this.treeHoleItem.replies}`)
              .fontSize(12)
              .fontColor('#999999')
          }
          .geometryTransition(`comment_${this.treeHoleItem.id}`, { follow: true })

          Blank()

          // ç‚¹èµæ“ä½œ
          Row() {
            Image(this.treeHoleItem.isLike === 1 ? $r('app.media.like_active') : $r('app.media.like'))
              .width(16)
              .height(16)
              .margin({ right: 4 })
              .fillColor(this.treeHoleItem.isLike === 1 ? '#FF6B6B' : '#999999')

            Text(this.treeHoleItem.likes.toString())
              .fontSize(14)
              .fontColor(this.treeHoleItem.isLike === 1 ? '#FF6B6B' : '#666666')
          }
          .padding({
            left: 8,
            right: 8,
            top: 6,
            bottom: 6
          })
          .borderRadius(12)
          .backgroundColor(this.treeHoleItem.isLike === 1 ? '#FFF0F0' : '#F5F5F5')
          .geometryTransition(`like_${this.treeHoleItem.id}`, { follow: true })
          .onClick(() => {
            this.handleLikeClick();
          })
        }
        .width('100%')
        .alignItems(VerticalAlign.Center)
      }
      .width('100%')
      .padding(20)
      .backgroundColor('#FFFFFF')
      .borderRadius(16)
      .margin({ bottom: 16 })
      .shadow({
        radius: 8,
        color: '#1A000000',
        offsetX: 0,
        offsetY: 2
      })
    }
  }

  @Builder
  buildCommentsHeader() {
    Row() {
      Image($r('app.media.comment'))
        .width(16)
        .height(16)
        .margin({ right: 8 })
      Text(`è¯„è®º`)
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')

      Text(`(${this.commentsList.length})`)
        .fontSize(16)
        .fontColor('#999999')
        .margin({ left: 6 })

      Blank()

      // æ’åºæŒ‰é’®
      Text('æŒ‰æ—¶é—´æ’åº')
        .fontSize(12)
        .fontColor('#999999')
    }
    .width('100%')
    .padding({ top: 8, bottom: 16 })
  }

  @Builder
  buildCommentsList() {
    if (this.commentsList.length === 0) {
      Column() {
        Text('æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§~')
          .fontSize(14)
          .fontColor('#999999')
          .textAlign(TextAlign.Center)
      }
      .width('100%')
      .height(80)
      .justifyContent(FlexAlign.Start)
      .alignItems(HorizontalAlign.Center)
      .padding({ top: 20 })
    } else {
      Column() {
        ForEach(this.commentsList, (comment: TreeHoleComment) => {
          this.buildCommentItem(comment)
        }, (comment: TreeHoleComment) => comment.id.toString())
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
    }
  }

  @Builder
  buildCommentItem(comment: TreeHoleComment) {
    Column() {
      Row() {
        Image(comment.avatar ? `${API_CONFIG.BASE_URL}${comment.avatar}` : $r('app.media.defaultAvatar'))
          .width(36)
          .height(36)
          .borderRadius(18)
          .margin({ right: 12 })

        Column() {
          Text(comment.author)
            .fontSize(15)
            .fontColor('#333333')
            .fontWeight(FontWeight.Medium)
            .alignSelf(ItemAlign.Start)

          Text(this.formatCommentTime(comment.createTime))
            .fontSize(11)
            .fontColor('#999999')
            .margin({ top: 3 })
            .alignSelf(ItemAlign.Start)
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        // åŒ¿åæ ‡è¯†
        if (comment.isAnonymous) {
          Text('åŒ¿å')
            .fontSize(10)
            .fontColor('#999999')
            .padding({
              left: 6,
              right: 6,
              top: 2,
              bottom: 2
            })
            .backgroundColor('#F5F5F5')
            .borderRadius(8)
        }
      }
      .width('100%')
      .margin({ bottom: 12 })

      // è¯„è®ºå†…å®¹
      Text(comment.content)
        .fontSize(15)
        .fontColor('#333333')
        .lineHeight(22)
        .width('100%')
        .textAlign(TextAlign.Start)
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('sys.color.comp_background_list_card'))
    .borderRadius(12)
    .borderWidth(1)
    .borderColor('#E8E8E8')
    .margin({ bottom: 12 })
    .shadow({
      radius: 6,
      color: '#0D000000',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder
  buildCommentInput() {
    Column() {
      // å­—æ•°ç»Ÿè®¡æç¤ºï¼ˆæ·»åŠ åŠ¨ç”»æ•ˆæœï¼‰
      Row() {
        Blank()
        Text(`${this.commentText.length}/500`)
          .fontSize(12)
          .fontColor(this.commentText.length > 500 ? '#FF6B6B' : '#999999')
      }
      .width('100%')
      .height(this.commentText.length > 0 ? 32 : 0) // åŠ¨æ€é«˜åº¦
      .opacity(this.commentText.length > 0 ? 1 : 0) // åŠ¨æ€é€æ˜åº¦
      .padding({ 
        left: 16, 
        right: 16, 
        bottom: this.commentText.length > 0 ? 8 : 0 // åŠ¨æ€å†…è¾¹è·
      })
      .animation({
        duration: 300,
        curve: Curve.EaseInOut,
        iterations: 1,
        playMode: PlayMode.Normal
      }) // æ·»åŠ åŠ¨ç”»æ•ˆæœ

      // è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’®
      Row() {
        TextInput({ placeholder: 'å†™ä¸‹ä½ çš„è¯„è®º...', text: this.commentText })
          .layoutWeight(1)
          .height(40)
          .fontSize(14)
          .backgroundColor('#F5F5F5')
          .borderRadius(20)
          .padding({ left: 16, right: 16 })
          .borderWidth(this.commentText.length > 500 ? 1 : 0)
          .borderColor(this.commentText.length > 500 ? '#FF6B6B' : 'transparent')
          .onChange((value: string) => {
            this.commentText = value;
          })
          .onSubmit(() => {
            this.handleSendComment();
          })
          .enabled(!this.isCommenting)

        if (this.commentText.trim().length > 0) {
          if (this.isCommenting) {
            // å‘é€ä¸­çŠ¶æ€
            Row() {
              LoadingProgress()
                .width(16)
                .height(16)
                .color('#007AFF')
                .margin({ right: 4 })
              Text('å‘é€ä¸­...')
                .fontSize(12)
                .fontColor('#007AFF')
            }
            .height(40)
            .padding({ left: 12, right: 12 })
            .borderRadius(20)
            .backgroundColor('#F0F8FF')
            .margin({ left: 12 })
            .transition({
              type: TransitionType.Insert,
              opacity: 1,
              translate: { x: 0, y: 0 }
            })
            .transition({
              type: TransitionType.Delete,
              opacity: 0,
              translate: { x: 20, y: 0 }
            })
          } else {
            // æ­£å¸¸å‘é€æŒ‰é’®
            Button('å‘é€')
              .fontSize(14)
              .fontColor('#FFFFFF')
              .backgroundColor(this.commentText.length > 500 ? '#CCCCCC' : '#007AFF')
              .borderRadius(20)
              .height(40)
              .width(60)
              .margin({ left: 12 })
              .enabled(!this.isCommenting && this.commentText.length <= 500)
              .onClick(() => {
                this.handleSendComment();
              })
              .transition({
                type: TransitionType.Insert,
                opacity: 1,
                translate: { x: 0, y: 0 }
              })
              .transition({
                type: TransitionType.Delete,
                opacity: 0,
                translate: { x: 20, y: 0 }
              })
          }
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 16 })
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    // å®Œå…¨ç§»é™¤é¡¶éƒ¨è¾¹æ¡†ï¼Œä½¿ç”¨é˜´å½±æ›¿ä»£åˆ†éš”æ•ˆæœ
    .shadow({
      radius: 4,
      color: '#10000000',
      offsetX: 0,
      offsetY: -2
    })
    .padding({ top: 16 }) // å¢åŠ é¡¶éƒ¨å†…è¾¹è·
  }

  @Builder
  buildLoadingState() {
    Column() {
      LoadingProgress()
        .width(50)
        .height(50)
        .color('#007AFF')
        .margin({ bottom: 16 })

      Text('åŠ è½½ä¸­...')
        .fontSize(14)
        .fontColor('#999999')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  buildLoginPrompt() {
    Row() {
      Text('ç™»å½•åå¯å‚ä¸è¯„è®ºå’Œç‚¹èµäº’åŠ¨')
        .fontSize(14)
        .fontColor('#999999')

      Blank()

      Button('å»ç™»å½•')
        .fontSize(14)
        .fontColor('#45CAD9')
        .backgroundColor(Color.Transparent)
        .borderWidth(1)
        .borderColor('#45CAD9')
        .borderRadius(16)
        .padding({
          left: 16,
          right: 16,
          top: 6,
          bottom: 6
        })
        .onClick(() => {
          // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è·³è½¬åˆ°ç™»å½•é¡µé¢çš„é€»è¾‘
          console.info('ğŸŒ³ [TreeHoleDetailNavPage] ç”¨æˆ·ç‚¹å‡»å»ç™»å½•');
        })
    }
    .width('100%')
    .padding({
      left: 16,
      right: 16,
      top: 12,
      bottom: 12
    })
    .backgroundColor('#F8F9FA')
  }

  build() {
    NavDestination() {
      Column() {
        // è‡ªå®šä¹‰æ ‡é¢˜æ 
        this.buildTitleBar()

        if (this.treeHoleItem) {
          // ä¸»å†…å®¹åŒºåŸŸ
          Scroll() {
            Column() {
              // æ ‘æ´è¯¦æƒ…
              this.buildTreeHoleDetail()

              // è¯„è®ºæ ‡é¢˜
              this.buildCommentsHeader()

              // è¯„è®ºåˆ—è¡¨
              this.buildCommentsList()
            }
            .layoutWeight(1)
            .width('100%')
            .padding(16)
            .justifyContent(FlexAlign.Start)
            .alignItems(HorizontalAlign.Start)
          }
          .scrollBar(BarState.Off)
          .layoutWeight(1)
          .align(Alignment.TopStart)

          // è¯„è®ºè¾“å…¥æ¡†ï¼ˆä»…ç™»å½•ç”¨æˆ·æ˜¾ç¤ºï¼‰
          if (this.isLoggedIn) {
            this.buildCommentInput()
          } else {
            this.buildLoginPrompt()
          }
        } else if (this.isLoading) {
          // åŠ è½½çŠ¶æ€
          this.buildLoadingState()
        } else {
          // ç©ºçŠ¶æ€
          Column() {
            Text('æœªæ‰¾åˆ°æ ‘æ´ä¿¡æ¯')
              .fontSize(16)
              .fontColor('#999999')
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#FAFAFA')
      .justifyContent(FlexAlign.Start)
      .alignItems(HorizontalAlign.Start)
      .opacity(this.pageOpacity)
      .translate({ x: 0, y: this.pageTranslateY })
      .animation({
        duration: 700,
        curve: Curve.EaseInOut,
        iterations: 1,
        playMode: PlayMode.Normal
      })
    }
    .title('æ ‘æ´è¯¦æƒ…')
    .hideTitleBar(true)
    .transition(this.transitionEffect)
    .onReady((ctx: NavDestinationContext) => {
      this.pathStack = ctx.pathStack;

      // æ¥æ”¶é¡µé¢å‚æ•°
      const params = ctx.pathInfo.param as TreeHoleItem;
      if (params) {
        console.info('ğŸŒ³ [TreeHoleDetailNavPage] æ¥æ”¶åˆ°å‚æ•°:', JSON.stringify(params));
        this.treeHoleItem = params;
        this.treeHoleId = params.id;
        this.loadComments();
      } else {
        console.error('ğŸŒ³ [TreeHoleDetailNavPage] æœªæ¥æ”¶åˆ°æ ‘æ´æ•°æ®');
      }

      console.info('ğŸŒ³ [TreeHoleDetailNavPage] é¡µé¢å°±ç»ª');
    })
    .onBackPressed(() => {
      // è®¾ç½®è¿”å›è½¬åœºæ•ˆæœ
      this.transitionEffect = TransitionEffect.IDENTITY;
      this.getUIContext().animateTo({ curve: curves.interpolatingSpring(0, 1, 342, 38) }, () => {
        this.pathStack.pop(false);
      });
      return true;
    })
  }

  /**
   * è®¾ç½®æ ‘æ´æ•°æ®
   */
  public setTreeHoleItem(item: TreeHoleItem): void {
    this.treeHoleItem = item;
    this.treeHoleId = item.id;
    console.info(`ğŸŒ³ [TreeHoleDetailNavPage] è®¾ç½®æ ‘æ´æ•°æ®ï¼ŒID: ${item.id}`);
  }

  /**
   * æ£€æŸ¥ç™»å½•çŠ¶æ€
   */
  private checkLoginStatus(): void {
    // æ£€æŸ¥tokenå’Œç”¨æˆ·ä¿¡æ¯ï¼ˆä¸å‘å¸ƒæ ‘æ´é¡µé¢ä¿æŒä¸€è‡´ï¼‰
    const hasToken = this.loginService.isLoggedIn();
    const currentUser = this.userInfoManager.getCurrentUserInfo(this.getUIContext().getHostContext());
    const hasValidUserInfo = currentUser !== null && currentUser.userId > 0;
    
    this.isLoggedIn = hasToken && hasValidUserInfo;
    
    console.info(`ğŸŒ³ [TreeHoleDetailNavPage] ç™»å½•çŠ¶æ€æ£€æŸ¥ - Token: ${hasToken}, UserInfo: ${hasValidUserInfo}, UserId: ${currentUser?.userId}, æœ€ç»ˆç»“æœ: ${this.isLoggedIn}`);
    
    // å¦‚æœæœ‰tokenä½†æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œå°è¯•å¼‚æ­¥è·å–
    if (hasToken && !hasValidUserInfo) {
      console.info('ğŸŒ³ [TreeHoleDetailNavPage] æœ‰tokenä½†ç¼ºå°‘ç”¨æˆ·ä¿¡æ¯ï¼Œå°è¯•å¼‚æ­¥è·å–');
      this.tryLoadUserInfo();
    }
  }

  /**
   * å°è¯•å¼‚æ­¥åŠ è½½ç”¨æˆ·ä¿¡æ¯
   */
  private async tryLoadUserInfo(): Promise<void> {
    try {
      const userInfoResponse = await this.userInfoManager.checkLoginStatus(this.getUIContext().getHostContext());
      if (userInfoResponse) {
        const currentUser = this.userInfoManager.getCurrentUserInfo(this.getUIContext().getHostContext());
        const hasValidUserInfo = currentUser !== null && currentUser.userId > 0;
        this.isLoggedIn = this.loginService.isLoggedIn() && hasValidUserInfo;
        console.info('ğŸŒ³ [TreeHoleDetailNavPage] ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸï¼Œæ›´æ–°ç™»å½•çŠ¶æ€:', this.isLoggedIn);
      }
    } catch (error) {
      console.warn('ğŸŒ³ [TreeHoleDetailNavPage] ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥:', error);
      this.isLoggedIn = false;
    }
  }

  // ===== äº‹ä»¶å¤„ç†æ–¹æ³• =====

  /**
   * å¯åŠ¨æ¸æ˜¾åŠ¨ç”»
   */
  private startFadeInAnimation(): void {
    setTimeout(() => {
      this.pageOpacity = 1;
      this.pageTranslateY = 0;
      console.info('[TreeHoleDetailNavPage] ğŸ¬ å¯åŠ¨æ¸æ˜¾åŠ¨ç”»');
    }, 100);
  }

  /**
   * åŠ è½½è¯„è®ºæ•°æ®
   */
  private async loadComments(): Promise<void> {
    try {
      this.isLoading = true;
      console.info(`ğŸŒ³ [TreeHoleDetailNavPage] å¼€å§‹åŠ è½½æ ‘æ´ ${this.treeHoleId} çš„è¯„è®º`);

      const commentsData = await this.treeHoleApiService.getTreeHoleComments(this.treeHoleId, 1, 50);
      this.commentsList = commentsData.list;

      console.info(`ğŸŒ³ [TreeHoleDetailNavPage] åŠ è½½äº† ${commentsData.list.length} æ¡è¯„è®º`);
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleDetailNavPage] åŠ è½½è¯„è®ºå¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * å‘é€è¯„è®º
   */
  private async handleSendComment(): Promise<void> {
    // 1. éªŒè¯è¾“å…¥å†…å®¹
    if (this.commentText.trim().length === 0) {
      this.showToast('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
      return;
    }

    if (this.commentText.trim().length > 500) {
      this.showToast('è¯„è®ºå†…å®¹ä¸èƒ½è¶…è¿‡500ä¸ªå­—ç¬¦');
      return;
    }

    // 2. æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆä¸å‘å¸ƒæ ‘æ´é¡µé¢ä¸€è‡´ï¼‰
    if (!this.isLoggedIn) {
      this.showLoginRequiredDialog();
      return;
    }

    // 3. è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸å‘å¸ƒæ ‘æ´é¡µé¢ä¸€è‡´çš„æ–¹å¼ï¼‰
    const currentUser = this.userInfoManager.getCurrentUserInfo(this.getUIContext().getHostContext());
    if (!currentUser || !currentUser.userId) {
      this.showToast('ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
      this.isLoggedIn = false; // æ›´æ–°ç™»å½•çŠ¶æ€
      return;
    }

    try {
      // 4. è®¾ç½®loadingçŠ¶æ€
      this.isCommenting = true;
      console.info('ğŸŒ³ [TreeHoleDetailNavPage] å¼€å§‹å‘é€è¯„è®º');

      // 5. æ„é€ APIè¯·æ±‚å‚æ•°ï¼ˆä¸å‘å¸ƒæ ‘æ´å®Œå…¨ä¸€è‡´çš„æ ¼å¼ï¼‰
      const request: PostTreeHoleRequest = {
        content: this.commentText.trim(),
        anonymous: 0, // è¯„è®ºæš‚ä¸æ”¯æŒåŒ¿åï¼Œå›ºå®šä¸º0
        parentId: this.treeHoleId, // è¯„è®ºæ—¶parentIdä¸ºæ ‘æ´ID
        userId: currentUser.userId, // ä½¿ç”¨çœŸå®çš„ç”¨æˆ·ID
        deleteTime: "" // è¯„è®ºä¸è®¾ç½®åˆ é™¤æ—¶é—´
      };

      console.info('ğŸŒ³ [TreeHoleDetailNavPage] å¼€å§‹å‘å¸ƒè¯„è®ºï¼Œè¯·æ±‚å‚æ•°:', JSON.stringify(request));

      // 6. è°ƒç”¨APIå‘å¸ƒè¯„è®º
      const result = await this.treeHoleApiService.postCommentWithFullRequest(request);

      // 7. å¤„ç†å“åº”ç»“æœ
      if (result.code === 200) {
        console.info('ğŸŒ³ [TreeHoleDetailNavPage] è¯„è®ºå‘å¸ƒæˆåŠŸ');
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        this.commentText = '';
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        this.showToast('è¯„è®ºå‘å¸ƒæˆåŠŸ');
        
        // 8. åˆ·æ–°è¯„è®ºåˆ—è¡¨
        await this.loadComments();
      } else {
        console.error('ğŸŒ³ [TreeHoleDetailNavPage] è¯„è®ºå‘å¸ƒå¤±è´¥:', result.msg);
        this.showToast(result.msg || 'è¯„è®ºå‘å¸ƒå¤±è´¥');
      }
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleDetailNavPage] å‘é€è¯„è®ºå¤±è´¥:', error);
      
      // å‹å¥½çš„é”™è¯¯æç¤º
      if (error instanceof Error) {
        if (error.message.includes('ç”¨æˆ·æœªç™»å½•')) {
          this.showToast('ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
          this.isLoggedIn = false; // æ›´æ–°ç™»å½•çŠ¶æ€
        } else if (error.message.includes('ç½‘ç»œ')) {
          this.showToast('ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
        } else {
          this.showToast('è¯„è®ºå‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
      } else {
        this.showToast('è¯„è®ºå‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }
    } finally {
      // 9. é‡ç½®loadingçŠ¶æ€
      this.isCommenting = false;
    }
  }

  /**
   * å¤„ç†è¯„è®ºç‚¹èµ
   */
  private async handleCommentLike(comment: TreeHoleComment): Promise<void> {
    try {
      console.info(`ğŸŒ³ [TreeHoleDetailNavPage] ç‚¹èµè¯„è®º ${comment.id}`);

      const newIsLiked = !(comment.isLiked ?? false);
      const result = await this.treeHoleApiService.toggleCommentLike(comment.id, newIsLiked);

      if (result.code === 200) {
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        const index = this.commentsList.findIndex(c => c.id === comment.id);
        if (index >= 0) {
          this.commentsList[index].isLiked = newIsLiked;
          this.commentsList[index].likeCount += newIsLiked ? 1 : -1;
        }
      }
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleDetailNavPage] è¯„è®ºç‚¹èµå¤±è´¥:', error);
    }
  }

  /**
   * å¤„ç†è¯„è®ºç‚¹è¸©
   */
  private async handleCommentDislike(comment: TreeHoleComment): Promise<void> {
    try {
      console.info(`ğŸŒ³ [TreeHoleDetailNavPage] ç‚¹è¸©è¯„è®º ${comment.id}`);

      const newIsDisliked = !(comment.isDisliked ?? false);
      const result = await this.treeHoleApiService.toggleCommentDislike(comment.id, newIsDisliked);

      if (result.code === 200) {
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        const index = this.commentsList.findIndex(c => c.id === comment.id);
        if (index >= 0) {
          this.commentsList[index].isDisliked = newIsDisliked;
          this.commentsList[index].dislikeCount += newIsDisliked ? 1 : -1;
        }
      }
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleDetailNavPage] è¯„è®ºç‚¹è¸©å¤±è´¥:', error);
    }
  }

  /**
   * æ ¼å¼åŒ–è¯„è®ºæ—¶é—´
   */
  private formatCommentTime(timeStr: string): string {
    try {
      const commentTime = new Date(timeStr).getTime();
      const currentTime = new Date().getTime();
      const timeDiff = currentTime - commentTime;

      const minutes = Math.floor(timeDiff / (1000 * 60));
      const hours = Math.floor(timeDiff / (1000 * 60 * 60));
      const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));

      if (minutes < 1) {
        return 'åˆšåˆš';
      } else if (minutes < 60) {
        return `${minutes}åˆ†é’Ÿå‰`;
      } else if (hours < 24) {
        return `${hours}å°æ—¶å‰`;
      } else if (days < 7) {
        return `${days}å¤©å‰`;
      } else {
        return timeStr.substring(5, 16); // æ˜¾ç¤ºæœˆ-æ—¥ æ—¶:åˆ†
      }
    } catch (error) {
      return timeStr;
    }
  }

  /**
   * æ ¼å¼åŒ–é”€æ¯æ—¶é—´
   */
  private formatDeleteTime(): string {
    if (!this.treeHoleItem?.deleteTime) {
      return '';
    }

    try {
      const deleteTime = new Date(this.treeHoleItem.deleteTime).getTime();
      const currentTime = new Date().getTime();
      const timeDiff = deleteTime - currentTime;

      if (timeDiff <= 0) {
        return 'å·²é”€æ¯';
      }

      const hours = Math.floor(timeDiff / (1000 * 60 * 60));
      const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));

      if (hours > 0) {
        return `${hours}å°æ—¶${minutes}åˆ†é’Ÿåé”€æ¯`;
      } else {
        return `${minutes}åˆ†é’Ÿåé”€æ¯`;
      }
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleDetailNavPage] æ ¼å¼åŒ–é”€æ¯æ—¶é—´å¤±è´¥:', error);
      return 'æ—¶é—´é”™è¯¯';
    }
  }

  /**
   * å¤„ç†å¸–å­ç‚¹èµç‚¹å‡»
   */
  private handleLikeClick(): void {
    if (!this.isLoggedIn) {
      this.showLoginRequiredDialog();
      return;
    }

    // å®ç°ç‚¹èµé€»è¾‘
    console.info('ğŸŒ³ [TreeHoleDetailNavPage] å¤„ç†å¸–å­ç‚¹èµ');
    // TODO: è°ƒç”¨APIæ¥å£
  }

  /**
   * æ˜¾ç¤ºToastæç¤º
   */
  private showToast(message: string): void {
    this.getUIContext().showAlertDialog({
      message: message,
      alignment: DialogAlignment.Center,
      autoCancel: true,
      primaryButton: {
        value: 'ç¡®å®š',
        action: () => {
          console.info('ğŸŒ³ [TreeHoleDetailNavPage] Toastç¡®è®¤');
        }
      }
    });
  }

  /**
   * æ˜¾ç¤ºéœ€è¦ç™»å½•çš„å¯¹è¯æ¡†
   */
  private showLoginRequiredDialog(): void {
    this.getUIContext().showAlertDialog({
      title: 'éœ€è¦ç™»å½•',
      message: 'ç‚¹èµå’Œè¯„è®ºåŠŸèƒ½éœ€è¦ç™»å½•åæ‰èƒ½ä½¿ç”¨',
      alignment: DialogAlignment.Center,
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {
          console.info('ğŸŒ³ [TreeHoleDetailNavPage] ç”¨æˆ·å–æ¶ˆç™»å½•');
        }
      },
      secondaryButton: {
        value: 'å»ç™»å½•',
        fontColor: '#45CAD9',
        action: () => {
          console.info('ğŸŒ³ [TreeHoleDetailNavPage] ç”¨æˆ·é€‰æ‹©å»ç™»å½•');
          // TODO: è·³è½¬åˆ°ç™»å½•é¡µé¢æˆ–åˆ‡æ¢åˆ°ç™»å½•Tab
        }
      }
    });
  }
}