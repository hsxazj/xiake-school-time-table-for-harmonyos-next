import { AppConfigManager } from '../services/AppConfigManager';
import { UserInfoManager } from '../common/utils/UserInfoManager';
import { CacheManager } from '../common/utils/CacheManager';
import { CourseApiService } from '../services/api/CourseApiService';
import { hilog } from '@kit.PerformanceAnalysisKit';

const DOMAIN: number = 0x0003;
const TAG: string = 'OpenPage';


@Entry
@Component
struct OpenPage {
  @Provide('NavStack') pathStack: NavPathStack = new NavPathStack();
  @State message: string = 'æ¬¢è¿ä½¿ç”¨éœå®¢è¯¾è¡¨';
  @State initMessage: string = 'æ­£åœ¨åŠ è½½...';
  private appConfigManager: AppConfigManager = AppConfigManager.getInstance();
  private userInfoManager: UserInfoManager = UserInfoManager.getInstance();

  aboutToAppear(): void {
    this.waitForInitAndNavigate();
  }

  build() {
    Navigation(this.pathStack) {
      RelativeContainer() {
        Column() {
          Image($r('app.media.startIcon'))
            .width(80)
            .height(80)
            .margin({ bottom: 20 })

          Text(this.message)
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#179FA2')
            .textAlign(TextAlign.Center)

          Text(this.initMessage)
            .fontSize(14)
            .fontColor('#999999')
            .margin({ top: 20 })
            .textAlign(TextAlign.Center)

          LoadingProgress()
            .width(30)
            .height(30)
            .color($r('app.color.schedule_primary_color'))
            .margin({ top: 20 })
        }
        .alignRules({
          center: { anchor: '__container__', align: VerticalAlign.Center },
          middle: { anchor: '__container__', align: HorizontalAlign.Center }
        })
      }
      .height('100%')
      .width('100%')
      .backgroundColor('#F8F8F8')
    }
    .mode(NavigationMode.Stack)
    .hideTitleBar(true)
    .hideToolBar(true)
  }

  /**
   * ç­‰å¾…åˆå§‹åŒ–å®Œæˆåè·³è½¬åˆ°ä¸»é¡µé¢
   */
  private async waitForInitAndNavigate(): Promise<void> {
    try {
      // ç­‰å¾…AppConfigManageråˆå§‹åŒ–å®Œæˆ
      const initResult = await this.appConfigManager.initialize();

      // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†ç¼“å­˜
      if (initResult.usedCache) {
        this.initMessage = 'æœåŠ¡å™¨å¯èƒ½å¼‚å¸¸ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®';

        // æ˜¾ç¤º toast æç¤º
        this.getUIContext().getPromptAction().showToast({
          message: 'æ•°æ®å¯èƒ½å»¶æ—¶æ˜¾ç¤º',
          duration: 3000,
          bottom: '150vp'
        });
      } else {
        this.initMessage = 'åŠ è½½å®Œæˆï¼';
      }

      // æ£€æŸ¥æ˜¯å¦å·²è®¾ç½®å®Œæ•´çš„å­¦ç±ä¿¡æ¯
      const hasCompleteInfo = this.userInfoManager.hasCompleteUserInfo(this.getUIContext().getHostContext());

      // å¯åŠ¨é™é»˜é¢„åŠ è½½è¯¾è¡¨ (å½“å‘¨Â±1å‘¨)
      if (hasCompleteInfo) {
        this.preloadScheduleCache();
      }

      // çŸ­æš‚å»¶è¿Ÿåè·³è½¬
      setTimeout(() => {
        if (hasCompleteInfo) {
          // å·²æœ‰å®Œæ•´ä¿¡æ¯ï¼Œç›´æ¥è·³è½¬åˆ°ä¸»é¡µTabé¡µé¢
          this.pathStack.replacePathByName('MainTabNavPage', null);
        } else {
          // æ²¡æœ‰å®Œæ•´ä¿¡æ¯ï¼Œè·³è½¬åˆ°å­¦é™¢é€‰æ‹©é¡µé¢
          this.pathStack.replacePathByName('ClassSelectNavPage', null);
        }
      }, 500);

    } catch (error) {
      console.error('Indexé¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
      this.initMessage = 'åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•';
      // å³ä½¿åˆå§‹åŒ–å¤±è´¥ä¹Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·èƒ½æ­£å¸¸ä½¿ç”¨
      setTimeout(() => {
        this.pathStack.replacePathByName('ClassSelectNavPage', null);
      }, 2000);
    }
  }

  /**
   * é™é»˜é¢„åŠ è½½è¯¾è¡¨ç¼“å­˜ (å½“å‘¨Â±1å‘¨)
   */
  private preloadScheduleCache(): void {
    try {
      const currentStatus = this.appConfigManager.getCurrentStatus();
      if (!currentStatus || !currentStatus.currentSemester) {
        hilog.warn(DOMAIN, TAG, 'âš ï¸ æ— æ³•è·å–å½“å‰å­¦æœŸä¿¡æ¯,è·³è¿‡é¢„åŠ è½½');
        return;
      }

      const context = this.getUIContext().getHostContext();
      const userInfo = this.userInfoManager.getUserInfo(context);
      if (!userInfo || !userInfo.classId) {
        hilog.warn(DOMAIN, TAG, 'âš ï¸ æ— æ³•è·å–ç”¨æˆ·ç­çº§ä¿¡æ¯,è·³è¿‡é¢„åŠ è½½');
        return;
      }

      const year = currentStatus.currentSemester.academicYear;
      const term = currentStatus.currentSemester.semester === 1 ? '3' : '12';
      const currentWeek = currentStatus.currentWeek;
      const classId = userInfo.classId;

      hilog.info(DOMAIN, TAG, `ğŸš€ å¼€å§‹é¢„åŠ è½½: ${year}å­¦å¹´ å­¦æœŸ${term} ç¬¬${currentWeek}å‘¨ Â±1å‘¨`);

      // é™é»˜é¢„åŠ è½½ (ä¸é˜»å¡UI,ä¸await)
      CacheManager.preloadSchedules(year, term, currentWeek, async (y: string, t: string, w: number) => {
        const courseApiService = CourseApiService.getInstance();
        const params = courseApiService.buildCourseParams(y, parseInt(t) === 3 ? 1 : 2, w, classId);
        const response = await courseApiService.getCourseList(params);
        return response.data;
      }).catch((err: Error) => {
        hilog.warn(DOMAIN, TAG, `âš ï¸ é¢„åŠ è½½å¤±è´¥: ${err.message}`);
      });
    } catch (error) {
      hilog.error(DOMAIN, TAG, `âŒ é¢„åŠ è½½å¼‚å¸¸: ${JSON.stringify(error)}`);
      // é™é»˜å¤„ç†,ä¸å½±å“ä¸»æµç¨‹
    }
  }
}