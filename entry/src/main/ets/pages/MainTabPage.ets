import {
  ConfigApiService,
  SemesterInfo,
  CurrentSemesterStatus,
  ConfigApiResponse
} from '../services/api/ConfigApiService';
import { ApiResponse } from '../models/CollegeModels';

// å®šä¹‰æ¥å£
interface UserInfo {
  avatar: string;
  username: string;
  studentId: string;
  college: string;
  major: string;
  className: string;
}

interface MenuItemType {
  icon: string;
  title: string;
  desc: string;
}

interface WeekDateRange {
  startDate: Date;
  endDate: Date;
}

@Entry
@Component
struct MainTabPage {
  @State currentTabIndex: number = 0;

  @Builder
  TabBuilder(title: string, targetIndex: number) {
    Column() {
      Text(this.getTabIcon(targetIndex))
        .fontSize(22)
        .fontColor(this.currentTabIndex === targetIndex ? '#45CAD9' : '#999999')
        .margin({ bottom: 4 })
      Text(title)
        .fontColor(this.currentTabIndex === targetIndex ? '#45CAD9' : '#999999')
        .fontSize(12)
        .fontWeight(this.currentTabIndex === targetIndex ? FontWeight.Medium : FontWeight.Normal)
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  private getTabIcon(index: number): string {
    const icons = ['ğŸ ', 'ğŸ“…', 'ğŸ‘¤'];
    return icons[index] || '';
  }

  build() {
    Tabs({ barPosition: BarPosition.End, controller: new TabsController() }) {
      TabContent() {
        HomePage()
      }
      .tabBar(this.TabBuilder('é¦–é¡µ', 0))

      TabContent() {
        SchedulePage()
      }
      .tabBar(this.TabBuilder('è¯¾è¡¨', 1))

      TabContent() {
        MinePage()
      }
      .tabBar(this.TabBuilder('æˆ‘çš„', 2))
    }
    .width('100%')
    .height('100%')
    .barBackgroundColor('#FFFFFF')
    .barMode(BarMode.Fixed)
    .vertical(false)
    .scrollable(false)
    .onChange((index: number) => {
      this.currentTabIndex = index;
    })
  }
}

@Component
struct HomePage {
  @State private username: string = '';
  @State private collegeName: string = '';

  aboutToAppear(): void {
    // è¿™é‡Œå¯ä»¥åŠ è½½ç”¨æˆ·ä¿¡æ¯
    this.username = 'åŒå­¦';
    this.collegeName = 'è®¡ç®—æœºå­¦é™¢';
  }

  build() {
    Column() {
      // é¡¶éƒ¨é—®å€™è¯­
      Row() {
        Column() {
          Text(`ä½ å¥½ï¼Œ${this.username}`)
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .margin({ bottom: 4 })
          Text(`${this.collegeName}`)
            .fontSize(14)
            .fontColor('#666666')
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        // æ¶ˆæ¯å›¾æ ‡
        Text('ğŸ””')
          .fontSize(24)
          .onClick(() => {
            // æ¶ˆæ¯ç‚¹å‡»äº‹ä»¶
          })
      }
      .width('100%')
      .padding({
        left: 20,
        right: 20,
        top: 50,
        bottom: 20
      })

      // åŠŸèƒ½åŒºåŸŸ
      Column() {
        // ä»Šæ—¥è¯¾ç¨‹å¡ç‰‡
        Column() {
          Row() {
            Text('ä»Šæ—¥è¯¾ç¨‹')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
            Blank()
            Text('æŸ¥çœ‹æ›´å¤š >')
              .fontSize(14)
              .fontColor('#45CAD9')
              .onClick(() => {
                // è·³è½¬åˆ°è¯¾è¡¨é¡µ
              })
          }
          .width('100%')
          .margin({ bottom: 15 })

          // è¯¾ç¨‹åˆ—è¡¨
          Column() {
            Text('æš‚æ— ä»Šæ—¥è¯¾ç¨‹')
              .fontSize(16)
              .fontColor('#999999')
              .margin({ top: 20, bottom: 20 })
          }
          .width('100%')
          .height(100)
          .justifyContent(FlexAlign.Center)
        }
        .width('100%')
        .padding(20)
        .backgroundColor(Color.White)
        .borderRadius(12)
        .shadow({
          radius: 8,
          color: 'rgba(0, 0, 0, 0.1)',
          offsetY: 2
        })
        .margin({ bottom: 20 })

        // å¿«æ·åŠŸèƒ½
        Column() {
          Text('å¿«æ·åŠŸèƒ½')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
            .width('100%')
            .margin({ bottom: 15 })

          Grid() {
            GridItem() {
              this.FunctionCard('ğŸ“…', 'æˆ‘çš„è¯¾è¡¨', '#E3F2FD')
            }

            GridItem() {
              this.FunctionCard('â­', 'è¯¾ç¨‹è¯„ä»·', '#F3E5F5')
            }

            GridItem() {
              this.FunctionCard('ğŸ“¢', 'ç³»ç»Ÿé€šçŸ¥', '#E8F5E8')
            }

            GridItem() {
              this.FunctionCard('â“', 'é—®é¢˜åé¦ˆ', '#FFF3E0')
            }
          }
          .rowsTemplate('1fr 1fr')
          .columnsTemplate('1fr 1fr')
          .rowsGap(15)
          .columnsGap(15)
          .height(200)
        }
        .width('100%')
        .padding(20)
        .backgroundColor(Color.White)
        .borderRadius(12)
        .shadow({
          radius: 8,
          color: 'rgba(0, 0, 0, 0.1)',
          offsetY: 2
        })
      }
      .width('90%')
      .layoutWeight(1)

      Blank()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  FunctionCard(icon: string, title: string, bgColor: string) {
    Column() {
      Text(icon)
        .fontSize(32)
        .margin({ bottom: 8 })
      Text(title)
        .fontSize(14)
        .fontColor('#333333')
    }
    .width('100%')
    .height('100%')
    .backgroundColor(bgColor)
    .borderRadius(8)
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      // å¤„ç†ç‚¹å‡»äº‹ä»¶
    })
  }
}

@Component
struct SchedulePage {
  @State private currentWeek: number = 1;
  @State private totalWeeks: number = 20;
  @State private currentMonth: string = '';
  @State private weekDates: WeekDateRange | null = null;
  @State private showWeekPicker: boolean = false;
  // æ–°å¢å­¦æœŸç®¡ç†ç›¸å…³çŠ¶æ€
  @State private currentStatus: CurrentSemesterStatus | null = null;
  @State private currentSemester: SemesterInfo | null = null;
  @State private semesterList: SemesterInfo[] = [];
  @State private displayStatusText: string = "ç¬¬1å‘¨";
  private swiper: SwiperController = new SwiperController();
  private configService: ConfigApiService = ConfigApiService.getInstance();
  private weekDays: string[] = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
  private timeSlots: string[] = ['8:00', '9:00', '10:00', '11:00', '14:00', '15:00', '16:00', '17:00'];
  // TODO æ¨¡æ‹Ÿå¤šå‘¨è¯¾ç¨‹æ•°æ®
  private allWeeksData: Record<number, Record<number, Record<number, CourseInfo | null>>> = {
    1: {
      // ç¬¬1å‘¨
      1: {
        // å‘¨ä¸€
        1: {
          name: 'é«˜ç­‰æ•°å­¦',
          location: 'æ•™å­¦æ¥¼A101',
          teacher: 'å¼ æ•™æˆ',
          color: '#E8F5E8'
        },
        2: {
          name: 'çº¿æ€§ä»£æ•°',
          location: 'æ•™å­¦æ¥¼A102',
          teacher: 'ææ•™æˆ',
          color: '#E3F2FD'
        },
        4: {
          name: 'æ•°æ®ç»“æ„',
          location: 'å®éªŒæ¥¼B201',
          teacher: 'ç‹æ•™æˆ',
          color: '#FFF3E0'
        }
      },
      2: {
        // å‘¨äºŒ
        0: {
          name: 'è‹±è¯­',
          location: 'å¤–è¯­æ¥¼C301',
          teacher: 'é™ˆæ•™æˆ',
          color: '#F3E5F5'
        },
        3: {
          name: 'è®¡ç®—æœºç½‘ç»œ',
          location: 'æ•™å­¦æ¥¼A205',
          teacher: 'åˆ˜æ•™æˆ',
          color: '#FFEBEE'
        }
      },
      3: {
        // å‘¨ä¸‰
        1: {
          name: 'æ“ä½œç³»ç»Ÿ',
          location: 'æ•™å­¦æ¥¼A301',
          teacher: 'èµµæ•™æˆ',
          color: '#F0F4C3'
        },
        5: {
          name: 'è½¯ä»¶å·¥ç¨‹',
          location: 'æ•™å­¦æ¥¼B105',
          teacher: 'å­™æ•™æˆ',
          color: '#FCE4EC'
        }
      },
      4: {
        // å‘¨å››
        2: {
          name: 'æ•°æ®åº“åŸç†',
          location: 'å®éªŒæ¥¼B301',
          teacher: 'é’±æ•™æˆ',
          color: '#E0F2F1'
        }
      },
      5: {
        // å‘¨äº”
        0: {
          name: 'ä½“è‚²',
          location: 'ä½“è‚²é¦†',
          teacher: 'å‘¨æ•™ç»ƒ',
          color: '#FFF8E1'
        },
        6: {
          name: 'é©¬å…‹æ€ä¸»ä¹‰åŸç†',
          location: 'æ•™å­¦æ¥¼C201',
          teacher: 'å´æ•™æˆ',
          color: '#F1F8E9'
        }
      },
      6: {}, // å‘¨å…­
      7: {}  // å‘¨æ—¥
    },
    2: {
      // ç¬¬2å‘¨ - ä¸åŒçš„è¯¾ç¨‹å®‰æ’
      1: {
        0: {
          name: 'é«˜ç­‰æ•°å­¦',
          location: 'æ•™å­¦æ¥¼A101',
          teacher: 'å¼ æ•™æˆ',
          color: '#E8F5E8'
        },
        3: {
          name: 'ç®—æ³•è®¾è®¡',
          location: 'å®éªŒæ¥¼B202',
          teacher: 'ææ•™æˆ',
          color: '#FFECB3'
        }
      },
      2: {
        1: {
          name: 'è‹±è¯­',
          location: 'å¤–è¯­æ¥¼C301',
          teacher: 'é™ˆæ•™æˆ',
          color: '#F3E5F5'
        },
        4: {
          name: 'è®¡ç®—æœºç»„æˆåŸç†',
          location: 'æ•™å­¦æ¥¼A206',
          teacher: 'èµµæ•™æˆ',
          color: '#E8EAF6'
        }
      },
      3: {
        2: {
          name: 'æ“ä½œç³»ç»Ÿ',
          location: 'æ•™å­¦æ¥¼A301',
          teacher: 'èµµæ•™æˆ',
          color: '#F0F4C3'
        }
      },
      4: {
        1: {
          name: 'æ•°æ®åº“åŸç†',
          location: 'å®éªŒæ¥¼B301',
          teacher: 'é’±æ•™æˆ',
          color: '#E0F2F1'
        },
        5: {
          name: 'ç¼–è¯‘åŸç†',
          location: 'æ•™å­¦æ¥¼A401',
          teacher: 'å­™æ•™æˆ',
          color: '#FCE4EC'
        }
      },
      5: {
        0: {
          name: 'ä½“è‚²',
          location: 'ä½“è‚²é¦†',
          teacher: 'å‘¨æ•™ç»ƒ',
          color: '#FFF8E1'
        }
      },
      6: {},
      7: {}
    }
  };

  aboutToAppear(): void {
    // å…ˆåˆå§‹åŒ–é»˜è®¤é…ç½®ï¼Œç¡®ä¿æœ‰åŸºç¡€æ•°æ®
    this.initDefaultConfig();
    // æ£€æŸ¥é…ç½®æœåŠ¡æ˜¯å¦å·²æœ‰æ•°æ®ï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥ä½¿ç”¨ï¼Œå¦åˆ™é‡æ–°åŠ è½½
    this.initializeFromExistingConfig();
  }

  /**
   * ä»ç°æœ‰é…ç½®åˆå§‹åŒ– (å¦‚æœåº”ç”¨å¯åŠ¨æ—¶å·²é¢„åŠ è½½)
   */
  private async initializeFromExistingConfig(): Promise<void> {
    try {
      const semesterList = this.configService.getSemesterList();
      if (semesterList && semesterList.length > 0) {
        // ä½¿ç”¨å·²å­˜åœ¨çš„é…ç½®æ•°æ®
        console.info('ğŸ“‹ [Schedule] ä½¿ç”¨é¢„åŠ è½½çš„é…ç½®æ•°æ®');
        this.processExistingConfig();
      } else {
        // æ²¡æœ‰é¢„åŠ è½½æ•°æ®ï¼Œé‡æ–°è·å–
        console.info('ğŸ“‹ [Schedule] é¢„åŠ è½½æ•°æ®ä¸å­˜åœ¨ï¼Œé‡æ–°è·å–é…ç½®');
        await this.loadConfig();
      }
    } catch (error) {
      console.error('ğŸ“‹ [Schedule] é…ç½®åˆå§‹åŒ–å¤±è´¥:', error);
      await this.loadConfig(); // é™çº§å¤„ç†
    }
  }

  /**
   * å¤„ç†ç°æœ‰é…ç½®æ•°æ®
   */
  private processExistingConfig(): void {
    // è·å–å­¦æœŸåˆ—è¡¨
    const tempSemesterList = this.configService.getSemesterList();
    this.semesterList = [];
    tempSemesterList.forEach((semester) => {
      this.semesterList.push({
        year: semester.year,
        semester: semester.semester,
        startDate: semester.startDate,
        endDate: semester.endDate,
        totalWeeks: semester.totalWeeks
      });
    });

    // è®¡ç®—å½“å‰å­¦æœŸçŠ¶æ€
    const tempStatus = this.configService.calculateCurrentSemesterStatus();
    const newCurrentStatus: CurrentSemesterStatus = {
      isInSemester: tempStatus.isInSemester,
      isInHoliday: tempStatus.isInHoliday,
      currentWeek: tempStatus.currentWeek,
      statusText: tempStatus.statusText
    };
    if (tempStatus.currentSemester) {
      newCurrentStatus.currentSemester = {
        year: tempStatus.currentSemester.year,
        semester: tempStatus.currentSemester.semester,
        startDate: tempStatus.currentSemester.startDate,
        endDate: tempStatus.currentSemester.endDate,
        totalWeeks: tempStatus.currentSemester.totalWeeks
      };
    }
    this.currentStatus = newCurrentStatus;
    this.displayStatusText = tempStatus.statusText;

    if (tempStatus.isInSemester && tempStatus.currentSemester) {
      // å½“å‰åœ¨å­¦æœŸä¸­
      const tempCurrentSemester = tempStatus.currentSemester;
      const newSemester: SemesterInfo = {
        year: tempCurrentSemester.year,
        semester: tempCurrentSemester.semester,
        startDate: tempCurrentSemester.startDate,
        endDate: tempCurrentSemester.endDate,
        totalWeeks: tempCurrentSemester.totalWeeks
      };
      this.currentSemester = newSemester;
      this.currentWeek = tempStatus.currentWeek;
      this.totalWeeks = tempCurrentSemester.totalWeeks;
      this.updateWeekDates(tempCurrentSemester.startDate);

      // å»¶è¿Ÿå®šä½åˆ°å½“å‰å‘¨
      setTimeout(() => {
        this.navigateToCurrentWeek();
      }, 100);
    } else if (tempStatus.isInHoliday) {
      // å½“å‰åœ¨å‡æœŸä¸­
      const latestSemester = this.getLatestSemester();
      if (latestSemester) {
        const newSemester: SemesterInfo = {
          year: latestSemester.year,
          semester: latestSemester.semester,
          startDate: latestSemester.startDate,
          endDate: latestSemester.endDate,
          totalWeeks: latestSemester.totalWeeks
        };
        this.currentSemester = newSemester;
        this.totalWeeks = latestSemester.totalWeeks;
        this.currentWeek = 1; // å‡æœŸä¸­é»˜è®¤æ˜¾ç¤ºç¬¬1å‘¨
        this.updateWeekDates(latestSemester.startDate);
      }
    }

    console.info(`ğŸ“… [Schedule Config] çŠ¶æ€: ${this.displayStatusText}, å½“å‰å­¦æœŸ: ${this.currentSemester?.year}å¹´${this.currentSemester?.semester ===
      1 ? 'ç§‹å­£' : 'æ˜¥å­£'}å­¦æœŸ`);
  }

  /**
   * åŠ è½½é…ç½®ä¿¡æ¯ (æ”¯æŒå®Œæ•´çš„å­¦æœŸç®¡ç†ç³»ç»Ÿ)
   */
  private async loadConfig(): Promise<void> {
    try {
      // è°ƒç”¨é…ç½®æœåŠ¡
      const rawConfigResponse = await this.configService.getConfig();
      // æ‰‹åŠ¨æ„å»ºå“åº”å¯¹è±¡ï¼Œé¿å…å¯¹è±¡å­—é¢é‡é”™è¯¯
      const configResponse: ConfigApiResponse = {
        msg: rawConfigResponse.msg,
        code: rawConfigResponse.code,
        data: {
          start: rawConfigResponse.data.start,
          end: rawConfigResponse.data.end
        }
      };

      if (configResponse.code === 200 && configResponse.data) {
        // è·å–å­¦æœŸåˆ—è¡¨
        const tempSemesterList = this.configService.getSemesterList();
        // æ¸…ç©ºå¹¶é‡æ–°å¡«å……
        this.semesterList = [];
        tempSemesterList.forEach((semester) => {
          this.semesterList.push({
            year: semester.year,
            semester: semester.semester,
            startDate: semester.startDate,
            endDate: semester.endDate,
            totalWeeks: semester.totalWeeks
          });
        });

        // è®¡ç®—å½“å‰å­¦æœŸçŠ¶æ€
        const tempStatus = this.configService.calculateCurrentSemesterStatus();
        // æ‰‹åŠ¨å¤åˆ¶çŠ¶æ€å¯¹è±¡
        const newCurrentStatus: CurrentSemesterStatus = {
          isInSemester: tempStatus.isInSemester,
          isInHoliday: tempStatus.isInHoliday,
          currentWeek: tempStatus.currentWeek,
          statusText: tempStatus.statusText
        };
        if (tempStatus.currentSemester) {
          newCurrentStatus.currentSemester = {
            year: tempStatus.currentSemester.year,
            semester: tempStatus.currentSemester.semester,
            startDate: tempStatus.currentSemester.startDate,
            endDate: tempStatus.currentSemester.endDate,
            totalWeeks: tempStatus.currentSemester.totalWeeks
          };
        }
        this.currentStatus = newCurrentStatus;
        this.displayStatusText = tempStatus.statusText;

        if (tempStatus.isInSemester && tempStatus.currentSemester) {
          // å½“å‰åœ¨å­¦æœŸä¸­
          const tempCurrentSemester = tempStatus.currentSemester;
          const newSemester: SemesterInfo = {
            year: tempCurrentSemester.year,
            semester: tempCurrentSemester.semester,
            startDate: tempCurrentSemester.startDate,
            endDate: tempCurrentSemester.endDate,
            totalWeeks: tempCurrentSemester.totalWeeks
          };
          this.currentSemester = newSemester;
          this.currentWeek = tempStatus.currentWeek;
          this.totalWeeks = tempCurrentSemester.totalWeeks;
          this.updateWeekDates(tempCurrentSemester.startDate);

          // å»¶è¿Ÿå®šä½åˆ°å½“å‰å‘¨ï¼Œç¡®ä¿Swiperå·²å®Œå…¨åˆå§‹åŒ–
          setTimeout(() => {
            this.navigateToCurrentWeek();
          }, 100);
        } else if (tempStatus.isInHoliday) {
          // å½“å‰åœ¨å‡æœŸä¸­ï¼Œæ˜¾ç¤ºæœ€è¿‘çš„å­¦æœŸ
          const latestSemester = this.getLatestSemester();
          if (latestSemester) {
            const newSemester: SemesterInfo = {
              year: latestSemester.year,
              semester: latestSemester.semester,
              startDate: latestSemester.startDate,
              endDate: latestSemester.endDate,
              totalWeeks: latestSemester.totalWeeks
            };
            this.currentSemester = newSemester;
            this.totalWeeks = latestSemester.totalWeeks;
            this.currentWeek = 1; // å‡æœŸä¸­é»˜è®¤æ˜¾ç¤ºç¬¬1å‘¨
            this.updateWeekDates(latestSemester.startDate);
          }
        }

        console.info(`ğŸ“… [Schedule Config] çŠ¶æ€: ${this.displayStatusText}, å½“å‰å­¦æœŸ: ${this.currentSemester?.year}å¹´${this.currentSemester?.semester ===
          1 ? 'ç§‹å­£' : 'æ˜¥å­£'}å­¦æœŸ`);
      } else {
        console.error('é…ç½®åŠ è½½å¤±è´¥:', configResponse.msg);
      }
    } catch (error) {
      console.error('é…ç½®è¯·æ±‚å¤±è´¥:', error);
      // ä¿æŒé»˜è®¤é…ç½®
    }
  }

  /**
   * åˆå§‹åŒ–é»˜è®¤é…ç½®
   */
  private initDefaultConfig(): void {
    this.totalWeeks = 20;
    this.currentWeek = 1;
    this.displayStatusText = "ç¬¬1å‘¨";

    // é»˜è®¤å­¦æœŸä¿¡æ¯ (2025å­¦å¹´ç¬¬ä¸€å­¦æœŸ)
    this.currentSemester = {
      year: "2024",
      semester: 1,
      startDate: "2024-09-08",
      endDate: "2025-01-21",
      totalWeeks: 20
    };

    this.updateWeekDates(this.currentSemester.startDate);
  }

  /**
   * è·å–æœ€è¿‘çš„å­¦æœŸ (ç”¨äºå‡æœŸä¸­çš„æ˜¾ç¤º)
   */
  private getLatestSemester(): SemesterInfo | null {
    if (this.semesterList.length === 0) {
      return null;
    }

    const today = new Date();
    let latestSemester: SemesterInfo | null = null;

    // æ‰¾åˆ°æœ€è¿‘ç»“æŸçš„å­¦æœŸï¼Œå¦‚æœæ²¡æœ‰å°±ç”¨æœ€åä¸€ä¸ªå­¦æœŸ
    for (const semester of this.semesterList) {
      const endDate = new Date(semester.endDate);
      if (endDate <= today) {
        latestSemester = semester;
      }
    }

    return latestSemester || this.semesterList[this.semesterList.length - 1];
  }

  /**
   * æ›´æ–°å‘¨æ—¥æœŸä¿¡æ¯
   */
  private updateWeekDates(startDate?: string): void {
    const semesterStartDate = startDate || this.currentSemester?.startDate || "2024-09-08";

    const weekRange = this.configService.calculateWeekDates(semesterStartDate, this.currentWeek);
    this.weekDates = {
      startDate: weekRange.startDate,
      endDate: weekRange.endDate
    };
    this.currentMonth = this.configService.getMonthString(this.weekDates.startDate);

    // åŒæ­¥Swiperä½ç½®åˆ°å½“å‰å‘¨
    if (this.swiper && this.currentWeek > 0) {
      this.swiper.changeIndex(this.currentWeek - 1);
    }
  }

  /**
   * å¯¼èˆªåˆ°å½“å‰å‘¨ (åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨å®šä½)
   */
  private navigateToCurrentWeek(): void {
    if (this.currentWeek > 0 && this.currentWeek <= this.totalWeeks) {
      console.info(`ğŸ“ [Navigation] è‡ªåŠ¨å®šä½åˆ°ç¬¬${this.currentWeek}å‘¨`);
      // å¼ºåˆ¶æ›´æ–°Swiperä½ç½®
      if (this.swiper) {
        this.swiper.changeIndex(this.currentWeek - 1);
      }
      // ç¡®ä¿çŠ¶æ€åŒæ­¥
      this.updateWeekDates();
    }
  }

  /**
   * åˆ‡æ¢å­¦æœŸ (æ”¯æŒä¸Šä¸€ä¸ª/ä¸‹ä¸€ä¸ªå­¦æœŸåˆ‡æ¢)
   */
  private switchSemester(direction: 'prev' | 'next'): void {
    if (!this.currentSemester) {
      return;
    }

    // å…ˆåˆ›å»ºå½“å‰å­¦æœŸçš„å‰¯æœ¬ç”¨äºä¼ å‚
    const currentSemesterCopy: SemesterInfo = {
      year: this.currentSemester.year,
      semester: this.currentSemester.semester,
      startDate: this.currentSemester.startDate,
      endDate: this.currentSemester.endDate,
      totalWeeks: this.currentSemester.totalWeeks
    };

    // è°ƒç”¨æœåŠ¡è·å–é‚»æ¥å­¦æœŸ
    const rawTargetSemester = this.configService.getAdjacentSemester(currentSemesterCopy, direction);
    if (rawTargetSemester) {
      // æ‰‹åŠ¨å¤åˆ¶å­¦æœŸå¯¹è±¡
      const targetSemester: SemesterInfo = {
        year: rawTargetSemester.year,
        semester: rawTargetSemester.semester,
        startDate: rawTargetSemester.startDate,
        endDate: rawTargetSemester.endDate,
        totalWeeks: rawTargetSemester.totalWeeks
      };

      this.currentSemester = targetSemester;
      this.totalWeeks = targetSemester.totalWeeks;
      this.currentWeek = 1; // åˆ‡æ¢å­¦æœŸåé»˜è®¤æ˜¾ç¤ºç¬¬1å‘¨

      // é‡æ–°è®¡ç®—çŠ¶æ€æ–‡æœ¬
      const now = new Date();
      const startDate = new Date(targetSemester.startDate);
      const endDate = new Date(targetSemester.endDate);

      if (now >= startDate && now <= endDate) {
        // åˆ‡æ¢åˆ°çš„å­¦æœŸæ˜¯å½“å‰å­¦æœŸ
        const realCurrentWeek = this.configService.calculateWeekInSemester(targetSemester.startDate, now);
        this.currentWeek = realCurrentWeek;
        this.displayStatusText = `ç¬¬${realCurrentWeek}å‘¨`;
      } else {
        // åˆ‡æ¢åˆ°çš„å­¦æœŸä¸æ˜¯å½“å‰å­¦æœŸ
        this.displayStatusText = `ç¬¬${this.currentWeek}å‘¨`;
      }

      this.updateWeekDates(targetSemester.startDate);

      console.info(`ğŸ“… [Semester Switch] åˆ‡æ¢åˆ°${targetSemester.year}å¹´${targetSemester.semester === 1 ? 'ç§‹å­£' :
        'æ˜¥å­£'}å­¦æœŸ`);
    }
  }

  /**
   * åˆ‡æ¢å‘¨æ•°
   */
  private onWeekChange(weekNum: number): void {
    this.currentWeek = weekNum;

    // å¦‚æœä¸åœ¨å‡æœŸä¸­ï¼Œæ›´æ–°æ˜¾ç¤ºçŠ¶æ€
    if (!this.currentStatus?.isInHoliday) {
      this.displayStatusText = `ç¬¬${weekNum}å‘¨`;
    }

    this.updateWeekDates();
    // åˆ‡æ¢Swiperåˆ°å¯¹åº”é¡µé¢
    this.swiper.changeIndex(weekNum - 1);
  }

  /**
   * ç”Ÿæˆå‘¨æ•°æ•°ç»„
   */
  private generateWeekNumbers(): number[] {
    const weeks: number[] = [];
    for (let i = 1; i <= this.totalWeeks; i++) {
      weeks.push(i);
    }
    return weeks;
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨æ—¥æœŸå’Œå‘¨æ¬¡tabbar
        Row() {
          // æœˆä»½æ˜¾ç¤º
          Text(this.currentMonth)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#45CAD9')
            .margin({ right: 10 })

          // å‘¨æ•°å¯ç‚¹å‡»åŒºåŸŸ
          Row() {
            Text(this.displayStatusText || `ç¬¬${this.currentWeek || 1}å‘¨`)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.currentStatus?.isInHoliday ? '#FF9800' : '#333333') // å‡æœŸä¸­ç”¨æ©™è‰²
            Text('â–¼')
              .fontSize(12)
              .fontColor('#999999')
              .margin({ left: 4 })
          }
          .padding({
            left: 8,
            right: 8,
            top: 4,
            bottom: 4
          })
          .borderRadius(4)
          .onClick(() => {
            this.showWeekPicker = true;
          })

          Blank()

          // æ—¥æœŸèŒƒå›´æ˜¾ç¤º
          if (this.weekDates) {
            Text(`${this.configService.formatDateString(this.weekDates.startDate)} - ${this.configService.formatDateString(this.weekDates.endDate)}`)
              .fontSize(12)
              .fontColor('#666666')
          }
        }
        .width('100%')
        .padding({
          left: 20,
          right: 20,
          top: 15,
          bottom: 10
        })
        .backgroundColor(Color.White)
        .border({ width: { bottom: 1 }, color: '#F0F0F0' })

        // Swiperå®¹å™¨ç”¨äºæ»‘åŠ¨åˆ‡æ¢å‘¨
        Swiper(this.swiper) {
          // ç”Ÿæˆå¤šå‘¨çš„è¯¾è¡¨å†…å®¹
          ForEach(this.generateWeekNumbers(), (weekNum: number) => {
            this.WeekScheduleContent(weekNum)
          })
        }
        .width('100%')
        .layoutWeight(1)
        .indicator(false)
        .loop(false)
        .onChange((index: number) => {
          this.currentWeek = index + 1;
          this.updateWeekDates();
        })
        .onGestureSwipe((index: number, extraInfo: SwiperAnimationEvent) => {
          this.currentWeek = index + 1;
          this.updateWeekDates();
        })
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F5')

      // å‘¨é€‰æ‹©å™¨å¼¹çª—
      if (this.showWeekPicker) {
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.5)')
          .onClick(() => {
            this.showWeekPicker = false;
          })

        Column() {
          Blank()

          this.buildWeekPickerContent()
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.End)
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  private buildWeekPickerContent() {
    Column() {
      // å­¦æœŸä¿¡æ¯å’Œåˆ‡æ¢æŒ‰é’®
      Row() {
        // ä¸Šä¸€ä¸ªå­¦æœŸæŒ‰é’®
        Button('< ä¸Šå­¦æœŸ')
          .fontSize(14)
          .fontColor('#45CAD9')
          .backgroundColor(Color.Transparent)
          .height(30)
          .onClick(() => {
            this.switchSemester('prev');
          })

        Blank()

        // å½“å‰å­¦æœŸä¿¡æ¯
        Text(`${this.currentSemester?.year || '2024'}å¹´${this.currentSemester?.semester === 1 ? 'ç§‹å­£' : 'æ˜¥å­£'}å­¦æœŸ`)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')

        Blank()

        // ä¸‹ä¸€ä¸ªå­¦æœŸæŒ‰é’®
        Button('ä¸‹å­¦æœŸ >')
          .fontSize(14)
          .fontColor('#45CAD9')
          .backgroundColor(Color.Transparent)
          .height(30)
          .onClick(() => {
            this.switchSemester('next');
          })
      }
      .width('100%')
      .padding({ left: 20, right: 20, bottom: 10 })

      Divider()
        .color('#F0F0F0')
        .strokeWidth(0.5)
        .margin({ bottom: 10 })

      Text('é€‰æ‹©å‘¨æ¬¡')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .margin({ bottom: 20 })

      Scroll() {
        Column() {
          ForEach(this.generateWeekNumbers(), (weekNum: number) => {
            Row() {
              Text(`ç¬¬${weekNum}å‘¨`)
                .fontSize(16)
                .fontColor(this.currentWeek === weekNum ? '#45CAD9' : '#333333')
                .fontWeight(this.currentWeek === weekNum ? FontWeight.Medium : FontWeight.Normal)

              Blank()

              if (this.currentWeek === weekNum) {
                Text('âœ“')
                  .fontSize(16)
                  .fontColor('#45CAD9')
              }
            }
            .width('100%')
            .height(50)
            .padding({ left: 20, right: 20 })
            .onClick(() => {
              this.onWeekChange(weekNum);
              this.showWeekPicker = false;
            })

            if (weekNum < this.totalWeeks) {
              Divider()
                .color('#F0F0F0')
                .strokeWidth(0.5)
            }
          })
        }
      }
      .height(300)

      Row() {
        Button('å–æ¶ˆ')
          .width('45%')
          .height(45)
          .fontSize(16)
          .fontColor('#666666')
          .backgroundColor('#F5F5F5')
          .onClick(() => {
            this.showWeekPicker = false;
          })

        Blank()

        Button('ç¡®å®š')
          .width('45%')
          .height(45)
          .fontSize(16)
          .fontColor(Color.White)
          .backgroundColor('#45CAD9')
          .onClick(() => {
            this.showWeekPicker = false;
          })
      }
      .width('100%')
      .margin({ top: 20 })
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius({ topLeft: 20, topRight: 20 })
  }

  @Builder
  WeekScheduleContent(weekNum: number) {
    Column() {
      // æ˜ŸæœŸè¡¨å¤´
      Row() {
        // å·¦ä¸Šè§’ç©ºç™½åŒºåŸŸ
        Column()
          .width(40)

        // æ˜ŸæœŸæ ‡é¢˜
        ForEach(this.weekDays, (day: string, dayIndex: number) => {
          Column() {
            Text(day)
              .fontSize(13)
              .fontColor('#333333')
              .fontWeight(FontWeight.Medium)
          }
          .layoutWeight(1)
          .padding(6)
          .justifyContent(FlexAlign.Center)
        })
      }
      .width('100%')
      .backgroundColor('#FAFAFA')
      .border({ width: { bottom: 1 }, color: '#E8E8E8' })

      // è¯¾è¡¨å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          ForEach(this.timeSlots, (time: string, timeIndex: number) => {
            Row() {
              // æ—¶é—´æ˜¾ç¤ºåˆ— - åªæ˜¾ç¤ºæ•°å­—
              Column() {
                Text(`${timeIndex + 1}`)
                  .fontSize(16)
                  .fontColor('#666666')
                  .fontWeight(FontWeight.Medium)
              }
              .width(40)
              .height(60)
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
              .backgroundColor('#FAFAFA')
              .border({ width: { right: 1 }, color: '#E8E8E8' })

              // ä¸ƒå¤©çš„è¯¾ç¨‹å†…å®¹
              ForEach(this.weekDays, (day: string, dayIndex: number) => {
                Column() {
                  this.buildCourseCell(weekNum, dayIndex + 1, timeIndex)
                }
                .layoutWeight(1)
                .height(60)
                .border({
                  width: { right: dayIndex < 6 ? 1 : 0, bottom: 1 },
                  color: '#E8E8E8'
                })
              })
            }
            .width('100%')
          })
        }
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  buildCourseCell(weekNum: number, dayIndex: number, timeIndex: number) {
    if (this.allWeeksData[weekNum]?.[dayIndex]?.[timeIndex]) {
      Column() {
        Text(this.allWeeksData[weekNum][dayIndex][timeIndex]!.name)
          .fontSize(11)
          .fontColor('#333333')
          .fontWeight(FontWeight.Medium)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .textAlign(TextAlign.Center)
          .margin({ bottom: 2 })
        Text(this.allWeeksData[weekNum][dayIndex][timeIndex]!.location)
          .fontSize(9)
          .fontColor('#666666')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .textAlign(TextAlign.Center)
      }
      .width('100%')
      .height('100%')
      .padding(4)
      .backgroundColor(this.allWeeksData[weekNum][dayIndex][timeIndex]!.color)
      .borderRadius(6)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
      .margin(2)
      .onClick(() => {
        // ç‚¹å‡»è¯¾ç¨‹è¯¦æƒ…
      })
    } else {
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor(Color.Transparent)
    }
  }
}

// è¯¾ç¨‹ä¿¡æ¯æ¥å£
interface CourseInfo {
  name: string;
  location: string;
  teacher: string;
  color: string;
}

@Component
struct MinePage {
  @State private userInfo: UserInfo = {
    avatar: 'ğŸ‘¤',
    username: 'ä¾ å®¢åŒå­¦',
    studentId: '2024001',
    college: 'è®¡ç®—æœºå­¦é™¢',
    major: 'è½¯ä»¶å·¥ç¨‹',
    className: 'è½¯å·¥2024-1ç­'
  };

  build() {
    Column() {
      // ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
      Column() {
        Row() {
          // å¤´åƒ
          Text(this.userInfo.avatar)
            .fontSize(48)
            .width(80)
            .height(80)
            .backgroundColor('#E3F2FD')
            .borderRadius(40)
            .textAlign(TextAlign.Center)
            .margin({ right: 16 })

          // ç”¨æˆ·ä¿¡æ¯
          Column() {
            Text(this.userInfo.username)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .margin({ bottom: 4 })
            Text(`å­¦å·ï¼š${this.userInfo.studentId}`)
              .fontSize(14)
              .fontColor('#666666')
              .margin({ bottom: 2 })
            Text(`${this.userInfo.college} Â· ${this.userInfo.major}`)
              .fontSize(12)
              .fontColor('#999999')
              .margin({ bottom: 2 })
            Text(this.userInfo.className)
              .fontSize(12)
              .fontColor('#999999')
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)
        }
        .width('100%')
        .alignItems(VerticalAlign.Center)
      }
      .width('90%')
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .shadow({
        radius: 8,
        color: 'rgba(0, 0, 0, 0.1)',
        offsetY: 2
      })
      .margin({ top: 50, bottom: 20 })

      // åŠŸèƒ½åˆ—è¡¨
      Column() {
        this.MenuSection('ä¸ªäººä¿¡æ¯', this.getPersonalItems())
        this.MenuSection('å­¦ä¹ ç›¸å…³', this.getStudyItems())
        this.MenuSection('ç³»ç»ŸåŠŸèƒ½', this.getSystemItems())
      }
      .width('90%')
      .layoutWeight(1)

      Blank()

      // é€€å‡ºç™»å½•æŒ‰é’®
      Button('é€€å‡ºç™»å½•')
        .width('60%')
        .height(45)
        .fontSize(16)
        .fontColor('#FF5722')
        .backgroundColor(Color.White)
        .borderRadius(22)
        .border({
          width: 1,
          color: '#FF5722'
        })
        .margin({ bottom: 60 })
        .onClick(() => {
          // é€€å‡ºç™»å½•é€»è¾‘
        })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  MenuSection(title: string, items: MenuItemType[]) {
    Column() {
      Text(title)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .width('100%')
        .margin({ bottom: 12 })

      Column() {
        ForEach(items, (item: MenuItemType, index: number) => {
          Row() {
            Text(item.icon)
              .fontSize(24)
              .width(40)
              .textAlign(TextAlign.Center)
              .margin({ right: 12 })

            Column() {
              Text(item.title)
                .fontSize(16)
                .fontColor('#333333')
                .fontWeight(FontWeight.Medium)
                .width('100%')
                .margin({ bottom: 2 })
              Text(item.desc)
                .fontSize(12)
                .fontColor('#999999')
                .width('100%')
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)

            Text('>')
              .fontSize(16)
              .fontColor('#CCCCCC')
          }
          .width('100%')
          .height(60)
          .padding({ left: 16, right: 16 })
          .alignItems(VerticalAlign.Center)
          .onClick(() => {
            // å¤„ç†ç‚¹å‡»äº‹ä»¶
          })

          if (index < items.length - 1) {
            Divider()
              .color('#F0F0F0')
              .strokeWidth(0.5)
              .margin({ left: 68 })
          }
        })
      }
      .width('100%')
      .backgroundColor(Color.White)
      .borderRadius(12)
      .margin({ bottom: 20 })
    }
  }

  private getPersonalItems(): MenuItemType[] {
    return [
      { icon: 'ğŸ“', title: 'ä¸ªäººèµ„æ–™', desc: 'ä¿®æ”¹ä¸ªäººä¿¡æ¯' },
      { icon: 'ğŸ”’', title: 'è´¦å·å®‰å…¨', desc: 'å¯†ç ä¿®æ”¹ç­‰' }
    ];
  }

  private getStudyItems(): MenuItemType[] {
    return [
      { icon: 'â­', title: 'æˆ‘çš„è¯„ä»·', desc: 'è¯¾ç¨‹å’Œæ•™å¸ˆè¯„ä»·' },
      { icon: 'ğŸ“Š', title: 'å­¦ä¹ ç»Ÿè®¡', desc: 'è¯¾ç¨‹ç»Ÿè®¡ä¿¡æ¯' },
      { icon: 'ğŸ“…', title: 'è¯¾è¡¨ç®¡ç†', desc: 'è‡ªå®šä¹‰è¯¾è¡¨' }
    ];
  }

  private getSystemItems(): MenuItemType[] {
    return [
      { icon: 'ğŸ“¢', title: 'ç³»ç»Ÿé€šçŸ¥', desc: 'æŸ¥çœ‹ç³»ç»Ÿæ¶ˆæ¯' },
      { icon: 'â“', title: 'å¸®åŠ©åé¦ˆ', desc: 'é—®é¢˜åé¦ˆå’Œå¸®åŠ©' },
      { icon: 'â„¹ï¸', title: 'å…³äºæˆ‘ä»¬', desc: 'åº”ç”¨ä¿¡æ¯' }
    ];
  }
}