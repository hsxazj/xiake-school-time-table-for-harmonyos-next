import {
  ConfigApiService,
  SemesterInfo,
  CurrentSemesterStatus,
  ConfigApiResponse
} from '../services/api/ConfigApiService';
import { 
  CourseApiService, 
  CourseInfo, 
  CourseRequestParams,
  CoursePosition
} from '../services/api/CourseApiService';
import { AppConfigManager } from '../services/AppConfigManager';
import { UserInfoManager, UserSchoolInfo } from '../common/constants/PreferencesUtil';
import { ApiResponse } from '../models/CollegeModels';

// å®šä¹‰æ¥å£
interface UserInfo {
  avatar: string;
  username: string;
  studentId: string;
  college: string;
  major: string;
  className: string;
}

interface MenuItemType {
  icon: string;
  title: string;
  desc: string;
}

interface WeekDateRange {
  startDate: Date;
  endDate: Date;
}

// è¯¾ç¨‹æ•°æ®æ¥å£ï¼ˆç”¨äºæ¨¡æ‹Ÿæ•°æ®ï¼‰
interface MockCourseInfo {
  name: string;
  location: string;
  teacher: string;
  color: string;
}

@Entry
@Component
struct MainTabPage {
  @State currentTabIndex: number = 0;

  @Builder
  TabBuilder(title: string, targetIndex: number) {
    Column() {
      Text(this.getTabIcon(targetIndex))
        .fontSize(22)
        .fontColor(this.currentTabIndex === targetIndex ? '#45CAD9' : '#999999')
        .margin({ bottom: 4 })
      Text(title)
        .fontColor(this.currentTabIndex === targetIndex ? '#45CAD9' : '#999999')
        .fontSize(12)
        .fontWeight(this.currentTabIndex === targetIndex ? FontWeight.Medium : FontWeight.Normal)
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  private getTabIcon(index: number): string {
    const icons = ['ğŸ ', 'ğŸ“…', 'ğŸ‘¤'];
    return icons[index] || '';
  }

  build() {
    Tabs({ barPosition: BarPosition.End, controller: new TabsController() }) {
      TabContent() {
        HomePage()
      }
      .tabBar(this.TabBuilder('é¦–é¡µ', 0))

      TabContent() {
        SchedulePage()
      }
      .tabBar(this.TabBuilder('è¯¾è¡¨', 1))

      TabContent() {
        MinePage()
      }
      .tabBar(this.TabBuilder('æˆ‘çš„', 2))
    }
    .width('100%')
    .height('100%')
    .barBackgroundColor('#FFFFFF')
    .barMode(BarMode.Fixed)
    .vertical(false)
    .scrollable(false)
    .onChange((index: number) => {
      this.currentTabIndex = index;
    })
  }
}

@Component
struct HomePage {
  @State private username: string = '';
  @State private collegeName: string = '';

  aboutToAppear(): void {
    // è¿™é‡Œå¯ä»¥åŠ è½½ç”¨æˆ·ä¿¡æ¯
    this.username = 'åŒå­¦';
    this.collegeName = 'è®¡ç®—æœºå­¦é™¢';
  }

  build() {
    Column() {
      // é¡¶éƒ¨é—®å€™è¯­
      Row() {
        Column() {
          Text(`ä½ å¥½ï¼Œ${this.username}`)
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .margin({ bottom: 4 })
          Text(`${this.collegeName}`)
            .fontSize(14)
            .fontColor('#666666')
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        // æ¶ˆæ¯å›¾æ ‡
        Text('ğŸ””')
          .fontSize(24)
          .onClick(() => {
            // æ¶ˆæ¯ç‚¹å‡»äº‹ä»¶
          })
      }
      .width('100%')
      .padding({
        left: 20,
        right: 20,
        top: 50,
        bottom: 20
      })

      // åŠŸèƒ½åŒºåŸŸ
      Column() {
        // ä»Šæ—¥è¯¾ç¨‹å¡ç‰‡
        Column() {
          Row() {
            Text('ä»Šæ—¥è¯¾ç¨‹')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
            Blank()
            Text('æŸ¥çœ‹æ›´å¤š >')
              .fontSize(14)
              .fontColor('#45CAD9')
              .onClick(() => {
                // è·³è½¬åˆ°è¯¾è¡¨é¡µ
              })
          }
          .width('100%')
          .margin({ bottom: 15 })

          // è¯¾ç¨‹åˆ—è¡¨
          Column() {
            Text('æš‚æ— ä»Šæ—¥è¯¾ç¨‹')
              .fontSize(16)
              .fontColor('#999999')
              .margin({ top: 20, bottom: 20 })
          }
          .width('100%')
          .height(100)
          .justifyContent(FlexAlign.Center)
        }
        .width('100%')
        .padding(20)
        .backgroundColor(Color.White)
        .borderRadius(12)
        .shadow({
          radius: 8,
          color: 'rgba(0, 0, 0, 0.1)',
          offsetY: 2
        })
        .margin({ bottom: 20 })

        // å¿«æ·åŠŸèƒ½
        Column() {
          Text('å¿«æ·åŠŸèƒ½')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
            .width('100%')
            .margin({ bottom: 15 })

          Grid() {
            GridItem() {
              this.FunctionCard('ğŸ“…', 'æˆ‘çš„è¯¾è¡¨', '#E3F2FD')
            }

            GridItem() {
              this.FunctionCard('â­', 'è¯¾ç¨‹è¯„ä»·', '#F3E5F5')
            }

            GridItem() {
              this.FunctionCard('ğŸ“¢', 'ç³»ç»Ÿé€šçŸ¥', '#E8F5E8')
            }

            GridItem() {
              this.FunctionCard('â“', 'é—®é¢˜åé¦ˆ', '#FFF3E0')
            }
          }
          .rowsTemplate('1fr 1fr')
          .columnsTemplate('1fr 1fr')
          .rowsGap(15)
          .columnsGap(15)
          .height(200)
        }
        .width('100%')
        .padding(20)
        .backgroundColor(Color.White)
        .borderRadius(12)
        .shadow({
          radius: 8,
          color: 'rgba(0, 0, 0, 0.1)',
          offsetY: 2
        })
      }
      .width('90%')
      .layoutWeight(1)

      Blank()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  FunctionCard(icon: string, title: string, bgColor: string) {
    Column() {
      Text(icon)
        .fontSize(32)
        .margin({ bottom: 8 })
      Text(title)
        .fontSize(14)
        .fontColor('#333333')
    }
    .width('100%')
    .height('100%')
    .backgroundColor(bgColor)
    .borderRadius(8)
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      // å¤„ç†ç‚¹å‡»äº‹ä»¶
    })
  }
}

@Component
struct SchedulePage {
  @State private currentWeek: number = 1;
  @State private totalWeeks: number = 20;
  @State private currentMonth: string = '';
  @State private weekDates: WeekDateRange | null = null;
  @State private showWeekPicker: boolean = false;
  // æ–°å¢å­¦æœŸç®¡ç†ç›¸å…³çŠ¶æ€
  @State private currentStatus: CurrentSemesterStatus | null = null;
  @State private currentSemester: SemesterInfo | null = null;
  @State private semesterList: SemesterInfo[] = [];
  @State private displayStatusText: string = "ç¬¬1å‘¨";
  // æ–°å¢åŸºäºæ—¥æœŸçš„æ»‘åŠ¨çŠ¶æ€
  @State private currentDate: Date = new Date(); // å½“å‰æ˜¾ç¤ºçš„æ—¥æœŸ
  // æ»‘åŠ¨æ‰‹åŠ¿çŠ¶æ€
  @State private startTime: number = 0;
  @State private startPosition: number = 0;
  @State private endPosition: number = 0;
  // æ–°å¢è¯¾ç¨‹æ•°æ®ç›¸å…³çŠ¶æ€
  @State private coursePositions: CoursePosition[] = [];
  @State private isLoadingCourses: boolean = false;
  
  private configService: ConfigApiService = ConfigApiService.getInstance();
  private courseService: CourseApiService = CourseApiService.getInstance();
  private appConfigManager: AppConfigManager = AppConfigManager.getInstance();
  private userInfoManager: UserInfoManager = UserInfoManager.getInstance();
  private weekDays: string[] = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
  private timeSlots: string[] = ['8:00', '9:00', '10:00', '11:00', '14:00', '15:00', '16:00', '17:00'];
  // æ¨¡æ‹Ÿå¤šå‘¨è¯¾ç¨‹æ•°æ®
  private allWeeksData: Record<number, Record<number, Record<number, MockCourseInfo | null>>> = this.initMockData();

  private initMockData(): Record<number, Record<number, Record<number, MockCourseInfo | null>>> {
    const mockData: Record<number, Record<number, Record<number, MockCourseInfo | null>>> = {};
    
    // åˆå§‹åŒ–ç¬¬1å‘¨æ•°æ®
    mockData[1] = {};
    mockData[1][1] = {}; // å‘¨ä¸€
    mockData[1][1][1] = {
      name: 'é«˜ç­‰æ•°å­¦',
      location: 'æ•™å­¦æ¥¼A101',
      teacher: 'å¼ æ•™æˆ',
      color: '#E8F5E8'
    };
    mockData[1][1][2] = {
      name: 'çº¿æ€§ä»£æ•°',
      location: 'æ•™å­¦æ¥¼A102',
      teacher: 'ææ•™æˆ',
      color: '#E3F2FD'
    };
    
    // å…¶ä»–æ¨¡æ‹Ÿæ•°æ®å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ 
    return mockData;
  }

  aboutToAppear(): void {
    // åŸºäºæ—¥æœŸçš„åˆå§‹åŒ–é€»è¾‘
    this.initializeWithCurrentDate();
  }

  /**
   * åŸºäºå½“å‰æ—¥æœŸåˆå§‹åŒ– - æ‰¾åˆ°æœ€è¿‘çš„å­¦æœŸå¹¶è®¡ç®—å½“å‰å‘¨æ•°
   */
  private async initializeWithCurrentDate(): Promise<void> {
    try {
      // ç¡®ä¿é…ç½®å·²åŠ è½½
      await this.appConfigManager.initialize();
      this.semesterList = this.configService.getSemesterList();
      
      if (this.semesterList.length === 0) {
        console.error('ğŸ“‹ [Schedule] æ²¡æœ‰å­¦æœŸæ•°æ®');
        return;
      }

      // ä½¿ç”¨ä»Šå¤©çš„æ—¥æœŸä½œä¸ºèµ·å§‹ç‚¹
      const today = new Date();
      this.currentDate = new Date(today);
      
      // æ‰¾åˆ°æœ€è¿‘çš„å­¦æœŸå’Œè®¡ç®—å‘¨æ•°
      this.updateCurrentSemesterFromDate(this.currentDate);
      
      // è®¡ç®—å½“å‰æ—¥æœŸå¯¹åº”çš„å‘¨æ—¥æœŸèŒƒå›´
      this.calculateWeekDatesFromCurrentDate();
      
      // åŠ è½½è¯¾ç¨‹æ•°æ®
      await this.loadCourseData();
      
      console.info(`ğŸ“… [Schedule Init] åˆå§‹åŒ–å®Œæˆ: ${this.currentDate.getFullYear()}-${this.currentDate.getMonth()+1}-${this.currentDate.getDate()}`);
      
    } catch (error) {
      console.error('ğŸ“‹ [Schedule] æ—¥æœŸåˆå§‹åŒ–å¤±è´¥:', error);
    }
  }

  /**
   * åŠ è½½è¯¾ç¨‹æ•°æ®
   */
  private async loadCourseData(): Promise<void> {
    if (!this.currentSemester) {
      console.warn('ğŸ“š [Course] å½“å‰å­¦æœŸä¿¡æ¯ä¸ºç©ºï¼Œæ— æ³•åŠ è½½è¯¾ç¨‹');
      return;
    }

    this.isLoadingCourses = true;
    
    try {
      // ä»é¦–é€‰é¡¹è·å–ç”¨æˆ·ç­çº§ä¿¡æ¯
      const userInfo = this.userInfoManager.getUserInfo();
      console.info(`ğŸ“š [Course] å½“å‰ç”¨æˆ·ä¿¡æ¯: å­¦é™¢=${userInfo.collegeName}, ä¸“ä¸š=${userInfo.majorName}, ç­çº§=${userInfo.className}`);
      
      const classId = userInfo.classId;
      
      if (!classId) {
        console.warn('ğŸ“š [Course] ç”¨æˆ·æœªè®¾ç½®ç­çº§ä¿¡æ¯ï¼Œæ— æ³•è·å–è¯¾ç¨‹æ•°æ®');
        console.warn('ğŸ“š [Course] è¯·åœ¨è®¾ç½®é¡µé¢é€‰æ‹©å­¦é™¢ã€ä¸“ä¸šå’Œç­çº§');
        return;
      }

      // æ„å»ºè¯·æ±‚å‚æ•° - ä½¿ç”¨å­¦æœŸä¿¡æ¯å’Œç”¨æˆ·ç­çº§ID
      const params = this.courseService.buildCourseParams(
        this.currentSemester.academicYear,
        this.currentSemester.semester,
        this.currentWeek, // æ·»åŠ å½“å‰å‘¨æ•°
        classId,
        undefined
      );

      console.info(`ğŸ“š [Course] è¯·æ±‚è¯¾ç¨‹æ•°æ®: ${JSON.stringify(params)}`);
      
      // è·å–è¯¾ç¨‹åˆ—è¡¨
      const courseResponse = await this.courseService.getCourseList(params);
      
      if (courseResponse.code === 200 && courseResponse.data) {
        // å¤„ç†è¯¾ç¨‹æ•°æ®
        this.courseService.processCourseData(courseResponse.data);
        this.coursePositions = this.courseService.getWeekCourses(this.currentWeek);
        console.info(`ğŸ“š [Course] æˆåŠŸåŠ è½½${courseResponse.data.length}é—¨è¯¾ç¨‹`);
      } else {
        console.warn(`ğŸ“š [Course] è¯¾ç¨‹æ•°æ®åŠ è½½å¤±è´¥: ${courseResponse.msg}`);
        this.coursePositions = [];
      }
      
    } catch (error) {
      console.error('ğŸ“š [Course] åŠ è½½è¯¾ç¨‹æ•°æ®å¤±è´¥:', error);
      this.coursePositions = [];
    } finally {
      this.isLoadingCourses = false;
    }
  }

  /**
   * æ ¹æ®ç»™å®šæ—¥æœŸæ‰¾åˆ°æœ€è¿‘çš„å­¦æœŸå¹¶è®¡ç®—å‘¨æ•°
   * ç›´æ¥ä½¿ç”¨ConfigApiServiceçš„calculateCurrentSemesterStatusé€»è¾‘
   */
  private updateCurrentSemesterFromDate(targetDate: Date): void {
    // ä½¿ç”¨ConfigApiServiceçš„å·²æœ‰é€»è¾‘æ¥è®¡ç®—çŠ¶æ€
    const semesterStatus = this.configService.calculateCurrentSemesterStatus(targetDate);
    
    if (semesterStatus && semesterStatus.currentSemester) {
      this.currentSemester = semesterStatus.currentSemester;
      this.currentWeek = semesterStatus.currentWeek;
      this.totalWeeks = semesterStatus.currentSemester.totalWeeks;
      this.displayStatusText = semesterStatus.statusText;
      
      console.info(`ğŸ“… [Semester Update] ${semesterStatus.currentSemester.academicYear}å­¦å¹´ç¬¬${semesterStatus.currentSemester.semester}å­¦æœŸ - ${semesterStatus.statusText} (å‘¨æ•°: ${semesterStatus.currentWeek})`);
    }
  }

  /**
   * æ ¹æ®å½“å‰æ—¥æœŸè®¡ç®—å‘¨æ—¥æœŸèŒƒå›´
   */
  private calculateWeekDatesFromCurrentDate(): void {
    // æ‰¾åˆ°å½“å‰æ—¥æœŸæ‰€åœ¨å‘¨çš„å‘¨ä¸€
    const currentDate = new Date(this.currentDate);
    const dayOfWeek = currentDate.getDay();
    const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    
    const mondayOfWeek = new Date(currentDate);
    mondayOfWeek.setDate(currentDate.getDate() + daysToMonday);
    
    // è®¡ç®—å‘¨æ—¥
    const sundayOfWeek = new Date(mondayOfWeek);
    sundayOfWeek.setDate(mondayOfWeek.getDate() + 6);
    
    this.weekDates = {
      startDate: mondayOfWeek,
      endDate: sundayOfWeek
    };
    
    this.currentMonth = this.configService.getMonthString(mondayOfWeek);
  }

  /**
   * å¯¼èˆªåˆ°ä¸Šä¸€å‘¨
   */
  private navigateToPreviousWeek(): void {
    // å½“å‰æ—¥æœŸå‡å»7å¤©
    const newDate = new Date(this.currentDate);
    newDate.setDate(this.currentDate.getDate() - 7);
    
    this.currentDate = newDate;
    this.updateCurrentSemesterFromDate(this.currentDate);
    this.calculateWeekDatesFromCurrentDate();
    
    // é‡æ–°åŠ è½½è¯¾ç¨‹æ•°æ®ï¼ˆå¦‚æœå­¦æœŸå‘ç”Ÿå˜åŒ–ï¼‰
    this.loadCourseData();
    
    console.info(`ğŸ“… [Navigate] å·¦æ»‘åˆ°ä¸Šä¸€å‘¨: ${newDate.getFullYear()}-${newDate.getMonth()+1}-${newDate.getDate()}`);
  }

  /**
   * å¯¼èˆªåˆ°ä¸‹ä¸€å‘¨  
   */
  private navigateToNextWeek(): void {
    // å½“å‰æ—¥æœŸåŠ ä¸Š7å¤©
    const newDate = new Date(this.currentDate);
    newDate.setDate(this.currentDate.getDate() + 7);
    
    this.currentDate = newDate;
    this.updateCurrentSemesterFromDate(this.currentDate);
    this.calculateWeekDatesFromCurrentDate();
    
    // é‡æ–°åŠ è½½è¯¾ç¨‹æ•°æ®ï¼ˆå¦‚æœå­¦æœŸå‘ç”Ÿå˜åŒ–ï¼‰
    this.loadCourseData();
    
    console.info(`ğŸ“… [Navigate] å³æ»‘åˆ°ä¸‹ä¸€å‘¨: ${newDate.getFullYear()}-${newDate.getMonth()+1}-${newDate.getDate()}`);
  }

  /**
   * åˆ‡æ¢å­¦æœŸ (è·³è½¬åˆ°æŒ‡å®šå­¦æœŸçš„ç¬¬ä¸€å‘¨)
   */
  private switchSemester(direction: 'prev' | 'next'): void {
    if (!this.currentSemester) {
      return;
    }

    // æ‰¾åˆ°ç›®æ ‡å­¦æœŸ
    const rawTargetSemester = this.configService.getAdjacentSemester(this.currentSemester, direction);
    if (rawTargetSemester) {
      // è·³è½¬åˆ°ç›®æ ‡å­¦æœŸçš„å¼€å­¦æ—¥æœŸ
      const targetStartDate = new Date(rawTargetSemester.startDate);
      this.currentDate = targetStartDate;
      
      // æ›´æ–°å­¦æœŸä¿¡æ¯
      this.updateCurrentSemesterFromDate(this.currentDate);
      this.calculateWeekDatesFromCurrentDate();
      
      // é‡æ–°åŠ è½½æ–°å­¦æœŸçš„è¯¾ç¨‹æ•°æ®
      this.loadCourseData();
      
      console.info(`ğŸ“… [Semester Switch] åˆ‡æ¢åˆ°${rawTargetSemester.academicYear}å­¦å¹´ç¬¬${rawTargetSemester.semester}å­¦æœŸ`);
    }
  }

  /**
   * è·å–æ˜ŸæœŸå¯¹åº”çš„æ—¥æœŸ
   */
  private getDateForWeekDay(dayIndex: number): string {
    if (!this.weekDates) return '';
    
    const targetDate = new Date(this.weekDates.startDate);
    targetDate.setDate(this.weekDates.startDate.getDate() + dayIndex);
    
    const month = targetDate.getMonth() + 1;
    const day = targetDate.getDate();
    return `${month}/${day}`;
  }

  /**
   * è§¦æ‘¸å¼€å§‹ (å‚è€ƒclass-schedule-cçš„touchStartæ–¹æ³•)
   */
  private touchStart(event: TouchEvent): void {
    this.startTime = Date.now();
    this.startPosition = event.touches[0].x;
  }

  /**
   * è§¦æ‘¸ç»“æŸ (å‚è€ƒclass-schedule-cçš„touchEndæ–¹æ³•)
   */
  private touchEnd(event: TouchEvent): void {
    const endTime = Date.now();
    // å¦‚æœè§¦æ‘¸æ—¶é—´è¶…è¿‡2ç§’ï¼Œå¿½ç•¥
    if (endTime - this.startTime > 2000) {
      return;
    }
    
    this.endPosition = event.changedTouches[0].x;
    
    // å½“ç§»åŠ¨è·ç¦»è¶…è¿‡100æ—¶åˆ¤æ–­å·¦æ»‘å³æ»‘ (ä¸class-schedule-cä¸€è‡´)
    if (Math.abs(this.endPosition - this.startPosition) > 100) {
      const elePosition = this.endPosition - this.startPosition > 0 ? "right" : "left";
      
      if (elePosition === 'right') {
        // å³æ»‘ï¼šæ˜¾ç¤ºä¸Šä¸€å‘¨ (å¯¹åº”class-schedule-cçš„leftClick)
        this.navigateToPreviousWeek();
      } else if (elePosition === 'left') {
        // å·¦æ»‘ï¼šæ˜¾ç¤ºä¸‹ä¸€å‘¨ (å¯¹åº”class-schedule-cçš„rightClick)
        this.navigateToNextWeek();
      }
    }
  }

  /**
   * ç”Ÿæˆå‘¨æ•°åˆ—è¡¨
   */
  private getWeekNumbersList(): number[] {
    const weekNumbers: number[] = [];
    for (let i = 1; i <= this.totalWeeks; i++) {
      weekNumbers.push(i);
    }
    return weekNumbers;
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨æ—¥æœŸå’Œå‘¨æ¬¡tabbar
        Row() {
          // å‘¨æ•°å¯ç‚¹å‡»åŒºåŸŸ
          Row() {
            Text(this.displayStatusText || `ç¬¬${this.currentWeek || 1}å‘¨`)
              .fontSize(22)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.currentStatus?.isInHoliday ? '#FF9800' : '#333333') // å‡æœŸä¸­ç”¨æ©™è‰²
            Text('â–¼')
              .fontSize(14)
              .fontColor('#999999')
              .margin({ left: 4 })
          }
          .padding({
            left: 8,
            right: 8,
            top: 4,
            bottom: 4
          })
          .borderRadius(4)
          .onClick(() => {
            this.showWeekPicker = true;
          })

          Blank()

          // æ—¥æœŸèŒƒå›´æ˜¾ç¤º
          if (this.weekDates) {
            Text(`${this.configService.formatDateString(this.weekDates.startDate)} - ${this.configService.formatDateString(this.weekDates.endDate)}`)
              .fontSize(14)
              .fontColor('#666666')
          }
        }
        .width('100%')
        .padding({
          left: 20,
          right: 20,
          top: 15,
          bottom: 5
        })
        .backgroundColor(Color.White)
        .border({ width: { bottom: 1 }, color: '#F0F0F0' })

        // è¯¾è¡¨å†…å®¹åŒºåŸŸ - æ”¯æŒè§¦æ‘¸æ»‘åŠ¨æ‰‹åŠ¿
        Column() {
          this.WeekScheduleContent()
        }
        .width('100%')
        .layoutWeight(1)
        .onTouch((event: TouchEvent) => {
          if (event.type === TouchType.Down) {
            this.touchStart(event);
          } else if (event.type === TouchType.Up) {
            this.touchEnd(event);
          }
          return true;
        })
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F5')

      // å‘¨é€‰æ‹©å™¨å¼¹çª—
      if (this.showWeekPicker) {
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.5)')
          .onClick(() => {
            this.showWeekPicker = false;
          })

        Column() {
          Blank()

          this.buildWeekPickerContent()
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.End)
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  private buildWeekPickerContent() {
    Column() {
      // å­¦æœŸä¿¡æ¯å’Œåˆ‡æ¢æŒ‰é’®
      Row() {
        // ä¸Šä¸€ä¸ªå­¦æœŸæŒ‰é’®
        Button('< ä¸Šå­¦æœŸ')
          .fontSize(14)
          .fontColor('#45CAD9')
          .backgroundColor(Color.Transparent)
          .height(30)
          .onClick(() => {
            this.switchSemester('prev');
          })

        Blank()

        // å½“å‰å­¦æœŸä¿¡æ¯
        Text(`${this.currentSemester?.academicYear || '2024'}å­¦å¹´ç¬¬${this.currentSemester?.semester || 1}å­¦æœŸ`)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')

        Blank()

        // ä¸‹ä¸€ä¸ªå­¦æœŸæŒ‰é’®
        Button('ä¸‹å­¦æœŸ >')
          .fontSize(14)
          .fontColor('#45CAD9')
          .backgroundColor(Color.Transparent)
          .height(30)
          .onClick(() => {
            this.switchSemester('next');
          })
      }
      .width('100%')
      .padding({ left: 20, right: 20, bottom: 10 })

      Divider()
        .color('#F0F0F0')
        .strokeWidth(0.5)
        .margin({ bottom: 10 })

      Text('é€‰æ‹©å‘¨æ¬¡')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .margin({ bottom: 20 })

      Scroll() {
        Column() {
          ForEach(this.getWeekNumbersList(), (weekNum: number) => {
            Row() {
              Text(`ç¬¬${weekNum}å‘¨`)
                .fontSize(16)
                .fontColor(this.currentWeek === weekNum ? '#45CAD9' : '#333333')
                .fontWeight(this.currentWeek === weekNum ? FontWeight.Medium : FontWeight.Normal)

              Blank()

              if (this.currentWeek === weekNum) {
                Text('âœ“')
                  .fontSize(16)
                  .fontColor('#45CAD9')
              }
            }
            .width('100%')
            .height(50)
            .padding({ left: 20, right: 20 })
            .onClick(() => {
              // è·³è½¬åˆ°æŒ‡å®šå‘¨ï¼šè®¡ç®—ç›®æ ‡æ—¥æœŸå¹¶æ›´æ–°
              if (this.currentSemester) {
                const semesterStartDate = new Date(this.currentSemester.startDate);
                const targetDate = new Date(semesterStartDate);
                targetDate.setDate(semesterStartDate.getDate() + (weekNum - 1) * 7);
                
                this.currentDate = targetDate;
                this.updateCurrentSemesterFromDate(this.currentDate);
                this.calculateWeekDatesFromCurrentDate();
              }
              this.showWeekPicker = false;
            })

            if (weekNum < this.totalWeeks) {
              Divider()
                .color('#F0F0F0')
                .strokeWidth(0.5)
            }
          })
        }
      }
      .height(300)

      Row() {
        Button('å–æ¶ˆ')
          .width('45%')
          .height(45)
          .fontSize(16)
          .fontColor('#666666')
          .backgroundColor('#F5F5F5')
          .onClick(() => {
            this.showWeekPicker = false;
          })

        Blank()

        Button('ç¡®å®š')
          .width('45%')
          .height(45)
          .fontSize(16)
          .fontColor(Color.White)
          .backgroundColor('#45CAD9')
          .onClick(() => {
            this.showWeekPicker = false;
          })
      }
      .width('100%')
      .margin({ top: 20 })
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius({ topLeft: 20, topRight: 20 })
  }

  @Builder
  WeekScheduleContent() {
    Column() {
      // æ˜ŸæœŸè¡¨å¤´
      Row() {
        // å·¦ä¸Šè§’ç©ºç™½åŒºåŸŸ
        Column()
          .width(40)

        // æ˜ŸæœŸæ ‡é¢˜å’Œæ—¥æœŸ
        ForEach(this.weekDays, (day: string, dayIndex: number) => {
          Column() {
            Text(day)
              .fontSize(16)
              .fontColor('#333333')
              .fontWeight(FontWeight.Medium)
              .margin({ bottom: 2 })
            
            // æ˜¾ç¤ºå¯¹åº”çš„æ—¥æœŸ
            if (this.weekDates) {
              Text(this.getDateForWeekDay(dayIndex))
                .fontSize(14)
                .fontColor('#666666')
            }
          }
          .layoutWeight(1)
          .padding(4)
          .justifyContent(FlexAlign.Center)
        })
      }
      .width('100%')
      .height(70)
      .backgroundColor('#FAFAFA')
      .border({ width: { bottom: 1 }, color: '#E8E8E8' })

      // è¯¾è¡¨å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          ForEach(this.timeSlots, (time: string, timeIndex: number) => {
            Row() {
              // æ—¶é—´æ˜¾ç¤ºåˆ— - åªæ˜¾ç¤ºæ•°å­—
              Column() {
                Text(`${timeIndex + 1}`)
                  .fontSize(16)
                  .fontColor('#666666')
                  .fontWeight(FontWeight.Medium)
              }
              .width(40)
              .height(70)
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
              .backgroundColor('#FAFAFA')
              .border({ width: { right: 1 }, color: '#E8E8E8' })

              // ä¸ƒå¤©çš„è¯¾ç¨‹å†…å®¹
              ForEach(this.weekDays, (day: string, dayIndex: number) => {
                Column() {
                  // æ˜¾ç¤ºå½“å‰æ—¥æœŸå¯¹åº”çš„è¯¾ç¨‹æ•°æ®
                  this.buildCurrentCourseCell(dayIndex + 1, timeIndex)
                }
                .layoutWeight(1)
                .height(60)
                .border({
                  width: { right: dayIndex < 6 ? 1 : 0, bottom: 1 },
                  color: '#E8E8E8'
                })
              })
            }
            .width('100%')
          })
        }
        .height('100%')
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  buildCurrentCourseCell(dayIndex: number, timeIndex: number) {
    // è·å–è¯¾ç¨‹æ•°æ®å¹¶æ˜¾ç¤º
    this.renderCourseCell(dayIndex, timeIndex)
  }

  @Builder
  renderCourseCell(dayIndex: number, timeIndex: number) {
    if (this.hasCourseAt(dayIndex, timeIndex)) {
      this.renderCourseWithData(dayIndex, timeIndex)
    } else {
      this.renderEmptyCell()
    }
  }

  @Builder
  renderCourseWithData(dayIndex: number, timeIndex: number) {
    Column() {
      Text(this.getCourseNameAt(dayIndex, timeIndex))
        .fontSize(11)
        .fontColor('#333333')
        .fontWeight(FontWeight.Medium)
        .maxLines(2)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .textAlign(TextAlign.Center)
        .margin({ bottom: 2 })
      
      // æ˜¾ç¤ºæ•™å®¤ä¿¡æ¯
      if (this.hasClassroomAt(dayIndex, timeIndex)) {
        Text(this.getClassroomAt(dayIndex, timeIndex))
          .fontSize(9)
          .fontColor('#666666')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .textAlign(TextAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
    .padding(4)
    .backgroundColor(this.getCourseColorAt(dayIndex, timeIndex))
    .borderRadius(6)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .margin(2)
    .onClick(() => {
      this.onCourseClick(dayIndex, timeIndex);
    })
  }

  @Builder
  renderEmptyCell() {
    Column() {
      if (this.isLoadingCourses) {
        Text('...')
          .fontSize(9)
          .fontColor('#999999')
          .textAlign(TextAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Transparent)
  }

  /**
   * æ£€æŸ¥æŒ‡å®šä½ç½®æ˜¯å¦æœ‰è¯¾ç¨‹
   */
  private hasCourseAt(dayIndex: number, timeIndex: number): boolean {
    const course = this.courseService.getCourseAt(this.currentWeek, dayIndex, timeIndex);
    return course !== null;
  }

  /**
   * è·å–æŒ‡å®šä½ç½®çš„è¯¾ç¨‹å
   */
  private getCourseNameAt(dayIndex: number, timeIndex: number): string {
    const course = this.courseService.getCourseAt(this.currentWeek, dayIndex, timeIndex);
    return course ? course.courseName : '';
  }

  /**
   * æ£€æŸ¥æŒ‡å®šä½ç½®çš„è¯¾ç¨‹æ˜¯å¦æœ‰æ•™å®¤ä¿¡æ¯
   */
  private hasClassroomAt(dayIndex: number, timeIndex: number): boolean {
    const course = this.courseService.getCourseAt(this.currentWeek, dayIndex, timeIndex);
    return course ? course.classroom && course.classroom.length > 0 : false;
  }

  /**
   * è·å–æŒ‡å®šä½ç½®çš„æ•™å®¤ä¿¡æ¯
   */
  private getClassroomAt(dayIndex: number, timeIndex: number): string {
    const course = this.courseService.getCourseAt(this.currentWeek, dayIndex, timeIndex);
    return course && course.classroom && course.classroom.length > 0 ? course.classroom[0] : '';
  }

  /**
   * è·å–æŒ‡å®šä½ç½®è¯¾ç¨‹çš„é¢œè‰²
   */
  private getCourseColorAt(dayIndex: number, timeIndex: number): string {
    const course = this.courseService.getCourseAt(this.currentWeek, dayIndex, timeIndex);
    return course ? this.getCourseColor(course.courseName) : Color.Transparent.toString();
  }

  /**
   * å¤„ç†è¯¾ç¨‹ç‚¹å‡»äº‹ä»¶
   */
  private onCourseClick(dayIndex: number, timeIndex: number): void {
    const course = this.courseService.getCourseAt(this.currentWeek, dayIndex, timeIndex);
    if (course) {
      console.info(`ğŸ“š [Course Click] ${course.courseName} - ${course.teacher.join(',')}`);
      // TODO: æ˜¾ç¤ºè¯¾ç¨‹è¯¦æƒ…å¼¹çª—
    }
  }

  /**
   * æ ¹æ®è¯¾ç¨‹åè·å–é¢œè‰²
   */
  private getCourseColor(courseName: string): string {
    // ç®€å•çš„é¢œè‰²è®¡ç®—ç®—æ³•
    const colors = [
      '#E8F5E8', '#E3F2FD', '#F3E5F5', '#FFF3E0', '#FFEBEE',
      '#F0F4C3', '#FCE4EC', '#E0F2F1', '#FFF8E1', '#F1F8E9'
    ];
    
    let hash = 0;
    for (let i = 0; i < courseName.length; i++) {
      hash = courseName.charCodeAt(i) + ((hash << 5) - hash);
    }
    
    return colors[Math.abs(hash) % colors.length];
  }
}

@Component
struct MinePage {
  @State private userInfo: UserInfo = {
    avatar: 'ğŸ‘¤',
    username: 'éœå®¢åŒå­¦',
    studentId: '2024001',
    college: 'è®¡ç®—æœºå­¦é™¢',
    major: 'è½¯ä»¶å·¥ç¨‹',
    className: 'è½¯å·¥2024-1ç­'
  };

  build() {
    Column() {
      // ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
      Column() {
        Row() {
          // å¤´åƒ
          Text(this.userInfo.avatar)
            .fontSize(48)
            .width(80)
            .height(80)
            .backgroundColor('#E3F2FD')
            .borderRadius(40)
            .textAlign(TextAlign.Center)
            .margin({ right: 16 })

          // ç”¨æˆ·ä¿¡æ¯
          Column() {
            Text(this.userInfo.username)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .margin({ bottom: 4 })
            Text(`å­¦å·ï¼š${this.userInfo.studentId}`)
              .fontSize(14)
              .fontColor('#666666')
              .margin({ bottom: 2 })
            Text(`${this.userInfo.college} Â· ${this.userInfo.major}`)
              .fontSize(12)
              .fontColor('#999999')
              .margin({ bottom: 2 })
            Text(this.userInfo.className)
              .fontSize(12)
              .fontColor('#999999')
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)
        }
        .width('100%')
        .alignItems(VerticalAlign.Center)
      }
      .width('90%')
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .shadow({
        radius: 8,
        color: 'rgba(0, 0, 0, 0.1)',
        offsetY: 2
      })
      .margin({ top: 50, bottom: 20 })

      // åŠŸèƒ½åˆ—è¡¨
      Column() {
        this.MenuSection('ä¸ªäººä¿¡æ¯', this.getPersonalItems())
        this.MenuSection('å­¦ä¹ ç›¸å…³', this.getStudyItems())
        this.MenuSection('ç³»ç»ŸåŠŸèƒ½', this.getSystemItems())
      }
      .width('90%')
      .layoutWeight(1)

      Blank()

      // é€€å‡ºç™»å½•æŒ‰é’®
      Button('é€€å‡ºç™»å½•')
        .width('60%')
        .height(45)
        .fontSize(16)
        .fontColor('#FF5722')
        .backgroundColor(Color.White)
        .borderRadius(22)
        .border({
          width: 1,
          color: '#FF5722'
        })
        .margin({ bottom: 60 })
        .onClick(() => {
          // é€€å‡ºç™»å½•é€»è¾‘
        })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  MenuSection(title: string, items: MenuItemType[]) {
    Column() {
      Text(title)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .width('100%')
        .margin({ bottom: 12 })

      Column() {
        ForEach(items, (item: MenuItemType, index: number) => {
          Row() {
            Text(item.icon)
              .fontSize(24)
              .width(40)
              .textAlign(TextAlign.Center)
              .margin({ right: 12 })

            Column() {
              Text(item.title)
                .fontSize(16)
                .fontColor('#333333')
                .fontWeight(FontWeight.Medium)
                .width('100%')
                .margin({ bottom: 2 })
              Text(item.desc)
                .fontSize(12)
                .fontColor('#999999')
                .width('100%')
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)

            Text('>')
              .fontSize(16)
              .fontColor('#CCCCCC')
          }
          .width('100%')
          .height(60)
          .padding({ left: 16, right: 16 })
          .alignItems(VerticalAlign.Center)
          .onClick(() => {
            // å¤„ç†ç‚¹å‡»äº‹ä»¶
          })

          if (index < items.length - 1) {
            Divider()
              .color('#F0F0F0')
              .strokeWidth(0.5)
              .margin({ left: 68 })
          }
        })
      }
      .width('100%')
      .backgroundColor(Color.White)
      .borderRadius(12)
      .margin({ bottom: 20 })
    }
  }

  private getPersonalItems(): MenuItemType[] {
    return [
      { icon: 'ğŸ“', title: 'ä¸ªäººèµ„æ–™', desc: 'ä¿®æ”¹ä¸ªäººä¿¡æ¯' },
      { icon: 'ğŸ”’', title: 'è´¦å·å®‰å…¨', desc: 'å¯†ç ä¿®æ”¹ç­‰' }
    ];
  }

  private getStudyItems(): MenuItemType[] {
    return [
      { icon: 'â­', title: 'æˆ‘çš„è¯„ä»·', desc: 'è¯¾ç¨‹å’Œæ•™å¸ˆè¯„ä»·' },
      { icon: 'ğŸ“Š', title: 'å­¦ä¹ ç»Ÿè®¡', desc: 'è¯¾ç¨‹ç»Ÿè®¡ä¿¡æ¯' },
      { icon: 'ğŸ“…', title: 'è¯¾è¡¨ç®¡ç†', desc: 'è‡ªå®šä¹‰è¯¾è¡¨' }
    ];
  }

  private getSystemItems(): MenuItemType[] {
    return [
      { icon: 'ğŸ“¢', title: 'ç³»ç»Ÿé€šçŸ¥', desc: 'æŸ¥çœ‹ç³»ç»Ÿæ¶ˆæ¯' },
      { icon: 'â“', title: 'å¸®åŠ©åé¦ˆ', desc: 'é—®é¢˜åé¦ˆå’Œå¸®åŠ©' },
      { icon: 'â„¹ï¸', title: 'å…³äºæˆ‘ä»¬', desc: 'åº”ç”¨ä¿¡æ¯' }
    ];
  }
}