import { ConfigApiService, CurrentSemesterStatus } from './api/ConfigApiService';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { PreferencesUtil } from '../common/utils/PreferencesUtil';

const DOMAIN = 0x1000; // App Config domain
const TREE_HOLE_ENABLED_KEY = 'tree_hole_enabled'; // æ ‘æ´åŠŸèƒ½å¯ç”¨çŠ¶æ€å­˜å‚¨é”®

/**
 * åº”ç”¨é…ç½®ç®¡ç†å™¨ - ç»Ÿä¸€ç®¡ç†å…¨å±€é…ç½®çŠ¶æ€
 * å‚ç…§class-schedule-cçš„åˆå§‹åŒ–æµç¨‹
 */
export class AppConfigManager {
  private static instance: AppConfigManager;
  private configService: ConfigApiService;
  private isInitialized: boolean = false;
  private initPromise: Promise<void> | null = null;
  private preferencesUtil: PreferencesUtil;
  private treeHoleEnabled: boolean = true; // æ ‘æ´åŠŸèƒ½é»˜è®¤å¯ç”¨

  private constructor() {
    this.configService = ConfigApiService.getInstance();
    this.preferencesUtil = PreferencesUtil.getInstance();
  }

  public static getInstance(): AppConfigManager {
    if (!AppConfigManager.instance) {
      AppConfigManager.instance = new AppConfigManager();
    }
    return AppConfigManager.instance;
  }

  /**
   * åˆå§‹åŒ–åº”ç”¨é…ç½® (å‚ç…§class-schedule-cçš„getKxTimeé€»è¾‘)
   * ç¡®ä¿åªåˆå§‹åŒ–ä¸€æ¬¡ï¼Œæ”¯æŒå¤šå¤„è°ƒç”¨
   */
  public async initialize(context?: Context): Promise<void> {
    if (this.isInitialized) {
      return Promise.resolve();
    }

    if (this.initPromise) {
      return this.initPromise;
    }

    this.initPromise = this.performInitialization(context);
    return this.initPromise;
  }

  /**
   * è·å–å½“å‰å­¦æœŸçŠ¶æ€
   */
  public getCurrentStatus(): CurrentSemesterStatus | null {
    if (!this.isInitialized) {
      hilog.warn(DOMAIN, 'AppConfig', 'âš ï¸ [AppConfigManager] é…ç½®æœªåˆå§‹åŒ–');
      return null;
    }
    return this.configService.getCurrentStatus();
  }

  /**
   * å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–é…ç½®
   */
  public async reinitialize(context?: Context): Promise<void> {
    hilog.info(DOMAIN, 'AppConfig', 'ğŸ”„ [AppConfigManager] å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–...');
    this.isInitialized = false;
    this.initPromise = null;
    return this.initialize(context);
  }

  /**
   * æ£€æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–
   */
  public isConfigInitialized(): boolean {
    return this.isInitialized;
  }

  /**
   * è·å–ConfigApiServiceå®ä¾‹ (å‘åå…¼å®¹)
   */
  public getConfigService(): ConfigApiService {
    return this.configService;
  }

  /**
   * ç­‰å¾…åˆå§‹åŒ–å®Œæˆåæ‰§è¡Œå›è°ƒ
   */
  public async whenReady<T>(callback: () => T | Promise<T>, context?: Context): Promise<T> {
    await this.initialize(context);
    return callback();
  }

  /**
   * è·å–æ ‘æ´åŠŸèƒ½å¯ç”¨çŠ¶æ€
   */
  public getTreeHoleEnabled(): boolean {
    return this.treeHoleEnabled;
  }

  /**
   * è®¾ç½®æ ‘æ´åŠŸèƒ½å¯ç”¨çŠ¶æ€
   */
  public setTreeHoleEnabled(enabled: boolean, context: Context): void {
    this.treeHoleEnabled = enabled;
    // ä¿å­˜åˆ°é¦–é€‰é¡¹
    this.preferencesUtil.putValue(context, TREE_HOLE_ENABLED_KEY, enabled);
    hilog.info(DOMAIN, 'AppConfig', `ğŸ›ï¸ [AppConfigManager] æ ‘æ´åŠŸèƒ½çŠ¶æ€å·²æ›´æ–°: ${enabled}`);
  }

  /**
   * ä»é¦–é€‰é¡¹åŠ è½½æ ‘æ´åŠŸèƒ½è®¾ç½®
   */
  private loadTreeHoleSettings(context: Context): void {
    try {
      // ä»é¦–é€‰é¡¹è·å–æ ‘æ´åŠŸèƒ½çŠ¶æ€ï¼Œé»˜è®¤ä¸ºtrueï¼ˆå¯ç”¨ï¼‰
      const enabled = this.preferencesUtil.getValue(context, TREE_HOLE_ENABLED_KEY, true) as boolean;
      this.treeHoleEnabled = enabled;
      hilog.info(DOMAIN, 'AppConfig', `ğŸ“± [AppConfigManager] åŠ è½½æ ‘æ´åŠŸèƒ½çŠ¶æ€: ${enabled}`);
    } catch (error) {
      hilog.error(DOMAIN, 'AppConfig', `âŒ [AppConfigManager] åŠ è½½æ ‘æ´åŠŸèƒ½è®¾ç½®å¤±è´¥: ${JSON.stringify(error)}`);
      this.treeHoleEnabled = true; // å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤å€¼
    }
  }

  private async performInitialization(context?: Context): Promise<void> {
    try {
      hilog.info(DOMAIN, 'AppConfig', 'ğŸ”„ [AppConfigManager] å¼€å§‹åˆå§‹åŒ–åº”ç”¨é…ç½®...');

      // Step 0: åŠ è½½æ ‘æ´åŠŸèƒ½è®¾ç½®ï¼ˆå¦‚æœæœ‰contextï¼‰
      if (context) {
        this.loadTreeHoleSettings(context);
      }

      // Step 1: è·å–é…ç½®æ•°æ® (å¯¹åº”class-schedule-cçš„api.getKxTime())
      const configResponse = await this.configService.getConfig();
      hilog.info(DOMAIN, 'AppConfig', 'âœ… [AppConfigManager] Configæ•°æ®è·å–æˆåŠŸ');

      // Step 2: è®¡ç®—å½“å‰å­¦æœŸçŠ¶æ€ (å¯¹åº”class-schedule-cçš„getWeeké€»è¾‘)
      const currentStatus = this.configService.calculateCurrentSemesterStatus();
      hilog.info(DOMAIN, 'AppConfig', `âœ… [AppConfigManager] å½“å‰çŠ¶æ€: ${currentStatus.statusText}`);

      // Step 3: è¾“å‡ºå­¦æœŸä¿¡æ¯ä¾›è°ƒè¯•
      const semesterList = this.configService.getSemesterList();
      hilog.info(DOMAIN, 'AppConfig', `ğŸ“š [AppConfigManager] å…±å¤„ç†${semesterList.length}ä¸ªå­¦æœŸæ•°æ®`);

      // Step 4: æ‰“å°ä»Šæ—¥æ—¥æœŸ (å‚ç…§class-schedule-cçš„getNowTimeé€»è¾‘)
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const todayString = `${year}-${month}-${day}`;
      hilog.info(DOMAIN, 'AppConfig', `ğŸ“… [AppConfigManager] ä»Šæ—¥æ—¥æœŸ: ${todayString}`);

      this.isInitialized = true;
      hilog.info(DOMAIN, 'AppConfig', 'ğŸ‰ [AppConfigManager] åº”ç”¨é…ç½®åˆå§‹åŒ–å®Œæˆ');

    } catch (error) {
      hilog.error(DOMAIN, 'AppConfig', 'âŒ [AppConfigManager] é…ç½®åˆå§‹åŒ–å¤±è´¥: %{public}s', JSON.stringify(error));
      this.initPromise = null; // å…è®¸é‡è¯•
      throw new Error(`é…ç½®åˆå§‹åŒ–å¤±è´¥: ${JSON.stringify(error)}`);
    }
  }
}