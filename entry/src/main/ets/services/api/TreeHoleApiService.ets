/**
 * æ ‘æ´åŠŸèƒ½APIæœåŠ¡å°è£…
 * å¤ç”¨ç°æœ‰HttpServiceï¼Œæä¾›æ ‘æ´ç›¸å…³çš„æ•°æ®æ¥å£
 */
import { HttpService } from './HttpService';
import { 
  TreeHoleItem, 
  TreeHoleComment, 
  PostTreeHoleRequest, 
  PostCommentRequest,
  TreeHoleApiResponse,
  TreeHolePaginationData 
} from '../../models/TreeHoleModels';

export class TreeHoleApiService {
  private static instance: TreeHoleApiService;
  private httpService: HttpService = HttpService.getInstance();

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  public static getInstance(): TreeHoleApiService {
    if (!TreeHoleApiService.instance) {
      TreeHoleApiService.instance = new TreeHoleApiService();
    }
    return TreeHoleApiService.instance;
  }

  private constructor() {
    console.info('ğŸŒ³ [TreeHoleApiService] åˆå§‹åŒ–æ ‘æ´APIæœåŠ¡');
  }

  /**
   * è·å–æ ‘æ´åˆ—è¡¨
   */
  public async getTreeHoleList(
    pageNum: number = 1, 
    pageSize: number = 10, 
    status: number = 1
  ): Promise<TreeHolePaginationData<TreeHoleItem>> {
    try {
      console.info(`ğŸŒ³ [TreeHoleApiService] è·å–æ ‘æ´åˆ—è¡¨ - é¡µç :${pageNum}, å¤§å°:${pageSize}, çŠ¶æ€:${status}`);
      
      // æš‚æ—¶è¿”å›Mockæ•°æ®
      return await this.getMockTreeHoleList(pageNum, pageSize, status);
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleApiService] è·å–æ ‘æ´åˆ—è¡¨å¤±è´¥:', error);
      throw new Error('è·å–æ ‘æ´åˆ—è¡¨å¤±è´¥');
    }
  }

  /**
   * è·å–æ ‘æ´è¯„è®ºåˆ—è¡¨
   */
  public async getTreeHoleComments(
    treeHoleId: number, 
    pageNum: number = 1, 
    pageSize: number = 10
  ): Promise<TreeHolePaginationData<TreeHoleComment>> {
    try {
      console.info(`ğŸŒ³ [TreeHoleApiService] è·å–è¯„è®ºåˆ—è¡¨ - æ ‘æ´ID:${treeHoleId}, é¡µç :${pageNum}`);
      
      // æš‚æ—¶è¿”å›Mockæ•°æ®
      return await this.getMockCommentsList(treeHoleId, pageNum, pageSize);
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleApiService] è·å–è¯„è®ºå¤±è´¥:', error);
      throw new Error('è·å–è¯„è®ºå¤±è´¥');
    }
  }

  /**
   * å‘å¸ƒæ ‘æ´
   */
  public async postTreeHole(request: PostTreeHoleRequest): Promise<boolean> {
    try {
      console.info('ğŸŒ³ [TreeHoleApiService] å‘å¸ƒæ ‘æ´:', request.content.substring(0, 20) + '...');
      
      // æš‚æ—¶è¿”å›æˆåŠŸ
      return await this.mockPostTreeHole(request);
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleApiService] å‘å¸ƒæ ‘æ´å¤±è´¥:', error);
      throw new Error('å‘å¸ƒæ ‘æ´å¤±è´¥');
    }
  }

  /**
   * å‘å¸ƒè¯„è®º
   */
  public async postComment(request: PostCommentRequest): Promise<boolean> {
    try {
      console.info(`ğŸŒ³ [TreeHoleApiService] å‘å¸ƒè¯„è®º - æ ‘æ´ID:${request.treeHoleId}`);
      
      // æš‚æ—¶è¿”å›æˆåŠŸ
      return await this.mockPostComment(request);
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleApiService] å‘å¸ƒè¯„è®ºå¤±è´¥:', error);
      throw new Error('å‘å¸ƒè¯„è®ºå¤±è´¥');
    }
  }

  /**
   * ç‚¹èµ/å–æ¶ˆç‚¹èµæ ‘æ´
   */
  public async toggleLike(treeHoleId: number, isLike: boolean): Promise<boolean> {
    try {
      console.info(`ğŸŒ³ [TreeHoleApiService] ${isLike ? 'ç‚¹èµ' : 'å–æ¶ˆç‚¹èµ'} æ ‘æ´ID:${treeHoleId}`);
      
      // æš‚æ—¶è¿”å›æˆåŠŸ
      return true;
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleApiService] ç‚¹èµæ“ä½œå¤±è´¥:', error);
      throw new Error('ç‚¹èµæ“ä½œå¤±è´¥');
    }
  }

  // ====== Mock æ•°æ®æ–¹æ³•ï¼ˆå¼€å‘é˜¶æ®µä½¿ç”¨ï¼‰ ======

  /**
   * Mock æ ‘æ´åˆ—è¡¨æ•°æ®
   */
  private async getMockTreeHoleList(pageNum: number, pageSize: number, status: number): Promise<TreeHolePaginationData<TreeHoleItem>> {
    return new Promise((resolve) => {
      // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
      setTimeout(() => {
        const mockData: TreeHoleItem[] = [
          {
            id: 1,
            content: "ä»Šå¤©çš„è¯¾ç¨‹å®‰æ’å¥½å……å®ï¼Œç»ˆäºç†è§£äº†ArkTSçš„ç”Ÿå‘½å‘¨æœŸæœºåˆ¶ï¼ğŸ’ª",
            author: "åŒ¿åç”¨æˆ·001",
            avatar: "defaultAvatar",
            createTime: "2024-12-06 14:30:00",
            likeCount: 15,
            commentCount: 8,
            isAnonymous: true,
            isLiked: false,
            isTop: status === 3 || status === 4
          },
          {
            id: 2,
            content: "æœ‰æ²¡æœ‰åŒå­¦ä¸€èµ·ç»„é˜Ÿå­¦ä¹ HarmonyOSå¼€å‘çš„ï¼Ÿæ¬¢è¿ç§ä¿¡äº¤æµç»éªŒ~",
            author: "å¼€å‘è€…å°å¼ ",
            avatar: "defaultAvatar", 
            createTime: "2024-12-06 13:45:00",
            likeCount: 23,
            commentCount: 12,
            isAnonymous: false,
            isLiked: true,
            isTop: false
          },
          {
            id: 3,
            content: "åˆšåˆšè§£å†³äº†ä¸€ä¸ªå›°æ‰°æˆ‘å¾ˆä¹…çš„ç»„ä»¶çŠ¶æ€ç®¡ç†é—®é¢˜ï¼Œæ„Ÿè§‰æ•´ä¸ªä¸–ç•Œéƒ½æ˜äº®äº†ï¼âœ¨",
            author: "åŒ¿åç”¨æˆ·002",
            avatar: "defaultAvatar",
            createTime: "2024-12-06 12:20:00", 
            likeCount: 31,
            commentCount: 5,
            isAnonymous: true,
            isLiked: false,
            isTop: false
          }
        ];

        const result: TreeHolePaginationData<TreeHoleItem> = {
          list: mockData,
          pageNum,
          pageSize,
          totalPages: 3,
          total: 25,
          hasNext: pageNum < 3
        };

        resolve(result);
      }, 500); // æ¨¡æ‹Ÿ500msç½‘ç»œå»¶è¿Ÿ
    });
  }

  /**
   * Mock è¯„è®ºåˆ—è¡¨æ•°æ®
   */
  private async getMockCommentsList(treeHoleId: number, pageNum: number, pageSize: number): Promise<TreeHolePaginationData<TreeHoleComment>> {
    return new Promise((resolve) => {
      setTimeout(() => {
        const mockComments: TreeHoleComment[] = [
          {
            id: 1,
            content: "å¤ªèµäº†ï¼æˆ‘ä¹Ÿåœ¨å­¦ä¹ è¿™ä¸ªï¼Œä¸€èµ·åŠ æ²¹ï¼",
            author: "å­¦ä¹ è¾¾äºº",
            avatar: "defaultAvatar",
            createTime: "2024-12-06 15:10:00",
            likeCount: 5,
            dislikeCount: 0,
            isLiked: true,
            isDisliked: false,
            isAnonymous: false,
            treeHoleId: treeHoleId
          },
          {
            id: 2,
            content: "æœ‰ä»€ä¹ˆå¥½çš„å­¦ä¹ èµ„æºæ¨èå—ï¼Ÿ",
            author: "åŒ¿åç”¨æˆ·003",
            avatar: "defaultAvatar",
            createTime: "2024-12-06 15:25:00",
            likeCount: 2,
            dislikeCount: 0,
            isLiked: false,
            isDisliked: false,
            isAnonymous: true,
            treeHoleId: treeHoleId
          }
        ];

        const result: TreeHolePaginationData<TreeHoleComment> = {
          list: mockComments,
          pageNum,
          pageSize,
          totalPages: 1,
          total: 2,
          hasNext: false
        };

        resolve(result);
      }, 300);
    });
  }

  /**
   * Mock å‘å¸ƒæ ‘æ´
   */
  private async mockPostTreeHole(request: PostTreeHoleRequest): Promise<boolean> {
    return new Promise((resolve) => {
      setTimeout(() => {
        console.info('ğŸŒ³ [Mock] å‘å¸ƒæˆåŠŸ');
        resolve(true);
      }, 800);
    });
  }

  /**
   * Mock å‘å¸ƒè¯„è®º
   */
  private async mockPostComment(request: PostCommentRequest): Promise<boolean> {
    return new Promise((resolve) => {
      setTimeout(() => {
        console.info('ğŸŒ³ [Mock] è¯„è®ºå‘å¸ƒæˆåŠŸ');
        resolve(true);
      }, 600);
    });
  }
}