import {
  PostCommentRequest,
  PostTreeHoleRequest,
  TreeHoleApiPaginationData,
  TreeHoleComment,
  TreeHoleItem,
  TreeHolePaginationData,
  TreeHolePicture,
  GetPicturesRequest
} from '../../models/TreeHoleModels';
import { ApiResponse, HttpService } from './HttpService';
import { UserInfoManager } from '../../common/utils/UserInfoManager';

// å¯¼å‡ºç±»å‹
export {
  TreeHoleItem,
  TreeHoleComment,
  PostTreeHoleRequest,
  PostCommentRequest,
  TreeHolePicture,
  GetPicturesRequest
} from '../../models/TreeHoleModels';

/**
 * æ ‘æ´APIè¯·æ±‚å‚æ•°æ¥å£
 */
export interface TreeHoleRequestParams {
  /** çŠ¶æ€ç­›é€‰ (1-æ­£å¸¸, 0-ç¦ç”¨ç­‰) */
  status?: number;

  /** é¡µç  */
  pageNum?: number;

  /** æ¯é¡µæ•°é‡ */
  pageSize?: number;

  /** æ ‘æ´ç±»å‹ (3-æ™®é€šæ ‘æ´ç­‰) */
  type?: number;

  /** çˆ¶çº§ID (ç”¨äºè·å–è¯„è®ºï¼Œè¯„è®ºçš„parentIdä¸ºæ ‘æ´ID) */
  parentId?: number;
}

/**
 * è¯„è®ºè¯·æ±‚å‚æ•°æ¥å£
 */
export interface CommentsRequestParams {
  /** æ ‘æ´ID */
  treeHoleId: number;

  /** é¡µç  */
  pageNum?: number;

  /** æ¯é¡µæ•°é‡ */
  pageSize?: number;
}

/**
 * è·å–è¯„è®ºçš„è¯·æ±‚å‚æ•°æ¥å£ï¼ˆåŸºäºparentIdçš„æ–¹å¼ï¼‰
 */
export interface GetCommentsRequestParams {
  /** çˆ¶çº§ID (å¯¹åº”æ ‘æ´ID) */
  parentId: number;

  /** é¡µç  */
  pageNum: number;

  /** æ¯é¡µæ•°é‡ */
  pageSize: number;

  /** çŠ¶æ€ç­›é€‰ */
  status: number;
}

/**
 * ç‚¹èµè¯·æ±‚å‚æ•°æ¥å£
 */
export interface LikeRequestParams {
  /** æ ‘æ´ID */
  treeHoleId: number;

  /** æ˜¯å¦ç‚¹èµ (true-ç‚¹èµ, false-å–æ¶ˆç‚¹èµ) */
  isLike: boolean;
}

/**
 * è¯„è®ºç‚¹èµè¯·æ±‚å‚æ•°æ¥å£
 */
export interface CommentLikeRequestParams {
  /** è¯„è®ºID */
  commentId: number;

  /** æ˜¯å¦ç‚¹èµ (true-ç‚¹èµ, false-å–æ¶ˆç‚¹èµ) */
  isLike: boolean;
}

/**
 * è¯„è®ºç‚¹è¸©è¯·æ±‚å‚æ•°æ¥å£
 */
export interface CommentDislikeRequestParams {
  /** è¯„è®ºID */
  commentId: number;

  /** æ˜¯å¦ç‚¹è¸© (true-ç‚¹è¸©, false-å–æ¶ˆç‚¹è¸©) */
  isDislike: boolean;
}

/**
 * åˆ é™¤æ ‘æ´è¯·æ±‚å‚æ•°æ¥å£
 */
export interface DeleteTreeHoleRequestParams {
  /** æ ‘æ´ID */
  treeHoleId: number;
}

/**
 * åˆ é™¤è¯„è®ºè¯·æ±‚å‚æ•°æ¥å£
 */
export interface DeleteCommentRequestParams {
  /** è¯„è®ºID */
  commentId: number;
}

/**
 * æ ‘æ´åŠŸèƒ½APIæœåŠ¡å°è£…
 * åŸºäºHttpServiceå®ç°çœŸå®çš„APIè¯·æ±‚
 */
export class TreeHoleApiService {
  private static instance: TreeHoleApiService;
  private httpService = HttpService.getInstance();
  private userInfoManager = UserInfoManager.getInstance();

  private constructor() {
    console.info('ğŸŒ³ [TreeHoleApiService] åˆå§‹åŒ–æ ‘æ´APIæœåŠ¡');
  }

  public static getInstance(): TreeHoleApiService {
    if (!TreeHoleApiService.instance) {
      TreeHoleApiService.instance = new TreeHoleApiService();
    }
    return TreeHoleApiService.instance;
  }

  /**
   * è·å–æ ‘æ´åˆ—è¡¨
   * GET /treeHole/get?status=1&pageNum=1&pageSize=10
   */
  public async getTreeHoleList(
    pageNum: number = 1,
    pageSize: number = 10,
    status: number = 1,
    type?: number
  ): Promise<TreeHolePaginationData<TreeHoleItem>> {
    try {
      console.info(`ğŸŒ³ [TreeHoleApiService] è·å–æ ‘æ´åˆ—è¡¨ - é¡µç :${pageNum}, å¤§å°:${pageSize}, çŠ¶æ€:${status}`);

      const params: TreeHoleRequestParams = {
        status,
        pageNum,
        pageSize
      };

      if (type !== undefined) {
        params.type = type;
      }

      const response =
        await this.httpService.get<TreeHoleRequestParams, TreeHoleApiPaginationData<TreeHoleItem>>('/treeHole/get',
          params);

      // è½¬æ¢åç«¯æ•°æ®ç»“æ„ä¸ºå‰ç«¯æœŸæœ›çš„æ ¼å¼
      const result: TreeHolePaginationData<TreeHoleItem> = {
        list: response.data.treeHoleVOList || [],
        pageNum: pageNum,
        pageSize: pageSize,
        totalPages: response.data.pageCount || 1,
        // ä¼°ç®—æ€»è®°å½•æ•°ï¼šå¦‚æœæ˜¯æœ€åä¸€é¡µç”¨å½“å‰é¡µæ•°æ®é‡ï¼Œå¦åˆ™ç”¨pageSize * totalPagesä¼°ç®—
        total: pageNum >= (response.data.pageCount || 1)
          ? (pageNum - 1) * pageSize + (response.data.treeHoleVOList || []).length
          : (response.data.pageCount || 1) * pageSize,
        hasNext: pageNum < (response.data.pageCount || 1)
      };

      console.info(`ğŸŒ³ [TreeHoleApiService] è·å–æ ‘æ´åˆ—è¡¨æˆåŠŸï¼Œå…±${result.list.length}æ¡æ•°æ®`);
      return result;
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleApiService] è·å–æ ‘æ´åˆ—è¡¨å¤±è´¥:', error);
      throw new Error('è·å–æ ‘æ´åˆ—è¡¨å¤±è´¥');
    }
  }

  /**
   * è·å–æ ‘æ´è¯„è®ºåˆ—è¡¨
   * GET /treeHole/get?parentId=xxx&pageNum=1&pageSize=10&status=1
   */
  public async getTreeHoleComments(
    treeHoleId: number,
    pageNum: number = 1,
    pageSize: number = 10
  ): Promise<TreeHolePaginationData<TreeHoleComment>> {
    try {
      console.info(`ğŸŒ³ [TreeHoleApiService] è·å–è¯„è®ºåˆ—è¡¨ - æ ‘æ´ID:${treeHoleId}, é¡µç :${pageNum}`);

      // ä½¿ç”¨/treeHole/getæ¥å£ï¼Œé€šè¿‡parentIdå‚æ•°è·å–è¯„è®º
      const params: GetCommentsRequestParams = {
        parentId: treeHoleId,
        pageNum: pageNum,
        pageSize: pageSize,
        status: 1  // è·å–æ­£å¸¸çŠ¶æ€çš„è¯„è®º
      };

      const response =
        await this.httpService.get<GetCommentsRequestParams, TreeHoleApiPaginationData<TreeHoleItem>>('/treeHole/get',
          params);

      // å°†TreeHoleItemè½¬æ¢ä¸ºTreeHoleCommentæ ¼å¼
      const comments: TreeHoleComment[] =
        (response.data.treeHoleVOList || []).map((item: TreeHoleItem): TreeHoleComment => ({
          id: item.id,
          content: item.content,
          author: item.anonymous === 1 ? (item.nickName || `åŒ¿åç”¨æˆ·${item.userId}`) : item.realName,
          avatar: item.avatar,
          createTime: item.createAt,
          likeCount: item.likes,
          dislikeCount: item.unlikes,
          isLiked: item.isLike === 1,
          isDisliked: item.isUnlike === 1,
          isAnonymous: item.anonymous === 1,
          treeHoleId: treeHoleId
        }));

      // æ„é€ å‰ç«¯æœŸæœ›çš„åˆ†é¡µæ•°æ®æ ¼å¼
      const result: TreeHolePaginationData<TreeHoleComment> = {
        list: comments,
        pageNum: pageNum,
        pageSize: pageSize,
        totalPages: response.data.pageCount || 1,
        total: pageNum >= (response.data.pageCount || 1)
          ? (pageNum - 1) * pageSize + comments.length
          : (response.data.pageCount || 1) * pageSize,
        hasNext: pageNum < (response.data.pageCount || 1)
      };

      console.info(`ğŸŒ³ [TreeHoleApiService] è·å–è¯„è®ºåˆ—è¡¨æˆåŠŸï¼Œå…±${comments.length}æ¡æ•°æ®`);
      return result;
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleApiService] è·å–è¯„è®ºå¤±è´¥:', error);
      throw new Error('è·å–è¯„è®ºå¤±è´¥');
    }
  }

  /**
   * å‘å¸ƒæ ‘æ´
   * POST /treeHole/add
   */
  public async postTreeHole(request: PostTreeHoleRequest): Promise<ApiResponse<boolean>> {
    try {
      console.info('ğŸŒ³ [TreeHoleApiService] å‘å¸ƒæ ‘æ´:', request.content.substring(0, 20) + '...');

      const response = await this.httpService.post<PostTreeHoleRequest, boolean>('/treeHole/add', request);

      console.info('ğŸŒ³ [TreeHoleApiService] å‘å¸ƒæ ‘æ´æˆåŠŸ');
      return response;
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleApiService] å‘å¸ƒæ ‘æ´å¤±è´¥:', error);
      throw new Error('å‘å¸ƒæ ‘æ´å¤±è´¥');
    }
  }

  /**
   * å‘å¸ƒè¯„è®º
   * POST /treeHole/add (å‚è€ƒclass-schedule-cå®ç°)
   */
  public async postComment(request: PostCommentRequest): Promise<ApiResponse<boolean>> {
    try {
      console.info(`ğŸŒ³ [TreeHoleApiService] å‘å¸ƒè¯„è®º - æ ‘æ´ID:${request.treeHoleId}`);

      // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸å‘å¸ƒæ ‘æ´çš„æ–¹å¼ä¸€è‡´ï¼‰
      const currentUser = this.userInfoManager.getCurrentUserInfo(undefined);
      if (!currentUser || !currentUser.userId) {
        throw new Error('ç”¨æˆ·æœªç™»å½•æˆ–ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥');
      }

      // è½¬æ¢ä¸ºåç«¯æœŸæœ›çš„PostTreeHoleRequestæ ¼å¼ï¼ˆä¸å‘å¸ƒæ ‘æ´å®Œå…¨ä¸€è‡´ï¼‰
      const backendRequest: PostTreeHoleRequest = {
        content: request.content,
        anonymous: request.isAnonymous ? 1 : 0,
        parentId: request.treeHoleId, // è¯„è®ºæ—¶parentIdä¸ºæ ‘æ´ID
        userId: currentUser.userId, // ä½¿ç”¨çœŸå®çš„ç”¨æˆ·IDï¼ˆä¸å‘å¸ƒæ ‘æ´ä¸€è‡´ï¼‰
        deleteTime: "" // è¯„è®ºä¸è®¾ç½®åˆ é™¤æ—¶é—´
      };

      console.info(`ğŸŒ³ [TreeHoleApiService] è¯„è®ºè¯·æ±‚å‚æ•°:`, JSON.stringify(backendRequest));

      const response = await this.httpService.post<PostTreeHoleRequest, boolean>('/treeHole/add', backendRequest);

      console.info('ğŸŒ³ [TreeHoleApiService] å‘å¸ƒè¯„è®ºæˆåŠŸ');
      return response;
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleApiService] å‘å¸ƒè¯„è®ºå¤±è´¥:', error);
      throw new Error('å‘å¸ƒè¯„è®ºå¤±è´¥');
    }
  }

  /**
   * å‘å¸ƒè¯„è®ºï¼ˆä½¿ç”¨å®Œæ•´è¯·æ±‚å‚æ•°ï¼‰
   * POST /treeHole/add (ä¸å‘å¸ƒæ ‘æ´ä½¿ç”¨ç›¸åŒçš„æ¥å£å’Œæ ¼å¼)
   */
  public async postCommentWithFullRequest(request: PostTreeHoleRequest): Promise<ApiResponse<boolean>> {
    try {
      console.info(`ğŸŒ³ [TreeHoleApiService] å‘å¸ƒè¯„è®ºï¼ˆå®Œæ•´å‚æ•°ï¼‰ - æ ‘æ´ID:${request.parentId}`);
      console.info(`ğŸŒ³ [TreeHoleApiService] è¯„è®ºè¯·æ±‚å‚æ•°:`, JSON.stringify(request));

      const response = await this.httpService.post<PostTreeHoleRequest, boolean>('/treeHole/add', request);

      console.info('ğŸŒ³ [TreeHoleApiService] å‘å¸ƒè¯„è®ºæˆåŠŸ');
      return response;
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleApiService] å‘å¸ƒè¯„è®ºå¤±è´¥:', error);
      throw new Error('å‘å¸ƒè¯„è®ºå¤±è´¥');
    }
  }

  /**
   * ç‚¹èµ/å–æ¶ˆç‚¹èµæ ‘æ´
   * POST /treeHole/like
   */
  public async toggleLike(treeHoleId: number, isLike: boolean): Promise<ApiResponse<boolean>> {
    try {
      console.info(`ğŸŒ³ [TreeHoleApiService] ${isLike ? 'ç‚¹èµ' : 'å–æ¶ˆç‚¹èµ'} æ ‘æ´ID:${treeHoleId}`);

      const params: LikeRequestParams = {
        treeHoleId,
        isLike
      };

      const response = await this.httpService.post<LikeRequestParams, boolean>('/treeHole/like', params);

      console.info(`ğŸŒ³ [TreeHoleApiService] ${isLike ? 'ç‚¹èµ' : 'å–æ¶ˆç‚¹èµ'}æˆåŠŸ`);
      return response;
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleApiService] ç‚¹èµæ“ä½œå¤±è´¥:', error);
      throw new Error('ç‚¹èµæ“ä½œå¤±è´¥');
    }
  }

  /**
   * ç‚¹èµ/å–æ¶ˆç‚¹èµè¯„è®º
   * POST /treeHole/comment/like
   */
  public async toggleCommentLike(commentId: number, isLike: boolean): Promise<ApiResponse<boolean>> {
    try {
      console.info(`ğŸŒ³ [TreeHoleApiService] ${isLike ? 'ç‚¹èµ' : 'å–æ¶ˆç‚¹èµ'} è¯„è®ºID:${commentId}`);

      const params: CommentLikeRequestParams = {
        commentId,
        isLike
      };

      const response = await this.httpService.post<CommentLikeRequestParams, boolean>('/treeHole/comment/like', params);

      console.info(`ğŸŒ³ [TreeHoleApiService] è¯„è®º${isLike ? 'ç‚¹èµ' : 'å–æ¶ˆç‚¹èµ'}æˆåŠŸ`);
      return response;
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleApiService] è¯„è®ºç‚¹èµæ“ä½œå¤±è´¥:', error);
      throw new Error('è¯„è®ºç‚¹èµæ“ä½œå¤±è´¥');
    }
  }

  /**
   * ç‚¹è¸©/å–æ¶ˆç‚¹è¸©è¯„è®º
   * POST /treeHole/comment/dislike
   */
  public async toggleCommentDislike(commentId: number, isDislike: boolean): Promise<ApiResponse<boolean>> {
    try {
      console.info(`ğŸŒ³ [TreeHoleApiService] ${isDislike ? 'ç‚¹è¸©' : 'å–æ¶ˆç‚¹è¸©'} è¯„è®ºID:${commentId}`);

      const params: CommentDislikeRequestParams = {
        commentId,
        isDislike
      };

      const response =
        await this.httpService.post<CommentDislikeRequestParams, boolean>('/treeHole/comment/dislike', params);

      console.info(`ğŸŒ³ [TreeHoleApiService] è¯„è®º${isDislike ? 'ç‚¹è¸©' : 'å–æ¶ˆç‚¹è¸©'}æˆåŠŸ`);
      return response;
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleApiService] è¯„è®ºç‚¹è¸©æ“ä½œå¤±è´¥:', error);
      throw new Error('è¯„è®ºç‚¹è¸©æ“ä½œå¤±è´¥');
    }
  }

  /**
   * åˆ é™¤æ ‘æ´
   * DELETE /treeHole/delete?treeHoleId=xxx
   */
  public async deleteTreeHole(treeHoleId: number): Promise<ApiResponse<boolean>> {
    try {
      console.info(`ğŸŒ³ [TreeHoleApiService] åˆ é™¤æ ‘æ´ID:${treeHoleId}`);

      const params: DeleteTreeHoleRequestParams = { treeHoleId };
      const response = await this.httpService.delete<DeleteTreeHoleRequestParams, boolean>('/treeHole/delete', params);

      console.info('ğŸŒ³ [TreeHoleApiService] åˆ é™¤æ ‘æ´æˆåŠŸ');
      return response;
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleApiService] åˆ é™¤æ ‘æ´å¤±è´¥:', error);
      throw new Error('åˆ é™¤æ ‘æ´å¤±è´¥');
    }
  }

  /**
   * åˆ é™¤è¯„è®º
   * DELETE /treeHole/comment/delete?commentId=xxx
   */
  public async deleteComment(commentId: number): Promise<ApiResponse<boolean>> {
    try {
      console.info(`ğŸŒ³ [TreeHoleApiService] åˆ é™¤è¯„è®ºID:${commentId}`);

      const params: DeleteCommentRequestParams = { commentId };
      const response =
        await this.httpService.delete<DeleteCommentRequestParams, boolean>('/treeHole/comment/delete', params);

      console.info('ğŸŒ³ [TreeHoleApiService] åˆ é™¤è¯„è®ºæˆåŠŸ');
      return response;
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleApiService] åˆ é™¤è¯„è®ºå¤±è´¥:', error);
      throw new Error('åˆ é™¤è¯„è®ºå¤±è´¥');
    }
  }

  /**
   * è·å–æ ‘æ´å›¾ç‰‡
   * GET /picture/getPictures?treeHoleId=xxx
   */
  public async getPictures(treeHoleId: number): Promise<TreeHolePicture[]> {
    try {
      console.info(`ğŸŒ³ [TreeHoleApiService] è·å–æ ‘æ´å›¾ç‰‡ - æ ‘æ´ID:${treeHoleId}`);

      const params: GetPicturesRequest = { treeHoleId };
      const response = await this.httpService.get<GetPicturesRequest, TreeHolePicture[]>('/picture/getPictures', params);

      console.info(`ğŸŒ³ [TreeHoleApiService] è·å–æ ‘æ´å›¾ç‰‡æˆåŠŸï¼Œå…±${response.data.length}å¼ å›¾ç‰‡`);
      return response.data;
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleApiService] è·å–æ ‘æ´å›¾ç‰‡å¤±è´¥:', error);
      throw new Error('è·å–æ ‘æ´å›¾ç‰‡å¤±è´¥');
    }
  }

  /**
   * æ„å»ºæ ‘æ´åˆ—è¡¨è¯·æ±‚å‚æ•°çš„ä¾¿æ·æ–¹æ³•
   */
  public buildTreeHoleParams(pageNum: number = 1, pageSize: number = 10, status: number = 1,
    type?: number): TreeHoleRequestParams {
    const params: TreeHoleRequestParams = {
      status,
      pageNum,
      pageSize
    };

    if (type !== undefined) {
      params.type = type;
    }

    return params;
  }

  /**
   * æ„å»ºè¯„è®ºè¯·æ±‚å‚æ•°çš„ä¾¿æ·æ–¹æ³•
   */
  public buildCommentsParams(treeHoleId: number, pageNum: number = 1, pageSize: number = 10): CommentsRequestParams {
    return {
      treeHoleId,
      pageNum,
      pageSize
    };
  }
}