import { ApiResponse, HttpService } from './HttpService';
import { DateUtil } from '../../common/utils/DateUtil';
import { ConfigApiResponseData, CurrentSemesterStatus, SemesterInfo, WeekDateRange } from '../../models/ConfigModels';

// å¯¼å‡ºç±»å‹
export { CurrentSemesterStatus, SemesterInfo } from '../../models/ConfigModels';

// æœ€è¿œå­¦æœŸä¿¡æ¯æ¥å£
interface FarthestSemesterInfo {
  semester: SemesterInfo | null;
  academicYear: string;
  semesterNumber: number;
  totalWeeks: number;
}


export class ConfigApiService {
  private static instance: ConfigApiService;
  private semesterList: SemesterInfo[] = [];
  private currentStatus: CurrentSemesterStatus | null = null;
  
  // ç¼“å­˜æœ€è¿œå­¦æœŸä¿¡æ¯ï¼Œç”¨äºå³æ»‘æé™åˆ¤æ–­
  private farthestSemester: SemesterInfo | null = null;
  private farthestAcademicYear: string = '';
  private farthestSemesterNumber: number = 0;
  private farthestTotalWeeks: number = 0;

  private constructor() {
  }

  public static getInstance(): ConfigApiService {
    if (!ConfigApiService.instance) {
      ConfigApiService.instance = new ConfigApiService();
    }
    return ConfigApiService.instance;
  }

  /**
   * è·å–é…ç½®ä¿¡æ¯
   */
  public async getConfig(): Promise<ApiResponse<ConfigApiResponseData>> {
    try {
      const response = await HttpService.getInstance().get<null, Record<string, Object>>('/config');

      // è½¬æ¢åŸå§‹æ•°æ®ä¸ºMapç»“æ„
      const rawData = response.data as Record<string, Record<string, string[]>>;
      const startMap = new Map<string, string[]>();
      const endMap = new Map<string, string[]>();

      if (rawData.start) {
        Object.keys(rawData.start).forEach((key: string) => {
          startMap.set(key, rawData.start[key]);
        });
      }

      if (rawData.end) {
        Object.keys(rawData.end).forEach((key: string) => {
          endMap.set(key, rawData.end[key]);
        });
      }

      // æ„å»ºå®Œæ•´çš„å“åº”å¯¹è±¡
      const configResponse: ApiResponse<ConfigApiResponseData> = {
        msg: "æ“ä½œæˆåŠŸ",
        code: response.code || 200,
        data: { start: startMap, end: endMap }
      };
      // å¤„ç†å­¦æœŸæ•°æ®
      this.processSemesterData(configResponse.data);

      return configResponse;
    } catch (error) {
      console.error('è·å–é…ç½®å¤±è´¥:', error);
      throw new Error('è·å–é…ç½®å¤±è´¥');
    }
  }

  /**
   * è®¡ç®—å½“å‰å­¦æœŸçŠ¶æ€ (å®Œå…¨å‚è€ƒclass-schedule-cé€»è¾‘)
   */
  public calculateCurrentSemesterStatus(currentDate?: Date): CurrentSemesterStatus {
    const today = currentDate || new Date();

    // å…ˆæ‰¾åˆ°æœ€è¿‘ç»“æŸçš„å­¦æœŸï¼Œè®¡ç®—æŒ‰è¯¥å­¦æœŸçš„å‘¨æ•°
    let mostRecentEndedSemester: SemesterInfo | null = null;
    let latestEndDate = new Date(0); // æœ€æ—©æ—¶é—´

    // æŸ¥æ‰¾å½“å‰æ—¥æœŸæ‰€åœ¨çš„å­¦æœŸï¼Œå¦‚æœæ²¡æœ‰ï¼Œæ‰¾æœ€è¿‘ç»“æŸçš„å­¦æœŸ
    for (const semester of this.semesterList) {
      // ä½¿ç”¨æ›´å®‰å…¨çš„æ—¥æœŸè§£ææ–¹å¼
      const startDateParts = semester.startDate.split('-');
      const endDateParts = semester.endDate.split('-');

      const startDate = new Date(
        parseInt(startDateParts[0]),
        parseInt(startDateParts[1]) - 1, // æœˆä»½ä»0å¼€å§‹
        parseInt(startDateParts[2])
      );
      const endDate = new Date(
        parseInt(endDateParts[0]),
        parseInt(endDateParts[1]) - 1, // æœˆä»½ä»0å¼€å§‹
        parseInt(endDateParts[2])
      );

      // ä½¿ç”¨DateUtilè¿›è¡Œå®‰å…¨çš„æ—¥æœŸæ¯”è¾ƒ
      if (DateUtil.isBetween(today, startDate, endDate)) {
        // åœ¨å­¦æœŸä¸­ï¼Œè®¡ç®—å½“å‰å‘¨æ•°
        const currentWeek = this.calculateWeekInSemester(semester.startDate, today);

        this.currentStatus = {
          isInSemester: true,
          isInHoliday: false,
          currentSemester: semester,
          currentWeek,
          statusText: `ç¬¬${currentWeek}å‘¨`
        };

        console.info(`ğŸ“… [Current Status] å½“å‰åœ¨${semester.academicYear}å­¦å¹´ç¬¬${semester.semester}å­¦æœŸç¬¬${currentWeek}å‘¨`);
        return this.currentStatus;
      }

      // è®°å½•æœ€è¿‘ç»“æŸçš„å­¦æœŸ - ä½¿ç”¨DateUtilè¿›è¡Œå®‰å…¨æ¯”è¾ƒ
      if (DateUtil.isAfter(today, endDate) && DateUtil.isAfter(endDate, latestEndDate)) {
        latestEndDate = endDate;
        mostRecentEndedSemester = semester;
      }
    }

    // ä¸åœ¨ä»»ä½•å­¦æœŸä¸­ï¼Œä½¿ç”¨æœ€è¿‘ç»“æŸçš„å­¦æœŸæ¥è®¡ç®—"å‡æƒ³å‘¨æ•°"
    if (mostRecentEndedSemester) {
      const calculatedWeek = this.calculateWeekInSemester(mostRecentEndedSemester.startDate, today);

      console.info(`ğŸ“… [Week Debug] æœ€è¿‘ç»“æŸå­¦æœŸ: ${mostRecentEndedSemester.academicYear}å­¦å¹´ç¬¬${mostRecentEndedSemester.semester}å­¦æœŸ`);
      console.info(`ğŸ“… [Week Debug] å­¦æœŸå¼€å§‹: ${mostRecentEndedSemester.startDate}, å½“å‰æ—¥æœŸ: ${today.getFullYear()}-${String(today.getMonth() +
        1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`);
      console.info(`ğŸ“… [Week Debug] è®¡ç®—å‡ºçš„å‘¨æ•°: ${calculatedWeek}`);

      this.currentStatus = {
        isInSemester: false,
        isInHoliday: true,
        currentSemester: mostRecentEndedSemester, // æ˜¾ç¤ºæœ€è¿‘ç»“æŸçš„å­¦æœŸ
        currentWeek: calculatedWeek, // æ˜¾ç¤ºè¶…å‡ºçš„å‘¨æ•°
        statusText: "å‡æœŸä¸­"
      };

      console.info(`ğŸ“… [Current Status] å½“å‰åœ¨å‡æœŸä¸­ï¼ŒæŒ‰${mostRecentEndedSemester.academicYear}å­¦å¹´ç¬¬${mostRecentEndedSemester.semester}å­¦æœŸè®¡ç®—ä¸ºç¬¬${calculatedWeek}å‘¨`);
      return this.currentStatus;
    }

    // æ‰¾ä¸åˆ°ä»»ä½•ç›¸å…³å­¦æœŸï¼Œä½¿ç”¨æœ€æ—©çš„æœªæ¥å­¦æœŸä½œä¸ºå‚è€ƒ
    let earliestFutureSemester: SemesterInfo | null = null;
    let earliestStartDate = new Date(9999, 0, 1); // å¾ˆè¿œçš„æœªæ¥æ—¶é—´

    for (const semester of this.semesterList) {
      const startDate = new Date(semester.startDate);
      if (DateUtil.isAfter(startDate, today) && DateUtil.isBefore(startDate, earliestStartDate)) {
        earliestStartDate = startDate;
        earliestFutureSemester = semester;
      }
    }

    this.currentStatus = {
      isInSemester: false,
      isInHoliday: true,
      currentSemester: earliestFutureSemester || undefined,
      currentWeek: 1,
      statusText: "å‡æœŸä¸­"
    };

    const semesterInfo = earliestFutureSemester
      ? `å³å°†å¼€å§‹${earliestFutureSemester.academicYear}å­¦å¹´ç¬¬${earliestFutureSemester.semester}å­¦æœŸ`
      : 'æœªæ‰¾åˆ°ç›¸å…³å­¦æœŸ';
    console.info(`ğŸ“… [Current Status] å½“å‰åœ¨å‡æœŸä¸­ï¼Œ${semesterInfo}`);
    return this.currentStatus;
  }

  /**
   * è®¡ç®—æŸä¸ªå­¦æœŸå†…çš„å½“å‰å‘¨æ•° (å®Œå…¨æŒ‰ç…§class-schedule-cçš„getWeeké€»è¾‘)
   */
  public calculateWeekInSemester(startDate: string, currentDate: Date): number {
    // è§£æå¼€å§‹æ—¥æœŸ - å®Œå…¨æŒ‰ç…§class-schedule-cçš„æ–¹å¼
    const startDateArray = startDate.split("-"); // ["2025", "09", "08"]
    const semesterStartDate =
      new Date(startDateArray[1] + '-' + startDateArray[2] + '-' + startDateArray[0]); // "09-08-2025"

    // è§£æå½“å‰æ—¥æœŸ - å®Œå…¨æŒ‰ç…§class-schedule-cçš„getNowTimeå’ŒgetWeeké€»è¾‘
    const currentYear = currentDate.getFullYear();
    const currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
    const currentDay = String(currentDate.getDate()).padStart(2, '0');
    const nowTimeString = currentYear + '-' + currentMonth + '-' + currentDay; // "2025-08-23"

    const nowDateArray = nowTimeString.split("-"); // ["2025", "08", "23"]
    const todayDate = new Date(nowDateArray[1] + '-' + nowDateArray[2] + '-' + nowDateArray[0]); // "08-23-2025"

    // è®¡ç®—ç›¸å·®å¤©æ•° (å®Œå…¨æŒ‰ç…§class-schedule-cé€»è¾‘)
    const timeDifference = todayDate.getTime() - semesterStartDate.getTime();
    const daysDifference = Math.floor(timeDifference / (1000 * 60 * 60 * 24)); // iDays

    // è®¡ç®—å‘¨æ•° (å®Œå…¨æŒ‰ç…§class-schedule-cçš„getWeeké€»è¾‘)
    let currentWeek: number;
    if (daysDifference < 0) {
      currentWeek = -1; // å¤©æ•°å·®<0ï¼Œå‘¨æ•°ç»Ÿä¸€è®¾ä¸º-1
    } else if (0 <= daysDifference && daysDifference <= 6) {
      currentWeek = 1; // 0<=å¤©æ•°å·®<=6ï¼Œåœ¨ç¬¬ä¸€å‘¨
    } else {
      currentWeek = Math.ceil((daysDifference - 6) / 7) + 1; // å¤§äº6å¤šä½™çš„éƒ¨åˆ†æ¯å¤š7å¤©åŠ 1å‘¨
    }

    console.info(`ğŸ“… [Week Calculation] ${startDate} -> ${nowTimeString}, ç›¸å·®${daysDifference}å¤©, ç¬¬${currentWeek}å‘¨`);
    return currentWeek;
  }

  /**
   * è·å–æ‰€æœ‰å­¦æœŸåˆ—è¡¨
   */
  public getSemesterList(): SemesterInfo[] {
    return this.semesterList;
  }

  /**
   * è·å–å½“å‰çŠ¶æ€
   */
  public getCurrentStatus(): CurrentSemesterStatus | null {
    return this.currentStatus;
  }

  /**
   * æ ¹æ®å­¦å¹´å’Œå­¦æœŸè·å–å­¦æœŸä¿¡æ¯
   */
  public getSemesterInfo(academicYear: string, semester: number): SemesterInfo | null {
    return this.semesterList.find(sem => sem.academicYear === academicYear && sem.semester === semester) || null;
  }

  /**
   * è·å–ä¸Šä¸€ä¸ª/ä¸‹ä¸€ä¸ªå­¦æœŸ
   */
  public getAdjacentSemester(current: SemesterInfo, direction: 'prev' | 'next'): SemesterInfo | null {
    const currentIndex = this.semesterList.findIndex(sem =>
    sem.academicYear === current.academicYear && sem.semester === current.semester
    );

    if (currentIndex === -1) {
      return null;
    }

    const targetIndex = direction === 'prev' ? currentIndex - 1 : currentIndex + 1;
    return this.semesterList[targetIndex] || null;
  }

  /**
   * è®¡ç®—æŒ‡å®šå‘¨çš„æ—¥æœŸèŒƒå›´
   */
  public calculateWeekDates(startDate: string, weekNum: number): WeekDateRange {
    const semesterStart = new Date(startDate);

    // è®¡ç®—è¯¥å‘¨çš„å¼€å§‹æ—¥æœŸ (å‘¨ä¸€)
    const daysToAdd = (weekNum - 1) * 7;
    const weekStart = new Date(semesterStart);
    weekStart.setDate(semesterStart.getDate() + daysToAdd);

    // æ‰¾åˆ°è¯¥å‘¨çš„å‘¨ä¸€
    const dayOfWeek = weekStart.getDay();
    const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    weekStart.setDate(weekStart.getDate() + daysToMonday);

    // è®¡ç®—è¯¥å‘¨çš„ç»“æŸæ—¥æœŸ (å‘¨æ—¥)
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);

    return {
      startDate: weekStart,
      endDate: weekEnd
    };
  }

  /**
   * æ ¼å¼åŒ–æ—¥æœŸä¸ºå­—ç¬¦ä¸²
   */
  public formatDateString(date: Date): string {
    const month = date.getMonth() + 1;
    const day = date.getDate();
    return `${month}æœˆ${day}æ—¥`;
  }

  /**
   * è·å–æœˆä»½
   */
  public getMonthString(date: Date): string {
    const month = date.getMonth() + 1;
    return `${month}æœˆ`;
  }

  /**
   * å‘åå…¼å®¹çš„æ–¹æ³• - è®¡ç®—å½“å‰å‘¨æ•°
   */
  public calculateCurrentWeek(startDate: string, currentDate?: Date): number {
    const status = this.calculateCurrentSemesterStatus(currentDate);
    return status.currentWeek;
  }

  /**
   * åˆ¤æ–­æ˜¯å¦å¯ä»¥å‰å¾€ä¸Šä¸€å‘¨ï¼ˆå³æ»‘æ“ä½œï¼Œå‘è¿‡å»ç¿»é¡µï¼‰
   * @param currentDate å½“å‰æ˜¾ç¤ºçš„æ—¥æœŸ
   * @param className å½“å‰ç”¨æˆ·çš„ç­çº§åç§°
   * @returns trueè¡¨ç¤ºå¯ä»¥å‰å¾€ä¸Šä¸€å‘¨ï¼Œfalseè¡¨ç¤ºå·²åˆ°æé™
   */
  public canSwipeLeft(currentDate: Date, className?: string): boolean {
    if (this.semesterList.length === 0) {
      return false;
    }

    // å¦‚æœæœ‰ç­çº§ä¿¡æ¯ï¼Œæ ¹æ®ç­çº§å¹´çº§è¿›è¡Œæ ¡éªŒ
    if (className) {
      const classGrade = this.extractGradeFromClassName(className);
      if (classGrade > 0) {
        // æ‰¾åˆ°è¯¥å¹´çº§å…¥å­¦å¯¹åº”çš„æœ€æ—©å­¦æœŸ
        const earliestValidDate = this.getEarliestValidDateForGrade(classGrade);
        
        // è®¡ç®—å‰å¾€ä¸Šä¸€å‘¨åçš„æ—¥æœŸ
        const previousWeekDate = new Date(currentDate);
        previousWeekDate.setDate(currentDate.getDate() - 7);
        
        if (previousWeekDate < earliestValidDate) {
          console.info(`ğŸ“… [Swipe Limit] ä¸èƒ½å‰å¾€ä¸Šä¸€å‘¨ï¼š${classGrade}çº§å­¦ç”Ÿåœ¨${previousWeekDate.toDateString()}ä¹‹å‰å°šæœªå…¥å­¦ï¼ˆæœ€æ—©å…¥å­¦æ—¥æœŸï¼š${earliestValidDate.toDateString()}ï¼‰`);
          return false;
        }
      }
    }

    // æ£€æŸ¥æ˜¯å¦ä¼šæ—©äºæœ€æ—©å­¦æœŸçš„å¼€å§‹æ—¥æœŸ
    const earliestSemester = this.semesterList[0];
    const earliestStartDate = new Date(earliestSemester.startDate);
    
    const previousWeekDate = new Date(currentDate);
    previousWeekDate.setDate(currentDate.getDate() - 7);
    
    if (previousWeekDate < earliestStartDate) {
      console.info(`ğŸ“… [Swipe Limit] ä¸èƒ½å‰å¾€ä¸Šä¸€å‘¨ï¼šä¸Šå‘¨æ—¥æœŸ(${previousWeekDate.toDateString()})æ—©äºæœ€æ—©å­¦æœŸå¼€å§‹æ—¥æœŸ(${earliestStartDate.toDateString()})`);
      return false;
    }

    console.info(`ğŸ“… [Swipe Check] å¯ä»¥å‰å¾€ä¸Šä¸€å‘¨ï¼šå½“å‰æ—¥æœŸ${currentDate.toDateString()}`);
    return true;
  }

  /**
   * ä»ç­çº§åç§°ä¸­æå–å¹´çº§ä¿¡æ¯
   * @param className ç­çº§åç§°ï¼Œå¦‚"25è½¯ä»¶å·¥ç¨‹1ç­"
   * @returns å¹´çº§æ•°å­—ï¼Œå¦‚25ï¼Œå¦‚æœæ— æ³•æå–åˆ™è¿”å›0
   */
  private extractGradeFromClassName(className: string): number {
    // æŸ¥æ‰¾ç­çº§åç§°ä¸­çš„æ•°å­—ï¼Œé€šå¸¸å¹´çº§åœ¨å‰é¢
    const gradeMatch = className.match(/(\d{2})/);
    if (gradeMatch) {
      const grade = parseInt(gradeMatch[1]);
      // ç¡®ä¿æ˜¯åˆç†çš„å¹´çº§èŒƒå›´ï¼ˆ20-30ä¹‹é—´ï¼‰
      if (grade >= 20 && grade <= 30) {
        return grade;
      }
    }
    
    console.warn(`ğŸ“… [Grade Extract] æ— æ³•ä»ç­çº§åç§°"${className}"ä¸­æå–æœ‰æ•ˆå¹´çº§`);
    return 0;
  }

  /**
   * æ ¹æ®å¹´çº§è·å–è¯¥å¹´çº§å­¦ç”Ÿçš„æœ€æ—©æœ‰æ•ˆå…¥å­¦æ—¥æœŸ
   * @param grade å¹´çº§ï¼Œå¦‚25è¡¨ç¤º2025çº§
   * @returns è¯¥å¹´çº§çš„æœ€æ—©å…¥å­¦æ—¥æœŸ
   */
  private getEarliestValidDateForGrade(grade: number): Date {
    // 25çº§å­¦ç”Ÿåœ¨2025å¹´å…¥å­¦ï¼Œå¯¹åº”2025å­¦å¹´ç¬¬1å­¦æœŸ
    const enrollmentYear = 2000 + grade;
    const academicYear = enrollmentYear.toString();
    
    // æŸ¥æ‰¾è¯¥å­¦å¹´ç¬¬1å­¦æœŸçš„å¼€å§‹æ—¥æœŸ
    const firstSemester = this.semesterList.find(sem => 
      sem.academicYear === academicYear && sem.semester === 1
    );
    
    if (firstSemester) {
      console.info(`ğŸ“… [Grade Validation] ${grade}çº§å­¦ç”Ÿæœ€æ—©å…¥å­¦æ—¥æœŸï¼š${firstSemester.startDate}`);
      return new Date(firstSemester.startDate);
    }
    
    // å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”å­¦æœŸï¼Œè¿”å›è¯¥å¹´9æœˆ1æ—¥ä½œä¸ºé»˜è®¤å…¥å­¦æ—¥æœŸ
    const defaultDate = new Date(enrollmentYear, 8, 1); // 9æœˆ1æ—¥ï¼ˆæœˆä»½ä»0å¼€å§‹ï¼‰
    console.info(`ğŸ“… [Grade Validation] ${grade}çº§å­¦ç”Ÿä½¿ç”¨é»˜è®¤å…¥å­¦æ—¥æœŸï¼š${defaultDate.toDateString()}`);
    return defaultDate;
  }

  /**
   * åˆ¤æ–­æ˜¯å¦å¯ä»¥è¿›å…¥ä¸‹ä¸€å‘¨ï¼ˆå·¦æ»‘æ“ä½œï¼Œå‘æœªæ¥ç¿»é¡µï¼‰
   * @param currentDate å½“å‰æ˜¾ç¤ºçš„æ—¥æœŸ
   * @returns trueè¡¨ç¤ºå¯ä»¥è¿›å…¥ä¸‹ä¸€å‘¨ï¼Œfalseè¡¨ç¤ºå·²åˆ°æé™
   */
  public canSwipeRight(currentDate: Date): boolean {
    if (this.semesterList.length === 0 || !this.farthestSemester) {
      return false;
    }

    // ä½¿ç”¨ç¼“å­˜çš„æœ€è¿œå­¦æœŸä¿¡æ¯
    // ä½¿ç”¨å®‰å…¨çš„æ—¥æœŸè§£ææ–¹å¼ï¼Œé¿å…æ—¶åŒºé—®é¢˜
    const endDateParts = this.farthestSemester.endDate.split('-');
    let latestEndDate = new Date(
      parseInt(endDateParts[0]),
      parseInt(endDateParts[1]) - 1, // æœˆä»½ä»0å¼€å§‹
      parseInt(endDateParts[2]),
      23, 59, 59, 999  // è®¾ç½®ä¸ºå½“å¤©çš„æœ€åä¸€åˆ»
    );
    
    const startDateParts = this.farthestSemester.startDate.split('-');
    let latestStartDate = new Date(
      parseInt(startDateParts[0]),
      parseInt(startDateParts[1]) - 1, // æœˆä»½ä»0å¼€å§‹
      parseInt(startDateParts[2]),
      0, 0, 0, 0  // è®¾ç½®ä¸ºå½“å¤©çš„å¼€å§‹
    );
    
    // æƒ…å†µ1ï¼šæ£€æŸ¥ä¸‹ä¸€å‘¨æ—¥æœŸæ˜¯å¦ä¼šè¶…å‡ºæœ€è¿œå­¦æœŸç»“æŸæ—¥æœŸ
    const nextWeekDate = new Date(currentDate);
    nextWeekDate.setDate(currentDate.getDate() + 7);
    
    // æ·»åŠ å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœæ—¥æœŸè§£ææ˜æ˜¾æœ‰é—®é¢˜ï¼Œåˆ™å…è®¸æ»‘åŠ¨
    const currentYear = currentDate.getFullYear();
    const endYear = latestEndDate.getFullYear();
    
    // å¦‚æœå½“å‰æ—¥æœŸå’Œç»“æŸæ—¥æœŸçš„å¹´ä»½å·®å¼‚è¿‡å¤§ï¼Œå¯èƒ½æ˜¯è§£æé”™è¯¯ï¼Œå…è®¸æ»‘åŠ¨
    if (Math.abs(currentYear - endYear) > 2) {
      return true;
    }
    
    // æ­£å¸¸çš„æ»‘åŠ¨æ£€æŸ¥ï¼šæ£€æŸ¥ä¸‹ä¸€å‘¨æ˜¯å¦ä¼šè¶…å‡ºèŒƒå›´
    if (nextWeekDate > latestEndDate) {
      if (currentDate >= latestStartDate && currentYear >= 2024 && currentYear <= 2026) {
      } else {
        return false;
      }
    }
    
    // æƒ…å†µ2ï¼šæ£€æŸ¥æ˜¯å¦å·²ç»åˆ°è¾¾æœ€åä¸€å­¦å¹´çš„æœ€åä¸€å­¦æœŸçš„æœ€åä¸€å‘¨
    const currentStatus = this.calculateCurrentSemesterStatus(currentDate);
    if (currentStatus.currentSemester) {
      // åˆ¤æ–­å½“å‰å­¦æœŸæ˜¯å¦æ˜¯æœ€è¿œå­¦æœŸ
      const isLastSemester = (
        currentStatus.currentSemester.academicYear === this.farthestAcademicYear &&
        currentStatus.currentSemester.semester === this.farthestSemesterNumber
      );
      
      if (isLastSemester) {
        // åœ¨æœ€è¿œå­¦æœŸä¸­ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯æœ€åä¸€å‘¨
        if (currentStatus.currentWeek >= this.farthestTotalWeeks) {
          console.info(`ğŸ“… [Swipe Limit] ä¸èƒ½è¿›å…¥ä¸‹ä¸€å‘¨ï¼šå½“å‰æ˜¯æœ€è¿œå­¦æœŸ${this.farthestAcademicYear}å­¦å¹´ç¬¬${this.farthestSemesterNumber}å­¦æœŸç¬¬${currentStatus.currentWeek}å‘¨ï¼ˆå…±${this.farthestTotalWeeks}å‘¨ï¼‰`);
          return false;
        }
      }
    }

    console.info(`ğŸ“… [Swipe Check] å¯ä»¥è¿›å…¥ä¸‹ä¸€å‘¨ï¼šå½“å‰æ—¥æœŸ${currentDate.toDateString()}`);
    return true;
  }

  /**
   * åˆ¤æ–­æŒ‡å®šå­¦æœŸæ˜¯å¦å¯¹æŒ‡å®šå¹´çº§æœ‰æ•ˆ
   * @param semester å­¦æœŸä¿¡æ¯
   * @param className ç­çº§åç§°
   * @returns trueè¡¨ç¤ºè¯¥å¹´çº§å¯ä»¥è®¿é—®è¯¥å­¦æœŸï¼Œfalseè¡¨ç¤ºä¸å¯è®¿é—®
   */
  public isSemesterValidForGrade(semester: SemesterInfo, className?: string): boolean {
    if (!className) {
      return true; // å¦‚æœæ²¡æœ‰ç­çº§ä¿¡æ¯ï¼Œé»˜è®¤å…è®¸è®¿é—®
    }

    const classGrade = this.extractGradeFromClassName(className);
    if (classGrade === 0) {
      return true; // å¦‚æœæ— æ³•æå–å¹´çº§ï¼Œé»˜è®¤å…è®¸è®¿é—®
    }

    // 25çº§å­¦ç”Ÿåœ¨2025å¹´å…¥å­¦ï¼Œåªèƒ½è®¿é—®2025å­¦å¹´åŠä¹‹åçš„å­¦æœŸ
    const enrollmentYear = 2000 + classGrade;
    const semesterYear = parseInt(semester.academicYear);

    const isValid = semesterYear >= enrollmentYear;
    
    if (!isValid) {
      console.info(`ğŸ“… [Semester Validation] ${classGrade}çº§å­¦ç”Ÿä¸èƒ½è®¿é—®${semester.academicYear}å­¦å¹´ç¬¬${semester.semester}å­¦æœŸï¼ˆå…¥å­¦å¹´ä»½ï¼š${enrollmentYear}ï¼‰`);
    }

    return isValid;
  }

  /**
   * åˆ¤æ–­æ˜¯å¦å¯ä»¥åˆ‡æ¢åˆ°æŒ‡å®šæ–¹å‘çš„å­¦æœŸ
   * @param currentSemester å½“å‰å­¦æœŸ
   * @param direction åˆ‡æ¢æ–¹å‘
   * @param className ç­çº§åç§°
   * @returns trueè¡¨ç¤ºå¯ä»¥åˆ‡æ¢ï¼Œfalseè¡¨ç¤ºä¸å¯åˆ‡æ¢
   */
  public canSwitchSemester(currentSemester: SemesterInfo, direction: 'prev' | 'next', className?: string): boolean {
    const targetSemester = this.getAdjacentSemester(currentSemester, direction);
    
    if (!targetSemester) {
      return false; // æ²¡æœ‰ç›®æ ‡å­¦æœŸ
    }

    // å¦‚æœæ˜¯å‘å‰åˆ‡æ¢ï¼ˆä¸Šä¸€ä¸ªå­¦æœŸï¼‰ï¼Œéœ€è¦æ£€æŸ¥å¹´çº§é™åˆ¶
    if (direction === 'prev' && className) {
      return this.isSemesterValidForGrade(targetSemester, className);
    }

    return true;
  }

  /**
   * åˆ¤æ–­æŒ‡å®šå­¦æœŸçš„æŒ‡å®šå‘¨æ•°æ˜¯å¦å¯¹å¹´çº§æœ‰æ•ˆ
   * @param semester å­¦æœŸä¿¡æ¯
   * @param weekNum å‘¨æ•°
   * @param className ç­çº§åç§°
   * @returns trueè¡¨ç¤ºè¯¥å‘¨æ•°å¯é€‰ï¼Œfalseè¡¨ç¤ºä¸å¯é€‰
   */
  public isWeekValidForGrade(semester: SemesterInfo, weekNum: number, className?: string): boolean {
    // é¦–å…ˆæ£€æŸ¥å­¦æœŸæ˜¯å¦å¯¹å¹´çº§æœ‰æ•ˆ
    if (!this.isSemesterValidForGrade(semester, className)) {
      return false;
    }

    // å¦‚æœå­¦æœŸæœ‰æ•ˆï¼Œæ‰€æœ‰å‘¨æ•°éƒ½å¯é€‰
    return true;
  }

  /**
   * è·å–æœ€è¿œå­¦æœŸä¿¡æ¯
   */
  public getFarthestSemesterInfo(): FarthestSemesterInfo {
    return {
      semester: this.farthestSemester,
      academicYear: this.farthestAcademicYear,
      semesterNumber: this.farthestSemesterNumber,
      totalWeeks: this.farthestTotalWeeks
    };
  }

  /**
   * å¤„ç†å­¦æœŸæ•°æ®
   */
  private processSemesterData(data: ConfigApiResponseData): void {
    this.semesterList = [];

    // è·å–æ‰€æœ‰å¹´ä»½çš„æ•°ç»„
    const startYears = Array.from(data.start.keys());
    const endYears = Array.from(data.end.keys());

    // åˆå¹¶å¹´ä»½å¹¶å»é‡
    const allYears: string[] = [];
    startYears.forEach((year: string) => {
      if (!allYears.includes(year)) {
        allYears.push(year);
      }
    });
    endYears.forEach((year: string) => {
      if (!allYears.includes(year)) {
        allYears.push(year);
      }
    });

    // å¤„ç†æ¯ä¸ªå¹´ä»½çš„å­¦æœŸæ•°æ®
    allYears.forEach((year: string) => {
      const startDates = data.start.get(year) || [];
      const endDates = data.end.get(year) || [];

      for (let i = 0; i < startDates.length; i++) {
        if (endDates[i]) {
          const startDate = new Date(startDates[i]);
          const endDate = new Date(endDates[i]);

          // è®¡ç®—å­¦æœŸæ€»å‘¨æ•°
          const totalWeeks = Math.ceil((endDate.getTime() - startDate.getTime()) / (7 * 24 * 60 * 60 * 1000));

          // ç¡®å®šå­¦å¹´å’Œå­¦æœŸ
          let academicYear: string;
          let semesterNumber: number;

          if (i % 2 === 0) {
            // ç¬¬ä¸€ä¸ªæ—¥æœŸæ˜¯ç¬¬ä¸€å­¦æœŸï¼ˆç§‹å­£å­¦æœŸï¼Œ9æœˆå¼€å§‹ï¼‰
            academicYear = year; // å­¦å¹´ä»¥9æœˆæ‰€åœ¨çš„å¹´ä»½å‘½å
            semesterNumber = 1;
          } else {
            // ç¬¬äºŒä¸ªæ—¥æœŸæ˜¯ç¬¬äºŒå­¦æœŸï¼ˆæ˜¥å­£å­¦æœŸï¼Œ2-3æœˆå¼€å§‹ï¼‰
            // æ˜¥å­£å­¦æœŸå±äºåŒä¸€å­¦å¹´ï¼Œä¸æ˜¯å‰ä¸€å­¦å¹´
            academicYear = year; // åŒä¸€å­¦å¹´
            semesterNumber = 2;
          }

          this.semesterList.push({
            academicYear,
            semester: semesterNumber,
            startDate: startDates[i],
            endDate: endDates[i],
            totalWeeks
          });
        }
      }
    });

    // æŒ‰å¼€å§‹æ—¥æœŸæ’åº
    this.semesterList.sort((a, b) => new Date(a.startDate).getTime() - new Date(b.startDate).getTime());

    // ç¼“å­˜æœ€è¿œå­¦æœŸä¿¡æ¯ï¼ˆæœ€åä¸€ä¸ªå­¦æœŸï¼‰
    if (this.semesterList.length > 0) {
      this.farthestSemester = this.semesterList[this.semesterList.length - 1];
      this.farthestAcademicYear = this.farthestSemester.academicYear;
      this.farthestSemesterNumber = this.farthestSemester.semester;
      this.farthestTotalWeeks = this.farthestSemester.totalWeeks;
      
      console.info(`ğŸ“š [Farthest Semester] æœ€è¿œå­¦æœŸ: ${this.farthestAcademicYear}å­¦å¹´ç¬¬${this.farthestSemesterNumber}å­¦æœŸï¼Œå…±${this.farthestTotalWeeks}å‘¨`);
    }

    console.info(`ğŸ“š [Semester Data] å¤„ç†äº†${this.semesterList.length}ä¸ªå­¦æœŸæ•°æ®`);
    this.semesterList.forEach(sem => {
      console.info(`ğŸ“š [Semester] ${sem.academicYear}å­¦å¹´ç¬¬${sem.semester}å­¦æœŸ: ${sem.startDate} ~ ${sem.endDate} (${sem.totalWeeks}å‘¨)`);
    });
  }
}