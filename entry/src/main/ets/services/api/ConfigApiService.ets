import { HttpService } from './HttpService';
import { ApiResponse } from '../../models/CollegeModels';

// çœŸå®çš„/config APIè¿”å›æ•°æ®ç»“æ„
export interface ConfigApiResponseData {
  start: Map<string, string[]>;
  end: Map<string, string[]>;
}

export interface ConfigApiResponse {
  msg: string;
  code: number;
  data: ConfigApiResponseData;
}

// å¤„ç†åçš„å­¦æœŸä¿¡æ¯
export interface SemesterInfo {
  year: string;
  semester: number; // 1: ä¸Šå­¦æœŸ(ç§‹å­£), 2: ä¸‹å­¦æœŸ(æ˜¥å­£)
  startDate: string;
  endDate: string;
  totalWeeks: number;
}

// å½“å‰çŠ¶æ€ä¿¡æ¯
export interface CurrentSemesterStatus {
  isInSemester: boolean;
  isInHoliday: boolean;
  currentSemester?: SemesterInfo;
  currentWeek: number;
  statusText: string; // "ç¬¬Xå‘¨" æˆ– "å‡æœŸä¸­"
}

export interface WeekDateRange {
  startDate: Date;
  endDate: Date;
}

export class ConfigApiService {
  private static instance: ConfigApiService;
  private semesterList: SemesterInfo[] = [];
  private currentStatus: CurrentSemesterStatus | null = null;

  private constructor() {}

  public static getInstance(): ConfigApiService {
    if (!ConfigApiService.instance) {
      ConfigApiService.instance = new ConfigApiService();
    }
    return ConfigApiService.instance;
  }

  /**
   * è·å–é…ç½®ä¿¡æ¯
   */
  public async getConfig(): Promise<ConfigApiResponse> {
    try {
      const response = await HttpService.getInstance().get<Record<string, Object>>('/config');
      
      // è½¬æ¢åŸå§‹æ•°æ®ä¸ºMapç»“æ„
      const rawData = response.data as Record<string, Record<string, string[]>>;
      const startMap = new Map<string, string[]>();
      const endMap = new Map<string, string[]>();
      
      if (rawData.start) {
        Object.keys(rawData.start).forEach((key: string) => {
          startMap.set(key, rawData.start[key]);
        });
      }
      
      if (rawData.end) {
        Object.keys(rawData.end).forEach((key: string) => {
          endMap.set(key, rawData.end[key]);
        });
      }
      
      // æ„å»ºå®Œæ•´çš„å“åº”å¯¹è±¡
      const configResponse: ConfigApiResponse = {
        msg: "æ“ä½œæˆåŠŸ",
        code: response.code || 200,
        data: { start: startMap, end: endMap }
      };
      
      // å¤„ç†å­¦æœŸæ•°æ®
      this.processSemesterData(configResponse.data);
      
      return configResponse;
    } catch (error) {
      console.error('è·å–é…ç½®å¤±è´¥:', error);
      throw new Error('è·å–é…ç½®å¤±è´¥');
    }
  }

  /**
   * å¤„ç†å­¦æœŸæ•°æ® (å‚è€ƒclass-schedule-cé€»è¾‘)
   */
  private processSemesterData(data: ConfigApiResponseData): void {
    this.semesterList = [];
    
    // è·å–æ‰€æœ‰å¹´ä»½çš„æ•°ç»„
    const startYears = Array.from(data.start.keys());
    const endYears = Array.from(data.end.keys());
    
    // åˆå¹¶å¹´ä»½å¹¶å»é‡
    const allYears: string[] = [];
    startYears.forEach((year: string) => {
      if (!allYears.includes(year)) {
        allYears.push(year);
      }
    });
    endYears.forEach((year: string) => {
      if (!allYears.includes(year)) {
        allYears.push(year);
      }
    });
    
    // å¤„ç†æ¯ä¸ªå¹´ä»½çš„å­¦æœŸæ•°æ®
    allYears.forEach((year: string) => {
      const startDates = data.start.get(year) || [];
      const endDates = data.end.get(year) || [];
      
      for (let i = 0; i < startDates.length; i++) {
        if (endDates[i]) {
          const startDate = new Date(startDates[i]);
          const endDate = new Date(endDates[i]);
          
          // è®¡ç®—å­¦æœŸæ€»å‘¨æ•°
          const totalWeeks = Math.ceil((endDate.getTime() - startDate.getTime()) / (7 * 24 * 60 * 60 * 1000));
          
          // åˆ¤æ–­æ˜¯ä¸Šå­¦æœŸè¿˜æ˜¯ä¸‹å­¦æœŸ (å‚è€ƒclass-schedule-c: i % 2 === 0 ? "3" : "12")
          const semester = i % 2 === 0 ? 1 : 2; // 1: ç§‹å­£å­¦æœŸ, 2: æ˜¥å­£å­¦æœŸ
          
          this.semesterList.push({
            year,
            semester,
            startDate: startDates[i],
            endDate: endDates[i],
            totalWeeks
          });
        }
      }
    });
    
    // æŒ‰å¼€å§‹æ—¥æœŸæ’åº
    this.semesterList.sort((a, b) => new Date(a.startDate).getTime() - new Date(b.startDate).getTime());
    
    console.info(`ğŸ“š [Semester Data] å¤„ç†äº†${this.semesterList.length}ä¸ªå­¦æœŸæ•°æ®`);
    this.semesterList.forEach(sem => {
      console.info(`ğŸ“š [Semester] ${sem.year}å¹´${sem.semester === 1 ? 'ç§‹å­£' : 'æ˜¥å­£'}å­¦æœŸ: ${sem.startDate} ~ ${sem.endDate} (${sem.totalWeeks}å‘¨)`);
    });
  }

  /**
   * è®¡ç®—å½“å‰å­¦æœŸçŠ¶æ€ (å®Œå…¨å‚è€ƒclass-schedule-cé€»è¾‘)
   */
  public calculateCurrentSemesterStatus(currentDate?: Date): CurrentSemesterStatus {
    const today = currentDate || new Date();
    
    // æŸ¥æ‰¾å½“å‰æ—¥æœŸæ‰€åœ¨çš„å­¦æœŸ
    for (const semester of this.semesterList) {
      const startDate = new Date(semester.startDate);
      const endDate = new Date(semester.endDate);
      
      if (today >= startDate && today <= endDate) {
        // åœ¨å­¦æœŸä¸­ï¼Œè®¡ç®—å½“å‰å‘¨æ•°
        const currentWeek = this.calculateWeekInSemester(semester.startDate, today);
        
        this.currentStatus = {
          isInSemester: true,
          isInHoliday: false,
          currentSemester: semester,
          currentWeek,
          statusText: `ç¬¬${currentWeek}å‘¨`
        };
        
        console.info(`ğŸ“… [Current Status] å½“å‰åœ¨${semester.year}å¹´${semester.semester === 1 ? 'ç§‹å­£' : 'æ˜¥å­£'}å­¦æœŸç¬¬${currentWeek}å‘¨`);
        return this.currentStatus;
      }
    }
    
    // ä¸åœ¨ä»»ä½•å­¦æœŸä¸­ï¼Œæ˜¾ç¤º"å‡æœŸä¸­"
    this.currentStatus = {
      isInSemester: false,
      isInHoliday: true,
      currentWeek: 1,
      statusText: "å‡æœŸä¸­"
    };
    
    console.info(`ğŸ“… [Current Status] å½“å‰åœ¨å‡æœŸä¸­`);
    return this.currentStatus;
  }

  /**
   * è®¡ç®—æŸä¸ªå­¦æœŸå†…çš„å½“å‰å‘¨æ•° (å‚è€ƒclass-schedule-cçš„getWeeké€»è¾‘)
   */
  public calculateWeekInSemester(startDate: string, currentDate: Date): number {
    // è§£æå¼€å§‹æ—¥æœŸ - æŒ‰ç…§class-schedule-cçš„æ–¹å¼
    const startDateArray = startDate.split("-");
    const semesterStartDate = new Date(startDateArray[1] + '-' + startDateArray[2] + '-' + startDateArray[0]);
    
    // è§£æå½“å‰æ—¥æœŸ
    const currentYear = currentDate.getFullYear();
    const currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
    const currentDay = String(currentDate.getDate()).padStart(2, '0');
    const todayDate = new Date(currentMonth + '-' + currentDay + '-' + currentYear);
    
    // è®¡ç®—ç›¸å·®å¤©æ•°
    const timeDifference = todayDate.getTime() - semesterStartDate.getTime();
    const daysDifference = Math.floor(timeDifference / (1000 * 60 * 60 * 24));
    
    // è®¡ç®—å‘¨æ•° (å®Œå…¨æŒ‰ç…§class-schedule-cé€»è¾‘)
    let currentWeek: number;
    if (daysDifference < 0) {
      currentWeek = 1;
    } else if (0 <= daysDifference && daysDifference <= 6) {
      currentWeek = 1;
    } else {
      currentWeek = Math.ceil((daysDifference - 6) / 7) + 1;
    }
    
    return currentWeek;
  }

  /**
   * è·å–æ‰€æœ‰å­¦æœŸåˆ—è¡¨
   */
  public getSemesterList(): SemesterInfo[] {
    return this.semesterList;
  }

  /**
   * è·å–å½“å‰çŠ¶æ€
   */
  public getCurrentStatus(): CurrentSemesterStatus | null {
    return this.currentStatus;
  }

  /**
   * æ ¹æ®å¹´ä»½å’Œå­¦æœŸè·å–å­¦æœŸä¿¡æ¯
   */
  public getSemesterInfo(year: string, semester: number): SemesterInfo | null {
    return this.semesterList.find(sem => sem.year === year && sem.semester === semester) || null;
  }

  /**
   * è·å–ä¸Šä¸€ä¸ª/ä¸‹ä¸€ä¸ªå­¦æœŸ
   */
  public getAdjacentSemester(current: SemesterInfo, direction: 'prev' | 'next'): SemesterInfo | null {
    const currentIndex = this.semesterList.findIndex(sem => 
      sem.year === current.year && sem.semester === current.semester
    );
    
    if (currentIndex === -1) return null;
    
    const targetIndex = direction === 'prev' ? currentIndex - 1 : currentIndex + 1;
    return this.semesterList[targetIndex] || null;
  }

  /**
   * è®¡ç®—æŒ‡å®šå‘¨çš„æ—¥æœŸèŒƒå›´
   */
  public calculateWeekDates(startDate: string, weekNum: number): WeekDateRange {
    const semesterStart = new Date(startDate);
    
    // è®¡ç®—è¯¥å‘¨çš„å¼€å§‹æ—¥æœŸ (å‘¨ä¸€)
    const daysToAdd = (weekNum - 1) * 7;
    const weekStart = new Date(semesterStart);
    weekStart.setDate(semesterStart.getDate() + daysToAdd);
    
    // æ‰¾åˆ°è¯¥å‘¨çš„å‘¨ä¸€
    const dayOfWeek = weekStart.getDay();
    const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    weekStart.setDate(weekStart.getDate() + daysToMonday);
    
    // è®¡ç®—è¯¥å‘¨çš„ç»“æŸæ—¥æœŸ (å‘¨æ—¥)
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);
    
    return {
      startDate: weekStart,
      endDate: weekEnd
    };
  }

  /**
   * æ ¼å¼åŒ–æ—¥æœŸä¸ºå­—ç¬¦ä¸²
   */
  public formatDateString(date: Date): string {
    const month = date.getMonth() + 1;
    const day = date.getDate();
    return `${month}æœˆ${day}æ—¥`;
  }

  /**
   * è·å–æœˆä»½
   */
  public getMonthString(date: Date): string {
    const month = date.getMonth() + 1;
    return `${month}æœˆ`;
  }

  /**
   * å‘åå…¼å®¹çš„æ–¹æ³• - è®¡ç®—å½“å‰å‘¨æ•°
   */
  public calculateCurrentWeek(startDate: string, currentDate?: Date): number {
    const status = this.calculateCurrentSemesterStatus(currentDate);
    return status.currentWeek;
  }
}