import { ApiResponse, HttpService } from './HttpService';
import { DateUtil } from '../../common/utils/DateUtil';
import { ConfigApiResponseData, CurrentSemesterStatus, SemesterInfo, WeekDateRange } from '../../models/ConfigModels';

// å¯¼å‡ºç±»å‹
export { CurrentSemesterStatus, SemesterInfo } from '../../models/ConfigModels';


export class ConfigApiService {
  private static instance: ConfigApiService;
  private semesterList: SemesterInfo[] = [];
  private currentStatus: CurrentSemesterStatus | null = null;
  private configData: ConfigApiResponseData | null = null;

  private constructor() {
  }

  public static getInstance(): ConfigApiService {
    if (!ConfigApiService.instance) {
      ConfigApiService.instance = new ConfigApiService();
    }
    return ConfigApiService.instance;
  }

  /**
   * è·å–é…ç½®ä¿¡æ¯
   */
  public async getConfig(): Promise<ApiResponse<ConfigApiResponseData>> {
    try {
      const response = await HttpService.getInstance().get<Record<string, Object>>('/config');

      // è½¬æ¢åŸå§‹æ•°æ®ä¸ºMapç»“æ„
      const rawData = response.data as Record<string, Object>;
      const startMap = new Map<string, string[]>();
      const endMap = new Map<string, string[]>();

      if (rawData.start && typeof rawData.start === 'object') {
        const startData = rawData.start as Record<string, string[]>;
        Object.keys(startData).forEach((key: string) => {
          startMap.set(key, startData[key]);
        });
      }

      if (rawData.end && typeof rawData.end === 'object') {
        const endData = rawData.end as Record<string, string[]>;
        Object.keys(endData).forEach((key: string) => {
          endMap.set(key, endData[key]);
        });
      }

      // æ„å»ºå®Œæ•´çš„å“åº”å¯¹è±¡ï¼ŒåŒ…å«æ–°çš„å­—æ®µ
      const configResponse: ApiResponse<ConfigApiResponseData> = {
        msg: "æ“ä½œæˆåŠŸ",
        code: response.code || 200,
        data: { 
          start: startMap, 
          end: endMap,
          week: rawData.week as number,
          weekDayStr: rawData.weekDayStr as string,
          year: rawData.year as number,
          termCode: rawData.termCode as string
        }
      };

      // å­˜å‚¨é…ç½®æ•°æ®
      this.configData = configResponse.data;

      // å¤„ç†å­¦æœŸæ•°æ®
      this.processSemesterData(configResponse.data);

      return configResponse;
    } catch (error) {
      console.error('è·å–é…ç½®å¤±è´¥:', error);
      throw new Error('è·å–é…ç½®å¤±è´¥');
    }
  }

  /**
   * è®¡ç®—å½“å‰å­¦æœŸçŠ¶æ€ (å®Œå…¨å‚è€ƒclass-schedule-cé€»è¾‘)
   */
  public calculateCurrentSemesterStatus(currentDate?: Date): CurrentSemesterStatus {
    const today = currentDate || new Date();

    // å…ˆæ‰¾åˆ°æœ€è¿‘ç»“æŸçš„å­¦æœŸï¼Œè®¡ç®—æŒ‰è¯¥å­¦æœŸçš„å‘¨æ•°
    let mostRecentEndedSemester: SemesterInfo | null = null;
    let latestEndDate = new Date(0); // æœ€æ—©æ—¶é—´

    // æŸ¥æ‰¾å½“å‰æ—¥æœŸæ‰€åœ¨çš„å­¦æœŸï¼Œå¦‚æœæ²¡æœ‰ï¼Œæ‰¾æœ€è¿‘ç»“æŸçš„å­¦æœŸ
    for (const semester of this.semesterList) {
      // ä½¿ç”¨æ›´å®‰å…¨çš„æ—¥æœŸè§£ææ–¹å¼
      const startDateParts = semester.startDate.split('-');
      const endDateParts = semester.endDate.split('-');

      const startDate = new Date(
        parseInt(startDateParts[0]),
        parseInt(startDateParts[1]) - 1, // æœˆä»½ä»0å¼€å§‹
        parseInt(startDateParts[2])
      );
      const endDate = new Date(
        parseInt(endDateParts[0]),
        parseInt(endDateParts[1]) - 1, // æœˆä»½ä»0å¼€å§‹
        parseInt(endDateParts[2])
      );

      // ä½¿ç”¨DateUtilè¿›è¡Œå®‰å…¨çš„æ—¥æœŸæ¯”è¾ƒ
      if (DateUtil.isBetween(today, startDate, endDate)) {
        // åœ¨å­¦æœŸä¸­ï¼Œè®¡ç®—å½“å‰å‘¨æ•°
        const currentWeek = this.calculateWeekInSemester(semester.startDate, today);

        this.currentStatus = {
          isInSemester: true,
          isInHoliday: false,
          currentSemester: semester,
          currentWeek,
          statusText: `ç¬¬${currentWeek}å‘¨`
        };

        console.info(`ğŸ“… [Current Status] å½“å‰åœ¨${semester.academicYear}å­¦å¹´ç¬¬${semester.semester}å­¦æœŸç¬¬${currentWeek}å‘¨`);
        return this.currentStatus;
      }

      // è®°å½•æœ€è¿‘ç»“æŸçš„å­¦æœŸ - ä½¿ç”¨DateUtilè¿›è¡Œå®‰å…¨æ¯”è¾ƒ
      if (DateUtil.isAfter(today, endDate) && DateUtil.isAfter(endDate, latestEndDate)) {
        latestEndDate = endDate;
        mostRecentEndedSemester = semester;
      }
    }

    // ä¸åœ¨ä»»ä½•å­¦æœŸä¸­ï¼Œä½¿ç”¨æœ€è¿‘ç»“æŸçš„å­¦æœŸæ¥è®¡ç®—"å‡æƒ³å‘¨æ•°"
    if (mostRecentEndedSemester) {
      const calculatedWeek = this.calculateWeekInSemester(mostRecentEndedSemester.startDate, today);

      console.info(`ğŸ“… [Week Debug] æœ€è¿‘ç»“æŸå­¦æœŸ: ${mostRecentEndedSemester.academicYear}å­¦å¹´ç¬¬${mostRecentEndedSemester.semester}å­¦æœŸ`);
      console.info(`ğŸ“… [Week Debug] å­¦æœŸå¼€å§‹: ${mostRecentEndedSemester.startDate}, å½“å‰æ—¥æœŸ: ${today.getFullYear()}-${String(today.getMonth() +
        1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`);
      console.info(`ğŸ“… [Week Debug] è®¡ç®—å‡ºçš„å‘¨æ•°: ${calculatedWeek}`);

      this.currentStatus = {
        isInSemester: false,
        isInHoliday: true,
        currentSemester: mostRecentEndedSemester, // æ˜¾ç¤ºæœ€è¿‘ç»“æŸçš„å­¦æœŸ
        currentWeek: calculatedWeek, // æ˜¾ç¤ºè¶…å‡ºçš„å‘¨æ•°
        statusText: "å‡æœŸä¸­"
      };

      console.info(`ğŸ“… [Current Status] å½“å‰åœ¨å‡æœŸä¸­ï¼ŒæŒ‰${mostRecentEndedSemester.academicYear}å­¦å¹´ç¬¬${mostRecentEndedSemester.semester}å­¦æœŸè®¡ç®—ä¸ºç¬¬${calculatedWeek}å‘¨`);
      return this.currentStatus;
    }

    // æ‰¾ä¸åˆ°ä»»ä½•ç›¸å…³å­¦æœŸï¼Œä½¿ç”¨æœ€æ—©çš„æœªæ¥å­¦æœŸä½œä¸ºå‚è€ƒ
    let earliestFutureSemester: SemesterInfo | null = null;
    let earliestStartDate = new Date(9999, 0, 1); // å¾ˆè¿œçš„æœªæ¥æ—¶é—´

    for (const semester of this.semesterList) {
      const startDate = new Date(semester.startDate);
      if (DateUtil.isAfter(startDate, today) && DateUtil.isBefore(startDate, earliestStartDate)) {
        earliestStartDate = startDate;
        earliestFutureSemester = semester;
      }
    }

    this.currentStatus = {
      isInSemester: false,
      isInHoliday: true,
      currentSemester: earliestFutureSemester || undefined,
      currentWeek: 1,
      statusText: "å‡æœŸä¸­"
    };

    const semesterInfo = earliestFutureSemester
      ? `å³å°†å¼€å§‹${earliestFutureSemester.academicYear}å­¦å¹´ç¬¬${earliestFutureSemester.semester}å­¦æœŸ`
      : 'æœªæ‰¾åˆ°ç›¸å…³å­¦æœŸ';
    console.info(`ğŸ“… [Current Status] å½“å‰åœ¨å‡æœŸä¸­ï¼Œ${semesterInfo}`);
    return this.currentStatus;
  }

  /**
   * è®¡ç®—æŸä¸ªå­¦æœŸå†…çš„å½“å‰å‘¨æ•° (å®Œå…¨æŒ‰ç…§class-schedule-cçš„getWeeké€»è¾‘)
   */
  public calculateWeekInSemester(startDate: string, currentDate: Date): number {
    // è§£æå¼€å§‹æ—¥æœŸ - å®Œå…¨æŒ‰ç…§class-schedule-cçš„æ–¹å¼
    const startDateArray = startDate.split("-"); // ["2025", "09", "08"]
    const semesterStartDate =
      new Date(startDateArray[1] + '-' + startDateArray[2] + '-' + startDateArray[0]); // "09-08-2025"

    // è§£æå½“å‰æ—¥æœŸ - å®Œå…¨æŒ‰ç…§class-schedule-cçš„getNowTimeå’ŒgetWeeké€»è¾‘
    const currentYear = currentDate.getFullYear();
    const currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
    const currentDay = String(currentDate.getDate()).padStart(2, '0');
    const nowTimeString = currentYear + '-' + currentMonth + '-' + currentDay; // "2025-08-23"

    const nowDateArray = nowTimeString.split("-"); // ["2025", "08", "23"]
    const todayDate = new Date(nowDateArray[1] + '-' + nowDateArray[2] + '-' + nowDateArray[0]); // "08-23-2025"

    // è®¡ç®—ç›¸å·®å¤©æ•° (å®Œå…¨æŒ‰ç…§class-schedule-cé€»è¾‘)
    const timeDifference = todayDate.getTime() - semesterStartDate.getTime();
    const daysDifference = Math.floor(timeDifference / (1000 * 60 * 60 * 24)); // iDays

    // è®¡ç®—å‘¨æ•° (å®Œå…¨æŒ‰ç…§class-schedule-cçš„getWeeké€»è¾‘)
    let currentWeek: number;
    if (daysDifference < 0) {
      currentWeek = -1; // å¤©æ•°å·®<0ï¼Œå‘¨æ•°ç»Ÿä¸€è®¾ä¸º-1
    } else if (0 <= daysDifference && daysDifference <= 6) {
      currentWeek = 1; // 0<=å¤©æ•°å·®<=6ï¼Œåœ¨ç¬¬ä¸€å‘¨
    } else {
      currentWeek = Math.ceil((daysDifference - 6) / 7) + 1; // å¤§äº6å¤šä½™çš„éƒ¨åˆ†æ¯å¤š7å¤©åŠ 1å‘¨
    }

    console.info(`ğŸ“… [Week Calculation] ${startDate} -> ${nowTimeString}, ç›¸å·®${daysDifference}å¤©, ç¬¬${currentWeek}å‘¨`);
    return currentWeek;
  }

  /**
   * è·å–æ‰€æœ‰å­¦æœŸåˆ—è¡¨
   */
  public getSemesterList(): SemesterInfo[] {
    return this.semesterList;
  }

  /**
   * è·å–å½“å‰çŠ¶æ€
   */
  public getCurrentStatus(): CurrentSemesterStatus | null {
    return this.currentStatus;
  }

  /**
   * æ ¹æ®å­¦å¹´å’Œå­¦æœŸè·å–å­¦æœŸä¿¡æ¯
   */
  public getSemesterInfo(academicYear: string, semester: number): SemesterInfo | null {
    return this.semesterList.find(sem => sem.academicYear === academicYear && sem.semester === semester) || null;
  }

  /**
   * è·å–ä¸Šä¸€ä¸ª/ä¸‹ä¸€ä¸ªå­¦æœŸ
   */
  public getAdjacentSemester(current: SemesterInfo, direction: 'prev' | 'next'): SemesterInfo | null {
    const currentIndex = this.semesterList.findIndex(sem =>
    sem.academicYear === current.academicYear && sem.semester === current.semester
    );

    if (currentIndex === -1) {
      return null;
    }

    const targetIndex = direction === 'prev' ? currentIndex - 1 : currentIndex + 1;
    return this.semesterList[targetIndex] || null;
  }

  /**
   * è®¡ç®—æŒ‡å®šå‘¨çš„æ—¥æœŸèŒƒå›´
   */
  public calculateWeekDates(startDate: string, weekNum: number): WeekDateRange {
    const semesterStart = new Date(startDate);

    // è®¡ç®—è¯¥å‘¨çš„å¼€å§‹æ—¥æœŸ (å‘¨ä¸€)
    const daysToAdd = (weekNum - 1) * 7;
    const weekStart = new Date(semesterStart);
    weekStart.setDate(semesterStart.getDate() + daysToAdd);

    // æ‰¾åˆ°è¯¥å‘¨çš„å‘¨ä¸€
    const dayOfWeek = weekStart.getDay();
    const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    weekStart.setDate(weekStart.getDate() + daysToMonday);

    // è®¡ç®—è¯¥å‘¨çš„ç»“æŸæ—¥æœŸ (å‘¨æ—¥)
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);

    return {
      startDate: weekStart,
      endDate: weekEnd
    };
  }

  /**
   * æ ¼å¼åŒ–æ—¥æœŸä¸ºå­—ç¬¦ä¸²
   */
  public formatDateString(date: Date): string {
    const month = date.getMonth() + 1;
    const day = date.getDate();
    return `${month}æœˆ${day}æ—¥`;
  }

  /**
   * è·å–æœˆä»½
   */
  public getMonthString(date: Date): string {
    const month = date.getMonth() + 1;
    return `${month}æœˆ`;
  }

  /**
   * å‘åå…¼å®¹çš„æ–¹æ³• - è®¡ç®—å½“å‰å‘¨æ•°
   */
  public calculateCurrentWeek(startDate: string, currentDate?: Date): number {
    const status = this.calculateCurrentSemesterStatus(currentDate);
    return status.currentWeek;
  }

  /**
   * è·å–å½“å‰å‘¨æ•° (ä»é…ç½®APIè¿”å›çš„æ–°å­—æ®µ)
   */
  public getCurrentWeekFromConfig(): number | undefined {
    return this.configData?.week;
  }

  /**
   * è·å–å½“å‰æ˜ŸæœŸå­—ç¬¦ä¸² (ä»é…ç½®APIè¿”å›çš„æ–°å­—æ®µ)
   */
  public getCurrentWeekDayString(): string | undefined {
    return this.configData?.weekDayStr;
  }

  /**
   * è·å–å½“å‰å¹´ä»½ (ä»é…ç½®APIè¿”å›çš„æ–°å­—æ®µ)
   */
  public getCurrentYear(): number | undefined {
    return this.configData?.year;
  }

  /**
   * è·å–å­¦æœŸä»£ç  (ä»é…ç½®APIè¿”å›çš„æ–°å­—æ®µ)
   */
  public getTermCode(): string | undefined {
    return this.configData?.termCode;
  }

  /**
   * å¤„ç†å­¦æœŸæ•°æ® (å‚è€ƒclass-schedule-cé€»è¾‘)
   */
  private processSemesterData(data: ConfigApiResponseData): void {
    this.semesterList = [];

    // è·å–æ‰€æœ‰å¹´ä»½çš„æ•°ç»„
    const startYears = Array.from(data.start.keys());
    const endYears = Array.from(data.end.keys());

    // åˆå¹¶å¹´ä»½å¹¶å»é‡
    const allYears: string[] = [];
    startYears.forEach((year: string) => {
      if (!allYears.includes(year)) {
        allYears.push(year);
      }
    });
    endYears.forEach((year: string) => {
      if (!allYears.includes(year)) {
        allYears.push(year);
      }
    });

    // å¤„ç†æ¯ä¸ªå¹´ä»½çš„å­¦æœŸæ•°æ®
    allYears.forEach((year: string) => {
      const startDates = data.start.get(year) || [];
      const endDates = data.end.get(year) || [];

      for (let i = 0; i < startDates.length; i++) {
        if (endDates[i]) {
          const startDate = new Date(startDates[i]);
          const endDate = new Date(endDates[i]);

          // è®¡ç®—å­¦æœŸæ€»å‘¨æ•°
          const totalWeeks = Math.ceil((endDate.getTime() - startDate.getTime()) / (7 * 24 * 60 * 60 * 1000));

          // ç¡®å®šå­¦å¹´å’Œå­¦æœŸ
          let academicYear: string;
          let semesterNumber: number;

          if (i % 2 === 0) {
            // ç¬¬ä¸€ä¸ªæ—¥æœŸæ˜¯ç¬¬ä¸€å­¦æœŸï¼ˆç§‹å­£å­¦æœŸï¼Œ9æœˆå¼€å§‹ï¼‰
            academicYear = year; // å­¦å¹´ä»¥9æœˆæ‰€åœ¨çš„å¹´ä»½å‘½å
            semesterNumber = 1;
          } else {
            // ç¬¬äºŒä¸ªæ—¥æœŸæ˜¯ç¬¬äºŒå­¦æœŸï¼ˆæ˜¥å­£å­¦æœŸï¼Œ2-3æœˆå¼€å§‹ï¼‰
            // æ˜¥å­£å­¦æœŸå±äºåŒä¸€å­¦å¹´ï¼Œä¸æ˜¯å‰ä¸€å­¦å¹´
            academicYear = year; // åŒä¸€å­¦å¹´
            semesterNumber = 2;
          }

          this.semesterList.push({
            academicYear,
            semester: semesterNumber,
            startDate: startDates[i],
            endDate: endDates[i],
            totalWeeks
          });
        }
      }
    });

    // æŒ‰å¼€å§‹æ—¥æœŸæ’åº
    this.semesterList.sort((a, b) => new Date(a.startDate).getTime() - new Date(b.startDate).getTime());

    console.info(`ğŸ“š [Semester Data] å¤„ç†äº†${this.semesterList.length}ä¸ªå­¦æœŸæ•°æ®`);
    this.semesterList.forEach(sem => {
      console.info(`ğŸ“š [Semester] ${sem.academicYear}å­¦å¹´ç¬¬${sem.semester}å­¦æœŸ: ${sem.startDate} ~ ${sem.endDate} (${sem.totalWeeks}å‘¨)`);
    });
  }
}