import { GetUserInfoApiResponse, GetUserInfoResponse, SimpleUserInfo } from '../../models/UserModels';
import { HttpService } from './HttpService';

/**
 * ç”¨æˆ·ä¿¡æ¯APIæœåŠ¡å°è£…
 * å¤„ç†ç”¨æˆ·ä¿¡æ¯è·å–å’Œç®¡ç†ç›¸å…³çš„APIè¯·æ±‚
 */
export class UserApiService {
  private static instance: UserApiService;
  private httpService = HttpService.getInstance();

  private constructor() {
    console.info('ğŸ‘¤ [UserApiService] åˆå§‹åŒ–ç”¨æˆ·APIæœåŠ¡');
  }

  public static getInstance(): UserApiService {
    if (!UserApiService.instance) {
      UserApiService.instance = new UserApiService();
    }
    return UserApiService.instance;
  }

  /**
   * è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
   * GET /getInfo
   * éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦token
   */
  public async getUserInfo(): Promise<GetUserInfoResponse> {
    try {
      console.info('ğŸ‘¤ [UserApiService] è·å–ç”¨æˆ·ä¿¡æ¯');

      // ä½¿ç”¨HttpServiceçš„getDirectæ–¹æ³•ï¼Œå› ä¸º/getInfoæ¥å£ç›´æ¥è¿”å›å®Œæ•´æ•°æ®ï¼Œä¸åŒ…è£…åœ¨ApiResponseä¸­
      const response: GetUserInfoApiResponse = await this.httpService.getDirect<GetUserInfoApiResponse>('/getInfo');

      if (response.code === 200) {
        console.info('ğŸ‘¤ [UserApiService] è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸ');
        console.info(`ğŸ‘¤ [UserApiService] ç”¨æˆ·: ${response.user.realName} (${response.user.userName})`);
        console.info(`ğŸ‘¤ [UserApiService] ç­çº§: ${response.user.stuClassId}`);

        // å°†GetUserInfoApiResponseè½¬æ¢ä¸ºæ ‡å‡†çš„GetUserInfoResponseæ ¼å¼
        const result: GetUserInfoResponse = {
          msg: response.msg,
          code: response.code,
          permissions: response.permissions,
          roles: response.roles,
          user: response.user
        };

        return result;
      } else {
        throw new Error(`è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${response.msg}`);
      }
    } catch (error) {
      console.error('ğŸ‘¤ [UserApiService] è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
      throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç™»å½•çŠ¶æ€');
    }
  }

  /**
   * å°†å®Œæ•´ç”¨æˆ·ä¿¡æ¯è½¬æ¢ä¸ºç®€åŒ–ç”¨æˆ·ä¿¡æ¯
   */
  public convertToSimpleUserInfo(userInfo: GetUserInfoResponse): SimpleUserInfo {
    return {
      userId: userInfo.user.userId,
      userName: userInfo.user.userName,
      stuClassId: userInfo.user.stuClassId,
      nickName: userInfo.user.nickName,
      realName: userInfo.user.realName,
      avatar: userInfo.user.avatar,
      admin: userInfo.user.admin
    };
  }

  /**
   * æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯æ˜¯å¦æœ‰æ•ˆ
   */
  public isValidUserInfo(userInfo: SimpleUserInfo | null): boolean {
    if (!userInfo) {
      return false;
    }

    // æ£€æŸ¥å…³é”®å­—æ®µæ˜¯å¦å­˜åœ¨
    return !!(
      userInfo.userId &&
      userInfo.userName &&
      userInfo.stuClassId &&
      userInfo.realName
    );
  }
}