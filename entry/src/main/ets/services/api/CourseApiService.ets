import { HttpService } from './HttpService';
import { ApiResponse } from '../../models/CollegeModels';

// è¯¾ç¨‹APIè¯·æ±‚å‚æ•°
export interface CourseRequestParams {
  week: number;        // ç¬¬å‡ å‘¨
  term: string;        // å­¦æœŸä»£å·ï¼š3ä¸ºç¬¬ä¸€å­¦æœŸ(ç§‹å­£)ï¼Œ12ä¸ºç¬¬äºŒå­¦æœŸ(æ˜¥å­£)
  year: string;        // å­¦å¹´ï¼Œå¦‚"2024"
  classId?: string;    // ç­çº§ID
  username?: string;   // å­¦ç”Ÿç”¨æˆ·å
}

// è¯¾ç¨‹ä¿¡æ¯
export interface CourseInfo {
  courseId: string;
  courseName: string;
  teacher: string[];
  classroom: string[];
  weekday: string;     // æ˜ŸæœŸå‡ ï¼Œå¦‚"æ˜ŸæœŸä¸€"
  section: string;     // èŠ‚æ¬¡ï¼Œå¦‚"1,2"
  weeks: string;       // å‘¨æ¬¡ï¼Œå¦‚"1-16"
  courseTime: string[]; // å…·ä½“ä¸Šè¯¾æ—¶é—´
}

// è¯¾ç¨‹APIå“åº”
export interface CourseApiResponse {
  msg: string;
  code: number;
  data: CourseInfo[];
}

// è¯¾ç¨‹ä½ç½®ä¿¡æ¯
export interface CoursePosition {
  week: number;
  day: number;
  timeSlot: number;
  course: CourseInfo;
}

export class CourseApiService {
  private static instance: CourseApiService;
  private httpService = HttpService.getInstance();
  private coursePositions: CoursePosition[] = [];

  private constructor() {}

  public static getInstance(): CourseApiService {
    if (!CourseApiService.instance) {
      CourseApiService.instance = new CourseApiService();
    }
    return CourseApiService.instance;
  }

  /**
   * è·å–è¯¾ç¨‹åˆ—è¡¨
   */
  public async getCourseList(params: CourseRequestParams): Promise<CourseApiResponse> {
    try {
      // æ„å»ºè¯·æ±‚å‚æ•°
      const requestParams = new Map<string, Object>();
      requestParams.set('week', params.week);
      requestParams.set('term', params.term);
      requestParams.set('year', params.year);
      
      if (params.classId) {
        requestParams.set('classId', params.classId);
      }
      
      if (params.username) {
        requestParams.set('username', params.username);
      }

      // å°†Mapè½¬æ¢ä¸ºæ™®é€šå¯¹è±¡
      const paramsObj: Record<string, Object> = {};
      requestParams.forEach((value, key) => {
        paramsObj[key] = value;
      });

      const response = await this.httpService.get<CourseInfo[]>('/course', paramsObj);
      
      return {
        msg: "æ“ä½œæˆåŠŸ",
        code: response.code || 200,
        data: response.data
      };
    } catch (error) {
      console.error('è·å–è¯¾ç¨‹åˆ—è¡¨å¤±è´¥:', error);
      throw new Error('è·å–è¯¾ç¨‹åˆ—è¡¨å¤±è´¥');
    }
  }

  /**
   * å¤„ç†è¯¾ç¨‹æ•°æ® - å°†çº¿æ€§æ•°æ®è½¬æ¢ä¸ºä½ç½®åˆ—è¡¨
   * å‚è€ƒclass-schedule-cçš„æ•°æ®å¤„ç†é€»è¾‘
   */
  public processCourseData(courseList: CourseInfo[]): void {
    this.coursePositions = [];
    
    courseList.forEach(course => {
      // è§£æå‘¨æ¬¡èŒƒå›´
      const weekRanges = this.parseWeekRange(course.weeks);
      
      // è§£æèŠ‚æ¬¡
      const timeSlots = this.parseSectionToTimeSlots(course.section);
      
      // è·å–æ˜ŸæœŸå¯¹åº”çš„æ•°å­—
      const dayIndex = this.getWeekdayIndex(course.weekday);
      if (dayIndex === -1) return;

      // ä¸ºæ¯ä¸ªå‘¨æ¬¡å’Œæ—¶é—´æ®µåˆ›å»ºè¯¾ç¨‹ä½ç½®
      weekRanges.forEach(week => {
        timeSlots.forEach(timeSlot => {
          this.coursePositions.push({
            week: week,
            day: dayIndex,
            timeSlot: timeSlot,
            course: course
          });
        });
      });
    });

    console.info(`ğŸ“š [Course Processing] å¤„ç†äº†${courseList.length}é—¨è¯¾ç¨‹ï¼Œç”Ÿæˆ${this.coursePositions.length}ä¸ªè¯¾ç¨‹ä½ç½®`);
  }

  /**
   * è·å–æ˜ŸæœŸå¯¹åº”çš„ç´¢å¼•
   */
  private getWeekdayIndex(weekday: string): number {
    const weekdays = ['æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­', 'æ˜ŸæœŸæ—¥'];
    return weekdays.indexOf(weekday) + 1; // 1-7
  }

  /**
   * è§£æå‘¨æ¬¡èŒƒå›´ï¼Œå¦‚"1-16"è§£æä¸º[1,2,3,...,16]
   */
  private parseWeekRange(weeksStr: string): number[] {
    const weeks: number[] = [];
    
    if (!weeksStr) return weeks;
    
    // å¤„ç†å¤šç§æ ¼å¼: "1-16", "1,3,5-7", "å•å‘¨1-15", "åŒå‘¨2-16"ç­‰
    const cleanWeeksStr = weeksStr.replace(/[å•åŒå‘¨]/g, '');
    const parts = cleanWeeksStr.split(',');
    
    parts.forEach(part => {
      if (part.includes('-')) {
        const dashIndex = part.indexOf('-');
        const start = parseInt(part.substring(0, dashIndex).trim());
        const end = parseInt(part.substring(dashIndex + 1).trim());
        for (let i = start; i <= end; i++) {
          if (!weeks.includes(i)) {
            weeks.push(i);
          }
        }
      } else {
        const week = parseInt(part.trim());
        if (!isNaN(week) && !weeks.includes(week)) {
          weeks.push(week);
        }
      }
    });

    return weeks.sort((a, b) => a - b);
  }

  /**
   * è§£æèŠ‚æ¬¡åˆ°æ—¶é—´æ®µç´¢å¼•ï¼Œå¦‚"1,2"è§£æä¸º[0] (ç¬¬1ä¸ªæ—¶é—´æ®µ)
   * "3,4"è§£æä¸º[1] (ç¬¬2ä¸ªæ—¶é—´æ®µ)
   */
  private parseSectionToTimeSlots(sectionStr: string): number[] {
    if (!sectionStr) return [];
    
    const sections = sectionStr.split(',').map(s => parseInt(s.trim()));
    const timeSlots: number[] = [];
    
    // å°†èŠ‚æ¬¡è½¬æ¢ä¸ºæ—¶é—´æ®µç´¢å¼• (æ¯2èŠ‚è¯¾ä¸º1ä¸ªæ—¶é—´æ®µ)
    sections.forEach(section => {
      const timeSlotIndex = Math.floor((section - 1) / 2);
      if (!timeSlots.includes(timeSlotIndex)) {
        timeSlots.push(timeSlotIndex);
      }
    });

    return timeSlots;
  }

  /**
   * æ ¹æ®å­¦æœŸä¿¡æ¯æ„å»ºè¯¾ç¨‹è¯·æ±‚å‚æ•°
   */
  public buildCourseParams(academicYear: string, semester: number, week: number, classId?: string, username?: string): CourseRequestParams {
    return {
      week: week,
      term: semester === 1 ? '3' : '12', // ç¬¬ä¸€å­¦æœŸç”¨3ï¼Œç¬¬äºŒå­¦æœŸç”¨12
      year: academicYear,
      classId: classId,
      username: username
    };
  }

  /**
   * è·å–æŒ‡å®šä½ç½®çš„è¯¾ç¨‹
   */
  public getCourseAt(week: number, day: number, timeSlot: number): CourseInfo | null {
    const position = this.coursePositions.find(pos => 
      pos.week === week && pos.day === day && pos.timeSlot === timeSlot
    );
    return position ? position.course : null;
  }

  /**
   * è·å–æŒ‡å®šå‘¨æ¬¡çš„æ‰€æœ‰è¯¾ç¨‹ä½ç½®
   */
  public getWeekCourses(week: number): CoursePosition[] {
    return this.coursePositions.filter(pos => pos.week === week);
  }
}