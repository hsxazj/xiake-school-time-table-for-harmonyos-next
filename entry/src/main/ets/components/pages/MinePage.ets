import { UserInfoManager } from '../../common/utils/UserInfoManager';
import { LoginApiService } from '../../services/api/LoginApiService';
import { SimpleUserInfo } from '../../models/UserModels';
import { API_CONFIG } from '../../common/constants/AppConstants';
import { AppConfigManager } from '../../services/AppConfigManager';
import { common } from '@kit.AbilityKit';

// ç”¨æˆ·ä¿¡æ¯æ¥å£
interface UserInfo {
  avatar: Resource | string;
  username: string;
  realName: string;
  studentId: string;
  college: string;
  major: string;
  className: string;
}

// èœå•é¡¹ç±»å‹æ¥å£
interface MenuItemType {
  icon: Resource;
  title: string;
  desc: string;
}

@Component
export struct MinePage {
  @Consume('NavStack') pathStack: NavPathStack;
  @StorageLink('loginStatusChanged') @Watch('onLoginStatusChanged') loginStatusChanged: number = 0;
  @State private userInfo: UserInfo = {
    avatar: $r('app.media.defaultAvatar'),
    username: 'æœªç™»å½•',
    realName: '',
    studentId: '',
    college: 'åŠ è½½ä¸­...',
    major: 'åŠ è½½ä¸­...',
    className: 'åŠ è½½ä¸­...'
  };
  @State private pageOpacity: number = 0; // é¡µé¢åˆå§‹é€æ˜åº¦ä¸º0
  @State private pageTranslateY: number = 30; // é¡µé¢åˆå§‹å‘ä¸‹åç§»30px
  @State private isLoggingOut: boolean = false; // æ˜¯å¦æ­£åœ¨é€€å‡ºç™»å½•
  @State private isLoggedIn: boolean = false; // ç™»å½•çŠ¶æ€
  @State private treeHoleEnabled: boolean = true; // æ ‘æ´åŠŸèƒ½çŠ¶æ€
  private userInfoManager: UserInfoManager = UserInfoManager.getInstance();
  private loginService: LoginApiService = LoginApiService.getInstance();
  private appConfigManager: AppConfigManager = AppConfigManager.getInstance();

  aboutToAppear(): void {
    this.loadUserInfo();
    this.checkLoginStatus();
    this.loadTreeHoleSettings();
    // å¯åŠ¨æ¸æ˜¾åŠ¨ç”»
    this.startFadeInAnimation();
  }

  build() {
    Column() {
      // ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
      Column() {
        Row() {
          // å¤´åƒ
          if (typeof this.userInfo.avatar === 'string') {
            // ç½‘ç»œå¤´åƒ
            Image(this.userInfo.avatar)
              .height(45)
              .width(45)
              .borderRadius(40)
              .margin({ right: 16 })
              .alt($r('app.media.defaultAvatar')) // åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºé»˜è®¤å¤´åƒ
          } else {
            // æœ¬åœ°Resourceå¤´åƒ
            Image(this.userInfo.avatar)
              .height(45)
              .width(45)
              .borderRadius(40)
              .margin({ right: 16 })
          }

          // ç”¨æˆ·ä¿¡æ¯
          Column() {
            // æ˜¾ç¤ºç”¨æˆ·çœŸå®å§“åï¼ˆå¦‚æœæœ‰ï¼‰æˆ–ç”¨æˆ·å
            Text(this.userInfo.realName || this.userInfo.username)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .margin({ bottom: 4 })

            // æ˜¾ç¤ºå­¦å·ï¼ˆå¦‚æœå·²ç™»å½•ï¼‰
            if (this.isLoggedIn && this.userInfo.studentId) {
              Text(`å­¦å·ï¼š${this.userInfo.studentId}`)
                .fontSize(14)
                .fontColor('#666666')
                .margin({ bottom: 4 })
            }
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)
        }
        .width('100%')
        .alignItems(VerticalAlign.Center)
      }
      .width('90%')
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(24)
      .borderWidth(1)
      .borderColor('#F2F2F2')
      .shadow({
        radius: 10,
        color: '#80000000', // åŠé€æ˜é»‘
        offsetX: 0,
        offsetY: 4
      })
      .margin({ top: 50, bottom: 20 })

      // åŠŸèƒ½è®¾ç½®åˆ—è¡¨ - æ ‘æ´å¼€å…³
      Column() {
        this.MenuSection('åŠŸèƒ½è®¾ç½®', this.getFunctionItems())
      }
      .width('90%')
      .margin({ bottom: 20 })

      // åŠŸèƒ½åˆ—è¡¨ - åªä¿ç•™é—®é¢˜åé¦ˆå’Œå…³äºæˆ‘ä»¬
      Column() {
        this.MenuSection('å¸®åŠ©ä¸ä¿¡æ¯', this.getHelpItems())
      }
      .width('90%')

      Blank()

      // ç™»å½•/é€€å‡ºç™»å½•æŒ‰é’®
      if (this.isLoggedIn) {
        Button(this.isLoggingOut ? 'é€€å‡ºä¸­...' : 'é€€å‡ºç™»å½•')
          .width('90%')
          .height(44)
          .fontSize(16)
          .fontColor('#FF6B6B')
          .backgroundColor(Color.White)
          .borderWidth(1)
          .borderColor('#FF6B6B')
          .borderRadius(8)
          .enabled(!this.isLoggingOut)
          .margin({ bottom: 20 })
          .onClick(() => {
            this.showLogoutConfirmDialog();
          })
      } else {
        Button('å»ç™»å½•')
          .width('90%')
          .height(44)
          .fontSize(16)
          .fontColor($r('app.color.schedule_primary_color'))
          .backgroundColor(Color.White)
          .borderWidth(1)
          .borderColor($r('app.color.schedule_primary_color'))
          .borderRadius(8)
          .margin({ bottom: 20 })
          .onClick(() => {
            this.navigateToLogin();
          })
      }

      Blank()
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
    .opacity(this.pageOpacity)
    .translate({ x: 0, y: this.pageTranslateY })
    .animation({
      duration: 700,
      curve: Curve.EaseInOut, // ä½¿ç”¨EaseOutBackåˆ›é€ è½»å¾®å›å¼¹æ•ˆæœ
      iterations: 1,
      playMode: PlayMode.Normal
    })
  }

  @Builder
  MenuSection(title: string, items: MenuItemType[]) {
    Column() {
      Text(title)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .width('100%')
        .margin({ bottom: 12 })

      Column() {
        ForEach(items, (item: MenuItemType, index: number) => {
          Row() {
            Image(item.icon)
              .height(24)
              .width(24)
              .margin({ right: 16 })

            Column() {
              Text(item.title)
                .fontSize(16)
                .fontColor('#333333')
                .fontWeight(FontWeight.Medium)
                .width('100%')
                .margin({ bottom: 2 })
              Text(item.desc)
                .fontSize(12)
                .fontColor('#999999')
                .width('100%')
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)

            // æ ¹æ®sectionç±»å‹æ˜¾ç¤ºä¸åŒçš„å³ä¾§ç»„ä»¶
            if (title === 'åŠŸèƒ½è®¾ç½®' && item.title === 'æ ‘æ´åŠŸèƒ½') {
              // æ ‘æ´åŠŸèƒ½æ˜¾ç¤ºå¼€å…³
              Toggle({ type: ToggleType.Switch, isOn: this.treeHoleEnabled })
                .selectedColor($r('app.color.schedule_primary_color'))
                .switchPointColor(Color.White)
                .onChange((isOn: boolean) => {
                  if (isOn !== this.treeHoleEnabled) {
                    this.toggleTreeHoleFunction();
                  }
                })
            } else {
              // å…¶ä»–é¡¹ç›®æ˜¾ç¤ºç®­å¤´
              Text('>')
                .fontSize(16)
                .fontColor('#CCCCCC')
            }
          }
          .width('100%')
          .height(60)
          .padding({ left: 16, right: 16 })
          .alignItems(VerticalAlign.Center)
          .onClick(() => {
            // å¤„ç†ç‚¹å‡»äº‹ä»¶
            if (title === 'åŠŸèƒ½è®¾ç½®' && item.title === 'æ ‘æ´åŠŸèƒ½') {
              // æ ‘æ´åŠŸèƒ½å¼€å…³ç‚¹å‡»
              this.toggleTreeHoleFunction();
            }
          })

          if (index < items.length - 1) {
            Divider()
              .color('#F0F0F0')
              .strokeWidth(0.5)
              .margin({ left: 68 })
          }
        })
      }
      .width('100%')
      .backgroundColor(Color.White)
      .borderRadius(12)
      .margin({ bottom: 20 })
      .shadow({
        radius: 10,
        color: '#80000000', // åŠé€æ˜é»‘
        offsetX: 0,
        offsetY: 4
      })
    }
  }

  /**
   * ç›‘å¬ç™»å½•çŠ¶æ€å˜åŒ–
   */
  private onLoginStatusChanged(): void {
    console.info(`[MinePage] æ”¶åˆ°ç™»å½•çŠ¶æ€å˜åŒ–é€šçŸ¥: ${this.loginStatusChanged}`);
    this.checkLoginStatus();
  }

  /**
   * æ£€æŸ¥ç™»å½•çŠ¶æ€
   */
  private checkLoginStatus(): void {
    // ä½¿ç”¨UserInfoManageræ£€æŸ¥ç™»å½•çŠ¶æ€
    this.isLoggedIn = this.userInfoManager.isLoggedInSync(this.getUIContext().getHostContext());
    console.info(`[MinePage] ç™»å½•çŠ¶æ€æ£€æŸ¥: ${this.isLoggedIn ? 'å·²ç™»å½•' : 'æœªç™»å½•'}`);

    // å¦‚æœç™»å½•çŠ¶æ€å˜åŒ–ï¼Œé‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯
    this.loadUserInfo();
  }

  /**
   * å¯åŠ¨æ¸æ˜¾åŠ¨ç”»
   */
  private startFadeInAnimation(): void {
    // çŸ­æš‚å»¶æ—¶åå¯åŠ¨åŠ¨ç”»ï¼Œè®©ç»„ä»¶å…ˆå®Œæˆåˆå§‹åŒ–
    setTimeout(() => {
      this.pageOpacity = 1;
      this.pageTranslateY = 0;
      console.info('[MinePage] ğŸ¬ å¯åŠ¨æ¸æ˜¾åŠ¨ç”»');
    }, 100);
  }

  private loadUserInfo(): void {
    const context = this.getUIContext().getHostContext();

    if (this.isLoggedIn) {
      // åŠ è½½ç™»å½•ç”¨æˆ·ä¿¡æ¯
      const currentUser: SimpleUserInfo | null = this.userInfoManager.getCurrentUserInfo(context);
      if (currentUser) {
        this.userInfo.username = currentUser.userName || 'æœªçŸ¥ç”¨æˆ·';
        this.userInfo.realName = currentUser.realName || '';
        this.userInfo.studentId = currentUser.userName || ''; // å­¦å·é€šå¸¸æ˜¯ç”¨æˆ·å

        // å¦‚æœæœ‰å¤´åƒURLï¼Œä½¿ç”¨ç½‘ç»œå›¾ç‰‡ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤å¤´åƒ
        if (currentUser.avatar && currentUser.avatar.trim() !== '') {
          this.userInfo.avatar = `${API_CONFIG.BASE_URL}${currentUser.avatar}`;
        } else {
          this.userInfo.avatar = $r('app.media.defaultAvatar');
        }

        console.info(`[MinePage] åŠ è½½ç™»å½•ç”¨æˆ·ä¿¡æ¯: ${currentUser.realName} (${currentUser.userName})`);
      } else {
        console.warn('[MinePage] ç™»å½•çŠ¶æ€ä¸ºtrueä½†æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯');
        this.resetUserInfoToDefault();
      }
    } else {
      // æœªç™»å½•çŠ¶æ€ï¼Œé‡ç½®ä¸ºé»˜è®¤ä¿¡æ¯
      this.resetUserInfoToDefault();
    }

    // åŠ è½½å­¦ç±ä¿¡æ¯ï¼ˆæ— è®ºæ˜¯å¦ç™»å½•éƒ½å°è¯•åŠ è½½ï¼‰
    const schoolInfo = this.userInfoManager.getUserInfo(context);
    console.info('[MinePage] è·å–åˆ°çš„å­¦ç±ä¿¡æ¯:', JSON.stringify(schoolInfo));

    // æ›´æ–°å­¦é™¢ã€ä¸“ä¸šã€ç­çº§ä¿¡æ¯
    if (schoolInfo.collegeName) {
      this.userInfo.college = schoolInfo.collegeName;
    } else {
      this.userInfo.college = this.isLoggedIn ? 'å­¦é™¢ä¿¡æ¯æœªè®¾ç½®' : 'è¯·å…ˆç™»å½•';
    }

    if (schoolInfo.majorName) {
      this.userInfo.major = schoolInfo.majorName;
    } else {
      this.userInfo.major = this.isLoggedIn ? 'ä¸“ä¸šä¿¡æ¯æœªè®¾ç½®' : 'è¯·å…ˆç™»å½•';
    }

    if (schoolInfo.className) {
      this.userInfo.className = schoolInfo.className;
    } else {
      this.userInfo.className = this.isLoggedIn ? 'ç­çº§ä¿¡æ¯æœªè®¾ç½®' : 'è¯·å…ˆç™»å½•';
    }

    // å¦‚æœç”¨æˆ·å·²ç™»å½•ä½†å­¦ç±ä¿¡æ¯ä¸å®Œæ•´ï¼Œæç¤ºç”¨æˆ·å®Œå–„
    if (this.isLoggedIn && (!schoolInfo.collegeName || !schoolInfo.majorName || !schoolInfo.className)) {
      console.info('[MinePage] ç”¨æˆ·å·²ç™»å½•ä½†å­¦ç±ä¿¡æ¯ä¸å®Œæ•´ï¼Œå»ºè®®ç”¨æˆ·å®Œå–„ä¿¡æ¯');
    }
  }

  /**
   * é‡ç½®ç”¨æˆ·ä¿¡æ¯ä¸ºé»˜è®¤çŠ¶æ€
   */
  private resetUserInfoToDefault(): void {
    this.userInfo.username = 'æœªç™»å½•';
    this.userInfo.realName = '';
    this.userInfo.studentId = '';
    this.userInfo.avatar = $r('app.media.defaultAvatar');
  }

  private getHelpItems(): MenuItemType[] {
    return [
      { icon: $r("app.media.problemFeedback"), title: 'é—®é¢˜åé¦ˆ', desc: 'åé¦ˆä½¿ç”¨é—®é¢˜å’Œå»ºè®®' },
      { icon: $r("app.media.aboutUs"), title: 'å…³äºæˆ‘ä»¬', desc: 'åº”ç”¨ä¿¡æ¯å’Œç‰ˆæœ¬' }
    ];
  }

  /**
   * è·å–åŠŸèƒ½è®¾ç½®åˆ—è¡¨é¡¹
   */
  private getFunctionItems(): MenuItemType[] {
    return [
      { icon: $r("app.media.treehole"), title: 'æ ‘æ´åŠŸèƒ½', desc: this.treeHoleEnabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨' }
    ];
  }

  /**
   * åŠ è½½æ ‘æ´åŠŸèƒ½è®¾ç½®
   */
  private loadTreeHoleSettings(): void {
    try {
      // ä»AppConfigManagerè·å–æ ‘æ´åŠŸèƒ½çŠ¶æ€
      this.treeHoleEnabled = this.appConfigManager.getTreeHoleEnabled();
      console.info(`[MinePage] æ ‘æ´åŠŸèƒ½çŠ¶æ€: ${this.treeHoleEnabled}`);
    } catch (error) {
      console.error('[MinePage] åŠ è½½æ ‘æ´åŠŸèƒ½è®¾ç½®å¤±è´¥:', error);
      this.treeHoleEnabled = true; // é»˜è®¤å¯ç”¨
    }
  }

  /**
   * åˆ‡æ¢æ ‘æ´åŠŸèƒ½çŠ¶æ€
   */
  private toggleTreeHoleFunction(): void {
    try {
      const newState = !this.treeHoleEnabled;
      const context = this.getUIContext().getHostContext();

      // æ£€æŸ¥contextæ˜¯å¦æœ‰æ•ˆ
      if (!context) {
        console.error('[MinePage] æ— æ³•è·å–æœ‰æ•ˆçš„context');
        this.showToast('è®¾ç½®å¤±è´¥ï¼Œè¯·é‡è¯•');
        return;
      }

      // ä¿å­˜æ–°çŠ¶æ€åˆ°AppConfigManager
      this.appConfigManager.setTreeHoleEnabled(newState, context);
      this.treeHoleEnabled = newState;

      console.info(`[MinePage] æ ‘æ´åŠŸèƒ½å·²${newState ? 'å¯ç”¨' : 'ç¦ç”¨'}`);

      // æ˜¾ç¤ºé‡å¯æç¤ºå¯¹è¯æ¡†
      this.showRestartConfirmDialog();

    } catch (error) {
      console.error('[MinePage] åˆ‡æ¢æ ‘æ´åŠŸèƒ½å¤±è´¥:', error);
      this.showToast('è®¾ç½®å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  /**
   * æ˜¾ç¤ºé‡å¯ç¡®è®¤å¯¹è¯æ¡†
   */
  private showRestartConfirmDialog(): void {
    this.getUIContext().showAlertDialog({
      title: 'è®¾ç½®å·²æ›´æ–°',
      message: `æ ‘æ´åŠŸèƒ½å·²${this.treeHoleEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}ï¼Œéœ€è¦é‡å¯åº”ç”¨æ‰èƒ½ç”Ÿæ•ˆã€‚`,
      alignment: DialogAlignment.Center,
      primaryButton: {
        value: 'ç¨åé‡å¯',
        fontColor: $r('app.color.schedule_primary_color'),
        action: () => {
          this.showToast('è®¾ç½®å·²ä¿å­˜ï¼Œä¸‹æ¬¡å¯åŠ¨æ—¶ç”Ÿæ•ˆ');
        }
      },
      secondaryButton: {
        value: 'ç«‹å³é‡å¯',
        fontColor: $r('app.color.schedule_primary_color'),
        action: () => {
          this.restartApp();
        }
      }
    });
  }

  /**
   * é‡å¯åº”ç”¨
   */
  private restartApp(): void {
    try {
      const context = this.getUIContext().getHostContext();

      // æ£€æŸ¥contextæ˜¯å¦æœ‰æ•ˆ
      if (!context) {
        console.error('[MinePage] æ— æ³•è·å–æœ‰æ•ˆçš„context');
        this.showToast('é‡å¯å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é‡å¯åº”ç”¨');
        return;
      }

      console.info('[MinePage] å‡†å¤‡é‡å¯åº”ç”¨...');

      // è·å–UIAbilityContextæ¥æ‰§è¡Œé‡å¯
      const abilityContext = context as common.UIAbilityContext;

      // ä½¿ç”¨HarmonyOS APIé‡å¯åº”ç”¨
      abilityContext.terminateSelf((error: Error) => {
        if (error) {
          console.error('[MinePage] é‡å¯åº”ç”¨å¤±è´¥:', error);
          this.showToast('é‡å¯å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é‡å¯åº”ç”¨');
        } else {
          console.info('[MinePage] åº”ç”¨é‡å¯æˆåŠŸ');
        }
      });
    } catch (error) {
      console.error('[MinePage] é‡å¯åº”ç”¨å¼‚å¸¸:', error);
      this.showToast('é‡å¯å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é‡å¯åº”ç”¨');
    }
  }

  /**
   * æ˜¾ç¤ºé€€å‡ºç™»å½•ç¡®è®¤å¯¹è¯æ¡†
   */
  private showLogoutConfirmDialog(): void {
    this.getUIContext().showAlertDialog({
      title: 'é€€å‡ºç™»å½•',
      message: 'ç¡®è®¤è¦é€€å‡ºå½“å‰è´¦æˆ·å—ï¼Ÿ',
      alignment: DialogAlignment.Center,
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {
          console.info('[MinePage] ç”¨æˆ·å–æ¶ˆé€€å‡ºç™»å½•');
        }
      },
      secondaryButton: {
        value: 'ç¡®è®¤é€€å‡º',
        fontColor: '#FF6B6B',
        action: () => {
          this.handleLogout();
        }
      }
    });
  }

  /**
   * è·³è½¬åˆ°ç™»å½•é¡µé¢
   */
  private navigateToLogin(): void {
    try {
      this.pathStack.pushPathByName('LoginNavPage', null, true); // ä½¿ç”¨æ¨¡æ€è½¬åœº
      console.info('[MinePage] è·³è½¬åˆ°ç™»å½•é¡µé¢');
    } catch (error) {
      console.error('[MinePage] è·³è½¬åˆ°ç™»å½•é¡µé¢å¤±è´¥:', error);
    }
  }

  /**
   * å¤„ç†é€€å‡ºç™»å½•
   */
  private async handleLogout(): Promise<void> {
    try {
      this.isLoggingOut = true;
      console.info('[MinePage] ğŸ”„ å¼€å§‹é€€å‡ºç™»å½•...');

      // è·å–contextç”¨äºæ¸…é™¤é¦–é€‰é¡¹
      const context = this.getUIContext().getHostContext();

      // ä½¿ç”¨UserInfoManageræ¸…é™¤ç™»å½•ä¿¡æ¯
      this.userInfoManager.clearAllInfo(context);

      // æ¸…é™¤AppStorageä¸­çš„token
      AppStorage.setOrCreate('token', '');

      console.info('[MinePage] âœ… é€€å‡ºç™»å½•æˆåŠŸ');

      // æ›´æ–°æœ¬åœ°ç™»å½•çŠ¶æ€
      this.isLoggedIn = false;

      // é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼ˆæ˜¾ç¤ºæœªç™»å½•çŠ¶æ€ï¼‰
      this.loadUserInfo();

      // é€šçŸ¥ç™»å½•çŠ¶æ€å˜åŒ–
      AppStorage.setOrCreate('loginStatusChanged', Date.now());
      console.info('[MinePage] ğŸ“¢ å·²å‘é€ç™»å½•çŠ¶æ€å˜åŒ–é€šçŸ¥');

      // æ˜¾ç¤ºæˆåŠŸæç¤º
      this.showToast('å·²é€€å‡ºç™»å½•');

    } catch (error) {
      console.error('[MinePage] âŒ é€€å‡ºç™»å½•å¤±è´¥:', JSON.stringify(error));
      this.showToast('é€€å‡ºç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      this.isLoggingOut = false;
    }
  }

  /**
   * æ˜¾ç¤ºToastæç¤º
   */
  private showToast(message: string): void {
    // ä½¿ç”¨ç³»ç»ŸToastæ˜¾ç¤ºæç¤ºä¿¡æ¯
    // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨console.infoä½œä¸ºç®€å•å®ç°ï¼Œå®é™…é¡¹ç›®ä¸­å¯ä»¥ä½¿ç”¨æ›´å®Œæ•´çš„Toastç»„ä»¶
    console.info(`[Toast] ${message}`);
  }
}