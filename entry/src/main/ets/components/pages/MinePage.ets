import { UserInfoManager } from '../../common/utils/UserInfoManager';
import { LoginApiService } from '../../services/api/LoginApiService';

// ç”¨æˆ·ä¿¡æ¯æ¥å£
interface UserInfo {
  avatar: Resource;
  username: string;
  studentId: string;
  college: string;
  major: string;
  className: string;
}

// èœå•é¡¹ç±»å‹æ¥å£
interface MenuItemType {
  icon: Resource;
  title: string;
  desc: string;
}

@Component
export struct MinePage {
  private pathStack: NavPathStack = new NavPathStack();
  @State private userInfo: UserInfo = {
    avatar: $r('app.media.defaultAvatar'),
    username: 'FJUTER',
    studentId: '2024001',
    college: 'åŠ è½½ä¸­...',
    major: 'åŠ è½½ä¸­...',
    className: 'åŠ è½½ä¸­...'
  };
  @State private pageOpacity: number = 0; // é¡µé¢åˆå§‹é€æ˜åº¦ä¸º0
  @State private pageTranslateY: number = 30; // é¡µé¢åˆå§‹å‘ä¸‹åç§»30px
  @State private isLoggingOut: boolean = false; // æ˜¯å¦æ­£åœ¨é€€å‡ºç™»å½•
  
  private userInfoManager: UserInfoManager = UserInfoManager.getInstance();
  private loginService: LoginApiService = LoginApiService.getInstance();

  aboutToAppear(): void {
    this.loadUserInfo();
    // å¯åŠ¨æ¸æ˜¾åŠ¨ç”»
    this.startFadeInAnimation();
  }

  /**
   * å¯åŠ¨æ¸æ˜¾åŠ¨ç”»
   */
  private startFadeInAnimation(): void {
    // çŸ­æš‚å»¶æ—¶åå¯åŠ¨åŠ¨ç”»ï¼Œè®©ç»„ä»¶å…ˆå®Œæˆåˆå§‹åŒ–
    setTimeout(() => {
      this.pageOpacity = 1;
      this.pageTranslateY = 0;
      console.info('[MinePage] ğŸ¬ å¯åŠ¨æ¸æ˜¾åŠ¨ç”»');
    }, 100);
  }

  build() {
    Column() {
      // ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
      Column() {
        Row() {
          // å¤´åƒ
          Image(this.userInfo.avatar)
            .height(45)
            .width(45)
            .borderRadius(40)
            .margin({ right: 16 })

          // ç”¨æˆ·ä¿¡æ¯
          Column() {
            Text(this.userInfo.username)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .margin({ bottom: 4 })
            // Text(`å­¦å·ï¼š${this.userInfo.studentId}`)
            //   .fontSize(14)
            //   .fontColor('#666666')
            //   .margin({ bottom: 2 })
            Text(`${this.userInfo.college}`)
              .fontSize(12)
              .fontColor('#999999')
              .margin({ bottom: 2 })
            Text(`${this.userInfo.major}`)
              .fontSize(12)
              .fontColor('#999999')
              .margin({ bottom: 2 })
            Text(this.userInfo.className)
              .fontSize(12)
              .fontColor('#999999')
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)
        }
        .width('100%')
        .alignItems(VerticalAlign.Center)
      }
      .width('90%')
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(24)
      .borderWidth(1)
      .borderColor('#F2F2F2')
      .shadow({
        radius: 10,
        color: '#80000000', // åŠé€æ˜é»‘
        offsetX: 0,
        offsetY: 4
      })
      .margin({ top: 50, bottom: 20 })
      .onClick(() => {
        this.navigateToClassSelect();
      })

      // åŠŸèƒ½åˆ—è¡¨ - åªä¿ç•™é—®é¢˜åé¦ˆå’Œå…³äºæˆ‘ä»¬
      Column() {
        this.MenuSection('å¸®åŠ©ä¸ä¿¡æ¯', this.getHelpItems())
      }
      .width('90%')
      .layoutWeight(1)

      // é€€å‡ºç™»å½•æŒ‰é’®
      Button(this.isLoggingOut ? 'é€€å‡ºä¸­...' : 'é€€å‡ºç™»å½•')
        .width('90%')
        .height(44)
        .fontSize(16)
        .fontColor('#FF6B6B')
        .backgroundColor(Color.White)
        .borderWidth(1)
        .borderColor('#FF6B6B')
        .borderRadius(8)
        .enabled(!this.isLoggingOut)
        .margin({ bottom: 20 })
        .onClick(() => {
          this.showLogoutConfirmDialog();
        })

      Blank()
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
    .opacity(this.pageOpacity)
    .translate({ x: 0, y: this.pageTranslateY })
    .animation({
      duration: 700,
      curve: Curve.EaseInOut, // ä½¿ç”¨EaseOutBackåˆ›é€ è½»å¾®å›å¼¹æ•ˆæœ
      iterations: 1,
      playMode: PlayMode.Normal
    })
  }

  @Builder
  MenuSection(title: string, items: MenuItemType[]) {
    Column() {
      Text(title)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .width('100%')
        .margin({ bottom: 12 })

      Column() {
        ForEach(items, (item: MenuItemType, index: number) => {
          Row() {
            Image(item.icon)
              .height(24)
              .width(24)
              .margin({ right: 16 })

            Column() {
              Text(item.title)
                .fontSize(16)
                .fontColor('#333333')
                .fontWeight(FontWeight.Medium)
                .width('100%')
                .margin({ bottom: 2 })
              Text(item.desc)
                .fontSize(12)
                .fontColor('#999999')
                .width('100%')
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)

            Text('>')
              .fontSize(16)
              .fontColor('#CCCCCC')
          }
          .width('100%')
          .height(60)
          .padding({ left: 16, right: 16 })
          .alignItems(VerticalAlign.Center)
          .onClick(() => {
            // å¤„ç†ç‚¹å‡»äº‹ä»¶
          })

          if (index < items.length - 1) {
            Divider()
              .color('#F0F0F0')
              .strokeWidth(0.5)
              .margin({ left: 68 })
          }
        })
      }
      .width('100%')
      .backgroundColor(Color.White)
      .borderRadius(12)
      .margin({ bottom: 20 })
      .shadow({
        radius: 10,
        color: '#80000000', // åŠé€æ˜é»‘
        offsetX: 0,
        offsetY: 4
      })
    }
  }

  private loadUserInfo(): void {
    const schoolInfo = this.userInfoManager.getUserInfo(this.getUIContext().getHostContext());
    console.info('è·å–åˆ°çš„ç”¨æˆ·ä¿¡æ¯:', JSON.stringify(schoolInfo));

    // æ›´æ–°å­¦é™¢ã€ä¸“ä¸šã€ç­çº§ä¿¡æ¯
    if (schoolInfo.collegeName) {
      this.userInfo.college = schoolInfo.collegeName;
    }

    if (schoolInfo.majorName) {
      this.userInfo.major = schoolInfo.majorName;
    }

    if (schoolInfo.className) {
      this.userInfo.className = schoolInfo.className;
    }

    // å¦‚æœæ²¡æœ‰å®Œæ•´ä¿¡æ¯ï¼Œæ˜¾ç¤ºæç¤º
    if (!schoolInfo.collegeName || !schoolInfo.majorName || !schoolInfo.className) {
      console.info('ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´ï¼Œå»ºè®®ç”¨æˆ·å®Œå–„ä¿¡æ¯');
    }
  }

  private getHelpItems(): MenuItemType[] {
    return [
      { icon: $r("app.media.problemFeedback"), title: 'é—®é¢˜åé¦ˆ', desc: 'åé¦ˆä½¿ç”¨é—®é¢˜å’Œå»ºè®®' },
      { icon: $r("app.media.aboutUs"), title: 'å…³äºæˆ‘ä»¬', desc: 'åº”ç”¨ä¿¡æ¯å’Œç‰ˆæœ¬' }
    ];
  }

  /**
   * æ˜¾ç¤ºé€€å‡ºç™»å½•ç¡®è®¤å¯¹è¯æ¡†
   */
  private showLogoutConfirmDialog(): void {
    AlertDialog.show({
      title: 'é€€å‡ºç™»å½•',
      message: 'ç¡®è®¤è¦é€€å‡ºå½“å‰è´¦æˆ·å—ï¼Ÿ',
      alignment: DialogAlignment.Center,
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {
          console.info('[MinePage] ç”¨æˆ·å–æ¶ˆé€€å‡ºç™»å½•');
        }
      },
      secondaryButton: {
        value: 'ç¡®è®¤é€€å‡º',
        fontColor: '#FF6B6B',
        action: () => {
          this.handleLogout();
        }
      }
    });
  }

  /**
   * å¤„ç†é€€å‡ºç™»å½•
   */
  private async handleLogout(): Promise<void> {
    try {
      this.isLoggingOut = true;
      console.info('[MinePage] ğŸ”„ å¼€å§‹é€€å‡ºç™»å½•...');

      // è·å–contextç”¨äºæ¸…é™¤é¦–é€‰é¡¹
      const context = this.getUIContext().getHostContext();
      
      // è°ƒç”¨ç™»å½•æœåŠ¡çš„é€€å‡ºæ–¹æ³•
      this.loginService.logout(context);
      console.info('[MinePage] âœ… é€€å‡ºç™»å½•æˆåŠŸ');

      // é€šçŸ¥ç™»å½•çŠ¶æ€å˜åŒ–
      AppStorage.setOrCreate('loginStatusChanged', Date.now());
      console.info('[MinePage] ğŸ“¢ å·²å‘é€ç™»å½•çŠ¶æ€å˜åŒ–é€šçŸ¥');

      // æ˜¾ç¤ºæˆåŠŸæç¤º
      this.showToast('å·²é€€å‡ºç™»å½•');

    } catch (error) {
      console.error('[MinePage] âŒ é€€å‡ºç™»å½•å¤±è´¥:', JSON.stringify(error));
      this.showToast('é€€å‡ºç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      this.isLoggingOut = false;
    }
  }

  /**
   * æ˜¾ç¤ºToastæç¤º
   */
  private showToast(message: string): void {
    // ä½¿ç”¨ç³»ç»ŸToastæ˜¾ç¤ºæç¤ºä¿¡æ¯
    // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨console.infoä½œä¸ºç®€å•å®ç°ï¼Œå®é™…é¡¹ç›®ä¸­å¯ä»¥ä½¿ç”¨æ›´å®Œæ•´çš„Toastç»„ä»¶
    console.info(`[Toast] ${message}`);
  }

  /**
   * è·³è½¬åˆ°ç­çº§é€‰æ‹©é¡µé¢
   */
  private navigateToClassSelect(): void {
    try {
      this.pathStack.pushPathByName('ClassSelectPage', null);
      console.info('è·³è½¬åˆ°ç­çº§é€‰æ‹©é¡µé¢');
    } catch (error) {
      console.error('è·³è½¬åˆ°ç­çº§é€‰æ‹©é¡µé¢å¤±è´¥:', error);
    }
  }
}