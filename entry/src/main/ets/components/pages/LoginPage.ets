import { LoginApiService } from '../../services/api/LoginApiService';
import { LoginForm, LoginStatus } from '../../models/LoginModels';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { promptAction } from '@kit.ArkUI';

const DOMAIN = 0x3000; // Login Page domain

/**
 * ç™»å½•é¡µé¢ç»„ä»¶
 * æä¾›è´¦å·å¯†ç ç™»å½•åŠŸèƒ½
 */
@Component
@Preview
export struct LoginPage {
  @State private loginForm: LoginForm = {
    username: '',
    password: ''
  };
  @State private loginStatus: LoginStatus = LoginStatus.IDLE;
  @State private errorMessage: string = '';
  @State private showPassword: boolean = false;

  private loginService: LoginApiService = LoginApiService.getInstance();

  build() {
    Column() {
      // é¡¶éƒ¨Logoå’Œæ ‡é¢˜åŒºåŸŸ
      this.buildHeader()

      // ç™»å½•è¡¨å•åŒºåŸŸ
      this.buildLoginForm()

      // ç™»å½•æŒ‰é’®
      this.buildLoginButton()

      // é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
      if (this.errorMessage) {
        this.buildErrorMessage()
      }

      Blank()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
    .padding({ left: 24, right: 24, top: 40 })
  }

  @Builder
  buildHeader() {
    Column() {
      // Logoå›¾æ ‡
      Image($r('app.media.startIcon'))
        .width(80)
        .height(80)
        .borderRadius(16)
        .margin({ bottom: 20 })

      // åº”ç”¨åç§°
      Text('éœå®¢è¯¾è¡¨')
        .fontSize(28)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1F2937')
        .margin({ bottom: 8 })

      // å‰¯æ ‡é¢˜
      Text('è¯·ç™»å½•æ‚¨çš„è´¦å·')
        .fontSize(16)
        .fontColor('#6B7280')
        .margin({ bottom: 40 })
    }
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  buildLoginForm() {
    Column({ space: 20 }) {
      // ç”¨æˆ·åè¾“å…¥æ¡†
      Column({ space: 8 }) {
        Text('å­¦å·')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#374151')
          .alignSelf(ItemAlign.Start)

        TextInput({
          placeholder: 'è¯·è¾“å…¥å­¦å·',
          text: $$this.loginForm.username
        })
          .height(48)
          .borderRadius(8)
          .backgroundColor(Color.White)
          .borderColor(this.loginForm.username ? '#3B82F6' : '#E5E7EB')
          .borderWidth(1)
          .placeholderColor('#9CA3AF')
          .fontSize(16)
          .padding({ left: 12, right: 12 })
          .onChange((value: string) => {
            this.loginForm.username = value;
            this.clearError();
          })
      }

      // å¯†ç è¾“å…¥æ¡†
      Column({ space: 8 }) {
        Text('å¯†ç ')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#374151')
          .alignSelf(ItemAlign.Start)

        Row() {
          TextInput({
            placeholder: 'è¯·è¾“å…¥å¯†ç ',
            text: $$this.loginForm.password
          })
            .layoutWeight(1)
            .height(48)
            .borderRadius(8)
            .backgroundColor(Color.White)
            .borderColor(this.loginForm.password ? '#3B82F6' : '#E5E7EB')
            .borderWidth(1)
            .placeholderColor('#9CA3AF')
            .fontSize(16)
            .padding({ left: 12, right: 40 })
            .type(this.showPassword ? InputType.Normal : InputType.Password)
            .onChange((value: string) => {
              this.loginForm.password = value;
              this.clearError();
            })

          // å¯†ç å¯è§æ€§åˆ‡æ¢æŒ‰é’®
          Button() {
            Image(this.showPassword ? $r('app.media.treehole') : $r('app.media.treehole_active'))
              .width(20)
              .height(20)
              .fillColor('#9CA3AF')
          }
          .width(32)
          .height(32)
          .backgroundColor(Color.Transparent)
          .position({ x: '85%', y: '50%' })
          .translate({ x: '-50%', y: '-50%' })
          .onClick(() => {
            this.showPassword = !this.showPassword;
          })
        }
        .width('100%')
      }
    }
    .width('100%')
    .margin({ bottom: 32 })
  }

  @Builder
  buildLoginButton() {
    Button() {
      if (this.loginStatus === LoginStatus.LOADING) {
        Row({ space: 8 }) {
          LoadingProgress()
            .width(20)
            .height(20)
            .color(Color.White)
          Text('ç™»å½•ä¸­...')
            .fontSize(16)
            .fontColor(Color.White)
        }
      } else {
        Text('ç™»å½•')
          .fontSize(16)
          .fontColor(Color.White)
      }
    }
    .width('100%')
    .height(48)
    .borderRadius(8)
    .backgroundColor(this.isFormValid() && this.loginStatus !== LoginStatus.LOADING ? '#3B82F6' : '#9CA3AF')
    .enabled(this.isFormValid() && this.loginStatus !== LoginStatus.LOADING)
    .onClick(() => {
      this.handleLogin();
    })
  }

  @Builder
  buildErrorMessage() {
    Row({ space: 8 }) {
      Image($r('app.media.treehole'))
        .width(16)
        .height(16)
        .fillColor('#EF4444')

      Text(this.errorMessage)
        .fontSize(14)
        .fontColor('#EF4444')
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#FEF2F2')
    .borderRadius(8)
    .borderColor('#FECACA')
    .borderWidth(1)
    .margin({ top: 16 })
  }

  /**
   * å¤„ç†ç™»å½•é€»è¾‘
   */
  private async handleLogin(): Promise<void> {
    if (!this.isFormValid()) {
      return;
    }

    try {
      this.loginStatus = LoginStatus.LOADING;
      this.clearError();

      hilog.info(DOMAIN, 'LoginPage', `ğŸ” [Login] å¼€å§‹ç™»å½•: ${this.loginForm.username}`);

      // è°ƒç”¨ç™»å½•API
      await this.loginService.login(this.loginForm);

      this.loginStatus = LoginStatus.SUCCESS;
      hilog.info(DOMAIN, 'LoginPage', 'âœ… [Login] ç™»å½•æˆåŠŸ');

      // ç™»å½•æˆåŠŸçš„æç¤º
      this.showSuccessMessage();

    } catch (error) {
      this.loginStatus = LoginStatus.FAILED;
      
      if (error instanceof Error) {
        this.errorMessage = error.message;
        hilog.error(DOMAIN, 'LoginPage', `âŒ [Login] ç™»å½•å¤±è´¥: ${error.message}`);
      } else {
        this.errorMessage = 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•';
        hilog.error(DOMAIN, 'LoginPage', 'âŒ [Login] ç™»å½•å¤±è´¥: æœªçŸ¥é”™è¯¯');
      }
    }
  }

  /**
   * è¡¨å•éªŒè¯
   */
  private isFormValid(): boolean {
    return !!(
      this.loginForm.username.trim().length > 0 &&
      this.loginForm.password.trim().length > 0
    );
  }

  /**
   * æ¸…é™¤é”™è¯¯ä¿¡æ¯
   */
  private clearError(): void {
    if (this.errorMessage) {
      this.errorMessage = '';
    }
    if (this.loginStatus === LoginStatus.FAILED) {
      this.loginStatus = LoginStatus.IDLE;
    }
  }

  /**
   * æ˜¾ç¤ºæˆåŠŸæç¤º
   */
  private showSuccessMessage(): void {
    // æ˜¾ç¤ºæˆåŠŸæç¤º
    promptAction.showToast({
      message: 'ç™»å½•æˆåŠŸï¼',
      duration: 2000,
      bottom: 100
    });
    
    // å»¶æ—¶è§¦å‘çŠ¶æ€æ›´æ–°ï¼Œè®©çˆ¶ç»„ä»¶æœ‰æœºä¼šé‡æ–°æ£€æŸ¥ç™»å½•çŠ¶æ€
    setTimeout(() => {
      // é€šè¿‡ä¿®æ”¹AppStorageä¸­çš„ä¸€ä¸ªæ ‡è®°æ¥è§¦å‘MainTabNavPageçš„çŠ¶æ€æ£€æŸ¥
      AppStorage.setOrCreate('loginStatusChanged', Date.now());
    }, 500);
    
    hilog.info(DOMAIN, 'LoginPage', 'ğŸ‰ [Success] ç™»å½•æˆåŠŸæç¤ºå·²æ˜¾ç¤º');
  }
}