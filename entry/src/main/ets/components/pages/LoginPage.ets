import { LoginApiService } from '../../services/api/LoginApiService';
import { LoginForm, LoginStatus } from '../../models/LoginModels';
import { UserInfoManager } from '../../common/utils/UserInfoManager';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { common } from '@kit.AbilityKit';

const DOMAIN = 0x3000; // Login Page domain

@Builder
export function LoginNavPageBuilder() {
  LoginNavPage();
}

@Component
struct LoginNavPage {
  @Consume('NavStack') pathStack: NavPathStack;

  build() {
    NavDestination() {
      LoginPageContent()
    }
    .hideTitleBar(true)
    .onReady((ctx: NavDestinationContext) => {
      this.pathStack = ctx.pathStack;
    })
  }
}

/**
 * ç™»å½•é¡µé¢ç»„ä»¶
 * æä¾›è´¦å·å¯†ç ç™»å½•åŠŸèƒ½
 */
@Component
@Preview
export struct LoginPageContent {
  @Consume('NavStack') pathStack: NavPathStack;
  @State private loginForm: LoginForm = {
    username: '',
    password: ''
  };
  @State private loginStatus: LoginStatus = LoginStatus.IDLE;
  @State private errorMessage: string = '';
  @State private showPassword: boolean = false;
  @State private pageOpacity: number = 0; // é¡µé¢åˆå§‹é€æ˜åº¦ä¸º0
  @State private pageTranslateY: number = 30; // é¡µé¢åˆå§‹å‘ä¸‹åç§»30px
  private promptAction = this.getUIContext().getPromptAction();
  private loginService: LoginApiService = LoginApiService.getInstance();
  private userInfoManager: UserInfoManager = UserInfoManager.getInstance();

  aboutToAppear(): void {
    // å¯åŠ¨æ¸æ˜¾åŠ¨ç”»
    this.startFadeInAnimation();
  }

  build() {
    Column() {
      // é¡¶éƒ¨Logoå’Œæ ‡é¢˜åŒºåŸŸ
      this.buildHeader()

      // ç™»å½•è¡¨å•åŒºåŸŸ
      this.buildLoginForm()

      // ç™»å½•æŒ‰é’®
      this.buildLoginButton()

      Blank()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
    .padding({ left: 24, right: 24, top: 40 })
    .opacity(this.pageOpacity)
    .translate({ x: 0, y: this.pageTranslateY })
    .animation({
      duration: 700,
      curve: Curve.EaseInOut, // ä½¿ç”¨EaseInOutåˆ›é€ æµç•…çš„æ¸æ˜¾æ•ˆæœ
      iterations: 1,
      playMode: PlayMode.Normal
    })
  }

  @Builder
  buildHeader() {
    Column() {
      // Logoå›¾æ ‡
      Image($r('app.media.startIcon'))
        .width(80)
        .height(80)
        .borderRadius(16)
        .margin({ bottom: 20 })

      // åº”ç”¨åç§°
      Text('éœå®¢è¯¾è¡¨')
        .fontSize(28)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1F2937')
        .margin({ bottom: 8 })

      // å‰¯æ ‡é¢˜
      Text('è¯·ç™»å½•æ‚¨çš„è´¦å·')
        .fontSize(16)
        .fontColor('#6B7280')
        .margin({ bottom: 40 })
    }
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  buildLoginForm() {
    Column({ space: 20 }) {
      // ç”¨æˆ·åè¾“å…¥æ¡†
      Column({ space: 8 }) {
        Text('å­¦å·')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#374151')
          .alignSelf(ItemAlign.Start)

        TextInput({
          placeholder: 'è¯·è¾“å…¥å­¦å·',
          text: $$this.loginForm.username
        })
          .height(48)
          .borderRadius(8)
          .backgroundColor(Color.White)
          .borderColor(this.loginForm.username ? $r('app.color.schedule_primary_color') : '#E5E7EB')
          .borderWidth(1)
          .placeholderColor('#9CA3AF')
          .fontSize(16)
          .padding({ left: 12, right: 12 })
          .onChange((value: string) => {
            this.loginForm.username = value;
            this.clearError();
          })
      }

      // å¯†ç è¾“å…¥æ¡†
      Column({ space: 8 }) {
        Text('å¯†ç ')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#374151')
          .alignSelf(ItemAlign.Start)

        Row() {
          TextInput({
            placeholder: 'è¯·è¾“å…¥å¯†ç ',
            text: $$this.loginForm.password
          })
            .layoutWeight(1)
            .height(48)
            .borderRadius(8)
            .backgroundColor(Color.White)
            .borderColor(this.loginForm.password ? $r('app.color.schedule_primary_color') : '#E5E7EB')
            .borderWidth(1)
            .placeholderColor('#9CA3AF')
            .fontSize(16)
            .padding({ left: 12, right: 40 })
            .type(this.showPassword ? InputType.Normal : InputType.Password)
            .onChange((value: string) => {
              this.loginForm.password = value;
              this.clearError();
            })
        }
        .width('100%')
      }
    }
    .width('100%')
    .margin({ bottom: 32 })
  }

  @Builder
  buildLoginButton() {
    Button() {
      if (this.loginStatus === LoginStatus.LOADING) {
        Row({ space: 8 }) {
          LoadingProgress()
            .width(20)
            .height(20)
            .color(Color.White)
          Text('ç™»å½•ä¸­...')
            .fontSize(16)
            .fontColor(Color.White)
        }
      } else {
        Text('ç™»å½•')
          .fontSize(16)
          .fontColor(Color.White)
      }
    }
    .width('100%')
    .height(48)
    .borderRadius(8)
    .backgroundColor(this.isFormValid() && this.loginStatus !== LoginStatus.LOADING ? $r('app.color.schedule_primary_color') : '#9CA3AF')
    .enabled(this.isFormValid() && this.loginStatus !== LoginStatus.LOADING)
    .onClick(() => {
      this.handleLogin();
    })
  }

  /**
   * å¯åŠ¨æ¸æ˜¾åŠ¨ç”»
   */
  private startFadeInAnimation(): void {
    // çŸ­æš‚å»¶æ—¶åå¯åŠ¨åŠ¨ç”»ï¼Œè®©ç»„ä»¶å…ˆå®Œæˆåˆå§‹åŒ–
    setTimeout(() => {
      this.pageOpacity = 1;
      this.pageTranslateY = 0;
      console.info('[LoginPage] ğŸ¬ å¯åŠ¨æ¸æ˜¾åŠ¨ç”»');
    }, 100);
  }

  /**
   * å¤„ç†ç™»å½•é€»è¾‘
   */
  private async handleLogin(): Promise<void> {
    if (!this.isFormValid()) {
      return;
    }

    try {
      this.loginStatus = LoginStatus.LOADING;
      this.clearError();

      hilog.info(DOMAIN, 'LoginPage', `ğŸ” [Login] å¼€å§‹ç™»å½•: ${this.loginForm.username}`);

      // è·å–UIAbilityContext
      const context = this.getUIContext().getHostContext() as common.UIAbilityContext;

      // è°ƒç”¨ç™»å½•APIï¼Œä¼ é€’contextç”¨äºtokenæŒä¹…åŒ–
      await this.loginService.login(this.loginForm, context);

      this.loginStatus = LoginStatus.SUCCESS;
      hilog.info(DOMAIN, 'LoginPage', 'âœ… [Login] ç™»å½•æˆåŠŸ');

      // ç™»å½•æˆåŠŸåè‡ªåŠ¨è·å–ç”¨æˆ·ä¿¡æ¯
      try {
        hilog.info(DOMAIN, 'LoginPage', 'ğŸ”„ [Login] å¼€å§‹è·å–ç”¨æˆ·ä¿¡æ¯...');
        await this.userInfoManager.checkLoginStatus(context);
        hilog.info(DOMAIN, 'LoginPage', 'âœ… [Login] ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ');
      } catch (error) {
        hilog.error(DOMAIN, 'LoginPage', `âš ï¸ [Login] è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${JSON.stringify(error)}`);
        // ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥ä¸å½±å“ç™»å½•æµç¨‹
      }

      // ç™»å½•æˆåŠŸçš„æç¤º
      this.showSuccessMessage();

    } catch (error) {
      this.loginStatus = LoginStatus.FAILED;

      if (error instanceof Error) {
        this.errorMessage = error.message;
        hilog.error(DOMAIN, 'LoginPage', `âŒ [Login] ç™»å½•å¤±è´¥: ${error.message}`);
      } else {
        this.errorMessage = 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•';
        hilog.error(DOMAIN, 'LoginPage', 'âŒ [Login] ç™»å½•å¤±è´¥: æœªçŸ¥é”™è¯¯');
      }
    }
  }

  /**
   * è¡¨å•éªŒè¯
   */
  private isFormValid(): boolean {
    return !!(
      this.loginForm.username.trim().length > 0 &&
        this.loginForm.password.trim().length > 0
    );
  }

  /**
   * æ¸…é™¤é”™è¯¯ä¿¡æ¯
   */
  private clearError(): void {
    if (this.errorMessage) {
      this.errorMessage = '';
    }
    if (this.loginStatus === LoginStatus.FAILED) {
      this.loginStatus = LoginStatus.IDLE;
    }
  }

  /**
   * æ˜¾ç¤ºæˆåŠŸæç¤º
   */
  private showSuccessMessage(): void {
    // æ˜¾ç¤ºæˆåŠŸæç¤º
    this.promptAction.showToast({
      message: 'ç™»å½•æˆåŠŸï¼',
      duration: 2000,
      bottom: 100
    });

    // å¯åŠ¨æ¸éšåŠ¨ç”»
    this.startFadeOutAnimation();

    hilog.info(DOMAIN, 'LoginPage', 'ğŸ‰ [Success] ç™»å½•æˆåŠŸæç¤ºå·²æ˜¾ç¤º');
  }

  /**
   * å¯åŠ¨æ¸éšåŠ¨ç”»
   */
  private startFadeOutAnimation(): void {
    // å»¶æ—¶å¼€å§‹åŠ¨ç”»ï¼Œè®©ç”¨æˆ·çœ‹åˆ°Toastæç¤º
    setTimeout(() => {
      // å¼€å§‹æ¸éšåŠ¨ç”»
      this.pageOpacity = 0;
      hilog.info(DOMAIN, 'LoginPage', 'ğŸ¬ [Animation] å¼€å§‹æ¸éšåŠ¨ç”»');

      // åŠ¨ç”»å®Œæˆåå…³é—­æ¨¡æ€é¡µé¢
      setTimeout(() => {
        // é€šè¿‡ä¿®æ”¹AppStorageä¸­çš„ä¸€ä¸ªæ ‡è®°æ¥è§¦å‘MainTabNavPageçš„çŠ¶æ€æ£€æŸ¥
        AppStorage.setOrCreate('loginStatusChanged', Date.now());
        hilog.info(DOMAIN, 'LoginPage', 'ğŸ“¢ [Notification] å‘é€ç™»å½•çŠ¶æ€å˜åŒ–é€šçŸ¥');

        // å…³é—­æ¨¡æ€é¡µé¢
        this.pathStack.pop();
        hilog.info(DOMAIN, 'LoginPage', 'ğŸ”™ [Navigation] å…³é—­ç™»å½•æ¨¡æ€é¡µé¢');
      }, 500); // å‡å°‘å»¶æ—¶ï¼Œè®©MinePageèƒ½æ›´æ—©å¼€å§‹æ¸æ˜¾
    }, 600); // ç¨å¾®å‡å°‘ç­‰å¾…æ—¶é—´ï¼Œæå‡å“åº”é€Ÿåº¦
  }
}