/**
 * æ ‘æ´ä¸»é¡µé¢ç»„ä»¶
 * å‚è€ƒclass-schedule-cçš„tree-hole.vueå®ç°ï¼Œé€‚é…ArkTS/HarmonyOS
 */
import { TreeHoleItem } from '../../models/TreeHoleModels';
import { TreeHoleApiService } from '../../services/api/TreeHoleApiService';
import { UserInfoManager } from '../../common/utils/UserInfoManager';
import { UserApiService } from '../../services/api/UserApiService';
import { SimpleUserInfo } from '../../models/UserModels';
import { curves } from '@kit.ArkUI';
import { API_CONFIG } from '../../common/constants/AppConstants';
import { TreeHoleImageGrid, ImageClickCallback } from '../base/TreeHoleImageGrid';
import { ImagePreviewDialog, ImagePreviewCloseCallback } from '../base/ImagePreviewDialog';

@Component
export struct TreeHolePage {
  @Consume('NavStack') pathStack: NavPathStack;
  @StorageLink('loginStatusChanged') @Watch('onLoginStatusChanged') loginStatusChanged: number = 0;
  @State private treeHoleList: TreeHoleItem[] = [];
  @State private isLoading: boolean = false;
  @State private isRefreshing: boolean = false;
  @State private isLoggedIn: boolean = false;
  @State private currentUser: SimpleUserInfo | null = null;
  @State private currentPage: number = 1;
  @State private hasMore: boolean = true;
  @State private transitionEffect: TransitionEffect = TransitionEffect.IDENTITY;
  // å›¾ç‰‡é¢„è§ˆç›¸å…³çŠ¶æ€
  @State private imagePreviewVisible: boolean = false;
  @State private previewImages: string[] = [];
  @State private previewCurrentIndex: number = 0;
  // æœåŠ¡å®ä¾‹
  private treeHoleApiService: TreeHoleApiService = TreeHoleApiService.getInstance();
  private userInfoManager: UserInfoManager = UserInfoManager.getInstance();
  private userApiService: UserApiService = UserApiService.getInstance();
  // åˆ†é¡µå‚æ•°
  private readonly pageSize: number = 10;

  aboutToAppear(): void {
    console.info('ğŸŒ³ [TreeHolePage] é¡µé¢å³å°†æ˜¾ç¤ºï¼Œåˆå§‹åŒ–æ•°æ®');
    this.checkLoginStatus();
    this.loadTreeHoleList(true);
  }

  onPageShow(): void {
    console.info('ğŸŒ³ [TreeHolePage] é¡µé¢æ˜¾ç¤º');
    // æ¯æ¬¡é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°ç™»å½•çŠ¶æ€
    this.checkLoginStatusAsync();
  }

  build() {
    Column() {
      // ä¸»å†…å®¹åŒºåŸŸ - ä½¿ç”¨æ»šåŠ¨åˆ—è¡¨åŒ…å«å‘å¸ƒåŒºåŸŸå’Œå†…å®¹
      if ((this.treeHoleList?.length || 0) === 0 && !this.isLoading) {
        this.buildEmptyStateWithHeader()
      } else {
        this.buildScrollableContent()
      }

      // å›¾ç‰‡é¢„è§ˆå¯¹è¯æ¡†
      if (this.imagePreviewVisible) {
        ImagePreviewDialog({
          isVisible: this.imagePreviewVisible,
          images: this.previewImages,
          currentIndex: this.previewCurrentIndex,
          onClose: new ImagePreviewCloseCallback(this.handleImagePreviewClose.bind(this))
        })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FAFAFA')
    .transition(this.transitionEffect)
  }

  /**
   * æ„å»ºå¯æ»šåŠ¨çš„å†…å®¹ï¼ˆåŒ…å«å‘å¸ƒåŒºåŸŸå’Œæ ‘æ´åˆ—è¡¨ï¼‰
   */
  @Builder
  buildScrollableContent() {
    Refresh({ refreshing: $$this.isRefreshing }) {
      List() {
        // å‘å¸ƒåŒºåŸŸä½œä¸ºåˆ—è¡¨çš„ç¬¬ä¸€é¡¹
        ListItem() {
          this.buildPublishArea()
        }
        .margin({ bottom: 15 })

        // æ ‘æ´å†…å®¹åˆ—è¡¨
        ForEach(this.treeHoleList || [], (item: TreeHoleItem, index: number) => {
          ListItem() {
            this.buildTreeHoleItem(item)
          }
          .margin({
            left: 20,
            right: 20,
            top: 8,
            bottom: 12
          })
        }, (item: TreeHoleItem) => item.id.toString())

        // åŠ è½½æ›´å¤šæŒ‡ç¤ºå™¨
        if (this.hasMore) {
          ListItem() {
            Row() {
              LoadingProgress()
                .width(20)
                .height(20)
                .color('#31BFCC')
                .margin({ right: 8 })

              Text('åŠ è½½æ›´å¤š...')
                .fontSize(14)
                .fontColor('#999999')
            }
            .justifyContent(FlexAlign.Center)
            .width('100%')
            .height(50)
          }
          .margin({ top: 10, bottom: 80 })
        } else if ((this.treeHoleList?.length || 0) > 0) {
          ListItem() {
            Text('â€” å·²ç»åˆ°åº•äº† â€”')
              .fontSize(14)
              .fontColor('#999999')
              .width('100%')
              .textAlign(TextAlign.Center)
              .height(50)
          }
          .margin({ top: 10, bottom: 80 })
        }
      }
      .onReachEnd(() => {
        if (this.hasMore && !this.isLoading) {
          this.loadMoreData();
        }
      })
      .scrollBar(BarState.Off)
      .edgeEffect(EdgeEffect.Spring)
    }
    .width('100%')
    .height('100%')
    .onRefreshing(() => {
      this.handleRefresh();
    })
  }

  /**
   * æ„å»ºå¸¦å¤´éƒ¨çš„ç©ºçŠ¶æ€
   */
  @Builder
  buildEmptyStateWithHeader() {
    Column() {
      // å‘å¸ƒåŒºåŸŸ
      Column() {
        this.buildPublishArea()
      }
      .margin({ top: 20, bottom: 15 })

      // ç©ºçŠ¶æ€
      Column() {
        Image($r('app.media.startIcon'))
          .width(80)
          .height(80)
          .opacity(0.3)
          .margin({ bottom: 15 })

        Text('â€” æš‚æ— æ ‘æ´å†…å®¹ â€”')
          .fontSize(16)
          .fontColor('#999999')
      }
      .justifyContent(FlexAlign.Center)
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
  }

  /**
   * æ„å»ºå‘å¸ƒåŒºåŸŸ
   */
  @Builder
  buildPublishArea() {
    Stack() {
      // èƒŒæ™¯
      Image($r('app.media.treeHole_background'))
        .width('100%')
        .height(120)
        .objectFit(ImageFit.Cover)
        .borderRadius(25)

      Column() {
        Text('åŒ¿ååˆ†äº«ï¼Œéšå¿ƒè€Œå‘')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
          .margin({ top: 15, bottom: 20 })

        Row() {
          Image($r('app.media.startIcon'))
            .width(24)
            .height(24)
            .margin({ right: 8 })

          Text('å‘å¸ƒ')
            .fontSize(16)
            .fontColor('#2DBACC')
        }
        .justifyContent(FlexAlign.Center)
        .alignItems(VerticalAlign.Center)
        .width('70%')
        .height(35)
        .backgroundColor('rgba(242, 251, 252, 0.68)')
        .borderRadius(25)
        .onClick(() => {
          this.handlePostClick();
        })
      }
      .padding({ left: 25, right: 25 })
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
    }
    .padding({ left: 20, right: 20 })
    .width('100%')
    .height(120)
  }

  /**
   * æ„å»ºæ ‘æ´æ¡ç›®
   */
  @Builder
  buildTreeHoleItem(item: TreeHoleItem) {
    Column() {
      // å¤´éƒ¨ä¿¡æ¯
      Row() {
        Image(item.avatar ? `${API_CONFIG.BASE_URL}${item.avatar}` : $r('app.media.defaultAvatar'))
          .width(35)
          .height(35)
          .borderRadius(20)
          .margin({ right: 10 })
          .geometryTransition(`avatar_${item.id}`, { follow: true })

        Column() {
          Text(item.anonymous === 1 ? (item.nickName || `ç”¨æˆ·${item.userId}`) : item.realName)
            .fontSize(15)
            .fontColor('#666666')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .geometryTransition(`author_${item.id}`, { follow: true })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

      }
      .width('100%')
      .alignItems(VerticalAlign.Top)
      .margin({ bottom: 12 })

      // å†…å®¹
      Text(item.content)
        .fontSize(16)
        .fontColor('#333333')
        .lineHeight(24)
        .maxLines(3)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .width('100%')
        .margin({ bottom: 15, left: 10, right: 10 })
        .geometryTransition(`content_${item.id}`, { follow: true })

      // å›¾ç‰‡å±•ç¤ºåŒºåŸŸï¼ˆåˆ—è¡¨ä¸­æ˜¾ç¤ºç¼©ç•¥å›¾ï¼‰
      if (item.images && item.images.length > 0) {
        TreeHoleImageGrid({
          images: item.images,
          onImageClick: new ImageClickCallback(this.handleImageClick.bind(this)),
          imageBorderRadius: 8
        })
          .margin({ bottom: 12, left: 10, right: 10 })
      }

      // åº•éƒ¨ä¿¡æ¯
      Row() {
        Text(item.createAt.replace('T', ' '))
          .fontSize(12)
          .fontColor('#A0ADCA')

        Blank()

        // è¯„è®º
        Row() {
          Image($r('app.media.comment'))
            .width(16)
            .height(16)
            .margin({ right: 4 })

          Text(item.replies.toString())
            .fontSize(12)
            .fontColor('#A0ADCA')
        }
        .margin({ right: 15 })
        .geometryTransition(`comment_${item.id}`, { follow: true })

        // ç‚¹èµ
        Row() {
          Image(item.isLike === 1 ? $r('app.media.like_active') : $r('app.media.like'))
            .width(16)
            .height(16)
            .margin({ right: 4 })

          Text(item.likes.toString())
            .fontSize(12)
            .fontColor(item.isLike === 1 ? '#E8311A' : '#A0ADCA')
        }
        .geometryTransition(`like_${item.id}`, { follow: true })
        .onClick(() => {
          this.handleLikeClick(item);
        })
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(25)
    .borderWidth(1)
    .borderColor('#E8E8E8')
    .shadow({
      radius: 6,
      color: '#0D000000',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      this.handleItemClick(item);
    })
  }

  /**
   * ç›‘å¬ç™»å½•çŠ¶æ€å˜åŒ–
   */
  private onLoginStatusChanged(): void {
    console.info(`ğŸŒ³ [TreeHolePage] æ”¶åˆ°ç™»å½•çŠ¶æ€å˜åŒ–é€šçŸ¥: ${this.loginStatusChanged}`);
    // ç™»å½•çŠ¶æ€å˜åŒ–æ—¶é‡æ–°æ£€æŸ¥
    this.checkLoginStatusAsync();
  }

  // ===== äº‹ä»¶å¤„ç†æ–¹æ³• =====

  /**
   * æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆåŒæ­¥æ–¹æ³•ï¼Œç”¨äºå¿«é€Ÿæ£€æŸ¥ï¼‰
   */
  private checkLoginStatus(): void {
    try {
      // ä½¿ç”¨åŒæ­¥æ–¹æ³•å¿«é€Ÿæ£€æŸ¥ç™»å½•çŠ¶æ€
      const isLoggedIn = this.userInfoManager.isLoggedInSync(this.getUIContext().getHostContext());
      this.isLoggedIn = isLoggedIn;

      if (isLoggedIn) {
        this.currentUser = this.userInfoManager.getCurrentUserInfo(this.getUIContext().getHostContext());
        console.info(`ğŸŒ³ [TreeHolePage] ç”¨æˆ·å·²ç™»å½• - ${this.currentUser?.realName} (${this.currentUser?.userName})`);
      } else {
        this.currentUser = null;
        console.info(`ğŸŒ³ [TreeHolePage] ç”¨æˆ·æœªç™»å½•`);
      }
    } catch (error) {
      console.error(`ğŸŒ³ [TreeHolePage] æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥: ${error}`);
      this.isLoggedIn = false;
      this.currentUser = null;
    }
  }

  /**
   * å¼‚æ­¥æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆå®Œæ•´éªŒè¯ï¼ŒåŒ…æ‹¬tokenéªŒè¯ï¼‰
   */
  private async checkLoginStatusAsync(): Promise<void> {
    try {
      console.info('ğŸŒ³ [TreeHolePage] å¼€å§‹å¼‚æ­¥éªŒè¯ç™»å½•çŠ¶æ€');
      const isLoggedIn = await this.userInfoManager.checkLoginStatus(this.getUIContext().getHostContext());

      this.isLoggedIn = isLoggedIn;
      this.currentUser = this.userInfoManager.getCurrentUserInfo(this.getUIContext().getHostContext());

      if (isLoggedIn && this.currentUser) {
        console.info(`ğŸŒ³ [TreeHolePage] ç™»å½•éªŒè¯æˆåŠŸ - ${this.currentUser.realName}`);
      } else {
        console.info('ğŸŒ³ [TreeHolePage] ç™»å½•éªŒè¯å¤±è´¥æˆ–ç”¨æˆ·æœªç™»å½•');
      }
    } catch (error) {
      console.error(`ğŸŒ³ [TreeHolePage] å¼‚æ­¥ç™»å½•çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error}`);
      this.isLoggedIn = false;
      this.currentUser = null;
    }
  }

  /**
   * åŠ è½½æ ‘æ´åˆ—è¡¨
   * @param reset æ˜¯å¦é‡ç½®åˆ—è¡¨
   */
  private async loadTreeHoleList(reset: boolean = false): Promise<void> {
    try {
      this.isLoading = true;

      if (reset) {
        this.currentPage = 1;
        this.treeHoleList = [];
      }

      // å…ˆåŠ è½½ç½®é¡¶å†…å®¹ï¼ˆä»…ç¬¬ä¸€é¡µï¼‰
      if (this.currentPage === 1) {
        const topData = await this.treeHoleApiService.getTreeHoleList(1, 3, 4);
        this.treeHoleList = topData?.list || [];
      }

      // åŠ è½½æ™®é€šå†…å®¹
      const normalData = await this.treeHoleApiService.getTreeHoleList(this.currentPage, this.pageSize, 1);

      if (reset) {
        this.treeHoleList = [...(this.treeHoleList || []), ...(normalData?.list || [])];
      } else {
        this.treeHoleList = [...(this.treeHoleList || []), ...(normalData?.list || [])];
      }

      this.hasMore = normalData?.hasNext || false;

      console.info(`ğŸŒ³ [TreeHolePage] åŠ è½½å®Œæˆï¼Œå½“å‰${this.treeHoleList?.length || 0}æ¡æ•°æ®`);
    } catch (error) {
      console.error('ğŸŒ³ [TreeHolePage] åŠ è½½æ ‘æ´åˆ—è¡¨å¤±è´¥:', error);
      // ç¡®ä¿åœ¨å‡ºé”™æ—¶æ•°ç»„ä»ç„¶æœ‰æ•ˆ
      if (!this.treeHoleList) {
        this.treeHoleList = [];
      }
    } finally {
      this.isLoading = false;
      this.isRefreshing = false;
    }
  }

  /**
   * åŠ è½½æ›´å¤šæ•°æ®
   */
  private async loadMoreData(): Promise<void> {
    if (this.hasMore && !this.isLoading) {
      this.currentPage++;
      await this.loadTreeHoleList(false);
    }
  }

  /**
   * å¤„ç†ä¸‹æ‹‰åˆ·æ–°
   */
  private async handleRefresh(): Promise<void> {
    this.isRefreshing = true;
    await this.loadTreeHoleList(true);
  }

  /**
   * å¤„ç†å‘å¸ƒæŒ‰é’®ç‚¹å‡»
   */
  private handlePostClick(): void {
    if (!this.isLoggedIn) {
      this.showLoginRequiredToast();
      return;
    }

    console.info('ğŸŒ³ [TreeHolePage] è·³è½¬åˆ°å‘å¸ƒé¡µé¢');
    try {
      this.pathStack.pushPathByName('TreeHolePostPage', null);
    } catch (error) {
      console.error('ğŸŒ³ [TreeHolePage] è·³è½¬å‘å¸ƒé¡µé¢å¤±è´¥:', error);
      // æ˜¾ç¤ºé”™è¯¯æç¤º
      this.getUIContext().showAlertDialog({
        title: 'è·³è½¬å¤±è´¥',
        message: 'æ— æ³•æ‰“å¼€å‘å¸ƒé¡µé¢ï¼Œè¯·é‡è¯•',
        primaryButton: {
          value: 'ç¡®å®š',
          action: () => {
            // ä¸åšä»»ä½•æ“ä½œ
          }
        }
      });
    }
  }

  /**
   * å¤„ç†æ ‘æ´é¡¹ç‚¹å‡»
   */
  private handleItemClick(item: TreeHoleItem): void {
    console.info(`ğŸŒ³ [TreeHolePage] æŸ¥çœ‹æ ‘æ´è¯¦æƒ… ID:${item.id}`);

    // è®¾ç½®è½¬åœºæ•ˆæœ
    this.transitionEffect = TransitionEffect.OPACITY
      .combine(TransitionEffect.scale({ x: 0.9, y: 0.9 }))
      .animation({ curve: curves.interpolatingSpring(0, 1, 195, 23) });

    // ä½¿ç”¨åŠ¨ç”»è·³è½¬åˆ°è¯¦æƒ…é¡µ
    this.getUIContext().animateTo({ curve: curves.interpolatingSpring(0, 1, 328, 36) }, () => {
      this.pathStack.pushPathByName('TreeHoleDetailPage', item);
    });
  }

  /**
   * å¤„ç†ç‚¹èµç‚¹å‡»
   */
  private async handleLikeClick(item: TreeHoleItem): Promise<void> {
    if (!this.isLoggedIn) {
      this.showLoginRequiredToast();
      return;
    }

    try {
      const newIsLiked = item.isLike !== 1;
      const result = await this.treeHoleApiService.toggleLike(item.id, newIsLiked);

      if (result.code === 200) {
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        const index = this.treeHoleList.findIndex(treeHole => treeHole.id === item.id);
        if (index >= 0) {
          this.treeHoleList[index].isLike = newIsLiked ? 1 : 0;
          this.treeHoleList[index].likes += newIsLiked ? 1 : -1;
        }
        console.info(`ğŸŒ³ [TreeHolePage] ${newIsLiked ? 'ç‚¹èµ' : 'å–æ¶ˆç‚¹èµ'}æˆåŠŸ`);
      }
    } catch (error) {
      console.error('ğŸŒ³ [TreeHolePage] ç‚¹èµæ“ä½œå¤±è´¥:', error);
    }
  }

  /**
   * å¤„ç†å›¾ç‰‡ç‚¹å‡»äº‹ä»¶
   */
  private handleImageClick(imageUrl: string, imageIndex: number, allImages: string[]): void {
    console.info(`ğŸ–¼ï¸ [TreeHolePage] ç‚¹å‡»å›¾ç‰‡: ${imageIndex}, URL: ${imageUrl}`);
    
    this.previewImages = allImages;
    this.previewCurrentIndex = imageIndex;
    this.imagePreviewVisible = true;
  }

  /**
   * å¤„ç†å›¾ç‰‡é¢„è§ˆå…³é—­äº‹ä»¶
   */
  private handleImagePreviewClose(): void {
    console.info('ğŸ–¼ï¸ [TreeHolePage] å…³é—­å›¾ç‰‡é¢„è§ˆ');
    this.imagePreviewVisible = false;
    this.previewImages = [];
    this.previewCurrentIndex = 0;
  }

  /**
   * æ˜¾ç¤ºéœ€è¦ç™»å½•çš„æç¤º
   */
  private showLoginRequiredToast(): void {
    // æ˜¾ç¤ºç™»å½•æç¤ºå’Œç™»å½•æŒ‰é’®
    this.getUIContext().showAlertDialog({
      title: 'éœ€è¦ç™»å½•',
      message: 'è¯·å…ˆç™»å½•åå†ä½¿ç”¨æ­¤åŠŸèƒ½',
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {
          console.info('ğŸŒ³ [TreeHolePage] ç”¨æˆ·å–æ¶ˆç™»å½•');
        }
      },
      secondaryButton: {
        value: 'å»ç™»å½•',
        action: () => {
          console.info('ğŸŒ³ [TreeHolePage] ç”¨æˆ·é€‰æ‹©å»ç™»å½•');
          try {
            this.pathStack.pushPathByName('LoginNavPage', null);
          } catch (error) {
            console.error('ğŸŒ³ [TreeHolePage] è·³è½¬ç™»å½•é¡µé¢å¤±è´¥:', error);
          }
        }
      }
    });
  }
}