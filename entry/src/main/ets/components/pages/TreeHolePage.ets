/**
 * æ ‘æ´ä¸»é¡µé¢ç»„ä»¶
 * å‚è€ƒclass-schedule-cçš„tree-hole.vueå®ç°ï¼Œé€‚é…ArkTS/HarmonyOS
 */
import { TreeHoleItem } from '../../models/TreeHoleModels';
import { TreeHoleApiService } from '../../services/api/TreeHoleApiService';
import { UserInfoManager } from '../../common/utils/UserInfoManager';

@Component
export struct TreeHolePage {
  @Consume('NavStack') pathStack: NavPathStack;
  @State private treeHoleList: TreeHoleItem[] = [];
  @State private isLoading: boolean = false;
  @State private isRefreshing: boolean = false;
  @State private isLoggedIn: boolean = false;
  @State private currentPage: number = 1;
  @State private hasMore: boolean = true;
  // æœåŠ¡å®ä¾‹
  private treeHoleApiService: TreeHoleApiService = TreeHoleApiService.getInstance();
  private userInfoManager: UserInfoManager = UserInfoManager.getInstance();
  // åˆ†é¡µå‚æ•°
  private readonly pageSize: number = 10;

  aboutToAppear(): void {
    console.info('ğŸŒ³ [TreeHolePage] é¡µé¢å³å°†æ˜¾ç¤ºï¼Œåˆå§‹åŒ–æ•°æ®');
    this.checkLoginStatus();
    this.loadTreeHoleList(true);
  }

  onPageShow(): void {
    console.info('ğŸŒ³ [TreeHolePage] é¡µé¢æ˜¾ç¤º');
    // æ¯æ¬¡é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°ç™»å½•çŠ¶æ€
    this.checkLoginStatus();
  }

  build() {
    Column() {
      // ä¸»å†…å®¹åŒºåŸŸ - ä½¿ç”¨æ»šåŠ¨åˆ—è¡¨åŒ…å«å‘å¸ƒåŒºåŸŸå’Œå†…å®¹
      if ((this.treeHoleList?.length || 0) === 0 && !this.isLoading) {
        this.buildEmptyStateWithHeader()
      } else {
        this.buildScrollableContent()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FAFAFA')
  }

  /**
   * æ„å»ºå¯æ»šåŠ¨çš„å†…å®¹ï¼ˆåŒ…å«å‘å¸ƒåŒºåŸŸå’Œæ ‘æ´åˆ—è¡¨ï¼‰
   */
  @Builder
  buildScrollableContent() {
    Refresh({ refreshing: $$this.isRefreshing }) {
      List() {
        // å‘å¸ƒåŒºåŸŸä½œä¸ºåˆ—è¡¨çš„ç¬¬ä¸€é¡¹
        ListItem() {
          this.buildPublishArea()
        }
        .margin({ bottom: 15 })

        // æ ‘æ´å†…å®¹åˆ—è¡¨
        ForEach(this.treeHoleList || [], (item: TreeHoleItem, index: number) => {
          ListItem() {
            this.buildTreeHoleItem(item)
          }
          .margin({ left: 20, right: 20, top: 8 })
        }, (item: TreeHoleItem) => item.id.toString())

        // åŠ è½½æ›´å¤šæŒ‡ç¤ºå™¨
        if (this.hasMore) {
          ListItem() {
            Row() {
              LoadingProgress()
                .width(20)
                .height(20)
                .color('#31BFCC')
                .margin({ right: 8 })

              Text('åŠ è½½æ›´å¤š...')
                .fontSize(14)
                .fontColor('#999999')
            }
            .justifyContent(FlexAlign.Center)
            .width('100%')
            .height(50)
          }
          .margin({ top: 10, bottom: 80 })
        } else if ((this.treeHoleList?.length || 0) > 0) {
          ListItem() {
            Text('â€” å·²ç»åˆ°åº•äº† â€”')
              .fontSize(14)
              .fontColor('#999999')
              .width('100%')
              .textAlign(TextAlign.Center)
              .height(50)
          }
          .margin({ top: 10, bottom: 80 })
        }
      }
      .onReachEnd(() => {
        if (this.hasMore && !this.isLoading) {
          this.loadMoreData();
        }
      })
      .scrollBar(BarState.Off)
      .edgeEffect(EdgeEffect.Spring)
    }
    .width('100%')
    .height('100%')
    .onRefreshing(() => {
      this.handleRefresh();
    })
  }

  /**
   * æ„å»ºå¸¦å¤´éƒ¨çš„ç©ºçŠ¶æ€
   */
  @Builder
  buildEmptyStateWithHeader() {
    Column() {
      // å‘å¸ƒåŒºåŸŸ
      Column() {
        this.buildPublishArea()
      }
      .margin({ top: 20, bottom: 15 })

      // ç©ºçŠ¶æ€
      Column() {
        Image($r('app.media.startIcon'))
          .width(80)
          .height(80)
          .opacity(0.3)
          .margin({ bottom: 15 })

        Text('â€” æš‚æ— æ ‘æ´å†…å®¹ â€”')
          .fontSize(16)
          .fontColor('#999999')
      }
      .justifyContent(FlexAlign.Center)
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
  }

  /**
   * æ„å»ºå‘å¸ƒåŒºåŸŸ
   */
  @Builder
  buildPublishArea() {
    Stack() {
      // èƒŒæ™¯
      Image($r('app.media.treeHole_background'))
        .width('100%')
        .height(120)
        .objectFit(ImageFit.Cover)
        .borderRadius(25)

      Column() {
        Text('åŒ¿ååˆ†äº«ï¼Œéšå¿ƒè€Œå‘')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
          .margin({ top: 15, bottom: 20 })

        Row() {
          Image($r('app.media.startIcon'))
            .width(24)
            .height(24)
            .margin({ right: 8 })

          Text('å‘å¸ƒ')
            .fontSize(16)
            .fontColor('#2DBACC')
        }
        .justifyContent(FlexAlign.Center)
        .alignItems(VerticalAlign.Center)
        .width('70%')
        .height(35)
        .backgroundColor('rgba(242, 251, 252, 0.68)')
        .borderRadius(25)
        .onClick(() => {
          this.handlePostClick();
        })
      }
      .padding({ left: 25, right: 25 })
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
    }
    .padding({ left: 20, right: 20 })
    .width('100%')
    .height(120)
  }

  /**
   * æ„å»ºæ ‘æ´æ¡ç›®
   */
  @Builder
  buildTreeHoleItem(item: TreeHoleItem) {
    Column() {
      // å¤´éƒ¨ä¿¡æ¯
      Row() {
        Image($r('app.media.defaultAvatar'))
          .width(35)
          .height(35)
          .borderRadius(20)
          .margin({ right: 10 })

        Column() {
          Text(item.anonymous === 1 ? (item.nickName || `ç”¨æˆ·${item.userId}`) : item.realName)
            .fontSize(15)
            .fontColor('#666666')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

      }
      .width('100%')
      .alignItems(VerticalAlign.Top)
      .margin({ bottom: 12 })

      // å†…å®¹
      Text(item.content)
        .fontSize(16)
        .fontColor('#333333')
        .lineHeight(24)
        .maxLines(3)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .width('100%')
        .margin({ bottom: 15, left: 10, right: 10 })

      // åº•éƒ¨ä¿¡æ¯
      Row() {
        Text(item.createAt.replace('T', ' '))
          .fontSize(12)
          .fontColor('#A0ADCA')

        Blank()

        // è¯„è®º
        Row() {
          Image($r('app.media.startIcon'))
            .width(16)
            .height(16)
            .margin({ right: 4 })

          Text(item.replies.toString())
            .fontSize(12)
            .fontColor('#A0ADCA')
        }
        .margin({ right: 15 })

        // ç‚¹èµ
        Row() {
          Image(item.isLike === 1 ? $r('app.media.homeActive') : $r('app.media.home'))
            .width(16)
            .height(16)
            .margin({ right: 4 })

          Text(item.likes.toString())
            .fontSize(12)
            .fontColor(item.isLike === 1 ? '#E8311A' : '#A0ADCA')
        }
        .onClick(() => {
          this.handleLikeClick(item);
        })
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .onClick(() => {
      this.handleItemClick(item);
    })
  }

  // ===== äº‹ä»¶å¤„ç†æ–¹æ³• =====

  /**
   * æ£€æŸ¥ç™»å½•çŠ¶æ€
   */
  private checkLoginStatus(): void {
    // æš‚æ—¶è®¾ä¸ºfalseï¼Œå¾…ç™»å½•åŠŸèƒ½å®ç°åæ›´æ–°
    this.isLoggedIn = false;
    console.info(`ğŸŒ³ [TreeHolePage] ç™»å½•çŠ¶æ€: ${this.isLoggedIn}`);
  }

  /**
   * åŠ è½½æ ‘æ´åˆ—è¡¨
   * @param reset æ˜¯å¦é‡ç½®åˆ—è¡¨
   */
  private async loadTreeHoleList(reset: boolean = false): Promise<void> {
    try {
      this.isLoading = true;

      if (reset) {
        this.currentPage = 1;
        this.treeHoleList = [];
      }

      // å…ˆåŠ è½½ç½®é¡¶å†…å®¹ï¼ˆä»…ç¬¬ä¸€é¡µï¼‰
      if (this.currentPage === 1) {
        const topData = await this.treeHoleApiService.getTreeHoleList(1, 3, 4);
        this.treeHoleList = topData?.list || [];
      }

      // åŠ è½½æ™®é€šå†…å®¹
      const normalData = await this.treeHoleApiService.getTreeHoleList(this.currentPage, this.pageSize, 1);

      if (reset) {
        this.treeHoleList = [...(this.treeHoleList || []), ...(normalData?.list || [])];
      } else {
        this.treeHoleList = [...(this.treeHoleList || []), ...(normalData?.list || [])];
      }

      this.hasMore = normalData?.hasNext || false;

      console.info(`ğŸŒ³ [TreeHolePage] åŠ è½½å®Œæˆï¼Œå½“å‰${this.treeHoleList?.length || 0}æ¡æ•°æ®`);
    } catch (error) {
      console.error('ğŸŒ³ [TreeHolePage] åŠ è½½æ ‘æ´åˆ—è¡¨å¤±è´¥:', error);
      // ç¡®ä¿åœ¨å‡ºé”™æ—¶æ•°ç»„ä»ç„¶æœ‰æ•ˆ
      if (!this.treeHoleList) {
        this.treeHoleList = [];
      }
    } finally {
      this.isLoading = false;
      this.isRefreshing = false;
    }
  }

  /**
   * åŠ è½½æ›´å¤šæ•°æ®
   */
  private async loadMoreData(): Promise<void> {
    if (this.hasMore && !this.isLoading) {
      this.currentPage++;
      await this.loadTreeHoleList(false);
    }
  }

  /**
   * å¤„ç†ä¸‹æ‹‰åˆ·æ–°
   */
  private async handleRefresh(): Promise<void> {
    this.isRefreshing = true;
    await this.loadTreeHoleList(true);
  }

  /**
   * å¤„ç†å‘å¸ƒæŒ‰é’®ç‚¹å‡»
   */
  private handlePostClick(): void {
    if (!this.isLoggedIn) {
      this.showLoginRequiredToast();
      return;
    }

    console.info('ğŸŒ³ [TreeHolePage] è·³è½¬åˆ°å‘å¸ƒé¡µé¢');
    // this.pathStack.pushPathByName('TreeHolePostPage', null);
  }

  /**
   * å¤„ç†æ ‘æ´é¡¹ç‚¹å‡»
   */
  private handleItemClick(item: TreeHoleItem): void {
    if (!this.isLoggedIn) {
      this.showLoginRequiredToast();
      return;
    }

    console.info(`ğŸŒ³ [TreeHolePage] æŸ¥çœ‹æ ‘æ´è¯¦æƒ… ID:${item.id}`);
    // this.pathStack.pushPathByName('TreeHoleDetailPage', item);
  }

  /**
   * å¤„ç†ç‚¹èµç‚¹å‡»
   */
  private async handleLikeClick(item: TreeHoleItem): Promise<void> {
    if (!this.isLoggedIn) {
      this.showLoginRequiredToast();
      return;
    }

    try {
      const newIsLiked = item.isLike !== 1;
      const result = await this.treeHoleApiService.toggleLike(item.id, newIsLiked);

      if (result.code === 200) {
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        const index = this.treeHoleList.findIndex(treeHole => treeHole.id === item.id);
        if (index >= 0) {
          this.treeHoleList[index].isLike = newIsLiked ? 1 : 0;
          this.treeHoleList[index].likes += newIsLiked ? 1 : -1;
        }
        console.info(`ğŸŒ³ [TreeHolePage] ${newIsLiked ? 'ç‚¹èµ' : 'å–æ¶ˆç‚¹èµ'}æˆåŠŸ`);
      }
    } catch (error) {
      console.error('ğŸŒ³ [TreeHolePage] ç‚¹èµæ“ä½œå¤±è´¥:', error);
    }
  }

  /**
   * æ˜¾ç¤ºéœ€è¦ç™»å½•çš„æç¤º
   */
  private showLoginRequiredToast(): void {
    // æ˜¾ç¤ºç™»å½•æç¤ºå’Œç™»å½•æŒ‰é’®
    this.getUIContext().showAlertDialog({
      title: 'éœ€è¦ç™»å½•',
      message: 'è¯·å…ˆç™»å½•åå†ä½¿ç”¨æ­¤åŠŸèƒ½',
      primaryButton: {
        value: 'æš‚ä¸ç™»å½•',
        action: () => {
          console.info('ğŸŒ³ [TreeHolePage] ç”¨æˆ·å–æ¶ˆç™»å½•');
        }
      },
      secondaryButton: {
        value: 'å»ç™»å½•',
        action: () => {
          console.info('ğŸŒ³ [TreeHolePage] ç”¨æˆ·é€‰æ‹©å»ç™»å½•');
          // TODO: è·³è½¬åˆ°ç™»å½•é¡µé¢
        }
      }
    });
  }
}