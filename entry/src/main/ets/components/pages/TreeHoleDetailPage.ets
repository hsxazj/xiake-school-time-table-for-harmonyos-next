/**
 * æ ‘æ´è¯¦æƒ…é¡µé¢ç»„ä»¶
 * æ˜¾ç¤ºæ ‘æ´å†…å®¹å’Œè¯„è®ºï¼Œæ”¯æŒå‘å¸ƒè¯„è®º
 */
import { TreeHoleItem, TreeHoleComment, TreeHolePaginationData } from '../../models/TreeHoleModels';
import { TreeHoleApiService } from '../../services/api/TreeHoleApiService';

@Builder
export function TreeHoleDetailPageBuilder() {
  TreeHoleDetailPage();
}

@Component
export struct TreeHoleDetailPage {
  @Consume('NavStack') pathStack: NavPathStack;
  @State private treeHoleItem: TreeHoleItem | null = null;
  @State private commentsList: TreeHoleComment[] = [];
  @State private isLoading: boolean = false;
  @State private commentText: string = '';
  @State private isCommenting: boolean = false;
  
  // æ¥æ”¶å‚æ•°
  private treeHoleId: number = 0;
  private treeHoleApiService: TreeHoleApiService = TreeHoleApiService.getInstance();

  aboutToAppear(): void {
    console.info('ğŸŒ³ [TreeHoleDetailPage] é¡µé¢åˆå§‹åŒ–');
    if (this.treeHoleId > 0) {
      this.loadComments();
    }
  }

  build() {
    NavDestination() {
      Column() {
        // è‡ªå®šä¹‰æ ‡é¢˜æ 
        this.buildTitleBar()
        
        if (this.treeHoleItem) {
          // ä¸»å†…å®¹åŒºåŸŸ
          Scroll() {
            Column() {
              // æ ‘æ´è¯¦æƒ…
              this.buildTreeHoleDetail()
              
              // è¯„è®ºæ ‡é¢˜
              this.buildCommentsHeader()
              
              // è¯„è®ºåˆ—è¡¨
              this.buildCommentsList()
            }
            .width('100%')
            .padding(16)
          }
          .layoutWeight(1)
          
          // è¯„è®ºè¾“å…¥æ¡†
          this.buildCommentInput()
        } else if (this.isLoading) {
          // åŠ è½½çŠ¶æ€
          this.buildLoadingState()
        } else {
          // ç©ºçŠ¶æ€
          Column() {
            Text('æœªæ‰¾åˆ°æ ‘æ´ä¿¡æ¯')
              .fontSize(16)
              .fontColor('#999999')
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
        }
      }
      .width('100%')
      .height('100%')
    }
    .title('æ ‘æ´è¯¦æƒ…')
    .onBackPressed(() => {
      this.pathStack.pop()
      return true
    })
  }

  @Builder
  private buildTitleBar() {
    Row() {
      Button('è¿”å›')
        .onClick(() => {
          this.pathStack.pop()
        })
        .backgroundColor('#F5F5F5')
        .fontColor('#333333')
        
      Blank()
      
      Text('æ ‘æ´è¯¦æƒ…')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        
      Blank()
      
      // å ä½
      Row() {}
      .width(60)
    }
    .width('100%')
    .height(50)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#FFFFFF')
  }

  @Builder
  private buildTreeHoleDetail() {
    if (this.treeHoleItem) {
      Column() {
        // æ—¥æœŸä¿¡æ¯
        Row() {
          Column() {
            Text(this.treeHoleItem.createAt.substring(8, 10))
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
            
            Text(this.treeHoleItem.createAt.substring(0, 7))
              .fontSize(12)
              .fontColor('#999999')
            
            Text(this.treeHoleItem.createAt.substring(11))
              .fontSize(12)
              .fontColor('#999999')
          }
          .alignItems(HorizontalAlign.Center)
          .margin({ right: 15 })
          
          // å€’è®¡æ—¶åŠŸèƒ½æš‚æ—¶ç§»é™¤ï¼Œå› æ–°æ•°æ®ç»“æ„ä¸­æ²¡æœ‰countdownå­—æ®µ
          // if (this.treeHoleItem.countdown) {
          //   Text(this.treeHoleItem.countdown)
          //     .fontSize(12)
          //     .fontColor('#A0ADCA')
          //     .layoutWeight(1)
          //     .textAlign(TextAlign.End)
          // }
        }
        .width('100%')
        .justifyContent(FlexAlign.Start)
        .alignItems(VerticalAlign.Top)
        .margin({ bottom: 12 })

        // ä½œè€…ä¿¡æ¯
        Row() {
          Image(this.treeHoleItem.avatar || $r('app.media.defaultAvatar'))
            .width(30)
            .height(30)
            .borderRadius(15)
            .margin({ right: 10 })
          
          Text(this.treeHoleItem.anonymous === 1 ? (this.treeHoleItem.nickName || `ç”¨æˆ·${this.treeHoleItem.userId}`) : this.treeHoleItem.realName)
            .fontSize(14)
            .fontColor('#666666')
        }
        .width('100%')
        .justifyContent(FlexAlign.Start)

        // å†…å®¹
        Text(this.treeHoleItem.content)
          .fontSize(16)
          .fontColor('#333333')
          .lineHeight(24)
          .width('100%')
          .margin({ top: 15, bottom: 15 })

        // åº•éƒ¨æ“ä½œæ 
        Row() {
          Text(`åˆ›å»ºæ—¶é—´: ${this.treeHoleItem.createAt}`)
            .fontSize(12)
            .fontColor('#A0ADCA')
            .margin({ left: 10, top: 2 })
        
          Blank()
        
          Text(`èµ ${this.treeHoleItem.likes}`)
            .fontSize(14)
            .fontColor('#666666')
        }
        .width('100%')
        .alignItems(VerticalAlign.Center)
        .padding({ top: 12, bottom: 12 })
        .borderRadius({ topLeft: 0, topRight: 0, bottomLeft: 8, bottomRight: 8 })
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .margin({ bottom: 16 })
    }
  }

  @Builder
  private buildCommentsHeader() {
    Row() {
      Text(`è¯„è®º (${this.commentsList.length})`)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
    }
    .width('100%')
    .margin({ top: 8, bottom: 12 })
  }

  @Builder
  private buildCommentsList() {
    if (this.commentsList.length === 0) {
      Column() {
        Text('æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§~')
          .fontSize(14)
          .fontColor('#999999')
          .textAlign(TextAlign.Center)
      }
      .width('100%')
      .height(100)
      .justifyContent(FlexAlign.Center)
    } else {
      Column() {
        ForEach(this.commentsList, (comment: TreeHoleComment) => {
          this.buildCommentItem(comment)
        }, (comment: TreeHoleComment) => comment.id.toString())
      }
      .width('100%')
    }
  }

  @Builder
  private buildCommentItem(comment: TreeHoleComment) {
    Column() {
      Row() {
        Image(comment.avatar || $r('app.media.defaultAvatar'))
          .width(32)
          .height(32)
          .borderRadius(16)
          .margin({ right: 12 })
        
        Column() {
          Text(comment.author)
            .fontSize(14)
            .fontColor('#666666')
            .alignSelf(ItemAlign.Start)
          
          Text(comment.createTime)
            .fontSize(12)
            .fontColor('#A0ADCA')
            .margin({ top: 2 })
            .alignSelf(ItemAlign.Start)
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
      }
      .width('100%')

      Text(comment.content)
        .fontSize(14)
        .fontColor('#333333')
        .lineHeight(20)
        .width('100%')
        .margin({ top: 8, bottom: 8 })

      // åº•éƒ¨æ“ä½œ
      Row() {
        Blank()
        
        // ç‚¹è¸©
        Row() {
          Image($r('app.media.startIcon'))
            .width(14)
            .height(14)
            .margin({ right: 4 })
          
          Text(comment.dislikeCount.toString())
            .fontSize(12)
            .fontColor(comment.isDisliked ? '#1296DB' : '#A0ADCA')
        }
        .margin({ right: 15 })
        .onClick(() => {
          this.handleCommentDislike(comment);
        })
        
        // ç‚¹èµ
        Row() {
          Image($r('app.media.startIcon'))
            .width(14)
            .height(14)
            .margin({ right: 4 })
          
          Text(comment.likeCount.toString())
            .fontSize(12)
            .fontColor(comment.isLiked ? '#E8311A' : '#A0ADCA')
        }
        .onClick(() => {
          this.handleCommentLike(comment);
        })
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .margin({ bottom: 8 })
  }

  @Builder
  private buildCommentInput() {
    Row() {
      TextInput({ placeholder: 'å†™ä¸‹ä½ çš„è¯„è®º...', text: this.commentText })
        .layoutWeight(1)
        .height(40)
        .fontSize(14)
        .backgroundColor('#F5F5F5')
        .borderRadius(20)
        .padding({ left: 16, right: 16 })
        .onChange((value: string) => {
          this.commentText = value;
        })
        .onSubmit(() => {
          this.handleSendComment();
        })
        .enabled(!this.isCommenting)

      if (this.commentText.trim().length > 0) {
        Button('å‘é€')
          .fontSize(14)
          .fontColor('#FFFFFF')
          .backgroundColor('#007AFF')
          .borderRadius(20)
          .height(40)
          .width(60)
          .margin({ left: 12 })
          .enabled(!this.isCommenting)
          .onClick(() => {
            this.handleSendComment();
          })
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderColor('#E5E5E5')
    .borderWidth({ top: 1 })
  }

  @Builder
  private buildLoadingState() {
    Column() {
      LoadingProgress()
        .width(50)
        .height(50)
        .color('#007AFF')
        .margin({ bottom: 16 })
      
      Text('åŠ è½½ä¸­...')
        .fontSize(14)
        .fontColor('#999999')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  // ===== äº‹ä»¶å¤„ç†æ–¹æ³• =====

  /**
   * åŠ è½½è¯„è®ºæ•°æ®
   */
  private async loadComments(): Promise<void> {
    try {
      this.isLoading = true;
      console.info(`ğŸŒ³ [TreeHoleDetailPage] å¼€å§‹åŠ è½½æ ‘æ´ ${this.treeHoleId} çš„è¯„è®º`);
      
      const commentsData = await this.treeHoleApiService.getTreeHoleComments(this.treeHoleId, 1, 50);
      this.commentsList = commentsData.list;
      
      console.info(`ğŸŒ³ [TreeHoleDetailPage] åŠ è½½äº† ${commentsData.list.length} æ¡è¯„è®º`);
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleDetailPage] åŠ è½½è¯„è®ºå¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * å‘é€è¯„è®º
   */
  private async handleSendComment(): Promise<void> {
    if (this.commentText.trim().length === 0) {
      return;
    }

    try {
      this.isCommenting = true;
      console.info('ğŸŒ³ [TreeHoleDetailPage] å‘é€è¯„è®º');
      
      const result = await this.treeHoleApiService.postComment({
        treeHoleId: this.treeHoleId,
        content: this.commentText.trim(),
        isAnonymous: false
      });

      if (result.code === 200) {
        this.commentText = '';
        // é‡æ–°åŠ è½½è¯„è®º
        await this.loadComments();
      }
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleDetailPage] å‘é€è¯„è®ºå¤±è´¥:', error);
    } finally {
      this.isCommenting = false;
    }
  }

  /**
   * å¤„ç†è¯„è®ºç‚¹èµ
   */
  private async handleCommentLike(comment: TreeHoleComment): Promise<void> {
    try {
      console.info(`ğŸŒ³ [TreeHoleDetailPage] ç‚¹èµè¯„è®º ${comment.id}`);
      
      const newIsLiked = !comment.isLiked;
      const result = await this.treeHoleApiService.toggleCommentLike(comment.id, newIsLiked);
      
      if (result.code === 200) {
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        const index = this.commentsList.findIndex(c => c.id === comment.id);
        if (index >= 0) {
          this.commentsList[index].isLiked = newIsLiked;
          this.commentsList[index].likeCount += newIsLiked ? 1 : -1;
        }
      }
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleDetailPage] è¯„è®ºç‚¹èµå¤±è´¥:', error);
    }
  }

  /**
   * å¤„ç†è¯„è®ºç‚¹è¸©
   */
  private async handleCommentDislike(comment: TreeHoleComment): Promise<void> {
    try {
      console.info(`ğŸŒ³ [TreeHoleDetailPage] ç‚¹è¸©è¯„è®º ${comment.id}`);
      
      const newIsDisliked = !comment.isDisliked;
      const result = await this.treeHoleApiService.toggleCommentDislike(comment.id, newIsDisliked);
      
      if (result.code === 200) {
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        const index = this.commentsList.findIndex(c => c.id === comment.id);
        if (index >= 0) {
          this.commentsList[index].isDisliked = newIsDisliked;
          this.commentsList[index].dislikeCount += newIsDisliked ? 1 : -1;
        }
      }
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleDetailPage] è¯„è®ºç‚¹è¸©å¤±è´¥:', error);
    }
  }

  /**
   * è®¾ç½®æ ‘æ´æ•°æ®
   */
  public setTreeHoleItem(item: TreeHoleItem): void {
    this.treeHoleItem = item;
    this.treeHoleId = item.id;
    console.info(`ğŸŒ³ [TreeHoleDetailPage] è®¾ç½®æ ‘æ´æ•°æ®ï¼ŒID: ${item.id}`);
  }
}