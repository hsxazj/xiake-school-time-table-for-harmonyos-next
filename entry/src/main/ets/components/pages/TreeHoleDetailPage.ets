/**
 * æ ‘æ´è¯¦æƒ…é¡µé¢ç»„ä»¶
 * æ˜¾ç¤ºæ ‘æ´å†…å®¹å’Œè¯„è®ºï¼Œæ”¯æŒå‘å¸ƒè¯„è®º
 */
import { TreeHoleItem, TreeHoleComment, TreeHolePaginationData } from '../../models/TreeHoleModels';
import { TreeHoleApiService } from '../../services/api/TreeHoleApiService';

@Builder
export function TreeHoleDetailPageBuilder() {
  TreeHoleDetailPage();
}

@Component
export struct TreeHoleDetailPage {
  @Consume('NavStack') pathStack: NavPathStack;
  @State private treeHoleItem: TreeHoleItem | null = null;
  @State private commentsList: TreeHoleComment[] = [];
  @State private isLoading: boolean = false;
  @State private commentText: string = '';
  @State private isCommenting: boolean = false;
  
  // æ¥æ”¶å‚æ•°
  private treeHoleId: number = 0;
  private treeHoleApiService: TreeHoleApiService = TreeHoleApiService.getInstance();

  aboutToAppear(): void {
    console.info('ğŸŒ³ [TreeHoleDetailPage] é¡µé¢åˆå§‹åŒ–');
    if (this.treeHoleId > 0) {
      this.loadComments();
    }
  }

  build() {
    NavDestination() {
      Column() {
        // è‡ªå®šä¹‰æ ‡é¢˜æ 
        this.buildTitleBar()
        
        if (this.treeHoleItem) {
          // ä¸»å†…å®¹åŒºåŸŸ
          Scroll() {
            Column() {
              // æ ‘æ´è¯¦æƒ…
              this.buildTreeHoleDetail()
              
              // è¯„è®ºæ ‡é¢˜
              this.buildCommentsHeader()
              
              // è¯„è®ºåˆ—è¡¨
              this.buildCommentsList()
            }
          }
          .layoutWeight(1)
          
          // åº•éƒ¨è¯„è®ºè¾“å…¥æ¡†
          this.buildCommentInput()
        } else {
          // åŠ è½½çŠ¶æ€æˆ–é”™è¯¯çŠ¶æ€
          this.buildLoadingState()
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#FAFAFA')
    }
    .title('æ ‘æ´è¯¦æƒ…')
    .hideTitleBar(true)
  }

  /**
   * æ„å»ºæ ‡é¢˜æ 
   */
  @Builder
  buildTitleBar() {
    Row() {
      Image($r('app.media.startIcon'))
        .width(24)
        .height(24)
        .onClick(() => {
          this.pathStack.pop();
        })
      
      Text('æ ‘æ´è¯¦æƒ…')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)
      
      // å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
      Row().width(24).height(24)
    }
    .width('100%')
    .height(50)
    .padding({ left: 16, right: 16 })
    .backgroundColor(Color.White)
    .justifyContent(FlexAlign.SpaceBetween)
    .alignItems(VerticalAlign.Center)
  }

  /**
   * æ„å»ºæ ‘æ´è¯¦æƒ…
   */
  @Builder
  buildTreeHoleDetail() {
    if (this.treeHoleItem) {
      Column() {
      // æ—¥æœŸä¿¡æ¯
      Row() {
        Column() {
          Text(this.treeHoleItem.createTime.substring(8, 10))
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
          
          Text(this.treeHoleItem.createTime.substring(0, 7))
            .fontSize(12)
            .fontColor('#999999')
          
          Text(this.treeHoleItem.createTime.substring(11))
            .fontSize(12)
            .fontColor('#999999')
        }
        .alignItems(HorizontalAlign.Center)
        .margin({ right: 15 })
        
        if (this.treeHoleItem.countdown) {
          Text(this.treeHoleItem.countdown)
            .fontSize(12)
            .fontColor('#A0ADCA')
            .layoutWeight(1)
            .textAlign(TextAlign.End)
        }
      }
      .width('100%')
      .margin({ bottom: 20 })

      // å†…å®¹æ–‡æœ¬
      Text(this.treeHoleItem.content)
        .fontSize(16)
        .fontColor('#333333')
        .lineHeight(24)
        .width('100%')
        .margin({ bottom: 20 })

      // ä½œè€…ä¿¡æ¯
      Row() {
        Image($r('app.media.defaultAvatar'))
          .width(30)
          .height(30)
          .borderRadius(15)
          .margin({ right: 10 })
        
        Text(this.treeHoleItem.author)
          .fontSize(14)
          .fontColor('#666666')
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 10 })
    }
  }

  /**
   * æ„å»ºè¯„è®ºæ ‡é¢˜åŒºåŸŸ
   */
  @Builder
  buildCommentsHeader() {
    Row() {
      Text(`è¯„è®º ${this.commentsList.length}`)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
      
      // ç»¿è‰²è£…é¥°çº¿
      Row()
        .width(30)
        .height(3)
        .backgroundColor('#3EA5B3')
        .borderRadius(2)
        .margin({ left: 10, top: 2 })
      
      Blank()
      
      if (this.treeHoleItem) {
        Text(`èµ ${this.treeHoleItem.likeCount}`)
          .fontSize(14)
          .fontColor('#666666')
      }
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 15, bottom: 10 })
    .alignItems(VerticalAlign.Center)
  }

  /**
   * æ„å»ºè¯„è®ºåˆ—è¡¨
   */
  @Builder
  buildCommentsList() {
    if (this.commentsList.length === 0) {
      Column() {
        Text('æš‚æ— è¯„è®º')
          .fontSize(14)
          .fontColor('#999999')
          .margin(30)
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
    } else {
      Column() {
        ForEach(this.commentsList, (comment: TreeHoleComment, index: number) => {
          this.buildCommentItem(comment)
        }, (comment: TreeHoleComment) => comment.id.toString())
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 80 })
    }
  }

  /**
   * æ„å»ºè¯„è®ºé¡¹
   */
  @Builder
  buildCommentItem(comment: TreeHoleComment) {
    Column() {
      Row() {
        Image($r('app.media.defaultAvatar'))
          .width(32)
          .height(32)
          .borderRadius(16)
          .margin({ right: 12 })
        
        Column() {
          Text(comment.author)
            .fontSize(14)
            .fontColor('#666666')
            .alignSelf(ItemAlign.Start)
          
          Text(comment.createTime)
            .fontSize(12)
            .fontColor('#A0ADCA')
            .margin({ top: 2 })
            .alignSelf(ItemAlign.Start)
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)
      .margin({ bottom: 8 })

      Text(comment.content)
        .fontSize(15)
        .fontColor('#333333')
        .lineHeight(22)
        .width('100%')
        .margin({ bottom: 12 })

      Row() {
        Blank()
        
        // ç‚¹è¸©
        Row() {
          Image($r('app.media.startIcon'))
            .width(14)
            .height(14)
            .margin({ right: 4 })
          
          Text(comment.dislikeCount.toString())
            .fontSize(12)
            .fontColor(comment.isDisliked ? '#1296DB' : '#A0ADCA')
        }
        .margin({ right: 15 })
        .onClick(() => {
          this.handleCommentDislike(comment);
        })
        
        // ç‚¹èµ
        Row() {
          Image($r('app.media.startIcon'))
            .width(14)
            .height(14)
            .margin({ right: 4 })
          
          Text(comment.likeCount.toString())
            .fontSize(12)
            .fontColor(comment.isLiked ? '#E8311A' : '#A0ADCA')
        }
        .onClick(() => {
          this.handleCommentLike(comment);
        })
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .margin({ bottom: 8 })
  }

  /**
   * æ„å»ºè¯„è®ºè¾“å…¥æ¡†
   */
  @Builder
  buildCommentInput() {
    Row() {
      TextInput({ 
        placeholder: 'è¯´ç‚¹ä»€ä¹ˆ...',
        text: $$this.commentText 
      })
        .layoutWeight(1)
        .fontSize(15)
        .backgroundColor('#F5F5F5')
        .borderRadius(20)
        .padding({ left: 15, right: 15, top: 8, bottom: 8 })
        .maxLength(200)
        .onFocus(() => {
          this.isCommenting = true;
        })
        .onBlur(() => {
          if (this.commentText.trim() === '') {
            this.isCommenting = false;
          }
        })
      
      if (this.isCommenting || this.commentText.trim() !== '') {
        Button('å‘é€')
          .fontSize(14)
          .fontColor(Color.White)
          .backgroundColor('#31BFCC')
          .borderRadius(15)
          .padding({ left: 15, right: 15, top: 8, bottom: 8 })
          .margin({ left: 8 })
          .onClick(() => {
            this.handleSendComment();
          })
      }
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 10, bottom: 10 })
    .backgroundColor(Color.White)
    .border({ width: { top: 1 }, color: '#E5E5E5' })
  }

  /**
   * æ„å»ºåŠ è½½çŠ¶æ€
   */
  @Builder
  buildLoadingState() {
    Column() {
      LoadingProgress()
        .width(40)
        .height(40)
        .color('#31BFCC')
        .margin({ bottom: 15 })
      
      Text('åŠ è½½ä¸­...')
        .fontSize(14)
        .fontColor('#999999')
    }
    .justifyContent(FlexAlign.Center)
    .layoutWeight(1)
  }

  // ===== äº‹ä»¶å¤„ç†æ–¹æ³• =====

  /**
   * åŠ è½½è¯„è®ºæ•°æ®
   */
  private async loadComments(): Promise<void> {
    try {
      this.isLoading = true;
      console.info(`ğŸŒ³ [TreeHoleDetailPage] åŠ è½½è¯„è®º - ID: ${this.treeHoleId}`);
      
      const commentsData = await this.treeHoleApiService.getTreeHoleComments(this.treeHoleId);
      this.commentsList = commentsData.list;
      
      console.info(`ğŸŒ³ [TreeHoleDetailPage] åŠ è½½äº† ${this.commentsList.length} æ¡è¯„è®º`);
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleDetailPage] åŠ è½½è¯„è®ºå¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * å¤„ç†å‘é€è¯„è®º
   */
  private async handleSendComment(): Promise<void> {
    if (this.commentText.trim() === '') {
      return;
    }

    try {
      console.info('ğŸŒ³ [TreeHoleDetailPage] å‘é€è¯„è®º:', this.commentText.substring(0, 20));
      
      const success = await this.treeHoleApiService.postComment({
        treeHoleId: this.treeHoleId,
        content: this.commentText.trim(),
        isAnonymous: false
      });

      if (success) {
        this.commentText = '';
        this.isCommenting = false;
        // é‡æ–°åŠ è½½è¯„è®º
        await this.loadComments();
        console.info('ğŸŒ³ [TreeHoleDetailPage] è¯„è®ºå‘å¸ƒæˆåŠŸ');
      }
    } catch (error) {
      console.error('ğŸŒ³ [TreeHoleDetailPage] å‘é€è¯„è®ºå¤±è´¥:', error);
    }
  }

  /**
   * å¤„ç†è¯„è®ºç‚¹èµ
   */
  private handleCommentLike(comment: TreeHoleComment): void {
    console.info(`ğŸŒ³ [TreeHoleDetailPage] è¯„è®ºç‚¹èµ ID: ${comment.id}`);
    // TODO: å®ç°è¯„è®ºç‚¹èµé€»è¾‘
  }

  /**
   * å¤„ç†è¯„è®ºç‚¹è¸©
   */
  private handleCommentDislike(comment: TreeHoleComment): void {
    console.info(`ğŸŒ³ [TreeHoleDetailPage] è¯„è®ºç‚¹è¸© ID: ${comment.id}`);
    // TODO: å®ç°è¯„è®ºç‚¹è¸©é€»è¾‘
  }

  /**
   * è®¾ç½®æ ‘æ´æ•°æ®
   * @param item æ ‘æ´é¡¹æ•°æ®
   */
  public setTreeHoleItem(item: TreeHoleItem): void {
    this.treeHoleItem = item;
    this.treeHoleId = item.id;
    console.info(`ğŸŒ³ [TreeHoleDetailPage] è®¾ç½®æ ‘æ´æ•°æ® ID: ${item.id}`);
  }
}