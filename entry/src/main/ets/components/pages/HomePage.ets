import { UserInfoManager, UserSchoolInfo } from '../../common/utils/UserInfoManager';
import { CourseInfo } from '../../models/CourseModels';
import { CourseColorUtil } from '../../common/utils/CourseColorUtil';
import { CourseTimeUtil } from '../../common/utils/CourseTimeUtil';
import { curves } from '@kit.ArkUI';
import { CourseApiService } from '../../services/api/CourseApiService';
import { AppConfigManager } from '../../services/AppConfigManager';
import { FormService } from '../../services/FormService';

interface TodayParm {
  year: number;
  week: number;
  termCode: string;
  weekDay: string;
}

@Component
export struct HomePage {
  @Consume('NavStack') pathStack: NavPathStack;
  // pathStack: NavPathStack = new NavPathStack();
  @State private userInfo: UserSchoolInfo | null = null;
  @State private todayCourses: CourseInfo[] = [];
  @State private isLoading: boolean = false;
  private userInfoManager: UserInfoManager = UserInfoManager.getInstance();
  private courseApiService: CourseApiService = CourseApiService.getInstance();
  private appConfigManager: AppConfigManager = AppConfigManager.getInstance();
  private formService: FormService = FormService.getInstance();
  // ä»Šæ—¥è¯¾ç¨‹å‚æ•°ç¼“å­˜
  private todayParams: TodayParm | null = null;
  // åŠ¨ç”»æ”¯æŒ - ä¸å‘¨è¯¾ç¨‹é¡µä¿æŒä¸€è‡´
  private effect: TransitionEffect =
    TransitionEffect.OPACITY
      .combine(TransitionEffect.scale({ x: 0, y: 0 }))
      .animation({ curve: curves.springMotion(0.8, 1.0), duration: 150 });
  // è¯¾ç¨‹é¢œè‰²ç›¸å…³çŠ¶æ€ - ä¸SchedulePageä¿æŒä¸€è‡´
  @State private courseColorsList: string[] = [];

  aboutToAppear(): void {
    this.loadUserInfo();
    this.loadTodayCourses();
  }

  onPageShow(): void {
    // é¡µé¢æ¯æ¬¡æ˜¾ç¤ºæ—¶é‡æ–°åˆå§‹åŒ–ä»Šæ—¥å‚æ•°ï¼Œç¡®ä¿ä¸å—å…¶ä»–é¡µé¢å½±å“
    console.info('ğŸ“± [HomePage] é¡µé¢æ˜¾ç¤ºï¼Œé‡æ–°åˆå§‹åŒ–ä»Šæ—¥å‚æ•°');
    this.initTodayParams();
    // é‡æ–°åŠ è½½ä»Šæ—¥è¯¾ç¨‹ä»¥é˜²æœ‰å˜åŒ–
    this.loadTodayCourses();
  }

  build() {
    Column() {
      Row() {
        Column() {
          Text(`ä½ å¥½ï¼ŒåŒå­¦`)
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .margin({ bottom: 20 }) // ä»4å¢åŠ åˆ°8

          // æ˜¾ç¤ºå­¦é™¢+ç­çº§ä¿¡æ¯
          if (this.userInfo) {
            Row() {
              Text(`${this.userInfo.collegeName} ${this.userInfo.className}`)
                .fontSize(16)
                .fontColor('#666666')

              Text('åˆ‡æ¢')
                .fontSize(16)
                .fontColor($r('app.color.schedule_primary_color'))
                .margin({ left: 8 })
            }
            .justifyContent(FlexAlign.SpaceBetween)
            .width('100%')
          } else {
            Row() {
              Text('å­¦é™¢ä¿¡æ¯åŠ è½½ä¸­...')
                .fontSize(14)
                .fontColor('#666666')

              Text('åˆ‡æ¢')
                .fontSize(12)
                .fontColor($r('app.color.schedule_primary_color'))
                .margin({ left: 8 })
            }
          }
        }
        .alignItems(HorizontalAlign.Start)
        .padding({
          top: 8,
          bottom: 8,
          left: 4,
          right: 4
        })
        .borderRadius(8)
        .onClick(() => {
          this.pathStack.pushPathByName('ClassSelectNavPage', null);
        })

        Blank()
      }
      .width('100%')
      .padding({
        left: 5,
        right: 5,
        top: 50,
        bottom: 20
      })

      // ä»Šæ—¥è¯¾ç¨‹åŒºåŸŸï¼ˆæ‹‰é•¿å¹¶åˆ é™¤æŸ¥çœ‹æ›´å¤šï¼‰
      Column() {
        Text('ä»Šæ—¥è¯¾ç¨‹')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .width('100%')
          .margin({ bottom: 15 })

        // è¯¾ç¨‹åˆ—è¡¨åŒºåŸŸ - å¢åŠ é«˜åº¦
        if (this.isLoading) {
          Column() {
            Text('åŠ è½½ä¸­...')
              .fontSize(16)
              .fontColor('#999999')
              .margin({ top: 50, bottom: 50 })
          }
          .width('100%')
          .height(300)
          .justifyContent(FlexAlign.Center)
        } else if (this.todayCourses.length > 0) {
          List() {
            ForEach(this.todayCourses, (course: CourseInfo) => {
              ListItem() {
                this.CourseCard(course)
              }
            })
          }
          .borderRadius(24)
          .width('100%')
          .layoutWeight(1)
          .scrollBar(BarState.Off)
        } else {
          Column() {
            Text('ä»Šæ—¥æ— è¯¾ğŸ˜‹')
              .fontSize(16)
              .fontColor('#999999')
              .margin({ top: 50, bottom: 50 })
            Text('å»åšç‚¹å–œæ¬¢çš„äº‹â˜ï¸ğŸ¤“')
              .fontSize(16)
              .fontColor('#999999')
          }
          .width('100%')
          .height(300)
          .justifyContent(FlexAlign.Center)
        }
      }
      .width('100%')
      .padding(20)
      .backgroundColor(Color.White) // ä»Šæ—¥è¯¾ç¨‹åŒºåŸŸä½¿ç”¨ç¨æ·±çš„ç°è“è‰²
      .borderRadius(24)
      .shadow({
        radius: 10,
        color: '#80000000', // åŠé€æ˜é»‘
        offsetX: 0,
        offsetY: 4
      })
      .margin({ bottom: 20 })
      .layoutWeight(1) // è®©ä»Šæ—¥è¯¾ç¨‹åŒºåŸŸå ç”¨æ›´å¤šç©ºé—´

      Blank()
    }
    .width('90%')
    .height('100%')
    .backgroundColor(Color.White) // èƒŒæ™¯æ”¹ä¸ºç™½è‰²
    .justifyContent(FlexAlign.Start)
  }

  @Builder
  CourseCard(courseInfo: CourseInfo) {
    Column() {
      Text(courseInfo.courseName || '')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(CourseColorUtil.getCourseTextColor(courseInfo.courseName, this.courseColorsList))
        .maxLines(2)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .margin({ bottom: 6 })
        .alignSelf(ItemAlign.Start)

      Text(courseInfo.teacher || '')
        .fontSize(14)
        .fontColor(CourseColorUtil.getCourseTextColor(courseInfo.courseName, this.courseColorsList))
        .margin({ bottom: 6 })
        .alignSelf(ItemAlign.Start)

      Text(`${courseInfo.section} (${CourseTimeUtil.getTimeRange(courseInfo.courseTime)})`)
        .fontSize(14)
        .fontColor(CourseColorUtil.getCourseTextColor(courseInfo.courseName, this.courseColorsList))
        .fontWeight(FontWeight.Medium)
        .alignSelf(ItemAlign.Start)

      Text(courseInfo.classroom || '')
        .fontSize(14)
        .fontColor(CourseColorUtil.getCourseTextColor(courseInfo.courseName, this.courseColorsList))
        .alignSelf(ItemAlign.Start)

    }
    .width('100%')
    .backgroundColor(CourseColorUtil.getCourseBackgroundColor(courseInfo.courseName, this.courseColorsList))
    .borderRadius(24)
    .border({
      width: 1,
      color: CourseColorUtil.getCourseBorderColor(courseInfo.courseName, this.courseColorsList),
      radius: 24
    })
    .padding({
      left: 16,
      right: 16,
      top: 16,
      bottom: 16
    })
    .margin({ bottom: 12 })
    .shadow({
      radius: 4,
      color: 'rgba(0, 0, 0, 0.1)',
      offsetY: 2
    })
    .alignItems(HorizontalAlign.Start)
    .transition(this.effect) // åº”ç”¨è½¬åœºåŠ¨ç”»
  }


  private async loadTodayCourses(): Promise<void> {
    this.isLoading = true;

    try {
      // ç­‰å¾…é…ç½®ç®¡ç†å™¨åˆå§‹åŒ–
      await this.appConfigManager.initialize();

      // è·å–ç”¨æˆ·ä¿¡æ¯
      const userInfo = this.userInfoManager.getUserInfo(this.getUIContext().getHostContext());
      if (!userInfo || !userInfo.classId) {
        console.warn('æœªæ‰¾åˆ°ç”¨æˆ·ç­çº§ä¿¡æ¯');
        return;
      }

      // å¦‚æœè¿˜æ²¡æœ‰ç¼“å­˜ä»Šæ—¥è¯¾ç¨‹å‚æ•°ï¼Œåˆ™åˆå§‹åŒ–
      if (!this.todayParams) {
        this.initTodayParams();
      }

      if (!this.todayParams) {
        console.warn('æ— æ³•è·å–ä»Šæ—¥è¯¾ç¨‹å‚æ•°');
        return;
      }

      console.info(`ğŸ” [Today Course] ä½¿ç”¨ç¼“å­˜å‚æ•°: year=${this.todayParams.year}, week=${this.todayParams.week}, weekDay=${this.todayParams.weekDay}, term=${this.todayParams.termCode}`);

      const response = await this.courseApiService.getTodayCourseList(
        userInfo.classId,
        this.todayParams.year,
        this.todayParams.termCode,
        this.todayParams.week,
        this.todayParams.weekDay
      );

      // const response = await this.courseApiService.getTodayCourseList(
      //   userInfo.classId,
      //   2025,
      //   '3',
      //   3,
      //   'æ˜ŸæœŸä¸€'
      // );


      if (response.code === 200 && response.data) {
        this.todayCourses = response.data;
        // æ›´æ–°è¯¾ç¨‹é¢œè‰²åˆ—è¡¨
        this.courseColorsList = CourseColorUtil.extractCourseNamesList(response.data);

        // åŒæ—¶æ›´æ–°æ‰€æœ‰æ´»è·ƒå¡ç‰‡çš„æ•°æ®
        console.info(`ğŸ“± [HomePage] åŒæ­¥æ›´æ–°å¡ç‰‡æ•°æ®ï¼Œè¯¾ç¨‹æ•°é‡: ${response.data.length}`);
        this.formService.updateAllActiveWidgetsWithData(this.getUIContext().getHostContext(), response.data);
      } else {
        console.warn('è·å–ä»Šæ—¥è¯¾ç¨‹å¤±è´¥');
      }

    } catch (error) {
      console.error('åŠ è½½ä»Šæ—¥è¯¾ç¨‹å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * åˆå§‹åŒ–ä»Šæ—¥è¯¾ç¨‹å‚æ•°ç¼“å­˜
   * ä¿®å¤ï¼šç›´æ¥åŸºäºå½“å‰æ—¥æœŸè®¡ç®—ï¼Œä¸ä¾èµ–å¯èƒ½è¢«è¯¾è¡¨é¡µé¢æ»‘åŠ¨å½±å“çš„å…¨å±€çŠ¶æ€
   */
  private initTodayParams(): void {
    // ç›´æ¥åŸºäºä»Šå¤©çš„æ—¥æœŸè®¡ç®—å­¦æœŸçŠ¶æ€ï¼Œé¿å…å—è¯¾è¡¨é¡µé¢æ»‘åŠ¨å½±å“
    const today = new Date();
    const configService = this.appConfigManager.getConfigService();

    // ä½¿ç”¨ConfigServiceç›´æ¥è®¡ç®—ä»Šå¤©å¯¹åº”çš„å­¦æœŸçŠ¶æ€
    const todayStatus = configService.calculateCurrentSemesterStatus(today);

    if (!todayStatus || !todayStatus.currentSemester) {
      console.warn('æœªæ‰¾åˆ°å½“å‰å­¦æœŸä¿¡æ¯');
      return;
    }

    // è·å–ä»Šå¤©æ˜¯æ˜ŸæœŸå‡ 
    const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
    const weekDayStr = weekdays[today.getDay()];

    // ç¼“å­˜ä»Šæ—¥è¯¾ç¨‹å‚æ•° - åŸºäºçœŸå®çš„ä»Šå¤©ï¼Œä¸å—å…¶ä»–é¡µé¢å½±å“
    this.todayParams = {
      year: parseInt(todayStatus.currentSemester.academicYear),
      week: todayStatus.currentWeek,
      termCode: todayStatus.currentSemester.semester === 1 ? '3' : '12',
      weekDay: weekDayStr
    };

    console.info(`âœ… [Today Params Cache] åŸºäºçœŸå®ä»Šæ—¥è®¡ç®—å‚æ•°: ${JSON.stringify(this.todayParams)}`);
  }

  private loadUserInfo(): void {
    this.userInfo = this.userInfoManager.getUserInfo(this.getUIContext().getHostContext());
  }
}