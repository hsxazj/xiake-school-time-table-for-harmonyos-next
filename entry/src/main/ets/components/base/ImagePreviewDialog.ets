/**
 * å›¾ç‰‡é¢„è§ˆå¯¹è¯æ¡†ç»„ä»¶
 * æ”¯æŒå…¨å±æŸ¥çœ‹ã€ç¼©æ”¾ã€æ»‘åŠ¨åˆ‡æ¢ç­‰åŠŸèƒ½
 */
import { curves } from '@kit.ArkUI';
import { API_CONFIG } from '../../common/constants/AppConstants';

/**
 * å›¾ç‰‡é¢„è§ˆå…³é—­å›è°ƒç±»
 */
export class ImagePreviewCloseCallback {
  handler?: () => void;

  constructor(handler?: () => void) {
    this.handler = handler;
  }

  call(): void {
    if (this.handler) {
      this.handler();
    }
  }
}

@Component
export struct ImagePreviewDialog {
  @Prop isVisible: boolean = false;
  @Prop images: string[] = [];
  @Prop currentIndex: number = 0;
  @Prop onClose: ImagePreviewCloseCallback = new ImagePreviewCloseCallback();
  @State private currentImageIndex: number = 0;
  @State private imageScale: number = 1;
  @State private imageOffsetX: number = 0;
  @State private imageOffsetY: number = 0;
  @State private dialogOpacity: number = 0;
  @State private imageOpacity: number = 0;
  @State private clickTimer: number = 0;

  aboutToAppear(): void {
    this.currentImageIndex = this.currentIndex;
    if (this.isVisible) {
      this.startShowAnimation();
    }
  }

  aboutToDisappear(): void {
    // æ¸…ç†å®šæ—¶å™¨
    if (this.clickTimer) {
      clearTimeout(this.clickTimer);
      this.clickTimer = 0;
    }
  }

  build() {
    if (this.isVisible) {
      Stack() {
        // é»‘è‰²èƒŒæ™¯é®ç½©
        Column() {}
          .width('100%')
          .height('100%')
          .backgroundColor('#000000')
          .opacity(this.dialogOpacity * 0.9)
          .onClick(() => {
            this.handleClose();
          })

        // ä¸»è¦å†…å®¹åŒºåŸŸ
        Column() {
          // é¡¶éƒ¨æ“ä½œæ 
          this.buildTopBar()

          // å›¾ç‰‡å±•ç¤ºåŒºåŸŸ
          this.buildImageViewer()

          // åº•éƒ¨æŒ‡ç¤ºå™¨ï¼ˆå¤šå›¾æ—¶æ˜¾ç¤ºï¼‰
          if (this.images.length > 1) {
            this.buildBottomIndicator()
          }
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.SpaceBetween)
        .opacity(this.dialogOpacity)
      }
      .width('100%')
      .height('100%')
      .position({ x: 0, y: 0 })
      .zIndex(1000)
    }
  }

  @Builder
  buildTopBar() {
    Row() {
      // å…³é—­æŒ‰é’®
      Button() {
        Text('Ã—')
          .fontSize(24)
          .fontColor('#FFFFFF')
          .fontWeight(FontWeight.Bold)
      }
      .width(40)
      .height(40)
      .backgroundColor('rgba(0, 0, 0, 0.5)')
      .borderRadius(20)
      .onClick(() => {
        this.handleClose();
      })

      Blank()

      // å›¾ç‰‡è®¡æ•°ï¼ˆå¤šå›¾æ—¶æ˜¾ç¤ºï¼‰
      if (this.images.length > 1) {
        Text(`${this.currentImageIndex + 1} / ${this.images.length}`)
          .fontSize(16)
          .fontColor('#FFFFFF')
          .textAlign(TextAlign.Center)
          .padding({ left: 12, right: 12, top: 8, bottom: 8 })
          .backgroundColor('rgba(0, 0, 0, 0.5)')
          .borderRadius(16)
      }
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 40 })
    .justifyContent(FlexAlign.SpaceBetween)
    .alignItems(VerticalAlign.Center)
  }

  @Builder
  buildImageViewer() {
    Stack() {
      if (this.images.length > 0 && this.currentImageIndex < this.images.length) {
        Image(this.getImageUrl(this.images[this.currentImageIndex]))
          .width('100%')
          .height('100%')
          .objectFit(ImageFit.Contain)
          .scale({ x: this.imageScale, y: this.imageScale })
          .translate({ x: this.imageOffsetX, y: this.imageOffsetY })
          .opacity(this.imageOpacity)
          .gesture(
            GestureGroup(GestureMode.Parallel,
              // ç¼©æ”¾æ‰‹åŠ¿
              PinchGesture({ fingers: 2, distance: 1 })
                .onActionStart(() => {
                  console.info('ğŸ–¼ï¸ [ImagePreviewDialog] å¼€å§‹ç¼©æ”¾æ‰‹åŠ¿');
                })
                .onActionUpdate((event: GestureEvent) => {
                  this.imageScale = Math.max(0.5, Math.min(3, event.scale));
                })
                .onActionEnd(() => {
                  console.info('ğŸ–¼ï¸ [ImagePreviewDialog] ç¼©æ”¾æ‰‹åŠ¿ç»“æŸ');
                  // ç¼©æ”¾ç»“æŸåé‡ç½®ä½ç½®
                  if (this.imageScale < 1) {
                    this.resetImageTransform();
                  }
                }),

              // æ‹–æ‹½/æ»‘åŠ¨æ‰‹åŠ¿ï¼ˆæ”¯æŒæ”¾å¤§æ‹–æ‹½å’Œå›¾ç‰‡åˆ‡æ¢ï¼‰
              PanGesture({ fingers: 1, distance: 3, direction: PanDirection.All })
                .onActionStart(() => {
                  if (this.imageScale > 1.1) {
                    console.info('ğŸ–¼ï¸ [ImagePreviewDialog] å¼€å§‹æ‹–æ‹½æ‰‹åŠ¿');
                  } else {
                    console.info('ğŸ–¼ï¸ [ImagePreviewDialog] å¼€å§‹æ»‘åŠ¨æ‰‹åŠ¿');
                  }
                })
                .onActionUpdate((event: GestureEvent) => {
                  if (this.imageScale > 1.1) {
                    // æ”¾å¤§çŠ¶æ€ä¸‹çš„æ‹–æ‹½ç§»åŠ¨
                    this.imageOffsetX += event.offsetX;
                    this.imageOffsetY += event.offsetY;
                  } else if (this.images.length > 1 && this.imageScale <= 1.1) {
                    // æ­£å¸¸çŠ¶æ€ä¸‹åªå…è®¸æ°´å¹³æ»‘åŠ¨
                    if (Math.abs(event.offsetX) > Math.abs(event.offsetY)) {
                      const maxOffset = 60;
                      const clampedOffset = Math.max(-maxOffset, Math.min(maxOffset, event.offsetX * 0.5));
                      this.imageOffsetX = clampedOffset;
                    }
                  }
                })
                .onActionEnd((event: GestureEvent) => {
                  if (this.imageScale > 1.1) {
                    console.info('ğŸ–¼ï¸ [ImagePreviewDialog] æ‹–æ‹½æ‰‹åŠ¿ç»“æŸ');
                  } else if (this.images.length > 1 && this.imageScale <= 1.1) {
                    // åˆ¤æ–­æ˜¯å¦ä¸ºæœ‰æ•ˆçš„æ°´å¹³æ»‘åŠ¨
                    const isHorizontalSwipe = Math.abs(event.offsetX) > Math.abs(event.offsetY) && Math.abs(event.offsetX) > 20;
                    
                    this.resetImageOffset();
                    
                    if (isHorizontalSwipe) {
                      if (event.offsetX > 20 && this.currentImageIndex > 0) {
                        // å‘å³æ»‘åŠ¨ï¼Œæ˜¾ç¤ºä¸Šä¸€å¼ 
                        console.info('ğŸ–¼ï¸ [ImagePreviewDialog] æ»‘åŠ¨åˆ°ä¸Šä¸€å¼ ');
                        this.switchToPrevious();
                      } else if (event.offsetX < -20 && this.currentImageIndex < this.images.length - 1) {
                        // å‘å·¦æ»‘åŠ¨ï¼Œæ˜¾ç¤ºä¸‹ä¸€å¼ 
                        console.info('ğŸ–¼ï¸ [ImagePreviewDialog] æ»‘åŠ¨åˆ°ä¸‹ä¸€å¼ ');
                        this.switchToNext();
                      }
                    }
                  }
                })
            )
          )
          .gesture(
            // å•å‡»æ‰‹åŠ¿å…³é—­é¢„è§ˆ
            TapGesture({ count: 1 })
              .onAction(() => {
                console.info('ğŸ–¼ï¸ [ImagePreviewDialog] å•å‡»å›¾ç‰‡');
                // æ¿€è¿›ä¼˜åŒ–ï¼šå»¶æ—¶å‡å°‘åˆ°50msï¼Œæœ€å¤§åŒ–å“åº”é€Ÿåº¦
                this.clickTimer = setTimeout(() => {
                  console.info('ğŸ–¼ï¸ [ImagePreviewDialog] å•å‡»å…³é—­é¢„è§ˆ');
                  this.handleClose();
                }, 50);
              })
          )
          .gesture(
            // åŒå‡»æ‰‹åŠ¿åˆ‡æ¢ç¼©æ”¾çŠ¶æ€
            TapGesture({ count: 2 })
              .onAction(() => {
                console.info('ğŸ–¼ï¸ [ImagePreviewDialog] åŒå‡»åˆ‡æ¢ç¼©æ”¾');
                // æ¸…é™¤å•å‡»å®šæ—¶å™¨
                if (this.clickTimer) {
                  clearTimeout(this.clickTimer);
                  this.clickTimer = 0;
                }
                
                if (this.imageScale === 1) {
                  this.getUIContext().animateTo({
                    duration: 300,
                    curve: Curve.EaseOut
                  }, () => {
                    this.imageScale = 2;
                  });
                } else {
                  this.resetImageTransform();
                }
              })
          )
      }
    }
    .width('100%')
    .layoutWeight(1)
  }

  @Builder
  buildBottomIndicator() {
    Row() {
      ForEach(this.images, (imageUrl: string, index: number) => {
        Circle()
          .width(8)
          .height(8)
          .fill(index === this.currentImageIndex ? '#FFFFFF' : 'rgba(255, 255, 255, 0.4)')
          .margin({ left: 4, right: 4 })
      }, (imageUrl: string, index: number) => `indicator_${index}_${imageUrl}`)
    }
    .width('100%')
    .height(60)
    .justifyContent(FlexAlign.Center)
    .alignItems(VerticalAlign.Center)
  }

  /**
   * å¼€å§‹æ˜¾ç¤ºåŠ¨ç”»
   */
  private startShowAnimation(): void {
    this.getUIContext().animateTo({
      duration: 300,
      curve: Curve.EaseOut
    }, () => {
      this.dialogOpacity = 1;
      this.imageOpacity = 1;
    });
  }

  /**
   * å¼€å§‹éšè—åŠ¨ç”»
   */
  private startHideAnimation(): void {
    this.getUIContext().animateTo({
      duration: 100,
      curve: Curve.EaseIn
    }, () => {
      this.dialogOpacity = 0;
      this.imageOpacity = 0;
    });

    // åŠ¨ç”»ç»“æŸåè°ƒç”¨å…³é—­å›è°ƒ
    setTimeout(() => {
      if (this.onClose) {
        this.onClose.call();
      }
    }, 100);
  }

  /**
   * å¤„ç†å…³é—­äº‹ä»¶
   */
  private handleClose(): void {
    console.info('ğŸ–¼ï¸ [ImagePreviewDialog] å…³é—­å›¾ç‰‡é¢„è§ˆ');
    this.startHideAnimation();
  }

  /**
   * åˆ‡æ¢åˆ°ä¸Šä¸€å¼ å›¾ç‰‡
   */
  private switchToPrevious(): void {
    if (this.currentImageIndex > 0) {
      this.resetImageTransform();
      this.getUIContext().animateTo({
        duration: 200,
        curve: Curve.EaseInOut
      }, () => {
        this.currentImageIndex--;
      });
      console.info(`ğŸ–¼ï¸ [ImagePreviewDialog] åˆ‡æ¢åˆ°ä¸Šä¸€å¼ : ${this.currentImageIndex - 1}`);
    }
  }

  /**
   * åˆ‡æ¢åˆ°ä¸‹ä¸€å¼ å›¾ç‰‡
   */
  private switchToNext(): void {
    if (this.currentImageIndex < this.images.length - 1) {
      this.resetImageTransform();
      this.getUIContext().animateTo({
        duration: 200,
        curve: Curve.EaseInOut
      }, () => {
        this.currentImageIndex++;
      });
      console.info(`ğŸ–¼ï¸ [ImagePreviewDialog] åˆ‡æ¢åˆ°ä¸‹ä¸€å¼ : ${this.currentImageIndex + 1}`);
    }
  }

  /**
   * é‡ç½®å›¾ç‰‡å˜æ¢çŠ¶æ€
   */
  private resetImageTransform(): void {
    this.getUIContext().animateTo({
      duration: 300,
      curve: Curve.EaseOut
    }, () => {
      this.imageScale = 1;
      this.imageOffsetX = 0;
      this.imageOffsetY = 0;
    });
  }

  /**
   * é‡ç½®å›¾ç‰‡ä½ç½®åç§»
   */
  private resetImageOffset(): void {
    this.getUIContext().animateTo({
      duration: 200,
      curve: Curve.EaseOut
    }, () => {
      this.imageOffsetX = 0;
      this.imageOffsetY = 0;
    });
  }

  /**
   * è·å–å®Œæ•´çš„å›¾ç‰‡URL
   */
  private getImageUrl(imagePath: string): string {
    if (!imagePath) {
      return '';
    }
    
    // å¦‚æœå·²ç»æ˜¯å®Œæ•´URLåˆ™ç›´æ¥è¿”å›
    if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
      return imagePath;
    }
    
    // å¦åˆ™æ‹¼æ¥åŸºç¡€URL
    return `${API_CONFIG.BASE_URL}${imagePath.startsWith('/') ? imagePath : '/' + imagePath}`;
  }
}