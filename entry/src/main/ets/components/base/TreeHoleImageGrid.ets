/**
 * æ ‘æ´å›¾ç‰‡ç½‘æ ¼å±•ç¤ºç»„ä»¶
 * æ”¯æŒ1-3å¼ å›¾ç‰‡çš„è‡ªé€‚åº”ç½‘æ ¼å¸ƒå±€
 */
import { API_CONFIG } from '../../common/constants/AppConstants';

/**
 * å›¾ç‰‡ç‚¹å‡»äº‹ä»¶å›è°ƒç±»
 */
export class ImageClickCallback {
  handler?: (imageUrl: string, imageIndex: number, allImages: string[]) => void;

  constructor(handler?: (imageUrl: string, imageIndex: number, allImages: string[]) => void) {
    this.handler = handler;
  }

  call(imageUrl: string, imageIndex: number, allImages: string[]): void {
    if (this.handler) {
      this.handler(imageUrl, imageIndex, allImages);
    }
  }
}

@Component
export struct TreeHoleImageGrid {
  @Prop images: string[] = [];
  @Prop onImageClick?: ImageClickCallback;
  @Prop maxWidth: number = 300;
  @Prop imageBorderRadius: number = 8;

  build() {
    if (!this.images || this.images.length === 0) {
      // æ— å›¾ç‰‡æ—¶ä¸æ¸²æŸ“ä»»ä½•å†…å®¹
      Column() {}
        .width(0)
        .height(0)
    } else {
      Column() {
        this.buildImageGrid()
      }
      .width('100%')
      .margin({ top: 12, bottom: 8 })
    }
  }

  @Builder
  buildImageGrid() {
    if (this.images.length === 1) {
      // å•å›¾ç‰‡ï¼šè¾ƒå¤§å°ºå¯¸å±•ç¤º
      this.buildSingleImage()
    } else if (this.images.length === 2) {
      // åŒå›¾ç‰‡ï¼šæ¨ªå‘å¹¶æ’
      this.buildDoubleImages()
    } else if (this.images.length === 3) {
      // ä¸‰å›¾ç‰‡ï¼šç¬¬ä¸€å¼ å¤§å›¾ï¼Œåä¸¤å¼ å°å›¾ç«–æ’
      this.buildTripleImages()
    }
  }

  @Builder
  buildSingleImage() {
    Image(this.getImageUrl(this.images[0]))
      .width('100%')
      .height(200)
      .objectFit(ImageFit.Cover)
      .borderRadius(this.imageBorderRadius)
      .onClick(() => {
        this.handleImageClick(this.images[0], 0);
      })
  }

  @Builder
  buildDoubleImages() {
    Row() {
      ForEach(this.images.slice(0, 2), (imageUrl: string, index: number) => {
        Image(this.getImageUrl(imageUrl))
          .width('48%')
          .height(150)
          .objectFit(ImageFit.Cover)
          .borderRadius(this.imageBorderRadius)
          .onClick(() => {
            this.handleImageClick(imageUrl, index);
          })
      }, (imageUrl: string, index: number) => `double_${index}_${imageUrl}`)
    }
    .width('100%')
    .justifyContent(FlexAlign.SpaceBetween)
  }

  @Builder
  buildTripleImages() {
    Row() {
      // å·¦ä¾§å¤§å›¾
      Image(this.getImageUrl(this.images[0]))
        .width('48%')
        .height(200)
        .objectFit(ImageFit.Cover)
        .borderRadius(this.imageBorderRadius)
        .onClick(() => {
          this.handleImageClick(this.images[0], 0);
        })

      // å³ä¾§åŒå›¾ç«–æ’
      Column() {
        ForEach(this.images.slice(1, 3), (imageUrl: string, index: number) => {
          Image(this.getImageUrl(imageUrl))
            .width('100%')
            .height(92)
            .objectFit(ImageFit.Cover)
            .borderRadius(this.imageBorderRadius)
            .onClick(() => {
              this.handleImageClick(imageUrl, index + 1);
            })
        }, (imageUrl: string, index: number) => `triple_${index + 1}_${imageUrl}`)
      }
      .width('48%')
      .height(200)
      .justifyContent(FlexAlign.SpaceBetween)
    }
    .width('100%')
    .justifyContent(FlexAlign.SpaceBetween)
  }

  /**
   * å¤„ç†å›¾ç‰‡ç‚¹å‡»äº‹ä»¶
   */
  private handleImageClick(imageUrl: string, imageIndex: number): void {
    console.info(`ğŸ–¼ï¸ [TreeHoleImageGrid] ç‚¹å‡»å›¾ç‰‡: ${imageIndex}, URL: ${imageUrl}`);
    
    if (this.onImageClick) {
      this.onImageClick.call(imageUrl, imageIndex, this.images);
    }
  }

  /**
   * è·å–å®Œæ•´çš„å›¾ç‰‡URL
   */
  private getImageUrl(imagePath: string): string {
    if (!imagePath) {
      return '';
    }
    
    // å¦‚æœå·²ç»æ˜¯å®Œæ•´URLåˆ™ç›´æ¥è¿”å›
    if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
      return imagePath;
    }
    
    // å¦åˆ™æ‹¼æ¥åŸºç¡€URL
    return `${API_CONFIG.BASE_URL}${imagePath.startsWith('/') ? imagePath : '/' + imagePath}`;
  }
}