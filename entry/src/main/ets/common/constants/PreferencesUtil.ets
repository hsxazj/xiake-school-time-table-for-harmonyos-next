import { ValueType } from '@kit.ArkData';
import dataPreferences from '@ohos.data.preferences';
import { BusinessError } from '@kit.BasicServicesKit';

const PREFERENCES_NAME: string = 'myPreferences';
let preference: dataPreferences.Preferences | null = null;

export class PreferencesUtil {
  private preferenceName: string = PREFERENCES_NAME;
  private groupId: string = "";

  setPreferenceName(preferenceName: string) {
    this.preferenceName = preferenceName;
  }

  setGroupId(groupId: string) {
    this.groupId = groupId;
  }

  getPreference(): dataPreferences.Preferences {
    let options: dataPreferences.Options = { name: this.preferenceName };
    console.debug(`name: ${this.preferenceName}, groupID: ${this.groupId}`);

    if (!this.groupId) options.dataGroupId = this.groupId;
    return dataPreferences.getPreferencesSync(getContext(this), options);
  }

  /**
   * æ„é€ å™¨
   */
  constructor(preferenceName: string = PREFERENCES_NAME, groupId: string) {
    this.preferenceName = preferenceName;
    this.groupId = groupId;

    preference = this.getPreference();
  }

  /**
   * ä¿å­˜æ•°æ®åˆ°é¦–é€‰é¡¹
   * @param key
   * @param value
   */
  putValue(key: string, value: ValueType, override: boolean = true) {
    try {
      if (!preference) {
        console.info('preferenceä¸å­˜åœ¨');
        preference = this.getPreference();
      }

      if (preference.hasSync(key)) { // åˆ¤æ–­å½“å‰keyæ˜¯å¦å·²å­˜åœ¨
        console.info(`The key ${key} is contained.`);

        // åˆ¤æ–­æ˜¯å¦è¦†ç›–å…¶å€¼ï¼Œä¸ºtrueåˆ™è¦†ç›–
        if (override) preference.putSync(key, value);
      } else {
        preference.putSync(key, value);
      }

      preference.flush((err: BusinessError) => {
        if (err) {
          console.error(`Failed to flush. Code:${err.code}, message:${err.message}`);
          return;
        }
        console.info('Succeeded in flushing.');
      });
    } catch (err) {
      console.error(`Save value by preferences error: ${err}`)
    }
  }

  /**
   * è·å–æ•°æ®åˆ°é¦–é€‰é¡¹
   * @param key
   * @param defaultValue é»˜è®¤è¿”å›å€¼
   * @returns stringç±»å‹å€¼
   */
  getValue(key: string, defaultValue: ValueType = ''): ValueType {
    let resValue: ValueType = '';
    try {
      if (!preference) {
        preference = this.getPreference();
      }

      resValue = preference.getSync(key, defaultValue).toString();
    } catch (err) {
      console.error('Get value by preferences error: ${err}')
    }

    return resValue;
  }

  /**
   * ä»é¦–é€‰é¡¹æŒ‰keyç§»é™¤æ•°æ®
   * @param key
   */
  removeValue(key: string) {
    try {
      if (!preference) {
        preference = this.getPreference();
      }
      preference.deleteSync(key);

      preference.flush((err: BusinessError) => {
        if (err) {
          console.error(`Failed to flush. Code:${err.code}, message:${err.message}`);
          return;
        }
        console.info('Succeeded in flushing.');
      });
    } catch (err) {
      console.error('Remove value by preferences error: ${err}')
    }
  }

  /**
   * æ¸…é™¤æ‰€æœ‰æ•°æ®
   */
  clearAll() {
    try {
      if (!preference) {
        preference = this.getPreference();
      }

      preference.clearSync();
      preference.flush((err: BusinessError) => {
        if (err) {
          console.error(`Failed to flush. Code:${err.code}, message:${err.message}`);
          return;
        }
        console.info('Succeeded in flushing.');
      });

    } catch (err) {
      console.error(`Failed to put value, Cause: ${err}`);
    }
  }

}

// ç”¨æˆ·å­¦ç±ä¿¡æ¯æ¥å£
export interface UserSchoolInfo {
  collegeId: string;
  collegeName: string;
  majorId: string;
  majorName: string;
  classId: string;
  className: string;
}

// ç”¨æˆ·å­¦ç±ä¿¡æ¯ç®¡ç†ç±»
export class UserInfoManager {
  private static instance: UserInfoManager;
  private preferencesUtil: PreferencesUtil;

  // å­˜å‚¨é”®å¸¸é‡
  private static readonly COLLEGE_ID_KEY = 'userCollegeId';
  private static readonly COLLEGE_NAME_KEY = 'userCollegeName';
  private static readonly MAJOR_ID_KEY = 'userMajorId';
  private static readonly MAJOR_NAME_KEY = 'userMajorName';
  private static readonly CLASS_ID_KEY = 'userClassId';
  private static readonly CLASS_NAME_KEY = 'userClassName';

  private constructor() {
    this.preferencesUtil = new PreferencesUtil(PREFERENCES_NAME, "");
  }

  public static getInstance(): UserInfoManager {
    if (!UserInfoManager.instance) {
      UserInfoManager.instance = new UserInfoManager();
    }
    return UserInfoManager.instance;
  }

  /**
   * ä¿å­˜å­¦é™¢ä¿¡æ¯
   */
  public saveCollegeInfo(collegeId: string, collegeName: string): void {
    this.preferencesUtil.putValue(UserInfoManager.COLLEGE_ID_KEY, collegeId);
    this.preferencesUtil.putValue(UserInfoManager.COLLEGE_NAME_KEY, collegeName);
    console.info(`ğŸ“š [UserInfo] ä¿å­˜å­¦é™¢ä¿¡æ¯: ${collegeId} - ${collegeName}`);
  }

  /**
   * ä¿å­˜ä¸“ä¸šä¿¡æ¯
   */
  public saveMajorInfo(majorId: string, majorName: string): void {
    this.preferencesUtil.putValue(UserInfoManager.MAJOR_ID_KEY, majorId);
    this.preferencesUtil.putValue(UserInfoManager.MAJOR_NAME_KEY, majorName);
    console.info(`ğŸ“š [UserInfo] ä¿å­˜ä¸“ä¸šä¿¡æ¯: ${majorId} - ${majorName}`);
  }

  /**
   * ä¿å­˜ç­çº§ä¿¡æ¯
   */
  public saveClassInfo(classId: string, className: string): void {
    this.preferencesUtil.putValue(UserInfoManager.CLASS_ID_KEY, classId);
    this.preferencesUtil.putValue(UserInfoManager.CLASS_NAME_KEY, className);
    console.info(`ğŸ“š [UserInfo] ä¿å­˜ç­çº§ä¿¡æ¯: ${classId} - ${className}`);
  }

  /**
   * è·å–å­¦é™¢ID
   */
  public getCollegeId(): string {
    return this.preferencesUtil.getValue(UserInfoManager.COLLEGE_ID_KEY, '') as string;
  }

  /**
   * è·å–å­¦é™¢åç§°
   */
  public getCollegeName(): string {
    return this.preferencesUtil.getValue(UserInfoManager.COLLEGE_NAME_KEY, '') as string;
  }

  /**
   * è·å–ä¸“ä¸šID
   */
  public getMajorId(): string {
    return this.preferencesUtil.getValue(UserInfoManager.MAJOR_ID_KEY, '') as string;
  }

  /**
   * è·å–ä¸“ä¸šåç§°
   */
  public getMajorName(): string {
    return this.preferencesUtil.getValue(UserInfoManager.MAJOR_NAME_KEY, '') as string;
  }

  /**
   * è·å–ç­çº§ID
   */
  public getClassId(): string {
    const classId = this.preferencesUtil.getValue(UserInfoManager.CLASS_ID_KEY, '') as string;
    return classId;
  }

  /**
   * è·å–ç­çº§åç§°
   */
  public getClassName(): string {
    return this.preferencesUtil.getValue(UserInfoManager.CLASS_NAME_KEY, '') as string;
  }

  /**
   * æ£€æŸ¥æ˜¯å¦å·²è®¾ç½®å®Œæ•´çš„å­¦ç±ä¿¡æ¯
   */
  public hasCompleteUserInfo(): boolean {
    const collegeId = this.getCollegeId();
    const majorId = this.getMajorId();
    const classId = this.getClassId();
    
    return !!(collegeId && majorId && classId);
  }

  /**
   * è·å–å®Œæ•´çš„ç”¨æˆ·å­¦ç±ä¿¡æ¯
   */
  public getUserInfo(): UserSchoolInfo {
    const result: UserSchoolInfo = {
      collegeId: this.getCollegeId(),
      collegeName: this.getCollegeName(),
      majorId: this.getMajorId(),
      majorName: this.getMajorName(),
      classId: this.getClassId(),
      className: this.getClassName()
    };
    return result;
  }

  /**
   * æ¸…é™¤æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯
   */
  public clearUserInfo(): void {
    this.preferencesUtil.removeValue(UserInfoManager.COLLEGE_ID_KEY);
    this.preferencesUtil.removeValue(UserInfoManager.COLLEGE_NAME_KEY);
    this.preferencesUtil.removeValue(UserInfoManager.MAJOR_ID_KEY);
    this.preferencesUtil.removeValue(UserInfoManager.MAJOR_NAME_KEY);
    this.preferencesUtil.removeValue(UserInfoManager.CLASS_ID_KEY);
    this.preferencesUtil.removeValue(UserInfoManager.CLASS_NAME_KEY);
    console.info('ğŸ“š [UserInfo] æ¸…é™¤ç”¨æˆ·å­¦ç±ä¿¡æ¯');
  }
}

export default new PreferencesUtil(PREFERENCES_NAME, "");
