import { PreferencesUtil } from "./PreferencesUtil";

// ç”¨æˆ·å­¦ç±ä¿¡æ¯æ¥å£
export interface UserSchoolInfo {
  collegeId: string;
  collegeName: string;
  majorId: string;
  majorName: string;
  classId: string;
  className: string;
}

// ç”¨æˆ·å­¦ç±ä¿¡æ¯ç®¡ç†ç±»
export class UserInfoManager {
  private static instance: UserInfoManager;
  // å­˜å‚¨é”®å¸¸é‡
  private static readonly COLLEGE_ID_KEY = 'userCollegeId';
  private static readonly COLLEGE_NAME_KEY = 'userCollegeName';
  private static readonly MAJOR_ID_KEY = 'userMajorId';
  private static readonly MAJOR_NAME_KEY = 'userMajorName';
  private static readonly CLASS_ID_KEY = 'userClassId';
  private static readonly CLASS_NAME_KEY = 'userClassName';

  private constructor() {
    // æ— éœ€å­˜å‚¨PreferencesUtilå®ä¾‹ï¼Œç›´æ¥ä½¿ç”¨å•ä¾‹
  }

  public static getInstance(): UserInfoManager {
    if (!UserInfoManager.instance) {
      UserInfoManager.instance = new UserInfoManager();
    }
    return UserInfoManager.instance;
  }

  /**
   * ä¿å­˜å­¦é™¢ä¿¡æ¯
   */
  public saveCollegeInfo(context: Context, collegeId: string, collegeName: string): void {
    const util = PreferencesUtil.getInstance();
    console.info(`ğŸ“š [UserInfo] ä¿å­˜å­¦é™¢ä¿¡æ¯å¼€å§‹: ${collegeId} - ${collegeName}`);
    util.putValue(context, UserInfoManager.COLLEGE_ID_KEY, collegeId);
    util.putValue(context, UserInfoManager.COLLEGE_NAME_KEY, collegeName);
    console.info(`ğŸ“š [UserInfo] ä¿å­˜å­¦é™¢ä¿¡æ¯å®Œæˆ: ${collegeId} - ${collegeName}`);
  }

  /**
   * ä¿å­˜ä¸“ä¸šä¿¡æ¯
   */
  public saveMajorInfo(context: Context, majorId: string, majorName: string): void {
    const util = PreferencesUtil.getInstance();
    console.info(`ğŸ“š [UserInfo] ä¿å­˜ä¸“ä¸šä¿¡æ¯å¼€å§‹: ${majorId} - ${majorName}`);
    util.putValue(context, UserInfoManager.MAJOR_ID_KEY, majorId);
    util.putValue(context, UserInfoManager.MAJOR_NAME_KEY, majorName);
    console.info(`ğŸ“š [UserInfo] ä¿å­˜ä¸“ä¸šä¿¡æ¯å®Œæˆ: ${majorId} - ${majorName}`);
  }

  /**
   * ä¿å­˜ç­çº§ä¿¡æ¯
   */
  public saveClassInfo(context: Context, classId: string, className: string): void {
    const util = PreferencesUtil.getInstance();
    console.info(`ğŸ“š [UserInfo] ä¿å­˜ç­çº§ä¿¡æ¯å¼€å§‹: ${classId} - ${className}`);
    util.putValue(context, UserInfoManager.CLASS_ID_KEY, classId);
    util.putValue(context, UserInfoManager.CLASS_NAME_KEY, className);
    console.info(`ğŸ“š [UserInfo] ä¿å­˜ç­çº§ä¿¡æ¯å®Œæˆ: ${classId} - ${className}`);
  }

  /**
   * æ‰¹é‡ä¿å­˜å®Œæ•´çš„ç”¨æˆ·å­¦ç±ä¿¡æ¯ï¼ˆåŸå­æ“ä½œï¼‰
   */
  public saveCompleteUserInfo(context: Context, userInfo: UserSchoolInfo): void {
    const util = PreferencesUtil.getInstance();
    console.info(`ğŸ“š [UserInfo] å¼€å§‹æ‰¹é‡ä¿å­˜ç”¨æˆ·ä¿¡æ¯...`);
    
    try {
      // è·å–åŒä¸€ä¸ªpreferenceså®ä¾‹ï¼Œç¡®ä¿åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­æ“ä½œ
      const preferences = util.getPreferences(context);
      
      // æ‰¹é‡è®¾ç½®æ‰€æœ‰å€¼
      preferences.putSync(UserInfoManager.COLLEGE_ID_KEY, userInfo.collegeId);
      preferences.putSync(UserInfoManager.COLLEGE_NAME_KEY, userInfo.collegeName);
      preferences.putSync(UserInfoManager.MAJOR_ID_KEY, userInfo.majorId);
      preferences.putSync(UserInfoManager.MAJOR_NAME_KEY, userInfo.majorName);
      preferences.putSync(UserInfoManager.CLASS_ID_KEY, userInfo.classId);
      preferences.putSync(UserInfoManager.CLASS_NAME_KEY, userInfo.className);
      
      // ä¸€æ¬¡æ€§åŒæ­¥åˆ·æ–°æ‰€æœ‰æ•°æ®
      preferences.flushSync();
      
      console.info(`ğŸ“š [UserInfo] æ‰¹é‡ä¿å­˜å®Œæˆ`);
      console.info(`ğŸ“š [UserInfo] å­¦é™¢: ${userInfo.collegeId} - ${userInfo.collegeName}`);
      console.info(`ğŸ“š [UserInfo] ä¸“ä¸š: ${userInfo.majorId} - ${userInfo.majorName}`);
      console.info(`ğŸ“š [UserInfo] ç­çº§: ${userInfo.classId} - ${userInfo.className}`);
    } catch (error) {
      console.error(`ğŸ“š [UserInfo] æ‰¹é‡ä¿å­˜å¤±è´¥: ${error}`);
      // ArkTSä¸æ”¯æŒæŠ›å‡ºä»»æ„ç±»å‹ï¼Œæ”¹ä¸ºæŠ›å‡ºErrorå¯¹è±¡
      throw new Error(`æ‰¹é‡ä¿å­˜ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${error}`);
    }
  }

  /**
   * è·å–å­¦é™¢ID
   */
  public getCollegeId(context: Context): string {
    const util = PreferencesUtil.getInstance();
    return util.getValue(context, UserInfoManager.COLLEGE_ID_KEY, '') as string;
  }

  /**
   * è·å–å­¦é™¢åç§°
   */
  public getCollegeName(context: Context): string {
    const util = PreferencesUtil.getInstance();
    return util.getValue(context, UserInfoManager.COLLEGE_NAME_KEY, '') as string;
  }

  /**
   * è·å–ä¸“ä¸šID
   */
  public getMajorId(context: Context): string {
    const util = PreferencesUtil.getInstance();
    return util.getValue(context, UserInfoManager.MAJOR_ID_KEY, '') as string;
  }

  /**
   * è·å–ä¸“ä¸šåç§°
   */
  public getMajorName(context: Context): string {
    const util = PreferencesUtil.getInstance();
    return util.getValue(context, UserInfoManager.MAJOR_NAME_KEY, '') as string;
  }

  /**
   * è·å–ç­çº§ID
   */
  public getClassId(context: Context): string {
    const util = PreferencesUtil.getInstance();
    return util.getValue(context, UserInfoManager.CLASS_ID_KEY, '') as string;
  }

  /**
   * è·å–ç­çº§åç§°
   */
  public getClassName(context: Context): string {
    const util = PreferencesUtil.getInstance();
    return util.getValue(context, UserInfoManager.CLASS_NAME_KEY, '') as string;
  }

  /**
   * æ£€æŸ¥æ˜¯å¦å·²è®¾ç½®å®Œæ•´çš„å­¦ç±ä¿¡æ¯
   */
  public hasCompleteUserInfo(context: Context): boolean {
    const collegeId = this.getCollegeId(context);
    const majorId = this.getMajorId(context);
    const classId = this.getClassId(context);

    return !!(collegeId && majorId && classId);
  }

  /**
   * è·å–å®Œæ•´çš„ç”¨æˆ·å­¦ç±ä¿¡æ¯
   */
  public getUserInfo(context: Context): UserSchoolInfo {
    const result: UserSchoolInfo = {
      collegeId: this.getCollegeId(context),
      collegeName: this.getCollegeName(context),
      majorId: this.getMajorId(context),
      majorName: this.getMajorName(context),
      classId: this.getClassId(context),
      className: this.getClassName(context)
    };
    return result;
  }

  /**
   * æ¸…é™¤æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯
   */
  public clearUserInfo(context: Context): void {
    const util = PreferencesUtil.getInstance();
    util.removeValue(context, UserInfoManager.COLLEGE_ID_KEY);
    util.removeValue(context, UserInfoManager.COLLEGE_NAME_KEY);
    util.removeValue(context, UserInfoManager.MAJOR_ID_KEY);
    util.removeValue(context, UserInfoManager.MAJOR_NAME_KEY);
    util.removeValue(context, UserInfoManager.CLASS_ID_KEY);
    util.removeValue(context, UserInfoManager.CLASS_NAME_KEY);
    console.info('ğŸ“š [UserInfo] æ¸…é™¤ç”¨æˆ·å­¦ç±ä¿¡æ¯');
  }
}