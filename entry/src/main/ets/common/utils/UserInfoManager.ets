import { PreferencesUtil } from './PreferencesUtil';
import { UserApiService } from '../../services/api/UserApiService';
import { GetUserInfoResponse, SimpleUserInfo } from '../../models/UserModels';

// ç”¨æˆ·å­¦ç±ä¿¡æ¯æ¥å£
export interface UserSchoolInfo {
  collegeId: string;
  collegeName: string;
  majorId: string;
  majorName: string;
  classId: string;
  className: string;
}

// ç”¨æˆ·å­¦ç±ä¿¡æ¯ç®¡ç†ç±»
export class UserInfoManager {
  private static instance: UserInfoManager;
  // å­˜å‚¨é”®å¸¸é‡
  private static readonly COLLEGE_ID_KEY = 'userCollegeId';
  private static readonly COLLEGE_NAME_KEY = 'userCollegeName';
  private static readonly MAJOR_ID_KEY = 'userMajorId';
  private static readonly MAJOR_NAME_KEY = 'userMajorName';
  private static readonly CLASS_ID_KEY = 'userClassId';
  private static readonly CLASS_NAME_KEY = 'userClassName';
  // æ–°å¢çš„ç”¨æˆ·ç™»å½•ç›¸å…³å­˜å‚¨é”®
  private static readonly TOKEN_KEY = 'token';
  private static readonly CURRENT_USER_KEY = 'currentUserInfo';
  private static readonly LOGIN_TIME_KEY = 'loginTime';
  private userApiService: UserApiService | null = null;

  private constructor() {
    // æ— éœ€å­˜å‚¨PreferencesUtilå®ä¾‹ï¼Œç›´æ¥ä½¿ç”¨å•ä¾‹
  }

  public static getInstance(): UserInfoManager {
    if (!UserInfoManager.instance) {
      UserInfoManager.instance = new UserInfoManager();
    }
    return UserInfoManager.instance;
  }

  /**
   * ä¿å­˜å­¦é™¢ä¿¡æ¯
   */
  public saveCollegeInfo(context: Context, collegeId: string, collegeName: string): void {
    const util = PreferencesUtil.getInstance();
    console.info(`ğŸ“š [UserInfo] ä¿å­˜å­¦é™¢ä¿¡æ¯å¼€å§‹: ${collegeId} - ${collegeName}`);
    util.putValue(context, UserInfoManager.COLLEGE_ID_KEY, collegeId);
    util.putValue(context, UserInfoManager.COLLEGE_NAME_KEY, collegeName);
    console.info(`ğŸ“š [UserInfo] ä¿å­˜å­¦é™¢ä¿¡æ¯å®Œæˆ: ${collegeId} - ${collegeName}`);
  }

  /**
   * ä¿å­˜ä¸“ä¸šä¿¡æ¯
   */
  public saveMajorInfo(context: Context, majorId: string, majorName: string): void {
    const util = PreferencesUtil.getInstance();
    console.info(`ğŸ“š [UserInfo] ä¿å­˜ä¸“ä¸šä¿¡æ¯å¼€å§‹: ${majorId} - ${majorName}`);
    util.putValue(context, UserInfoManager.MAJOR_ID_KEY, majorId);
    util.putValue(context, UserInfoManager.MAJOR_NAME_KEY, majorName);
    console.info(`ğŸ“š [UserInfo] ä¿å­˜ä¸“ä¸šä¿¡æ¯å®Œæˆ: ${majorId} - ${majorName}`);
  }

  /**
   * ä¿å­˜ç­çº§ä¿¡æ¯
   */
  public saveClassInfo(context: Context, classId: string, className: string): void {
    const util = PreferencesUtil.getInstance();
    console.info(`ğŸ“š [UserInfo] ä¿å­˜ç­çº§ä¿¡æ¯å¼€å§‹: ${classId} - ${className}`);
    util.putValue(context, UserInfoManager.CLASS_ID_KEY, classId);
    util.putValue(context, UserInfoManager.CLASS_NAME_KEY, className);
    console.info(`ğŸ“š [UserInfo] ä¿å­˜ç­çº§ä¿¡æ¯å®Œæˆ: ${classId} - ${className}`);
  }

  /**
   * æ‰¹é‡ä¿å­˜å®Œæ•´çš„ç”¨æˆ·å­¦ç±ä¿¡æ¯ï¼ˆåŸå­æ“ä½œï¼‰
   */
  public saveCompleteUserInfo(context: Context | undefined, userInfo: UserSchoolInfo): void {
    const util = PreferencesUtil.getInstance();
    console.info(`ğŸ“š [UserInfo] å¼€å§‹æ‰¹é‡ä¿å­˜ç”¨æˆ·ä¿¡æ¯...`);

    try {
      // è·å–åŒä¸€ä¸ªpreferenceså®ä¾‹ï¼Œç¡®ä¿åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­æ“ä½œ
      const preferences = util.getPreferences(context);

      // æ‰¹é‡è®¾ç½®æ‰€æœ‰å€¼
      preferences.putSync(UserInfoManager.COLLEGE_ID_KEY, userInfo.collegeId);
      preferences.putSync(UserInfoManager.COLLEGE_NAME_KEY, userInfo.collegeName);
      preferences.putSync(UserInfoManager.MAJOR_ID_KEY, userInfo.majorId);
      preferences.putSync(UserInfoManager.MAJOR_NAME_KEY, userInfo.majorName);
      preferences.putSync(UserInfoManager.CLASS_ID_KEY, userInfo.classId);
      preferences.putSync(UserInfoManager.CLASS_NAME_KEY, userInfo.className);

      // ä¸€æ¬¡æ€§åŒæ­¥åˆ·æ–°æ‰€æœ‰æ•°æ®
      preferences.flushSync();

      console.info(`ğŸ“š [UserInfo] æ‰¹é‡ä¿å­˜å®Œæˆ`);
      console.info(`ğŸ“š [UserInfo] å­¦é™¢: ${userInfo.collegeId} - ${userInfo.collegeName}`);
      console.info(`ğŸ“š [UserInfo] ä¸“ä¸š: ${userInfo.majorId} - ${userInfo.majorName}`);
      console.info(`ğŸ“š [UserInfo] ç­çº§: ${userInfo.classId} - ${userInfo.className}`);
    } catch (error) {
      console.error(`ğŸ“š [UserInfo] æ‰¹é‡ä¿å­˜å¤±è´¥: ${error}`);
      // ArkTSä¸æ”¯æŒæŠ›å‡ºä»»æ„ç±»å‹ï¼Œæ”¹ä¸ºæŠ›å‡ºErrorå¯¹è±¡
      throw new Error(`æ‰¹é‡ä¿å­˜ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${error}`);
    }
  }

  /**
   * è·å–å­¦é™¢ID
   */
  public getCollegeId(context: Context | undefined): string {
    const util = PreferencesUtil.getInstance();
    return util.getValue(context, UserInfoManager.COLLEGE_ID_KEY, '') as string;
  }

  /**
   * è·å–å­¦é™¢åç§°
   */
  public getCollegeName(context: Context | undefined): string {
    const util = PreferencesUtil.getInstance();
    return util.getValue(context, UserInfoManager.COLLEGE_NAME_KEY, '') as string;
  }

  /**
   * è·å–ä¸“ä¸šID
   */
  public getMajorId(context: Context | undefined): string {
    const util = PreferencesUtil.getInstance();
    return util.getValue(context, UserInfoManager.MAJOR_ID_KEY, '') as string;
  }

  /**
   * è·å–ä¸“ä¸šåç§°
   */
  public getMajorName(context: Context | undefined): string {
    const util = PreferencesUtil.getInstance();
    return util.getValue(context, UserInfoManager.MAJOR_NAME_KEY, '') as string;
  }

  /**
   * è·å–ç­çº§ID
   */
  public getClassId(context: Context | undefined): string {
    const util = PreferencesUtil.getInstance();
    return util.getValue(context, UserInfoManager.CLASS_ID_KEY, '') as string;
  }

  /**
   * è·å–ç­çº§åç§°
   */
  public getClassName(context: Context | undefined): string {
    const util = PreferencesUtil.getInstance();
    return util.getValue(context, UserInfoManager.CLASS_NAME_KEY, '') as string;
  }

  /**
   * æ£€æŸ¥æ˜¯å¦å·²è®¾ç½®å®Œæ•´çš„å­¦ç±ä¿¡æ¯
   */
  public hasCompleteUserInfo(context: Context | undefined): boolean {
    const collegeId = this.getCollegeId(context);
    const majorId = this.getMajorId(context);
    const classId = this.getClassId(context);

    return !!(collegeId && majorId && classId);
  }

  /**
   * è·å–å®Œæ•´çš„ç”¨æˆ·å­¦ç±ä¿¡æ¯
   */
  public getUserInfo(context: Context | undefined): UserSchoolInfo {
    const result: UserSchoolInfo = {
      collegeId: this.getCollegeId(context),
      collegeName: this.getCollegeName(context),
      majorId: this.getMajorId(context),
      majorName: this.getMajorName(context),
      classId: this.getClassId(context),
      className: this.getClassName(context)
    };
    return result;
  }

  /**
   * æ¸…é™¤æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯
   */
  public clearUserInfo(context: Context | undefined): void {
    const util = PreferencesUtil.getInstance();
    util.removeValue(context, UserInfoManager.COLLEGE_ID_KEY);
    util.removeValue(context, UserInfoManager.COLLEGE_NAME_KEY);
    util.removeValue(context, UserInfoManager.MAJOR_ID_KEY);
    util.removeValue(context, UserInfoManager.MAJOR_NAME_KEY);
    util.removeValue(context, UserInfoManager.CLASS_ID_KEY);
    util.removeValue(context, UserInfoManager.CLASS_NAME_KEY);
    console.info('ğŸ“š [UserInfo] æ¸…é™¤ç”¨æˆ·å­¦ç±ä¿¡æ¯');
  }

  // ===== æ–°å¢çš„ç™»å½•çŠ¶æ€ç®¡ç†æ–¹æ³• =====

  /**
   * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼ˆæ£€æŸ¥tokenå’Œç”¨æˆ·ä¿¡æ¯ï¼‰
   */
  public async checkLoginStatus(context: Context | undefined): Promise<boolean> {
    try {
      const token = this.getToken(context);
      if (!token) {
        console.info('ğŸ‘¤ [UserInfoManager] æœªæ‰¾åˆ°tokenï¼Œç”¨æˆ·æœªç™»å½•');
        return false;
      }

      // å°è¯•è·å–ç”¨æˆ·ä¿¡æ¯éªŒè¯tokenæœ‰æ•ˆæ€§
      try {
        const userInfoResponse: GetUserInfoResponse = await this.getUserApiService().getUserInfo();
        const simpleUserInfo: SimpleUserInfo = this.getUserApiService().convertToSimpleUserInfo(userInfoResponse);

        // ä¿å­˜æœ€æ–°çš„ç”¨æˆ·ä¿¡æ¯
        this.saveCurrentUserInfo(context, simpleUserInfo);

        console.info('ğŸ‘¤ [UserInfoManager] ç”¨æˆ·å·²ç™»å½•ä¸”tokenæœ‰æ•ˆ');
        return true;
      } catch (error) {
        console.error('ğŸ‘¤ [UserInfoManager] tokenéªŒè¯å¤±è´¥:', error);
        this.clearLoginInfo(context);

        // é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œè®©è°ƒç”¨æ–¹èƒ½å¤Ÿå¤„ç†ç‰¹å®šé”™è¯¯ç±»å‹
        if (error instanceof Error) {
          throw error;
        } else {
          throw new Error(`TokenéªŒè¯å¤±è´¥: ${JSON.stringify(error)}`);
        }
      }
    } catch (error) {
      console.error('ğŸ‘¤ [UserInfoManager] ç™»å½•çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
      return false;
    }
  }

  /**
   * åŒæ­¥æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆä»…æ£€æŸ¥æœ¬åœ°å­˜å‚¨ï¼‰
   */
  public isLoggedInSync(context: Context | undefined): boolean {
    const token = this.getToken(context);
    // å¦‚æœæœ‰tokenï¼Œå°±è®¤ä¸ºç”¨æˆ·å·²ç™»å½•
    // ç”¨æˆ·ä¿¡æ¯å¯èƒ½åœ¨å¼‚æ­¥è·å–ä¸­ï¼Œä¸åº”è¯¥é˜»å¡ç™»å½•çŠ¶æ€æ£€æµ‹
    return !!(token && token.trim().length > 0);
  }

  /**
   * ä¿å­˜ç™»å½•token
   */
  public saveToken(context: Context | undefined, token: string): void {
    const util = PreferencesUtil.getInstance();
    util.putValue(context, UserInfoManager.TOKEN_KEY, token);

    // è®°å½•ç™»å½•æ—¶é—´
    const loginTime = new Date().toISOString();
    util.putValue(context, UserInfoManager.LOGIN_TIME_KEY, loginTime);

    console.info('ğŸ‘¤ [UserInfoManager] tokenå·²ä¿å­˜');
  }

  /**
   * è·å–ç™»å½•token
   */
  public getToken(context: Context | undefined): string | null {
    // ä¼˜å…ˆä»AppStorageè·å–ï¼ˆæœ€æ–°çš„tokenï¼‰
    const appStorageToken = AppStorage.get<string>('token');
    if (appStorageToken && appStorageToken.trim().length > 0) {
      return appStorageToken;
    }

    // å¦‚æœAppStorageä¸­æ²¡æœ‰ï¼Œä»PreferencesUtilè·å–
    const util = PreferencesUtil.getInstance();
    const token = util.getValue(context, UserInfoManager.TOKEN_KEY, '') as string;
    return token || null;
  }

  /**
   * ä¿å­˜å½“å‰ç”¨æˆ·ä¿¡æ¯
   */
  public saveCurrentUserInfo(context: Context | undefined, userInfo: SimpleUserInfo): void {
    const util = PreferencesUtil.getInstance();
    util.putValue(context, UserInfoManager.CURRENT_USER_KEY, JSON.stringify(userInfo));
    console.info('ğŸ‘¤ [UserInfoManager] å½“å‰ç”¨æˆ·ä¿¡æ¯å·²ä¿å­˜');
  }

  /**
   * è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
   */
  public getCurrentUserInfo(context: Context | undefined): SimpleUserInfo | null {
    try {
      const util = PreferencesUtil.getInstance();
      const userInfoStr = util.getValue(context, UserInfoManager.CURRENT_USER_KEY, '') as string;
      if (!userInfoStr) {
        return null;
      }
      return JSON.parse(userInfoStr) as SimpleUserInfo;
    } catch (error) {
      console.error('ğŸ‘¤ [UserInfoManager] è§£æå½“å‰ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
      return null;
    }
  }

  /**
   * è·å–ç™»å½•æ—¶é—´
   */
  public getLoginTime(context: Context | undefined): string | null {
    const util = PreferencesUtil.getInstance();
    const loginTime = util.getValue(context, UserInfoManager.LOGIN_TIME_KEY, '') as string;
    return loginTime || null;
  }

  /**
   * æ¸…é™¤ç™»å½•ä¿¡æ¯ï¼ˆä¿ç•™å­¦ç±ä¿¡æ¯ï¼‰
   */
  public clearLoginInfo(context: Context | undefined): void {
    const util = PreferencesUtil.getInstance();
    util.removeValue(context, UserInfoManager.TOKEN_KEY);
    util.removeValue(context, UserInfoManager.CURRENT_USER_KEY);
    util.removeValue(context, UserInfoManager.LOGIN_TIME_KEY);
    console.info('ğŸ‘¤ [UserInfoManager] ç™»å½•ä¿¡æ¯å·²æ¸…é™¤');
  }

  /**
   * æ¸…é™¤æ‰€æœ‰ä¿¡æ¯ï¼ˆåŒ…æ‹¬å­¦ç±ä¿¡æ¯å’Œç™»å½•ä¿¡æ¯ï¼‰
   */
  public clearAllInfo(context: Context | undefined): void {
    this.clearUserInfo(context);
    this.clearLoginInfo(context);
    console.info('ğŸ‘¤ [UserInfoManager] æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯å·²æ¸…é™¤');
  }

  /**
   * è·å–UserApiServiceå®ä¾‹ï¼ˆæ‡’åŠ è½½ï¼‰
   */
  private getUserApiService(): UserApiService {
    if (!this.userApiService) {
      this.userApiService = UserApiService.getInstance();
    }
    return this.userApiService;
  }
}