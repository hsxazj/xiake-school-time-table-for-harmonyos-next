import { hilog } from '@kit.PerformanceAnalysisKit';
import { ErrorType } from '../../models/CacheModels';

const DOMAIN: number = 0x0001;
const TAG: string = 'ErrorUtil';

// å®šä¹‰HTTPå“åº”æ¥å£
interface HttpResponse {
  status?: number;
}

// å®šä¹‰é”™è¯¯å¯¹è±¡æ¥å£
interface NetworkError {
  code?: string | number;  // æ”¯æŒå­—ç¬¦ä¸²å’Œæ•°å­—ç±»å‹çš„é”™è¯¯ç 
  message?: string;
  response?: HttpResponse;
  request?: object;
}

// è§£æåçš„é”™è¯¯ä¿¡æ¯æ¥å£
interface ParsedErrorInfo {
  code?: number;
  message?: string;
}

/**
 * é”™è¯¯åˆ¤æ–­å·¥å…·ç±»
 * èŒè´£: åŒºåˆ†ç½‘ç»œé”™è¯¯å’Œä¸šåŠ¡é”™è¯¯,åˆ¤æ–­æ˜¯å¦éœ€è¦é™çº§åˆ°ç¼“å­˜
 */
export class ErrorUtil {
  /**
   * åˆ¤æ–­æ˜¯å¦ä¸ºç½‘ç»œé”™è¯¯ (éœ€è¦é™çº§åˆ°ç¼“å­˜)
   *
   * ç½‘ç»œé”™è¯¯åŒ…æ‹¬:
   * - è¿æ¥å¤±è´¥ (ECONNREFUSED)
   * - è¶…æ—¶ (ETIMEDOUT, ECONNABORTED, code: 2300028)
   * - DNSè§£æå¤±è´¥ (ENOTFOUND)
   * - æœåŠ¡å™¨5xxé”™è¯¯ (500, 502, 503, 504ç­‰)
   * - å®Œå…¨æ²¡æœ‰å“åº” (ç½‘ç»œæ–­å¼€)
   * - HarmonyOSç½‘ç»œé”™è¯¯ç  (23xxxxxç³»åˆ—)
   *
   * ä¸åŒ…æ‹¬:
   * - ä¸šåŠ¡é”™è¯¯ (æœåŠ¡å™¨è¿”å›200ä½†data.codeâ‰ 200)
   * - 4xxå®¢æˆ·ç«¯é”™è¯¯ (400, 401, 403, 404ç­‰)
   *
   * @param error é”™è¯¯å¯¹è±¡
   * @returns trueè¡¨ç¤ºç½‘ç»œé”™è¯¯,éœ€è¦é™çº§; falseè¡¨ç¤ºéç½‘ç»œé”™è¯¯
   */
  public static isNetworkError(error: Error | object | null): boolean {
    if (!error) {
      return false;
    }

    const err = error as NetworkError;

    // è¯¦ç»†è°ƒè¯•æ—¥å¿—
    hilog.info(DOMAIN, TAG, `ğŸ” [DEBUG] å®Œæ•´é”™è¯¯å¯¹è±¡: ${JSON.stringify(error)}`);
    hilog.info(DOMAIN, TAG, `ğŸ” [DEBUG] error.code ç±»å‹: ${typeof err.code}`);
    hilog.info(DOMAIN, TAG, `ğŸ” [DEBUG] error.code å€¼: ${err.code}`);
    hilog.info(DOMAIN, TAG, `ğŸ” [DEBUG] error.message: ${err.message}`);
    hilog.info(DOMAIN, TAG, `ğŸ” [DEBUG] error.response: ${err.response ? 'exists' : 'null'}`);
    hilog.info(DOMAIN, TAG, `ğŸ” [DEBUG] error.request: ${err.request ? 'exists' : 'null'}`);

    // å°è¯•ä» error.message ä¸­è§£æ JSON æ ¼å¼çš„é”™è¯¯ä¿¡æ¯
    if (err.message) {
      try {
        // HarmonyOS çš„ axios å¯èƒ½å°†åº•å±‚é”™è¯¯åºåˆ—åŒ–åˆ° message ä¸­
        if (err.message.startsWith('{') && err.message.includes('code')) {
          const parsedError: ParsedErrorInfo = JSON.parse(err.message) as ParsedErrorInfo;
          if (parsedError.code && typeof parsedError.code === 'number') {
            hilog.info(DOMAIN, TAG, `ğŸ” [DEBUG] ä» message è§£æåˆ° code: ${parsedError.code}`);
            // æ£€æŸ¥æ˜¯å¦ä¸º HarmonyOS ç½‘ç»œé”™è¯¯ç 
            if (parsedError.code >= 2300000 && parsedError.code < 2400000) {
              hilog.info(DOMAIN, TAG, `ğŸŒ HarmonyOSç½‘ç»œé”™è¯¯ (ä»messageè§£æ): ${parsedError.code} - ${parsedError.message}`);
              return true;
            }
          }
        }
      } catch (parseError) {
        // JSON è§£æå¤±è´¥ï¼Œç»§ç»­å…¶ä»–æ£€æŸ¥
        hilog.debug(DOMAIN, TAG, `è§£æ message JSON å¤±è´¥ï¼Œç»§ç»­å…¶ä»–æ£€æŸ¥`);
      }
    }

    // 1. æ£€æŸ¥ HarmonyOS ç½‘ç»œé”™è¯¯ç  (23xxxxx ç³»åˆ—)
    if (typeof err.code === 'number') {
      // HarmonyOS ç½‘ç»œé”™è¯¯ç èŒƒå›´
      // 2300028: è¶…æ—¶
      // 2300002: è¿æ¥å¤±è´¥
      // 2300003: URLæ ¼å¼é”™è¯¯
      // 2300006: SSLé”™è¯¯
      // 2300999: æœªçŸ¥é”™è¯¯
      const harmonyNetworkErrors = [
        2300028, // Timeout
        2300002, // Connection failed
        2300003, // URL error
        2300006, // SSL error
        2300007, // Protocol error
        2300999  // Unknown error
      ];

      if (harmonyNetworkErrors.includes(err.code)) {
        hilog.info(DOMAIN, TAG, `ğŸŒ HarmonyOSç½‘ç»œé”™è¯¯: ${err.code} - ${err.message}`);
        return true;
      }

      // æ£€æŸ¥æ˜¯å¦æ˜¯ 23xxxxx èŒƒå›´å†…çš„å…¶ä»–é”™è¯¯ç 
      if (err.code >= 2300000 && err.code < 2400000) {
        hilog.info(DOMAIN, TAG, `ğŸŒ HarmonyOSç½‘ç»œé”™è¯¯ (èŒƒå›´æ£€æŸ¥): ${err.code}`);
        return true;
      }
    }

    // 2. æ£€æŸ¥å­—ç¬¦ä¸²å½¢å¼çš„é”™è¯¯ç  (axios/node é£æ ¼)
    if (typeof err.code === 'string') {
      const networkErrorCodes = [
        'ECONNREFUSED', // è¿æ¥è¢«æ‹’ç»
        'ETIMEDOUT', // è¶…æ—¶
        'ECONNABORTED', // è¿æ¥ä¸­æ­¢
        'ENOTFOUND', // DNSè§£æå¤±è´¥
        'ENETUNREACH', // ç½‘ç»œä¸å¯è¾¾
        'EHOSTUNREACH', // ä¸»æœºä¸å¯è¾¾
        'ECONNRESET', // è¿æ¥é‡ç½®
        'EPIPE' // ç®¡é“ç ´è£‚
      ];

      if (networkErrorCodes.includes(err.code)) {
        hilog.info(DOMAIN, TAG, `ğŸŒ ç½‘ç»œé”™è¯¯: ${err.code}`);
        return true;
      }
    }

    // 3. æ£€æŸ¥HTTPå“åº”çŠ¶æ€ç 
    if (err.response) {
      const status = err.response.status;

      if (status) {
        // 5xxæœåŠ¡å™¨é”™è¯¯ -> ç½‘ç»œé”™è¯¯
        if (status >= 500 && status < 600) {
          hilog.info(DOMAIN, TAG, `ğŸŒ æœåŠ¡å™¨é”™è¯¯: ${status}`);
          return true;
        }

        // 4xxå®¢æˆ·ç«¯é”™è¯¯ -> éç½‘ç»œé”™è¯¯
        if (status >= 400 && status < 500) {
          hilog.info(DOMAIN, TAG, `âš ï¸ å®¢æˆ·ç«¯é”™è¯¯ (éç½‘ç»œ): ${status}`);
          return false;
        }

        // 2xx/3xx -> éç½‘ç»œé”™è¯¯ (æ­£å¸¸å“åº”æˆ–é‡å®šå‘)
        hilog.info(DOMAIN, TAG, `âœ… HTTPå“åº”æ­£å¸¸ (éç½‘ç»œé”™è¯¯): ${status}`);
        return false;
      }
    }

    // 4. å®Œå…¨æ²¡æœ‰å“åº” -> ç½‘ç»œé”™è¯¯ (å¯èƒ½æ˜¯ç½‘ç»œæ–­å¼€)
    if (!err.response && err.request) {
      hilog.info(DOMAIN, TAG, `ğŸŒ ç½‘ç»œé”™è¯¯: æ²¡æœ‰æ”¶åˆ°å“åº”`);
      return true;
    }

    // 5. æ£€æŸ¥é”™è¯¯æ¶ˆæ¯ä¸­çš„å…³é”®è¯
    const errorMessage = err.message || JSON.stringify(err);
    const networkKeywords = [
      'network', 'ç½‘ç»œ',
      'timeout', 'è¶…æ—¶', 'timed out',
      'connection', 'è¿æ¥',
      'unreachable', 'ä¸å¯è¾¾',
      'failed to fetch', 'è·å–å¤±è´¥',
      'network request failed'
    ];

    for (const keyword of networkKeywords) {
      if (errorMessage.toLowerCase().includes(keyword.toLowerCase())) {
        hilog.info(DOMAIN, TAG, `ğŸŒ ç½‘ç»œé”™è¯¯ (å…³é”®è¯åŒ¹é…): ${keyword}`);
        return true;
      }
    }

    // é»˜è®¤åˆ¤æ–­ä¸ºéç½‘ç»œé”™è¯¯
    hilog.info(DOMAIN, TAG, `âš ï¸ éç½‘ç»œé”™è¯¯ (é»˜è®¤)`);
    return false;
  }

  /**
   * è·å–è¯¦ç»†çš„é”™è¯¯ç±»å‹
   * @param error é”™è¯¯å¯¹è±¡
   * @returns é”™è¯¯ç±»å‹æšä¸¾
   */
  public static getErrorType(error: Error | object | null): ErrorType {
    if (ErrorUtil.isNetworkError(error)) {
      return ErrorType.NETWORK_ERROR;
    }

    const err = error as NetworkError;

    // æ£€æŸ¥æ˜¯å¦ä¸ºä¸šåŠ¡é”™è¯¯ (æœ‰å“åº”ä¸”çŠ¶æ€ç ä¸º2xx)
    if (err && err.response && err.response.status) {
      if (err.response.status >= 200 && err.response.status < 300) {
        return ErrorType.BUSINESS_ERROR;
      }
    }

    return ErrorType.UNKNOWN_ERROR;
  }

  /**
   * æ ¼å¼åŒ–é”™è¯¯ä¿¡æ¯ (ç”¨äºæ—¥å¿—è®°å½•)
   * @param error é”™è¯¯å¯¹è±¡
   * @returns æ ¼å¼åŒ–åçš„é”™è¯¯ä¿¡æ¯
   */
  public static formatError(error: Error | object | null): string {
    if (!error) {
      return 'æœªçŸ¥é”™è¯¯';
    }

    const errorType = ErrorUtil.getErrorType(error);
    const typeStr = errorType === ErrorType.NETWORK_ERROR ? 'ç½‘ç»œé”™è¯¯' :
      errorType === ErrorType.BUSINESS_ERROR ? 'ä¸šåŠ¡é”™è¯¯' : 'æœªçŸ¥é”™è¯¯';

    let message = `[${typeStr}] `;

    const err = error as NetworkError;

    if (err.code) {
      message += `é”™è¯¯ç : ${err.code} `;
    }

    if (err.response?.status) {
      message += `HTTPçŠ¶æ€: ${err.response.status} `;
    }

    if (err.message) {
      message += `æ¶ˆæ¯: ${err.message}`;
    } else {
      message += `æ¶ˆæ¯: ${JSON.stringify(err)}`;
    }

    return message;
  }
}
